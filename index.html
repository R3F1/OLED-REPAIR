<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>OLED REPAIR v1.3 (by ≈Åukasz Gruszczy≈Ñski)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap&subset=latin-ext" rel="stylesheet">
  
  <style>
    /* --- STYLES --- */
    :root {
      --bg-deep: #050505;
      --panel-glass: rgba(20, 25, 35, 0.95);
      --neon-cyan: #00f3ff;
      --neon-green: #0aff00;
      --neon-red: #ff003c;
      --neon-gold: #ffd700;
      --neon-purple: #bc13fe;
      --neon-orange: #ff9d00;
      --font-ui: 'Roboto', sans-serif;
      --font-tech: 'Oxanium', cursive;
    }
    * { box-sizing: border-box; user-select: none; }
    body {
      margin: 0; background-color: var(--bg-deep); color: #fff;
      font-family: var(--font-ui); height: 100vh; overflow: hidden;
      display: flex; flex-direction: column;
      background-image: linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
    }

    /* LOGIN SCREEN */
    #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; transition: opacity 0.8s; }
    .login-box { width: 450px; padding: 40px; background: rgba(10, 10, 10, 0.95); border: 1px solid var(--neon-cyan); text-align: center; border-radius: 12px; box-shadow: 0 0 60px rgba(0, 243, 255, 0.1); backdrop-filter: blur(10px); }
    .login-input { width: 100%; padding: 15px; margin: 10px 0; background: #080808; border: 1px solid #333; color: var(--neon-cyan); font-family: var(--font-tech); font-size: 18px; text-align: center; outline: none; transition: 0.3s; }
    .login-input:focus { border-color: var(--neon-cyan); background: #111; }
    input[type="password"] { letter-spacing: 5px; color: var(--neon-red); }
    .login-btn { width: 100%; padding: 15px; margin-top: 20px; background: var(--neon-cyan); color: #000; font-weight: bold; border: none; cursor: pointer; font-family: var(--font-tech); font-size: 16px; letter-spacing: 2px; transition: 0.3s; }
    .login-btn:hover { background: #fff; box-shadow: 0 0 30px var(--neon-cyan); }
    .quick-admin-btn { width: 100%; padding: 10px; margin-top: 10px; background: transparent; color: var(--neon-gold); border: 1px dashed var(--neon-gold); cursor: pointer; font-family: var(--font-tech); font-size: 12px; transition: 0.3s; border-radius: 4px; }
    .quick-admin-btn:hover { background: rgba(255, 215, 0, 0.1); box-shadow: 0 0 15px rgba(255, 215, 0, 0.2); }
    .login-error { color: var(--neon-red); font-size: 12px; height: 20px; margin-top: 10px; font-weight: bold; font-family: var(--font-ui); }
    .sync-status { color: #666; font-size: 11px; margin-top: 10px; font-family: monospace; height: 15px; }
    .sync-status.ok { color: var(--neon-green); }
    .sync-status.err { color: var(--neon-red); }
    .remember-me { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; font-size: 14px; color: #aaa; }
    .remember-me input { transform: scale(1.5); accent-color: var(--neon-cyan); cursor: pointer; }
    .emergency-reset { position: absolute; bottom: 20px; left: 20px; color: #333; font-size: 10px; cursor: pointer; border: 1px solid #222; padding: 5px; font-family: var(--font-tech); transition: 0.3s; }
    .emergency-reset:hover { color: var(--neon-red); border-color: var(--neon-red); }

    /* NETWORK GUARD */
    #networkGuard { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 8000; display: none; align-items: center; justify-content: center; flex-direction: column; backdrop-filter: blur(15px); }
    .alert-box { width: 600px; padding: 40px; border: 2px solid var(--neon-red); background: #050505; text-align: center; border-radius: 12px; box-shadow: 0 0 100px rgba(255, 0, 60, 0.2); }
    .path-box { background:#111; padding:15px; border:1px dashed #555; font-size:12px; color:#fff; font-family:var(--font-tech); margin-top: 5px; word-break: break-all; }
    .guard-btn { width: 100%; padding: 20px; background: var(--neon-red); color: #fff; font-weight: bold; border: none; cursor: pointer; font-family: var(--font-tech); font-size: 18px; margin-top: 20px; }
    .offline-btn { width: 100%; padding: 15px; background: transparent; color: var(--neon-orange); border: 1px solid var(--neon-orange); font-family: var(--font-tech); cursor: pointer; margin-top: 10px; font-weight: bold; transition: 0.3s; }
    .offline-btn:hover { background: var(--neon-orange); color: #000; }

    /* HEADER & UI */
    header { height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 30px; background: rgba(0,0,0,0.8); border-bottom: 1px solid #333; }
    .brand { font-family: var(--font-tech); font-size: 28px; font-weight: 700; color: #fff; letter-spacing: 2px; }
    .brand span { color: var(--neon-cyan); text-shadow: 0 0 10px var(--neon-cyan); }
    .operator-info { display: flex; align-items: center; gap: 20px; font-family: var(--font-tech); color: #aaa; font-size: 14px; }
    .operator-badge { background: #1a1a1a; padding: 6px 15px; border-radius: 4px; border: 1px solid #444; color: var(--neon-cyan); transition:0.3s; font-weight: bold; }
    .operator-badge.admin { border-color: var(--neon-gold); color: var(--neon-gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.1); }
    .operator-badge.coord { border-color: var(--neon-purple); color: var(--neon-purple); box-shadow: 0 0 15px rgba(188, 19, 254, 0.2); }
    .operator-badge.rma-leader { border-color: var(--neon-orange); color: var(--neon-orange); box-shadow: 0 0 15px rgba(255, 157, 0, 0.3); }
    .operator-badge.manager { border-color: #fff; color: #fff; background: var(--neon-red); box-shadow: 0 0 20px var(--neon-red); }
    .logout-btn { background: transparent; border: 1px solid #444; color: var(--neon-red); padding: 5px 10px; font-family: var(--font-tech); font-size: 12px; cursor: pointer; border-radius: 4px; transition: 0.3s; }
    .logout-btn:hover { background: var(--neon-red); color: #fff; }
    #motdBar { width: 100%; background: #220000; color: var(--neon-red); text-align: center; font-family: var(--font-tech); font-weight: bold; padding: 5px; font-size: 14px; border-bottom: 1px solid var(--neon-red); display: none; animation: pulseRed 3s infinite; }
    @keyframes pulseRed { 0% {opacity:0.8;} 50% {opacity:1;} 100% {opacity:0.8;} }

    /* DASHBOARDS */
    .dashboard { flex: 1; display: grid; grid-template-columns: 420px 1fr; gap: 20px; padding: 20px; overflow: hidden; opacity: 0; transition: opacity 1s; }
    body.mode-admin .dashboard { display: none !important; }
    body.mode-admin #adminDash { display: flex !important; }
    body.mode-manager .dashboard { display: none !important; }
    body.mode-manager #managerDash { display: flex !important; }
    body.mode-manager .bar-bottom { display: none !important; } 
    .panel-left { background: var(--panel-glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
    .panel-right { position: relative; background: #000; border: 2px solid #333; border-radius: 12px; overflow: hidden; box-shadow: inset 0 0 50px rgba(0,0,0,0.8); cursor: grab; }
    .panel-right:active { cursor: grabbing; }

    /* TARGET SYSTEM STYLES */
    .target-box { background: #0a0a0a; border: 1px solid #333; padding: 12px; border-radius: 8px; margin-bottom: 15px; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); transition: 0.5s; }
    .target-header { display: flex; justify-content: space-between; font-size: 11px; color: #888; margin-bottom: 6px; font-family: var(--font-tech); letter-spacing: 1px; }
    .progress-track { width: 100%; height: 10px; background: #151515; border-radius: 5px; overflow: hidden; border: 1px solid #333; position: relative; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--neon-cyan), var(--neon-green)); width: 0%; transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1); box-shadow: 0 0 10px var(--neon-green); }
    .target-val { color: var(--neon-green); font-weight: bold; font-size: 14px; }
    
    .target-box.reached { border-color: var(--neon-gold); box-shadow: 0 0 30px rgba(255, 215, 0, 0.2); animation: pulseGold 2s infinite; }
    .target-box.reached .progress-fill { background: var(--neon-gold); box-shadow: 0 0 20px var(--neon-gold); }
    @keyframes pulseGold { 0% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.1); } 50% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.3); } 100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.1); } }

    .mini-target-track { width: 100%; height: 6px; background: #222; margin-top: 5px; border-radius: 3px; overflow: hidden; }
    .mini-target-fill { height: 100%; background: var(--neon-green); width: 0%; transition: width 0.5s; }

    /* FLOW CONTROL STYLES */
    .checklist-btn.locked { opacity: 0.2; cursor: not-allowed; border-color: #333 !important; color: #444 !important; filter: grayscale(1); }
    .confirm-identity-btn { width: 100%; padding: 15px; background: var(--neon-green); color: #000; font-weight: bold; border: none; font-family: var(--font-tech); cursor: pointer; border-radius: 6px; margin-bottom: 15px; box-shadow: 0 0 20px rgba(10, 255, 0, 0.4); display: none; animation: pulseGreen 1.5s infinite; }
    @keyframes pulseGreen { 0% { box-shadow: 0 0 5px var(--neon-green); } 50% { box-shadow: 0 0 20px var(--neon-green); } 100% { box-shadow: 0 0 5px var(--neon-green); } }
    .scan-status-info { font-family: var(--font-tech); font-size: 12px; color: var(--neon-green); text-align: center; margin-bottom: 10px; display: none; }

    /* ADMIN DASH */
    #adminDash { display: none; flex: 1; padding: 40px; flex-direction: column; overflow-y: auto; gap: 20px; align-items: center; background: radial-gradient(circle at center, #111, #000); }
    .admin-container { width: 100%; max-width: 1600px; display: flex; flex-direction: column; gap: 20px; }
    .admin-status-bar { display: flex; justify-content: space-between; background: #0a0a0a; border: 1px solid #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .status-item { display: flex; align-items: center; gap: 10px; font-family: var(--font-tech); font-size: 14px; color: #888; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #333; }
    .status-dot.ok { background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }
    .admin-grid { display: grid; grid-template-columns: 1fr 380px; gap: 25px; width: 100%; }
    .admin-panel-box { background: rgba(10, 10, 10, 0.9); border: 1px solid #333; padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); backdrop-filter: blur(5px); display: flex; flex-direction: column; }
    .admin-panel-box.highlight { border-color: var(--neon-gold); box-shadow: 0 0 20px rgba(255, 215, 0, 0.1); }
    .admin-h { font-family: var(--font-tech); color: var(--neon-gold); font-size: 20px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; display:flex; justify-content:space-between; align-items:center; letter-spacing: 1px; }
    .cfg-input { width: 100%; background: #000; color: #fff; border: 1px solid #444; padding: 12px; margin-bottom: 10px; font-family: monospace; font-size: 14px; }
    .cfg-btn { background: #222; color: #fff; border: 1px solid #555; padding: 10px 20px; font-weight:bold; cursor:pointer; font-family: var(--font-tech); transition:0.3s; font-size: 13px; text-transform: uppercase; }
    .cfg-btn:hover { background: var(--neon-gold); color: #000; border-color: var(--neon-gold); box-shadow: 0 0 15px var(--neon-gold); }
    .cfg-btn.cyan:hover { background: var(--neon-cyan); color: #000; border-color: var(--neon-cyan); box-shadow: 0 0 15px var(--neon-cyan); }
    .adm-table { width: 100%; border-collapse: collapse; }
    .adm-table th { text-align: left; border-bottom: 2px solid #444; color: var(--neon-cyan); padding: 10px; font-size: 12px; }
    .adm-table td { border-bottom: 1px solid #222; padding: 12px 10px; font-size: 14px; }
    .adm-btn-group { display: flex; gap: 8px; }
    .adm-act-btn { padding: 5px 10px; font-size: 11px; cursor: pointer; border: 1px solid #444; background: #000; color: #aaa; transition: 0.2s; }
    .adm-act-btn:hover { border-color: #fff; color: #fff; }
    .admin-terminal { background: #000; border: 1px solid #333; height: 200px; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; color: #0f0; margin-top: 20px; }
    .log-line { margin-bottom: 4px; border-bottom: 1px dashed #222; padding-bottom: 2px; }
    .log-time { color: #666; margin-right: 10px; }
    #adminCamPreview { width: 100%; height: 200px; background: #000; border: 1px solid var(--neon-cyan); object-fit: cover; margin-top: 10px; border-radius: 4px; box-shadow: 0 0 15px rgba(0,243,255,0.1); }

    /* MANAGER DASH */
    #managerDash { flex: 1; padding: 30px; flex-direction: column; overflow-y: auto; gap: 20px; background: radial-gradient(circle at top, #111, #000); }
    .mgr-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 20px; }
    .mgr-title { font-size: 32px; font-family: var(--font-tech); color: #fff; text-shadow: 0 0 20px var(--neon-cyan); display:flex; align-items:center; }
    .mgr-filters { display: flex; gap: 10px; background: #111; padding: 10px; border-radius: 8px; border: 1px solid #333; align-items:center; }
    .mgr-btn { background: transparent; border: 1px solid #555; color: #aaa; padding: 10px 25px; font-family: var(--font-tech); cursor: pointer; transition: 0.3s; font-size: 14px; }
    .mgr-btn:hover { border-color: #fff; color: #fff; }
    .mgr-btn.active { background: var(--neon-cyan); color: #000; border-color: var(--neon-cyan); font-weight: bold; box-shadow: 0 0 20px rgba(0,243,255,0.3); }
    .mgr-connect-btn { margin-left: 20px; background: var(--neon-green); color: #000; border: 1px solid var(--neon-green); padding: 10px 20px; font-weight: bold; font-family: var(--font-tech); cursor: pointer; box-shadow: 0 0 15px rgba(10,255,0,0.3); transition: 0.3s; }
    .mgr-connect-btn:hover { background: #fff; border-color: #fff; box-shadow: 0 0 25px rgba(255,255,255,0.6); }
    .mgr-stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 20px; }
    .mgr-card { background: rgba(20,20,20,0.8); border: 1px solid #333; padding: 25px; border-radius: 12px; text-align: center; backdrop-filter: blur(10px); position: relative; overflow: hidden; }
    .mgr-card h3 { font-size: 14px; color: #888; margin: 0 0 10px 0; letter-spacing: 1px; }
    .mgr-card .val { font-size: 48px; font-weight: bold; font-family: var(--font-tech); color: #fff; }
    .mgr-content-grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; flex: 1; min-height: 400px; margin-top: 20px; }
    .mgr-panel { background: #0a0a0a; border: 1px solid #333; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; }
    .mgr-panel h4 { margin: 0 0 20px 0; color: var(--neon-gold); font-family: var(--font-tech); border-bottom: 1px solid #222; padding-bottom: 10px; }
    .data-table { width: 100%; border-collapse: collapse; font-size: 13px; color: #ccc; font-family: var(--font-tech); }
    .data-table th { text-align: left; padding: 10px; background: #151515; color: #888; border-bottom: 1px solid #444; position: sticky; top: 0; }
    .data-table td { padding: 10px; border-bottom: 1px solid #222; }
    .data-table tr:hover { background: rgba(255,255,255,0.05); }

    /* SELECTABLE SN STYLE */
    .selectable-text { user-select: text !important; cursor: pointer; transition: 0.2s; }
    .selectable-text:hover { color: var(--neon-cyan); text-shadow: 0 0 5px var(--neon-cyan); }

    /* FOLDER BTN STYLE */
    .folder-btn { background: transparent; border: 1px solid #555; color: var(--neon-cyan); padding: 5px 10px; border-radius: 4px; text-decoration: none; font-size: 11px; font-family: var(--font-tech); transition: 0.2s; cursor: pointer; display: inline-block; }
    .folder-btn:hover { background: var(--neon-cyan); color: #000; box-shadow: 0 0 10px var(--neon-cyan); }
    
    /* RMA ACTION BUTTONS */
    .rma-btn { background: #222; border: 1px solid #555; color: #fff; padding: 3px 8px; font-size: 10px; font-family: var(--font-tech); cursor: pointer; margin-right: 5px; transition: 0.2s; border-radius: 3px; }
    .rma-btn:hover { border-color: var(--neon-orange); color: var(--neon-orange); }
    .rma-btn.active { background: var(--neon-orange); color: #000; border-color: var(--neon-orange); font-weight: bold; }

    /* CAM & UI */
    .video-container { width: 100%; height: 100%; overflow: hidden; position: relative; display: flex; justify-content: center; align-items: center; }
    video { width: 100%; height: 100%; object-fit: contain; transition: transform 0.1s linear; transform-origin: center center; }
    #drawCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 60; cursor: crosshair; display: none; }
    .draw-toolbar { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100; display: none; background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 30px; border: 1px solid var(--neon-cyan); backdrop-filter: blur(5px); }
    .color-btn { width: 25px; height: 25px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; display: inline-block; margin: 0 5px; }
    .tool-btn { background: transparent; border: 1px solid #aaa; color: #fff; padding: 5px 12px; cursor: pointer; font-family: var(--font-tech); font-size: 12px; margin-left: 10px; border-radius: 4px; }
    .tool-btn.confirm { background: var(--neon-cyan); color: #000; border-color: var(--neon-cyan); font-weight: bold; }
    .cam-controls { position: absolute; bottom: 20px; right: 20px; z-index: 50; display: flex; gap: 15px; align-items: center; background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 30px; border: 1px solid #333; backdrop-filter: blur(5px); }
    .cam-btn { background: transparent; border: 1px solid var(--neon-cyan); color: var(--neon-cyan); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; transition: 0.2s; }
    .cam-btn:hover { background: var(--neon-cyan); color: #000; }
    .zoom-group { display: flex; align-items: center; gap: 10px; font-family: var(--font-tech); font-size: 12px; color: var(--neon-cyan); }
    input[type=range] { -webkit-appearance: none; width: 100px; height: 4px; background: #333; border-radius: 2px; outline: none; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--neon-cyan); cursor: pointer; box-shadow: 0 0 10px var(--neon-cyan); }
    .input-label { font-size: 11px; color: var(--neon-cyan); letter-spacing: 1px; margin-bottom: 5px; display: block; font-weight: bold; font-family: var(--font-tech); }
    #scanInput { width: 100%; background: #080808; border: 1px solid #444; color: #fff; padding: 12px; font-size: 22px; text-align: center; font-family: var(--font-tech); outline: none; border-radius: 6px; margin-bottom: 15px; }
    #scanInput:disabled { background: #111; color: #333; border-color: #222; cursor: not-allowed; }
    #scanInput:focus { border-color: var(--neon-cyan); box-shadow: 0 0 20px rgba(0, 243, 255, 0.2); }
    .checklist-btn { width: 100%; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); color: #888; padding: 12px; margin-bottom: 8px; cursor: pointer; text-align: left; font-family: var(--font-ui); display: flex; justify-content: space-between; transition: 0.2s; font-size: 14px; border-radius: 6px; font-weight: 500; }
    .checklist-btn:hover { background: rgba(255,255,255,0.05); color: #fff; border-color: #fff; }
    .checklist-btn.done { border-color: var(--neon-green); color: var(--neon-green); background: rgba(10,255,0,0.1); font-weight: 700; }
    .decision-panel { border-top: 1px solid #333; margin-top: 10px; padding-top: 15px; }
    .custom-select { width: 100%; background: #080808; color: #fff; border: 1px solid var(--neon-purple); padding: 10px; font-family: var(--font-tech); font-size: 14px; border-radius: 5px; outline: none; cursor: pointer; margin-bottom: 10px; }
    .custom-textarea { width: 100%; background: #080808; color: #ccc; border: 1px solid #444; padding: 10px; font-family: var(--font-ui); font-size: 14px; border-radius: 5px; outline: none; resize: vertical; margin-bottom: 10px; }
    .custom-textarea:focus { border-color: var(--neon-cyan); color: #fff; }
    #actionBtn { margin-top: auto; padding: 15px; width: 100%; background: #111; color: #444; font-weight: bold; border: none; font-size: 16px; cursor: not-allowed; border-radius: 6px; text-transform: uppercase; letter-spacing: 1px; font-family: var(--font-tech); }
    #actionBtn.active { background: var(--neon-green); color: #000; cursor: pointer; animation: pulseBtn 2s infinite; box-shadow: 0 0 20px var(--neon-green); }
    @keyframes pulseBtn { 0% { box-shadow: 0 0 10px var(--neon-green); } 50% { box-shadow: 0 0 30px var(--neon-green); } 100% { box-shadow: 0 0 10px var(--neon-green); } }
    .bar-bottom { position: fixed; bottom: 0; left: 0; width: 100%; height: 40px; background: #080808; border-top: 1px solid #333; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; z-index: 100; }
    .bar-group { display: flex; gap: 10px; }
    .bar-btn { background: transparent; border: 1px solid #444; color: #aaa; padding: 5px 15px; font-family: var(--font-tech); font-size: 11px; cursor: pointer; transition: 0.2s; }
    .bar-btn:hover { border-color: var(--neon-cyan); color: var(--neon-cyan); }
    .bar-btn.admin-only { border-color: var(--neon-gold); color: var(--neon-gold); display: none; }
    .quick-defects { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
    .defect-tag { font-family: var(--font-tech); font-size: 11px; padding: 4px 8px; border: 1px solid #444; color: #888; border-radius: 4px; cursor: pointer; transition: 0.2s; }
    .defect-tag:hover { border-color: var(--neon-cyan); color: var(--neon-cyan); }
    .recent-list { margin-top: 15px; border-top: 1px solid #333; padding-top: 10px; max-height: 100px; overflow-y: auto; }
    .recent-item { display: flex; justify-content: space-between; font-size: 12px; color: #666; padding: 4px 0; border-bottom: 1px dashed #222; }
    .recent-item span:last-child { font-weight: bold; }
    .op-connect-btn { width: 100%; padding: 12px; background: var(--neon-cyan); color: #000; font-weight: bold; border: none; font-family: var(--font-tech); cursor: pointer; border-radius: 6px; margin-bottom: 15px; box-shadow: 0 0 15px rgba(0, 243, 255, 0.3); transition: 0.3s; }
    .op-connect-btn:hover { background: #fff; box-shadow: 0 0 25px rgba(0, 243, 255, 0.6); }
    .slide-panel { position: fixed; bottom: 0; left: 0; width: 100%; height: 0; background: rgba(10, 12, 16, 0.98); z-index: 200; transition: height 0.5s cubic-bezier(0.25, 1, 0.5, 1); overflow: hidden; border-top: 2px solid var(--neon-cyan); display: flex; flex-direction: column; }
    .slide-panel.open { height: 85vh; }
    .panel-header { padding: 20px; background: #000; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
    .panel-content { flex: 1; overflow: auto; padding: 30px; }
    .op-stats-row { display: flex; gap: 10px; margin-bottom: 20px; }
    .op-stat-box { flex: 1; background: #111; border: 1px solid #333; padding: 10px; text-align: center; border-radius: 6px; }
    .op-stat-num { font-size: 24px; font-weight: bold; color: #fff; font-family: var(--font-tech); }
    .op-stat-lbl { font-size: 10px; color: #888; }
    #qrPopup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; color: #000; padding: 30px; border-radius: 10px; z-index: 500; text-align: center; display: none; box-shadow: 0 0 100px rgba(0,0,0,1); border: 5px solid var(--neon-cyan); }
    #qrCodeBox { margin: 20px auto; }
    #printLabel { display: none; }
    @media print {
        @page { size: auto; margin: 0mm; }
        body * { visibility: hidden; } 
        #printLabel, #printLabel * { visibility: visible; }
        #printLabel { position: absolute; left: 0; top: 0; width: 150mm; height: 150mm; display: flex !important; flex-direction: column; justify-content: space-between; align-items: center; border: 2px solid #000; background: white; color: black; font-family: 'Roboto', sans-serif; padding: 10mm; box-sizing: border-box; z-index: 9999; }
        .pl-header { font-size: 24pt; font-weight: bold; border-bottom: 2px solid #000; width: 100%; text-align: center; padding-bottom: 5mm; }
        .pl-qr { margin: 5mm 0; }
        .pl-info { width: 100%; text-align: left; font-size: 14pt; line-height: 1.5; }
        .pl-footer { font-size: 10pt; width: 100%; text-align: center; border-top: 1px solid #000; padding-top: 2mm; margin-top: auto; }
        #qrPopup { display: none !important; }
    }
    canvas { display: none; }
    #patternOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 99999; display: none; cursor: pointer; }
    /* --- MODU≈Å FFL (JAKO≈öƒÜ I ANALIZA) --- */
    body.mode-ffl .dashboard { display: none !important; }
    body.mode-ffl #fflDash { display: flex !important; }
    
    #fflDash { display: none; flex: 1; padding: 30px; gap: 20px; overflow: hidden; height: calc(100vh - 70px); }
    
    .ffl-left-panel { flex: 0 0 420px; background: rgba(15, 10, 20, 0.95); border: 1px solid var(--neon-purple); border-radius: 12px; padding: 25px; display: flex; flex-direction: column; overflow-y: auto; box-shadow: 0 0 40px rgba(188, 19, 254, 0.1); }
    .ffl-right-panel { flex: 1; display: flex; flex-direction: column; gap: 20px; overflow: hidden; }
    
    .ffl-header { font-family: var(--font-tech); color: var(--neon-purple); font-size: 26px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #333; text-align: center; text-shadow: 0 0 15px rgba(188, 19, 254, 0.4); }
    
    .ffl-label { font-size: 11px; color: #aaa; font-family: var(--font-tech); display: block; margin-bottom: 8px; font-weight: bold; }
    .ffl-input { width: 100%; padding: 15px; background: #050505; border: 1px solid #444; color: #fff; font-family: var(--font-tech); font-size: 18px; border-radius: 6px; outline: none; transition: 0.3s; text-align: center; }
    .ffl-input:focus { border-color: var(--neon-purple); box-shadow: 0 0 20px rgba(188, 19, 254, 0.2); }
    
    .ffl-fixed-status { background: rgba(188, 19, 254, 0.1); padding: 15px; border: 1px solid var(--neon-purple); color: var(--neon-purple); font-weight: bold; text-align: center; font-family: var(--font-tech); border-radius: 6px; font-size: 18px; }
    
    .ffl-camera-box { flex: 1; background: #000; border: 2px solid #333; border-radius: 12px; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center; }
    .ffl-camera-box video { width: 100%; height: 100%; object-fit: contain; }
    
    .ffl-upload-zone { position: relative; border: 1px dashed #666; background: #111; padding: 15px; text-align: center; border-radius: 6px; margin-top: 10px; cursor: pointer; transition: 0.3s; }
    .ffl-upload-zone:hover { border-color: var(--neon-purple); background: rgba(188, 19, 254, 0.05); }
    .ffl-upload-zone input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
    
    .ffl-btn { width: 100%; padding: 18px; background: var(--neon-purple); color: #fff; font-weight: bold; border: none; font-family: var(--font-tech); cursor: pointer; border-radius: 6px; font-size: 16px; transition: 0.3s; margin-top: auto; }
    .ffl-btn:hover { background: #d05eff; box-shadow: 0 0 25px var(--neon-purple); }
    
    .ffl-list-box { flex: 1; background: rgba(20, 20, 20, 0.8); border: 1px solid #333; border-radius: 12px; padding: 20px; overflow-y: auto; }
    .ffl-table { width: 100%; border-collapse: collapse; font-family: var(--font-tech); font-size: 13px; }
    .ffl-table th { text-align: left; color: var(--neon-purple); border-bottom: 1px solid #444; padding: 12px; background: #111; position: sticky; top: 0; }
    .ffl-table td { padding: 12px; border-bottom: 1px solid #222; color: #ccc; }
  </style>
</head>
<body>

<div id="patternOverlay" onclick="nextPattern()"></div>

<div id="printLabel">
    <div class="pl-header">TPV OLED SERVICE</div>
    <div id="printQrCode" class="pl-qr"></div>
    <div class="pl-info">
        <div><strong>SN:</strong> <span id="plSN">---</span></div>
        <div><strong>DATA:</strong> <span id="plDate">---</span></div>
        <div><strong>OPERATOR:</strong> <span id="plOp">---</span></div>
        <div><strong>STATUS:</strong> <span id="plStatus" style="font-weight:bold; font-size:20pt;">---</span></div>
    </div>
    <div class="pl-footer">OLED REPAIR SYSTEM v1.1 - By ≈Åukasz Gruszczy≈Ñski</div>
</div>

<div id="loginScreen">
  <div class="login-box">
    <h2 style="color:#fff;">OLED REPAIR SYSTEM</h2>
    <div style="font-size:12px; color:#666; font-family: var(--font-tech);">v1.3 (RMA LEADER + COPY)</div>
    <div id="syncStatus" class="sync-status">≈Åadowanie u≈ºytkownik√≥w...</div>
    
    <label class="input-label" style="text-align:left; margin-left:5px; margin-top:20px;">U≈ªYTKOWNIK</label>
    <input type="text" id="userInput" class="login-input" placeholder="LOGIN" autocomplete="off" oninput="this.value = this.value.toUpperCase()">
    <label class="input-label" style="text-align:left; margin-left:5px; color:var(--neon-red);">HAS≈ÅO</label>
    <input type="password" id="passInput" class="login-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    
    <div class="remember-me">
        <input type="checkbox" id="rememberCheck"> <label for="rememberCheck">ZAPAMIƒòTAJ MNIE</label>
    </div>

    <div id="loginError" class="login-error"></div>
    <button class="login-btn" onclick="attemptLogin()">ROZPOCZNIJ ZMIANƒò</button>
    <button class="quick-admin-btn" onclick="quickAdminLogin()">‚ö° SZYBKIE LOGOWANIE (ADMIN)</button>
  </div>
  
  <div class="emergency-reset" onclick="emergencyReset()">‚ö† RESET BAZY</div>
</div>

<div id="networkGuard">
  <div class="alert-box">
    <h1 style="color:var(--neon-red); margin:0;">‚ö†Ô∏è SYSTEM ROZ≈ÅƒÑCZONY ‚ö†Ô∏è</h1>
    <p style="font-size:16px; color:#ccc; margin:20px 0;">WYMAGANY DOSTƒòP DO FOLDERU SIECIOWEGO</p>
    <div class="input-label" style="color:#aaa;">CEL:</div>
    <div class="path-box" id="displayPath">...</div>
    <button class="guard-btn" onclick="connectNetwork()">üì° PO≈ÅƒÑCZ Z SERWEREM</button>
    <button class="offline-btn" onclick="startOfflineMode()">üìÇ PRACA OFFLINE (ZIP)</button>
  </div>
</div>

<header>
  <div class="brand">TPV <span>OLED</span> REPAIR STATION</div>
  <div class="operator-info">
    <button class="bar-btn" onclick="toggleFullScreen()" title="Kiosk Mode">‚õ∂</button>
    <div class="operator-badge" id="operatorBadge">---</div>
    <button class="logout-btn" onclick="logout()">WYLOGUJ</button>
    <div id="clockDisplay">00:00</div>
  </div>
</header>

<div id="motdBar">KOMUNIKAT: ---</div>

<div class="dashboard" id="mainDashboard">
  <aside class="panel-left">
    <button id="opConnectBtn" class="op-connect-btn" onclick="connectNetwork()">üì° PO≈ÅƒÑCZ Z SERWEREM</button>
    
    <div id="targetBox" class="target-box">
        <div class="target-header">
            <span>CEL DZIENNY (OK+NDF+OFFRS)</span>
            <span id="targetText">0 / 15</span>
        </div>
        <div class="progress-track">
            <div id="targetFill" class="progress-fill"></div>
        </div>
    </div>

    <div class="scene-container">
      <div class="tv-pivot" id="tv3d">
        <div class="tv-panel tv-front"></div>
        <div class="tv-panel tv-back">SERWIS</div>
      </div>
    </div>
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
        <span class="input-label">1. SN MODU≈ÅU (SET)</span>
        <span id="snCheck" style="display:none; color:#0aff00; font-weight:bold; margin-left:10px;">‚úÖ</span>
        <span id="sessionTimer" style="font-family:var(--font-tech); color:#666; font-size:12px; margin-left:auto;">‚è±Ô∏è 00:00</span>
    </div>
    <input type="text" id="scanInput" placeholder="NAJPIERW PO≈ÅƒÑCZ Z BAZƒÑ..." disabled oninput="this.value = this.value.toUpperCase()">

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
        <span class="input-label" style="color:var(--neon-green)">2. SN OC (SZK≈ÅO)</span>
        <span id="ocCheck" style="display:none; color:#0aff00; font-weight:bold; margin-left:10px;">‚úÖ</span>
    </div>
    <input type="text" id="scanInputOC" placeholder="OCZEKIWANIE NA SN MODU≈ÅU..." disabled 
           style="width: 100%; background: #080808; border: 1px solid #333; color: var(--neon-green); padding: 12px; font-size: 18px; text-align: center; font-family: var(--font-tech); outline: none; border-radius: 6px; margin-bottom: 15px;"
           oninput="this.value = this.value.toUpperCase()">

    <div id="scanStatusInfo" class="scan-status-info">NUMERY ZESKANOWANE POPRAWNIE</div>
    <button id="confirmIdentityBtn" class="confirm-identity-btn" onclick="confirmScanData()">‚úÖ ZATWIERD≈π DANE (OK)</button>

    <div id="checklist">
        <a href="https://docs.google.com/spreadsheets/d/10W03bvKlVFlIUcxsHkzP_v_13gtnYRBmnrrO0ujB1bU/edit?gid=661466938#gid=661466938" target="_blank" class="checklist-btn" style="border-color:var(--neon-purple); color:var(--neon-purple); text-decoration:none; display:flex; align-items:center;">
            <span>üìä GOOGLE SHEET</span> <span>üîó</span>
        </a>
        <div style="height:10px;"></div>
        <div id="btnFront" class="checklist-btn locked" onclick="capture('PRZOD')"><span>1. PRZ√ìD EKRANU</span> <span>üì∑</span></div>
        <div id="btnBack" class="checklist-btn locked" onclick="capture('TYL')"><span>2. TY≈Å (TABLICZKA)</span> <span>üì∑</span></div>
        <div id="btnImage" class="checklist-btn locked" onclick="capture('OBRAZ')"><span>3. TEST OBRAZU</span> <span>üì∑</span></div>
    </div>

    <div class="decision-panel">
      <span class="input-label" style="color:var(--neon-purple)">DECYZJA SERWISOWA</span>
      <select id="statusSelect" class="custom-select" onchange="checkOcRequirement(); saveRecoveryState();">
        <option value="OK">üü¢ OK (SPRAWNY)</option>
        <option value="NG">üî¥ NG (USZKODZONY)</option>
        <option value="NDF">üîµ NDF (BRAK WAD)</option>
        <option value="RMA_VF">üü† RMA_VF (ZWROT)</option>
        <option value="SCRAP">‚ö´ SCRAP (Z≈ÅOM)</option>
        <option value="OFFRS_OK">üü£ OFFRS OK</option>
      </select>
      
      <span class="input-label">KOMENTARZ / SZYBKIE WADY</span>
      <div class="quick-defects">
          <div class="defect-tag" onclick="addDefect('RYSA NA MATRYCY')">RYSA</div>
          <div class="defect-tag" onclick="addDefect('BAD PIXEL')">PIXEL</div>
          <div class="defect-tag" onclick="addDefect('PƒòKNIƒòCIE')">PƒòKNIƒòCIE</div>
          <div class="defect-tag" onclick="addDefect('LINIA PIONOWA')">LINIA |</div>
          <div class="defect-tag" onclick="addDefect('LINIA POZIOMA')">LINIA ‚Äî</div>
          <div class="defect-tag" onclick="addDefect('BRAK OBRAZU')">NO IMAGE</div>
      </div>
      
      <textarea id="commentInput" class="custom-textarea" rows="2" placeholder="Wpisz uwagi..." onkeyup="saveRecoveryState()"></textarea>
    </div>

    <div class="recent-list" id="recentList"></div>

    <button id="actionBtn" onclick="saveData()">OCZEKIWANIE</button>
    <div id="saveStatus" style="text-align:center; color:#666; margin-top:10px; font-size:11px; height:15px; font-family: var(--font-tech);"></div>
  </aside>

  <main class="panel-right" id="camContainer">
    <div class="cam-overlay">
      <div class="tag" id="tagSN">SN: ---</div>
      <div class="tag" id="tagOp">OP: ---</div>
    </div>
    <div class="draw-toolbar" id="drawToolbar">
      <span style="color:#fff; font-size:12px; margin-right:10px;">ZAZNACZ WADƒò:</span>
      <div class="color-btn" style="background:red;" onclick="setDrawColor('red')"></div>
      <div class="color-btn" style="background:#0aff00;" onclick="setDrawColor('#0aff00')"></div>
      <button class="tool-btn" onclick="clearDraw()">WYCZY≈öƒÜ</button>
      <button class="tool-btn confirm" onclick="confirmPhoto()">ZAPISZ</button>
      <button class="tool-btn" onclick="cancelPhoto()">ANULUJ</button>
    </div>
    <div class="cam-controls">
      <div class="zoom-group">
        <span>ZOOM</span>
        <input type="range" id="zoomSlider" min="1" max="4" step="0.1" value="1">
        <span id="zoomVal">1.0x</span>
      </div>
      <div style="width:1px; height:20px; background:#444; margin:0 5px;"></div>
      <div class="cam-btn" onclick="toggleMirror()" title="Odbicie lustrzane">‚Üî</div>
    </div>
    <div class="video-container">
        <video id="videoFeed" autoplay playsinline></video>
        <canvas id="drawCanvas"></canvas>
    </div>
  </main>
</div>

<div id="adminDash">
    <div class="admin-container">
        <div class="admin-status-bar">
            <div class="status-item"><div class="status-dot ok"></div> SYSTEM: ONLINE</div>
            <div class="status-item">VER: 1.3 RMA</div>
            <div class="status-item">CPU: <span id="simCpu">12%</span></div>
            <div class="status-item">MEM: <span id="simMem">2.4GB</span></div>
        </div>
        <div class="admin-grid">
            <div style="display:flex; flex-direction:column; gap:20px;">
                <div class="admin-panel-box highlight">
                    <div class="admin-h">
                        <span>ZARZƒÑDZANIE U≈ªYTKOWNIKAMI</span>
                        <span style="font-size:12px; color:#666;">EDYCJA / RESET HASE≈Å</span>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 100px; gap:10px; margin-bottom:15px;">
                      <input type="text" id="newLogin" placeholder="LOGIN" class="cfg-input" style="margin:0;" oninput="this.value = this.value.toUpperCase()">
                      <input type="text" id="newPass" placeholder="HAS≈ÅO" class="cfg-input" style="margin:0;">
                      <select id="newRole" class="cfg-input" style="margin:0; padding:10px; cursor:pointer;">
                        <option value="OPERATOR">OPERATOR</option>
                        <option value="KOORDYNATOR">KOORDYNATOR</option>
                        <option value="KIEROWNIK">KIEROWNIK</option>
                        <option value="RMA_LEADER">LIDER RMA</option>
                        <option value="ADMIN">ADMINISTRATOR</option>
                      </select>
                      <button onclick="addUser()" class="cfg-btn">DODAJ</button>
                    </div>
                    <div style="overflow-y:auto; max-height:250px; border:1px solid #333;">
                        <table class="adm-table" id="admUserTable">
                            <thead><tr><th>LOGIN</th><th>ROLA</th><th>AKCJE</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <button class="cfg-btn" style="margin-top:10px; width:100%; border-style:dashed;" onclick="backupUsers()">üíæ BACKUP U≈ªYTKOWNIK√ìW (JSON)</button>
                </div>
                <div class="admin-panel-box">
                    <div class="admin-h" style="margin-bottom:5px;">TERMINAL SYSTEMOWY</div>
                    <div class="admin-terminal" id="sysLog">
                        <div class="log-line"><span class="log-time">System:</span> Inicjalizacja v1.1...</div>
                        <div class="log-line"><span class="log-time">System:</span> Gotowy do pracy.</div>
                    </div>
                </div>
            </div>
            <div style="display:flex; flex-direction:column; gap:20px;">
                <div class="admin-panel-box" style="border-color:var(--neon-cyan);">
                    <div class="admin-h" style="color:var(--neon-cyan)">BAZA DANYCH</div>
                    <div style="font-size:12px; color:#aaa; margin-bottom:15px;">Po≈ÇƒÖcz, aby zarzƒÖdzaƒá plikami.</div>
                    <div style="display:flex; gap:10px;">
                        <button class="cfg-btn cyan" style="flex:1;" onclick="connectNetwork()">üì° PO≈ÅƒÑCZ</button>
                        <button class="cfg-btn cyan" style="flex:1;" onclick="switchToManagerReports()">üìä RAPORTY (TABELA)</button>
                    </div>
                </div>
                <div class="admin-panel-box">
                    <div class="admin-h">KONFIGURACJA</div>
                    <div class="input-label">≈öCIE≈ªKA SIECIOWA</div>
                    <input type="text" id="cfgPath" class="cfg-input" value="\\plgorfs001...">
                    <button class="cfg-btn" onclick="saveConfigPath()">ZAPISZ</button>
                    <div style="margin-top:15px;"></div>
                    <div class="input-label">WIADOMO≈öƒÜ DNIA</div>
                    <input type="text" id="cfgMotd" class="cfg-input" placeholder="Komunikat...">
                    <button class="cfg-btn" onclick="saveMotd()">WY≈öLIJ</button>
                </div>
                <div class="admin-panel-box">
                    <div class="admin-h" style="margin-bottom:5px;">PODGLƒÑD KAMERY</div>
                    <video id="adminCamPreview" autoplay playsinline muted></video>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="managerDash">
    <div class="mgr-header">
        <div class="mgr-title">
            </div>
        
        <div style="display:flex; align-items:center; gap:10px; background:#1a1a1a; padding:5px 15px; border-radius:30px; border:1px solid #444; margin-right:20px;">
            <span style="font-size:16px;">üîç</span>
            <input type="text" id="mgrSearchSn" placeholder="Szukaj SN..." 
                   style="background:transparent; border:none; color:#fff; font-family:var(--font-tech); font-size:14px; outline:none; width:150px; text-transform:uppercase;"
                   onkeyup="if(event.key === 'Enter') runManagerSearch()">
            <button class="mgr-btn" style="padding:5px 10px; font-size:11px;" onclick="runManagerSearch()">SZUKAJ</button>
        </div>
        <div class="mgr-filters">
            <button class="mgr-btn active" id="fToday" onclick="updateLeaderStats('TODAY')">DZISIAJ</button>
            <button class="mgr-btn" id="fYesterday" onclick="updateLeaderStats('YESTERDAY')">WCZORAJ</button>
            <button class="mgr-btn" id="fMonth" onclick="updateLeaderStats('MONTH')">TEN MIESIƒÑC</button>
            <button class="mgr-btn" id="fAll" onclick="updateLeaderStats('ALL')">CA≈ÅA HISTORIA</button>
            <div style="width:1px; background:#444; margin:0 10px;"></div>
            <button class="mgr-btn" onclick="fetchCloudflareData()">üîÑ OD≈öWIE≈ª (CLOUD)</button>
            <button class="mgr-btn" onclick="exportCSV()">üíæ CSV</button>
        </div>
    </div>
    <div class="mgr-stats-row">
        <div class="mgr-card" style="border-color:var(--neon-cyan)">
            <h3>ILO≈öƒÜ CA≈ÅKOWITA</h3>
            <div class="val" id="mgrTotal">0</div>
        </div>
        <div class="mgr-card" style="border-color:var(--neon-green)">
            <h3>STATUS OK</h3>
            <div class="val" id="mgrOK" style="color:var(--neon-green)">0</div>
        </div>
        <div class="mgr-card" style="border-color:var(--neon-red)">
            <h3>ODRZUTY (NG)</h3>
            <div class="val" id="mgrNG" style="color:var(--neon-red)">0</div>
        </div>
        <div class="mgr-card" style="border-color:var(--neon-orange)">
            <h3>YIELD %</h3>
            <div class="val" id="mgrYield">0%</div>
        </div>
    </div>
    <div class="mgr-content-grid">
        <div class="mgr-panel mgr-ranking-panel">
            <h4>RANKING OPERATOR√ìW</h4>
            <div style="overflow:auto;">
                <table class="data-table">
                    <thead><tr><th>OP</th><th>ILO≈öƒÜ</th><th>CEL</th><th>YIELD</th></tr></thead>
                    <tbody id="mgrRankBody"><tr><td colspan="4" style="text-align:center">Brak danych</td></tr></tbody>
                </table>
            </div>
        </div>
        <div class="mgr-panel">
            <h4>DZIENNIK ZDARZE≈É</h4>
            <div style="overflow:auto;">
                <table class="data-table">
                    <thead><tr><th>DATA</th><th>SN MODU≈ÅU</th><th>SN OC</th><th>OP</th><th>DECYZJA</th><th>UWAGI</th><th>AKCJA</th></tr></thead>
                    <tbody id="mgrLogBody"><tr><td colspan="7" style="text-align:center">Po≈ÇƒÖcz siƒô z serwerem, aby pobraƒá dane...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="bar-bottom">
  <div id="connStatus" style="color:#444; font-size:11px;">üî¥ OFFLINE</div>
  <div class="bar-group">
    <button class="bar-btn admin-only" onclick="alert('U≈ºyj Panelu Administratora')">üë• U≈ªYTKOWNICY</button>
    <button class="bar-btn" id="dbBtn" onclick="toggleReportPanel()">üìä MOJE WYNIKI</button>
  </div>
</div>

<div id="reportPanel" class="slide-panel">
  <div class="panel-header">
    <div style="font-size:20px; color:var(--neon-cyan); font-family: var(--font-tech);">MOJE DZISIEJSZE WYNIKI</div>
    <div>
        <button class="bar-btn" onclick="fetchCloudflareData()">üîÑ OD≈öWIE≈ª (CLOUD)</button>
        <button class="bar-btn" onclick="toggleReportPanel()">ZAMKNIJ X</button>
    </div>
  </div>
  <div class="panel-content">
    <div style="color:#888; text-align:center; font-size:14px; margin-bottom:20px;">
        Poni≈ºej znajdujƒÖ siƒô Twoje statystyki z bie≈ºƒÖcej zmiany. (Wymaga po≈ÇƒÖczenia z bazƒÖ)
    </div>
    <div class="op-stats-row">
        <div class="op-stat-box" style="border-color:var(--neon-cyan)">
            <div class="op-stat-num" id="opTotal">0</div>
            <div class="op-stat-lbl">ZROBIONE</div>
        </div>
        <div class="op-stat-box" style="border-color:var(--neon-green)">
            <div class="op-stat-num" id="opOK">0</div>
            <div class="op-stat-lbl">OK</div>
        </div>
        <div class="op-stat-box" style="border-color:var(--neon-red)">
            <div class="op-stat-num" id="opNG">0</div>
            <div class="op-stat-lbl">NG</div>
        </div>
        <div class="op-stat-box" style="border-color:var(--neon-orange)">
            <div class="op-stat-num" id="opYield">0%</div>
            <div class="op-stat-lbl">YIELD</div>
        </div>
    </div>
  </div>
</div>

<div id="qrPopup">
  <h2 style="font-family: var(--font-tech); margin-top:0;">OLED PASSPORT</h2>
  <div id="qrCodeBox"></div>
  <div id="qrSnDisplay" style="font-weight:bold; font-family:var(--font-tech);">SN: ---</div>
  <div id="qrStatusDisplay" style="color:green; margin-bottom:10px;">STATUS: OK</div>
  <button onclick="closeQr()" style="padding:10px 20px; background:#000; color:#fff; border:none; cursor:pointer;">ZAMKNIJ</button>
  <button onclick="window.print()" style="padding:10px 20px; background:var(--neon-cyan); color:#000; border:none; cursor:pointer;">DRUKUJ ETYKIETƒò</button>
</div>

<canvas id="photoCanvas"></canvas>

<div id="fflDash">
    <aside class="ffl-left-panel">
        <div class="ffl-header">ANALIZA FFL</div>
        
        <div style="margin-bottom: 15px;">
            <label class="ffl-label">1. SN MODU≈ÅU (SET)</label>
            <input type="text" id="fflSn" class="ffl-input" placeholder="SKANUJ SN..." oninput="this.value = this.value.toUpperCase()">
        </div>
        
        <div style="margin-bottom: 15px;">
            <label class="ffl-label">2. SN OC (SZK≈ÅO)</label>
            <input type="text" id="fflOc" class="ffl-input" placeholder="SKANUJ OC..." oninput="this.value = this.value.toUpperCase()">
        </div>

        <div style="margin-bottom: 15px;">
            <label class="ffl-label">STATUS DECYZJI</label>
            <div class="ffl-fixed-status">RMA DO VF</div>
        </div>
        
        <div style="margin-bottom: 15px;">
            <label class="ffl-label">DOKUMENTACJA (KAMERA / PLIKI)</label>
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <button class="bar-btn" onclick="fflCapture('PRZOD')" style="flex:1;">FOTO: PRZ√ìD</button>
                <button class="bar-btn" onclick="fflCapture('TYL')" style="flex:1;">FOTO: TY≈Å</button>
            </div>
            <div class="ffl-upload-zone">
                <span style="font-size:11px; color:#888;">üìÇ KLIKNIJ ABY WGRAƒÜ PLIKI RƒòCZNIE</span>
                <input type="file" id="fflFiles" multiple accept="image/*" onchange="fflHandleFiles(this)">
            </div>
            <div id="fflFileCount" style="font-size:11px; color:var(--neon-purple); margin-top:5px; text-align:center;">Wybrano zdjƒôƒá: 0</div>
        </div>

        <div style="margin-bottom: 15px;">
            <label class="ffl-label">UWAGI ANALITYCZNE</label>
            <textarea id="fflComment" class="custom-textarea" rows="3" placeholder="Wpisz opis wady..."></textarea>
        </div>

        <button class="ffl-btn" onclick="saveFFLData()">ZAPISZ DO VF</button>
    </aside>

    <main class="ffl-right-panel">
        <div class="ffl-camera-box">
             <video id="fflVideo" autoplay playsinline muted></video>
             <canvas id="fflCanvas" style="display:none;"></canvas>
        </div>
        
        <div class="ffl-list-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
                <span style="font-family:var(--font-tech); color:#fff;">DZIENNIK RMA DO VF (TYLKO FFL)</span>
                <button class="bar-btn" onclick="fetchCloudflareData()">üîÑ OD≈öWIE≈ª</button>
            </div>
            <table class="ffl-table">
                <thead><tr><th>DATA</th><th>SN</th><th>OC</th><th>UWAGI</th><th>PLIKI</th></tr></thead>
                <tbody id="fflTableBody"></tbody>
            </table>
        </div>
    </main>
</div>

<script>
  /* --- CONFIG --- */
  let CONFIG = {
    networkPath: String.raw`\\plgorfs001\pub\SERVICE\LCDR\LCDR\OLED OBM Panels\Zdjƒôcia z napraw OLED`,
    motd: "",
    loginUrl: "https://oledrepair.lukaszarmiajotpe.workers.dev/", 
    // ZAKTUALIZOWANY LINK CLOUDFLARE:
    reportUrl: "https://daneoled.lukaszarmiajotpe.workers.dev/", 
    defaultUsers: [] 
  };

  /* --- AUDIO SYSTEM --- */
  const SoundFX = {
    ctx: null,
    init: function() { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
    play: function(type) {
      if(!this.ctx) this.init();
      const osc = this.ctx.createOscillator();
      const gain = this.ctx.createGain();
      osc.connect(gain); gain.connect(this.ctx.destination);
      const now = this.ctx.currentTime;
      if(type === 'beep') {
        osc.type = 'sine'; osc.frequency.setValueAtTime(1200, now);
        gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.1);
        osc.start(now); osc.stop(now+0.1);
      } else if(type === 'error') {
        osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now+0.3);
        gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0.01, now+0.3);
        osc.start(now); osc.stop(now+0.3);
      } else if(type === 'shutter') {
        osc.type = 'square'; osc.frequency.setValueAtTime(800, now);
        gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now+0.05);
        osc.start(now); osc.stop(now+0.05);
      } else if(type === 'success') {
        osc.type = 'triangle'; osc.frequency.setValueAtTime(440, now); osc.frequency.setValueAtTime(554, now+0.1); osc.frequency.setValueAtTime(659, now+0.2); 
        gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.4);
        osc.start(now); osc.stop(now+0.4);
      }
    }
  };

  /* --- STATE --- */
  let users = [];
  let currentUser = null;
  let dirHandle = null;
  let currentSN = "";
  let currentOC = ""; 
  let isScanConfirmed = false;
  let photos = { PRZOD: null, TYL: null, OBRAZ: null };
  let isMirrored = false;
  let reportsCache = [];
  let leaderMode = 'TODAY'; 
  
  let isDrawing = false;
  let drawColor = "red";
  let tempPhotoType = "";
  let zoomLevel = 1.0;
  let panX = 0; let panY = 0;
  let isPanning = false; let startPanX = 0; let startPanY = 0;
  
  let sessionStartTime = null;
  let recentScans = [];

  /* --- INIT --- */
  window.onload = () => {
    loadConfig();
    loadUsers(); 
    loadUsersFromSheet(); 
    checkSavedLogin();
    checkRecovery();
    checkOcRequirement();
    
    document.getElementById('mainDashboard').style.display = 'none';
    document.getElementById('adminDash').style.display = 'none';
    document.getElementById('managerDash').style.display = 'none';
    
    if(CONFIG.motd) {
        document.getElementById('motdBar').style.display = 'block';
        document.getElementById('motdBar').innerText = "KOMUNIKAT: " + CONFIG.motd;
    }

    setInterval(() => {
        document.getElementById('clockDisplay').innerText = new Date().toLocaleTimeString().slice(0,5);
        if(currentUser && currentUser.role === 'ADMIN') {
            document.getElementById('simCpu').innerText = Math.floor(Math.random() * 15 + 5) + "%";
            document.getElementById('simMem').innerText = (Math.random() * 0.5 + 2.1).toFixed(1) + "GB";
        }
        updateSessionTimer(); 
    }, 1000);
    
    const c = document.getElementById('drawCanvas');
    c.addEventListener('mousedown', startDraw); c.addEventListener('mouseup', endDraw); c.addEventListener('mousemove', draw);
    c.addEventListener('touchstart', (e)=>{e.preventDefault(); startDraw(e.touches[0])});
    c.addEventListener('touchend', (e)=>{e.preventDefault(); endDraw()});
    c.addEventListener('touchmove', (e)=>{e.preventDefault(); draw(e.touches[0])});

    const slider = document.getElementById('zoomSlider');
    slider.addEventListener('input', (e) => { zoomLevel = parseFloat(e.target.value); applyTransform(); });

    const camContainer = document.getElementById('camContainer');
    camContainer.addEventListener('mousedown', (e) => {
        if(zoomLevel > 1 && !isDrawing && document.getElementById('drawCanvas').style.display === 'none') {
            isPanning = true; startPanX = e.clientX - panX; startPanY = e.clientY - panY;
            camContainer.style.cursor = 'grabbing';
        }
    });
    window.addEventListener('mouseup', () => { isPanning = false; camContainer.style.cursor = zoomLevel > 1 ? 'grab' : 'default'; });
    window.addEventListener('mousemove', (e) => {
        if(!isPanning) return; e.preventDefault();
        panX = e.clientX - startPanX; panY = e.clientY - startPanY;
        applyTransform();
    });
  };

  /* --- FUNKCJA SZYBKIEGO LOGOWANIA --- */
  function quickAdminLogin() {
      // Wpisujemy login
      document.getElementById('userInput').value = "ADMIN";
      // Czy≈õcimy pole has≈Ça na wypadek zapisanych danych
      document.getElementById('passInput').value = "";
      // Ustawiamy kursor w polu has≈Ça
      document.getElementById('passInput').focus();
      logSystem("U≈ºyto szybkiego logowania ADMIN (Has≈Ço wyczyszczone).");
  }

  function confirmScanData() {
      if(!currentSN || !currentOC) {
          alert("BRAKUJE NUMER√ìW SN LUB OC!");
          return;
      }
      isScanConfirmed = true;
      SoundFX.play('success');
      
      document.getElementById('confirmIdentityBtn').style.display = 'none';
      document.getElementById('scanStatusInfo').style.display = 'none';
      
      const btns = document.querySelectorAll('.checklist-btn');
      btns.forEach(btn => btn.classList.remove('locked'));
      
      logSystem(`Dane SN: ${currentSN} zatwierdzone przez operatora.`);
  }

  function updateSessionTimer() {
      if(!sessionStartTime || !currentSN) return;
      const now = new Date();
      const diff = Math.floor((now - sessionStartTime) / 1000);
      const m = Math.floor(diff / 60).toString().padStart(2, '0');
      const s = (diff % 60).toString().padStart(2, '0');
      document.getElementById('sessionTimer').innerText = `‚è±Ô∏è ${m}:${s}`;
  }

  function addDefect(text) {
      const field = document.getElementById('commentInput');
      if(field.value) field.value += ", " + text;
      else field.value = text;
      saveRecoveryState();
  }

  function logSystem(msg) {
      const term = document.getElementById('sysLog');
      if(!term) return;
      const time = new Date().toLocaleTimeString();
      const div = document.createElement('div');
      div.className = "log-line";
      div.innerHTML = `<span class="log-time">[${time}]</span> ${msg}`;
      term.appendChild(div);
      term.scrollTop = term.scrollHeight;
  }

  function applyTransform() {
    const v = document.getElementById('videoFeed');
    const mirrorFactor = isMirrored ? -1 : 1;
    v.style.transform = `scale(${zoomLevel * mirrorFactor}, ${zoomLevel}) translate(${panX / zoomLevel}px, ${panY / zoomLevel}px)`;
  }

  function loadConfig() {
      const savedPath = localStorage.getItem('oled_cfg_path');
      if(savedPath) CONFIG.networkPath = savedPath;
      const savedMotd = localStorage.getItem('oled_cfg_motd');
      if(savedMotd) CONFIG.motd = savedMotd;
      document.getElementById('displayPath').innerText = CONFIG.networkPath;
  }
  function saveConfigPath() {
      const v = document.getElementById('cfgPath').value.trim();
      if(v) { CONFIG.networkPath = v; localStorage.setItem('oled_cfg_path', v); alert("Zapisano!"); logSystem("Zmiana ≈õcie≈ºki sieciowej"); }
  }
  function saveMotd() {
      const v = document.getElementById('cfgMotd').value.trim();
      CONFIG.motd = v; localStorage.setItem('oled_cfg_motd', v); alert("Komunikat zapisany!"); logSystem("Aktualizacja MOTD");
  }

  function loadUsers() {
    const stored = localStorage.getItem('oled_users');
    if(stored) {
        users = JSON.parse(stored);
        if(users.length === 0) users = CONFIG.defaultUsers;
    } else {
        users = CONFIG.defaultUsers;
    }
  }

  async function loadUsersFromSheet() {
      if(!CONFIG.loginUrl) return;
      const statusEl = document.getElementById('syncStatus');
      statusEl.innerText = "Synchronizacja...";
      try {
          const res = await fetch(CONFIG.loginUrl, { method: "GET" });
          if(!res.ok) throw new Error("B≈ÇƒÖd sieci");
          const txt = await res.text();
          const rows = txt.split(/\r?\n/); 
          const newUsers = [];
          for(let i=1; i<rows.length; i++) {
              const row = rows[i];
              if(!row || row.trim() === '') continue;
              const cols = row.split(',');
              if(cols.length >= 3) {
                   const l = cols[0].replace(/^"|"$/g, '').trim().toUpperCase();
                   const p = cols[1].replace(/^"|"$/g, '').trim(); 
                   let r = cols[2].replace(/^"|"$/g, '').trim().toUpperCase();
                   if (r === 'ADMINISTRATOR') r = 'ADMIN';
                   if (r === 'OPERATOR') r = 'OPERATOR';
                   // Obs≈Çuga r√≥l RMA
                   if (r === 'LIDER RMA' || r === 'RMA LEADER' || r === 'RMA') r = 'RMA_LEADER';
                   
                   if(l && p && ['OPERATOR','ADMIN','KIEROWNIK','KOORDYNATOR', 'RMA_LEADER', 'FFL'].includes(r)) {
                       newUsers.push({login:l, pass:p, role:r});
                   }
              }
          }
          if(newUsers.length > 0) {
              users = newUsers;
              saveUsers();
              statusEl.innerText = "Zsynchronizowano!";
              statusEl.className = "sync-status ok";
              setTimeout(()=>{ if(statusEl) statusEl.innerText=""; }, 3000);
              if(currentUser && currentUser.role === 'ADMIN') renderAdminUserTable();
              logSystem("Baza u≈ºytkownik√≥w zaktualizowana.");
          }
      } catch(e) {
          statusEl.innerText = "B≈ÇƒÖd pobierania bazy";
          statusEl.className = "sync-status err";
      }
  }

  function saveUsers() { localStorage.setItem('oled_users', JSON.stringify(users)); if(currentUser && currentUser.role==='ADMIN') renderAdminUserTable(); }
  
  function checkSavedLogin() {
      const saved = localStorage.getItem('oled_saved_creds');
      if(saved) {
          try {
              const creds = JSON.parse(saved);
              document.getElementById('userInput').value = creds.login;
              document.getElementById('passInput').value = creds.pass;
              document.getElementById('rememberCheck').checked = true;
          } catch(e) {}
      }
  }

  function attemptLogin() {
    const l = document.getElementById('userInput').value.trim().toUpperCase();
    const p = document.getElementById('passInput').value.trim();
    const remember = document.getElementById('rememberCheck').checked;
    const u = users.find(user => user.login === l && user.pass === p);
    if (u) {
      currentUser = u;
      if(remember) localStorage.setItem('oled_saved_creds', JSON.stringify({login:l, pass:p}));
      else localStorage.removeItem('oled_saved_creds');
      logSystem(`Zalogowano: ${u.login}`);
      document.getElementById('loginScreen').style.opacity = '0';
      setTimeout(() => {
        document.getElementById('loginScreen').style.display = 'none';
        setupInterface();
        if(currentUser.role === 'ADMIN') {
            startAdminCamera();
            document.getElementById('cfgPath').value = CONFIG.networkPath;
            document.getElementById('cfgMotd').value = CONFIG.motd;
            renderAdminUserTable();
        } else if (currentUser.role === 'OPERATOR') {
            initCamera();
        }
        document.getElementById('mainDashboard').style.opacity = '1';
      }, 800);
    } else { 
      SoundFX.play('error');
      document.getElementById('loginError').innerText = "B≈ÅƒòDNY LOGIN LUB HAS≈ÅO"; 
    }
  }

  function logout() { 
      // DODANE: Podsumowanie przy wylogowaniu
      let summary = "";
      if(currentUser && currentUser.role === 'OPERATOR') {
          const total = document.getElementById('opTotal').innerText;
          summary = `\nZrobione dzisiaj: ${total} szt.`;
      }
      if(confirm(`Czy na pewno chcesz zako≈Ñczyƒá zmianƒô?${summary}`)) {
          location.reload(); 
      }
  }
  function emergencyReset() { if(confirm("Reset bazy?")) { localStorage.removeItem('oled_users'); location.reload(); } }

  function setupInterface() {
    const b = document.getElementById('operatorBadge');
    b.innerText = currentUser.login;
    document.getElementById('tagOp').innerText = "OP: " + currentUser.login;
    b.className = "operator-badge"; 
    document.body.className = "";
    document.getElementById('mainDashboard').style.display = 'none';
    document.getElementById('adminDash').style.display = 'none';
    document.getElementById('managerDash').style.display = 'none';

    // DODANE: Automatyczne pobieranie danych przy starcie
    fetchCloudflareData(); 
    // DODANE: Auto-refresh co 5 minut (300000 ms)
    setInterval(fetchCloudflareData, 300000);

    if(currentUser.role === 'KIEROWNIK' || currentUser.role === 'KOORDYNATOR' || currentUser.role === 'RMA_LEADER') {
        const mgrTitle = document.querySelector('.mgr-title');
        const btnHtml = '<button class="mgr-connect-btn" onclick="fetchCloudflareData()">üì° PO≈ÅƒÑCZ Z BAZƒÑ (CLOUD)</button>';
        
        if (currentUser.role === 'KOORDYNATOR') {
            b.classList.add('coord');
            document.body.classList.add('mode-manager', 'mode-coord'); 
            mgrTitle.innerHTML = 'PANEL KOORDYNATORA ' + btnHtml; 
        } else if (currentUser.role === 'RMA_LEADER') {
            b.classList.add('rma-leader');
            document.body.classList.add('mode-manager');
            mgrTitle.innerHTML = '<span style="color:var(--neon-orange)">PANEL LIDER RMA</span> ' + btnHtml;
        } else {
            b.classList.add('manager');
            document.body.classList.add('mode-manager');
            mgrTitle.innerHTML = 'PANEL KIEROWNIKA ' + btnHtml; 
        }
        document.getElementById('managerDash').style.display = 'flex';
    } else if(currentUser.role === 'ADMIN') {
        b.classList.add('admin');
        document.body.classList.add('mode-admin');
        document.getElementById('adminDash').style.display = 'flex';
    } else {
        document.getElementById('mainDashboard').style.display = 'grid';
        setTimeout(() => document.getElementById('mainDashboard').style.opacity = '1', 100);
    }
  }

  async function connectNetwork() {
    try {
      await navigator.clipboard.writeText(CONFIG.networkPath);
      alert("≈öcie≈ºka skopiowana. Wybierz folder docelowy.");
      dirHandle = await window.showDirectoryPicker();
      const statusEl = document.getElementById('connStatus');
      statusEl.innerHTML = "üü¢ ONLINE";
      statusEl.style.color = "var(--neon-green)";
      document.getElementById('scanInput').disabled = false;
      document.getElementById('scanInput').placeholder = "SKANUJ MODU≈Å...";
      document.getElementById('scanInput').focus();
      document.getElementById('networkGuard').style.display = 'none';
      if(currentUser.role === 'KIEROWNIK' || currentUser.role === 'KOORDYNATOR' || currentUser.role === 'RMA_LEADER') setTimeout(scanNetwork, 500); 
      if(currentUser.role === 'OPERATOR') { initCamera(); document.getElementById('scanInput').focus(); scanNetworkForOperator(); }
    } catch(e) { alert("Anulowano wyb√≥r folderu."); }
  }

  function startOfflineMode() { dirHandle = null; }

  async function scanNetwork() {
    if(!dirHandle) return;
    reportsCache = [];
    try {
      for await (const e of dirHandle.values()) {
        if(e.kind === 'directory') {
          const sn = e.name; 
          let op="---", dec="---", com="---", oc="---";
          let rawDateObj = null;
          try {
            const sub = await dirHandle.getDirectoryHandle(sn);
            for await (const f of sub.values()) {
              if(f.name.includes('RAPORT')) {
                const fl = await f.getFile(); const tx = await fl.text(); 
                rawDateObj = fl.lastModifiedDate;
                const mOp = tx.match(/OPERATOR: (.*)/); if(mOp) op=mOp[1];
                const mDec = tx.match(/DECYZJA: (.*)/); if(mDec) dec=mDec[1];
                const mCom = tx.match(/UWAGI: (.*)/); if(mCom) com=mCom[1];
                const mOc = tx.match(/OC SN:\s+(.*)/); if(mOc) oc=mOc[1];
              }
            }
          } catch(err){}
          reportsCache.push({rawDate: rawDateObj, sn, op, dec, com, oc});
        }
      }
    } catch(e) {}
  }

  async function scanNetworkForOperator() {
      if(!dirHandle) return;
      reportsCache = [];
      try {
          for await (const e of dirHandle.values()) {
            if(e.kind === 'directory') {
              const sn = e.name; 
              let op="---", dec="---";
              let rawDateObj = null;
              try {
                const sub = await dirHandle.getDirectoryHandle(sn);
                for await (const f of sub.values()) {
                  if(f.name.includes('RAPORT')) {
                    const fl = await f.getFile(); const tx = await fl.text(); 
                    rawDateObj = fl.lastModifiedDate;
                    const mOp = tx.match(/OPERATOR: (.*)/); if(mOp) op=mOp[1];
                    const mDec = tx.match(/DECYZJA: (.*)/); if(mDec) dec=mDec[1];
                  }
                }
              } catch(err){}
              reportsCache.push({rawDate: rawDateObj, sn, op, dec});
            }
          }
          calculateOperatorStats();
      } catch(e) {}
  }

  function calculateOperatorStats() {
      const today = new Date().toDateString();
      const myStats = reportsCache.filter(r => r.op === currentUser.login && r.rawDate && r.rawDate.toDateString() === today);
      let total = myStats.length, ok = 0, ng = 0;
      myStats.forEach(r => { if(['OK','OFFRS_OK','NDF'].includes(r.dec)) ok++; else ng++; });
      let yieldVal = total > 0 ? ((ok/total)*100).toFixed(1) : 0;
      document.getElementById('opTotal').innerText = total;
      document.getElementById('opOK').innerText = ok;
      document.getElementById('opNG').innerText = ng;
      document.getElementById('opYield').innerText = yieldVal + "%";

      // TARGET SYSTEM LOGIC FOR OPERATOR
      const DAILY_TARGET = 15;
      let progressPct = (ok / DAILY_TARGET) * 100;
      if(progressPct > 100) progressPct = 100;
      
      const targetFill = document.getElementById('targetFill');
      const targetText = document.getElementById('targetText');
      const targetBox = document.getElementById('targetBox');

      if(targetFill && targetText) {
          targetFill.style.width = progressPct + "%";
          targetText.innerText = `${ok} / ${DAILY_TARGET}`;
          if(ok >= DAILY_TARGET) {
              // DODANE: Efekt osiƒÖgniƒôcia celu
              targetText.style.color = "var(--neon-gold)";
              targetText.innerHTML = `${ok} / ${DAILY_TARGET} üèÜ`;
              targetBox.classList.add('reached');
          } else {
              targetBox.classList.remove('reached');
              targetText.style.color = "#888";
          }
      }
  }

async function initCamera() {
    if(currentUser.role !== 'OPERATOR') return;
    try {
        // ULTRA HD (4K) CONFIGURATION
        const constraints = { 
            video: { 
                width: { ideal: 3840 },  // Prosi o 4K
                height: { ideal: 2160 }, // Prosi o 4K
                aspectRatio: { ideal: 1.7777777778 }, // Preferuje format 16:9
                frameRate: { ideal: 30, max: 60 },    // P≈Çynno≈õƒá
                focusMode: "continuous" // Pr√≥ba wymuszenia ciƒÖg≈Çego autofocusa (je≈õli przeglƒÖdarka wspiera)
            } 
        };
        
        // Zatrzymujemy poprzednie strumienie, je≈õli istniejƒÖ
        const oldVideo = document.getElementById('videoFeed');
        if (oldVideo.srcObject) {
            oldVideo.srcObject.getTracks().forEach(track => track.stop());
        }

        const s = await navigator.mediaDevices.getUserMedia(constraints); 
        const video = document.getElementById('videoFeed');
        video.srcObject = s;
        video.play();
        
        // Weryfikacja i wy≈õwietlenie rzeczywistej rozdzielczo≈õci na ekranie
        const track = s.getVideoTracks()[0];
        const settings = track.getSettings();
        const actualRes = (settings.width || '???') + "x" + (settings.height || '???');
        
        console.log("Uruchomiono kamerƒô w rozdzielczo≈õci: " + actualRes);
        
        // Dodajemy informacjƒô o rozdzielczo≈õci obok suwaka Zoomu (dla pewno≈õci)
        const zoomValDisplay = document.getElementById('zoomVal');
        if(zoomValDisplay) {
            zoomValDisplay.innerHTML = `1.0x <span style="font-size:10px; color:var(--neon-gold)">[${actualRes}]</span>`;
        }

        // Pr√≥ba wymuszenia maksymalnych ustawie≈Ñ sprzƒôtowych
        try {
            await track.applyConstraints({ 
                advanced: [{ width: 3840, height: 2160 }, { focusMode: "continuous" }] 
            });
        } catch(err) {
            console.log("PrzeglƒÖdarka nie obs≈Çuguje zaawansowanych constraint√≥w, u≈ºywam standardowych.");
        }
        
    } catch(e) {
        console.warn("Kamera 4K niedostƒôpna lub b≈ÇƒÖd dostƒôpu. Pr√≥ba fallback...", e);
        try {
             // Fallback do standardowego HD je≈õli 4K zawiedzie
             const s2 = await navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 1920 }, height: { ideal: 1080 } } });
             const video = document.getElementById('videoFeed');
             video.srcObject = s2;
             video.play();
        } catch(err) {
            console.error("KRYTYCZNY B≈ÅƒÑD KAMERY:", err);
            alert("Nie uda≈Ço siƒô uruchomiƒá kamery. Sprawd≈∫ uprawnienia lub po≈ÇƒÖczenie USB.");
        }
    }
}

  function updatePhotoProgress() {
      if(photos.PRZOD) document.getElementById('btnFront').classList.add('done');
      if(photos.TYL) document.getElementById('btnBack').classList.add('done');
      if(photos.OBRAZ) document.getElementById('btnImage').classList.add('done');
      let count = 0;
      if(photos.PRZOD) count++; if(photos.TYL) count++; if(photos.OBRAZ) count++;
      const btn = document.getElementById('actionBtn');
      if(count === 3) { btn.innerText = "ZAPISZ DANE"; btn.classList.add('active'); } 
      else { btn.innerText = `OCZEKIWANIE (${count}/3)`; btn.classList.remove('active'); }
  }

  function startSession(sn) {
    currentSN = sn; currentOC = ""; isScanConfirmed = false;
    photos = { PRZOD: null, TYL: null, OBRAZ: null };
    document.getElementById('tagSN').innerText = "SN: " + sn;
    
    document.getElementById('scanStatusInfo').style.display = 'none';
    document.getElementById('confirmIdentityBtn').style.display = 'none';
    const btns = document.querySelectorAll('.checklist-btn');
    btns.forEach(btn => btn.classList.add('locked'));

    document.getElementById('scanInputOC').value = ""; 
    document.getElementById('scanInputOC').disabled = true;
    document.querySelectorAll('.checklist-btn').forEach(b => b.classList.remove('done'));
    document.getElementById('snCheck').style.display = 'none';
    document.getElementById('ocCheck').style.display = 'none';
    document.getElementById('actionBtn').innerText = "OCZEKIWANIE (0/3)";
    document.getElementById('actionBtn').classList.remove('active');
    document.getElementById('statusSelect').value = "OK";
    document.getElementById('commentInput').value = "";
    sessionStartTime = new Date();
  }

  function processPhoto() {
      const v = document.getElementById('videoFeed');
      const finalC = document.getElementById('photoCanvas'); 
      
      // Ustawiamy canvas dok≈Çadnie na rozmiar ≈∫r√≥d≈Ça wideo (bez skalowania CSS)
      finalC.width = v.videoWidth; 
      finalC.height = v.videoHeight;
      
      const ctx = finalC.getContext('2d');
      
      // WY≈ÅƒÑCZENIE WYG≈ÅADZANIA (Dla maksymalnej ostro≈õci pikseli)
      ctx.imageSmoothingEnabled = false; 

      // Obs≈Çuga lustra
      if(isMirrored) { 
          ctx.translate(finalC.width, 0); 
          ctx.scale(-1, 1); 
      }
      
      // Rysowanie wideo w pe≈Çnej rozdzielczo≈õci
      ctx.drawImage(v, 0, 0, finalC.width, finalC.height);

      // Reset transformacji dla rysunk√≥w i tekstu
      if(isMirrored) {
          ctx.setTransform(1, 0, 0, 1, 0, 0); 
      }
      
      // Rysowanie overlay (rysunk√≥w u≈ºytkownika)
      // Skalujemy rysunki z podglƒÖdu do pe≈Çnej rozdzielczo≈õci zdjƒôcia
      const drawC = document.getElementById('drawCanvas');
      ctx.drawImage(drawC, 0, 0, finalC.width, finalC.height);

      // WYPALANIE DANYCH RAPORTU NA ZDJƒòCIU (Skalowane dynamicznie do 4K)
      const now = new Date();
      const dateStr = now.toLocaleDateString() + " " + now.toLocaleTimeString();
      const op = currentUser ? currentUser.login : "---";
      const dec = document.getElementById('statusSelect').value;
      
      const lines = [
          `SN: ${currentSN}`,
          `OC: ${currentOC || "---"}`,
          `OP: ${op}`,
          `DEC: ${dec}`,
          `DATA: ${dateStr}`
      ];
      
      // Czcionka skalowana wzglƒôdem wysoko≈õci (np. dla 4K bƒôdzie wiƒôksza ni≈º dla HD)
      const fs = Math.floor(finalC.height / 35); 
      ctx.font = `bold ${fs}px Roboto`;
      ctx.fillStyle = "#0aff00";
      ctx.shadowColor = "black";
      ctx.shadowBlur = 4;
      ctx.shadowOffsetX = 2;
      ctx.shadowOffsetY = 2;
      
      let y = fs + 20;
      const x = 30;
      
      lines.forEach(line => {
          ctx.fillText(line, x, y);
          y += fs + 10;
      });

      // ZAPIS Z MAKSYMALNƒÑ JAKO≈öCIƒÑ (1.0 zamiast 0.9)
      finalC.toBlob(b => { 
          photos[tempPhotoType] = b; 
          updatePhotoProgress(); 
          cancelPhoto(); 
      }, 'image/jpeg', 1.0); 
  }

  function checkOcRequirement() {
      const decision = document.getElementById('statusSelect').value;
      const ocInput = document.getElementById('scanInputOC');
      if(['OK','RMA'].includes(decision)) {
          ocInput.placeholder = "‚ö†Ô∏è SKANUJ OC (WYMAGANE)";
          ocInput.style.borderColor = currentOC ? "var(--neon-green)" : "var(--neon-red)";
      } else {
          ocInput.placeholder = "OC OPCJONALNE";
          ocInput.style.borderColor = "#333";
      }
  }

  function capture(type) {
      if(!currentSN || !isScanConfirmed) { 
          alert("NAJPIERW ZESKANUJ SN, OC I ZATWIERD≈π DANE!"); 
          return; 
      }
      tempPhotoType = type;
      const dec = document.getElementById('statusSelect').value;
      if(['OK', 'NDF', 'OFFRS_OK'].includes(dec)) { processPhoto(); SoundFX.play('shutter'); return; }
      const v = document.getElementById('videoFeed'); v.pause();
      document.getElementById('drawToolbar').style.display='block';
      document.getElementById('drawCanvas').style.display='block';
      const c = document.getElementById('drawCanvas'); c.width=v.offsetWidth; c.height=v.offsetHeight;
      const ctx = c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);
  }

  function confirmPhoto() { processPhoto(); }
  function cancelPhoto() {
      document.getElementById('videoFeed').play();
      document.getElementById('drawToolbar').style.display='none';
      document.getElementById('drawCanvas').style.display='none';
  }

  document.getElementById('scanInput').addEventListener('keydown', e => {
    if(e.key==='Enter') {
      const v = e.target.value.trim().toUpperCase();
      if(v.length > 3 && (v.startsWith("TBV") || v.startsWith("TOV"))) { 
          SoundFX.play('beep'); startSession(v); saveRecoveryState();
          document.getElementById('snCheck').style.display = 'inline';
          document.getElementById('scanInputOC').disabled=false; 
          document.getElementById('scanInputOC').focus(); 
      } else {
          SoundFX.play('error');
          alert("B≈ÅƒòDNY SN! Numer musi zaczynaƒá siƒô od TBV lub TOV.");
      }
    }
  });

  document.getElementById('scanInputOC').addEventListener('keydown', e => {
    if(e.key==='Enter') {
        const v = e.target.value.trim().toUpperCase();
        if(v.length > 3) { 
            currentOC = v; SoundFX.play('beep'); 
            document.getElementById('ocCheck').style.display = 'inline';
            document.getElementById('scanStatusInfo').style.display = 'block';
            document.getElementById('confirmIdentityBtn').style.display = 'block';
            checkOcRequirement(); saveRecoveryState(); 
        } else {
            SoundFX.play('error');
            alert("B≈ÅƒòDNY OC! Numer musi mieƒá wiƒôcej ni≈º 3 znaki.");
        }
    }
  });

  function saveRecoveryState() {
      if(!currentSN) return;
      localStorage.setItem('oled_recovery', JSON.stringify({sn:currentSN, oc:currentOC, status:document.getElementById('statusSelect').value}));
      
      // DODANE: Resetowanie koloru ramki, gdy u≈ºytkownik wpisuje komentarz
      if(document.getElementById('commentInput').value.trim().length > 0) {
          document.getElementById('commentInput').style.borderColor = "#444";
      }
  }
  function checkRecovery() {
      const rec = JSON.parse(localStorage.getItem('oled_recovery'));
      if(rec && confirm(`Przywr√≥ciƒá sesjƒô SN: ${rec.sn}?`)) {
          startSession(rec.sn);
          if(rec.oc) { currentOC = rec.oc; document.getElementById('scanInputOC').value = rec.oc; document.getElementById('ocCheck').style.display = 'inline'; }
          document.getElementById('statusSelect').value = rec.status;
          document.getElementById('scanInputOC').disabled = false;
          if(currentSN && currentOC) { 
              document.getElementById('confirmIdentityBtn').style.display = 'block'; 
              document.getElementById('scanStatusInfo').style.display = 'block';
          }
      }
  }

  async function saveData() {
      if(!photos.PRZOD || !photos.TYL || !photos.OBRAZ) { alert("BRAK ZDJƒòƒÜ!"); return; }
      const dec = document.getElementById('statusSelect').value;
      if(['OK','RMA'].includes(dec) && !currentOC) return alert("BRAK OC!");

      // DODANE: Sprawdzanie czy komentarz jest uzupe≈Çniony
      const commentVal = document.getElementById('commentInput').value.trim();
      if(commentVal.length === 0) {
          alert("KOMENTARZ JEST OBOWIƒÑZKOWY!");
          const cBox = document.getElementById('commentInput');
          cBox.style.borderColor = "var(--neon-red)";
          cBox.focus();
          return;
      }

      document.getElementById('saveStatus').innerText = "ZAPISYWANIE...";

      const now = new Date();
      const timestamp = now.toLocaleDateString() + " " + now.toLocaleTimeString();

      const txt = `RAPORT\nDATA: ${timestamp}\nSN: ${currentSN}\nOC: ${currentOC}\nOP: ${currentUser.login}\nDEC: ${dec}`;
      if(dirHandle) {
          try {
              const d = await dirHandle.getDirectoryHandle(currentSN, {create:true});
              const h = await d.getFileHandle(`RAPORT_${currentSN}.txt`, {create:true});
              const w = await h.createWritable(); await w.write(txt); await w.close();
              const types = ['PRZOD', 'TYL', 'OBRAZ'];
              for (const type of types) {
                  const fh = await d.getFileHandle(`${currentSN}_${type}.jpg`, {create: true});
                  const wr = await fh.createWritable(); await wr.write(photos[type]); await wr.close();
              }
          } catch(e) {}
      }
      try {
          await fetch(CONFIG.reportUrl, {
              method: "POST", headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                  timestamp: timestamp,
                  sn: currentSN, 
                  oc: currentOC || "---", 
                  op: currentUser.login, 
                  dec: dec, 
                  com: document.getElementById('commentInput').value
              })
          });
      } catch(e) {}
      finishSave(dec);
  }

  function finishSave(dec) {
      recentScans.unshift({sn: currentSN, dec: dec});
      const qrb = document.getElementById('qrCodeBox'); qrb.innerHTML = "";
      new QRCode(qrb, `${currentSN}|${dec}`);
      document.getElementById('qrPopup').style.display='block';
      
      localStorage.removeItem('oled_recovery');
      
      setTimeout(() => {
          currentSN = ""; currentOC = ""; isScanConfirmed = false;
          photos = { PRZOD: null, TYL: null, OBRAZ: null };
          document.getElementById('scanInput').value = "";
          document.getElementById('scanInputOC').value = "";
          document.getElementById('scanInputOC').disabled = true;
          document.getElementById('commentInput').value = "";
          document.getElementById('statusSelect').value = "OK";
          document.getElementById('snCheck').style.display = 'none';
          document.getElementById('ocCheck').style.display = 'none';
          document.getElementById('tagSN').innerText = "SN: ---";
          document.querySelectorAll('.checklist-btn').forEach(btn => {
              btn.classList.add('locked');
              btn.classList.remove('done');
          });
          document.getElementById('actionBtn').classList.remove('active');
          document.getElementById('actionBtn').innerText = "OCZEKIWANIE (0/3)";
          document.getElementById('saveStatus').innerText = "";
          document.getElementById('scanInput').focus();
          scanNetworkForOperator();
      }, 1000); 
  }
  
  function closeQr() { document.getElementById('qrPopup').style.display='none'; }

  function startDraw(e) { isDrawing=true; draw(e); }
  function endDraw() { isDrawing=false; document.getElementById('drawCanvas').getContext('2d').beginPath(); }
  function draw(e) {
      if(!isDrawing) return;
      const ctx = document.getElementById('drawCanvas').getContext('2d');
      const rect = e.target.getBoundingClientRect();
      const x = e.clientX - rect.left, y = e.clientY - rect.top;
      ctx.lineWidth=5; ctx.strokeStyle=drawColor; ctx.lineTo(x,y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x,y);
  }
  function setDrawColor(c) { drawColor = c; }
  function clearDraw() { const c = document.getElementById('drawCanvas'); if(c) c.getContext('2d').clearRect(0, 0, c.width, c.height); }
  function togglePatterns() { document.getElementById('patternOverlay').style.display='block'; nextPattern(); }
  let pIdx=-1; const pats=['#fff','#f00','#0f0','#00f','#000'];
  function nextPattern() { pIdx++; if(pIdx>=pats.length){document.getElementById('patternOverlay').style.display='none';pIdx=-1;} else document.getElementById('patternOverlay').style.background=pats[pIdx]; }
  function toggleFullScreen() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
  function toggleReportPanel() { document.getElementById('reportPanel').classList.toggle('open'); }
  
  async function addUser() {
    const l = document.getElementById('newLogin').value.trim().toUpperCase(), p = document.getElementById('newPass').value.trim(), r = document.getElementById('newRole').value;
    if(l && p) { 
        users.push({login:l, pass:p, role:r}); saveUsers(); 
        try { await fetch(CONFIG.loginUrl, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({type: "ADD_USER", login: l, pass: p, role: r}) }); } catch(e) {}
    }
  }
  
  function renderAdminUserTable() {
      const tb = document.querySelector('#admUserTable tbody'); if(!tb) return;
      tb.innerHTML = "";
      users.forEach((u, i) => {
        let color = '#fff'; if(u.role === 'ADMIN') color = 'var(--neon-gold)';
        tb.innerHTML += `<tr><td>${u.login}</td><td style="color:${color}">${u.role}</td><td><button class="adm-act-btn" onclick="removeUser(${i})">X</button></td></tr>`;
      });
  }
  async function removeUser(idx) {
      const l = users[idx].login;
      try { await fetch(CONFIG.loginUrl, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({type: "REMOVE_USER", login: l}) }); } catch(e) {}
      users.splice(idx, 1); saveUsers();
  }
  async function startAdminCamera() { try { const s = await navigator.mediaDevices.getUserMedia({video:true}); document.getElementById('adminCamPreview').srcObject = s; } catch(e) {} }

  /* --- NEW FUNCTION: SWITCH TO MANAGER REPORTS --- */
  function switchToManagerReports() {
      document.getElementById('adminDash').style.display = 'none';
      document.getElementById('managerDash').style.display = 'flex';
      // Automatically show Monthly data for Admin view
      updateLeaderStats('MONTH');
  }

  /* --- MGR FILTER LOGIC --- */
  function updateLeaderStats(mode) {
      leaderMode = mode;
      const btns = document.querySelectorAll('.mgr-btn');
      btns.forEach(b => b.classList.remove('active'));
      
      if(mode==='TODAY') document.getElementById('fToday').classList.add('active');
      else if(mode==='YESTERDAY') document.getElementById('fYesterday').classList.add('active');
      else if(mode==='MONTH') document.getElementById('fMonth').classList.add('active');
      else document.getElementById('fAll').classList.add('active');

      updateManagerView();
  }

  /* --- NOWE FUNKCJE OBS≈ÅUGUJƒÑCE CLOUDFLARE --- */
  
  async function fetchCloudflareData() {
      // Wska≈∫niki ≈Çadowania
      const statusEl = document.getElementById('mgrLogBody');
      if(statusEl) statusEl.innerHTML = '<tr><td colspan="7" style="text-align:center; color:var(--neon-cyan)">üîÑ Pobieranie danych z chmury (Google Sheets)...</td></tr>';
      
      const connStatus = document.getElementById('connStatus');
      if(connStatus) {
         connStatus.innerHTML = "‚è≥ ≈ÅƒÑCZENIE...";
         connStatus.style.color = "var(--neon-orange)";
      }

      try {
          // 1. Pobieramy dane z Twojego Workera
          const res = await fetch(CONFIG.reportUrl, { method: "GET" });
          if(!res.ok) throw new Error("B≈ÇƒÖd sieci Cloudflare: " + res.status);
          
          const data = await res.json();
          
          // 2. Mapujemy dane na format aplikacji (reportsCache)
          // Zaktualizowano o pole 'rma_sub'
          reportsCache = data.map(item => ({
              rawDate: new Date(item.timestamp),
              sn: item.sn,
              oc: item.oc,
              op: item.op,
              dec: item.dec,
              com: item.com,
              rma_sub: item.rma_sub || null
          }));

          // 3. Od≈õwie≈ºamy widoki
          updateManagerView();       // Tabela Managera
          calculateOperatorStats();  // Statystyki Operatora

          // 4. Sukces
          if(connStatus) {
            connStatus.innerHTML = "üü¢ ONLINE (CLOUD)";
            connStatus.style.color = "var(--neon-green)";
          }

      } catch(e) {
          console.error(e);
          if(statusEl) statusEl.innerHTML = '<tr><td colspan="7" style="text-align:center; color:var(--neon-red)">‚ö†Ô∏è B≈ÇƒÖd po≈ÇƒÖczenia z bazƒÖ danych! Sprawd≈∫ internet.</td></tr>';
          if(connStatus) {
            connStatus.innerHTML = "üî¥ B≈ÅƒÑD SIECI";
            connStatus.style.color = "var(--neon-red)";
          }
      }
  }

  /* --- MANAGER SEARCH & PHOTOS LINK --- */

  function runManagerSearch() {
      const query = document.getElementById('mgrSearchSn').value.trim().toUpperCase();
      if(!query) {
          alert("Wpisz numer SN!");
          return;
      }
      
      // Wy≈ÇƒÖczamy aktywne filtry daty wizualnie
      document.querySelectorAll('.mgr-btn').forEach(b => b.classList.remove('active'));
      
      // Filtrujemy dane
      const results = reportsCache.filter(r => r.sn.includes(query) || (r.oc && r.oc.includes(query)));
      
      // Aktualizujemy tabelƒô przekazujƒÖc wyniki rƒôcznie
      updateManagerView(results);
  }

  // --- NOWA FUNKCJA ZMIANY STATUSU RMA ---
  async function setRmaStatus(sn, subStatus) {
      if(!confirm(`Czy na pewno oznaczyƒá ${sn} jako ${subStatus}?`)) return;

      // 1. Aktualizacja lokalna (dla natychmiastowego efektu)
      const record = reportsCache.find(r => r.sn === sn);
      if(record) {
          record.rma_sub = subStatus;
          updateManagerView(); // Od≈õwie≈º widok
      }

      // 2. Wys≈Çanie do bazy (Cloudflare)
      // Wymaga, aby Tw√≥j Worker obs≈Çugiwa≈Ç typ akcji 'UPDATE_RMA'. Je≈õli nie, dane zniknƒÖ po od≈õwie≈ºeniu.
      try {
          await fetch(CONFIG.reportUrl, {
              method: "POST", headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                  type: "UPDATE_RMA",
                  sn: sn,
                  rma_sub: subStatus,
                  op: currentUser.login
              })
          });
      } catch(e) {
          console.error("B≈ÇƒÖd zapisu statusu RMA:", e);
          alert("B≈ÇƒÖd zapisu online! Zmiana widoczna tylko lokalnie.");
      }
  }

  function updateManagerView(customData = null) {
      const tbody = document.getElementById('mgrLogBody');
      if(!tbody) return;
      tbody.innerHTML = "";
      
      let total = 0, ok = 0, ng = 0;

      // Je≈ºeli przekazano customData (wyniki wyszukiwania), u≈ºyj ich. 
      // W przeciwnym razie u≈ºyj standardowych filtr√≥w daty.
      let filteredData = [];

      if (customData) {
          filteredData = customData;
      } else {
          // Standardowa logika filtr√≥w (bez zmian)
          const today = new Date().toDateString();
          const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
          const yStr = yesterday.toDateString();
          const now = new Date();

          if(typeof leaderMode !== 'undefined') {
              if(leaderMode === 'TODAY') filteredData = reportsCache.filter(r => r.rawDate && r.rawDate.toDateString() === today);
              else if(leaderMode === 'YESTERDAY') filteredData = reportsCache.filter(r => r.rawDate && r.rawDate.toDateString() === yStr);
              else if(leaderMode === 'MONTH') filteredData = reportsCache.filter(r => r.rawDate && r.rawDate.getMonth() === now.getMonth() && r.rawDate.getFullYear() === now.getFullYear());
              else filteredData = reportsCache; // ALL
          }
      }

      // Generowanie tabeli z nowƒÖ kolumnƒÖ LINKU i RMA ACTION
      if(filteredData.length === 0) {
           tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">BRAK WYNIK√ìW</td></tr>';
           return;
      }

      const baseFolderPath = String.raw`\\plgorfs001\pub\SERVICE\LCDR\LCDR\OLED OBM Panels\Zdjƒôcia z napraw OLED`;
      const isRmaLeader = currentUser && currentUser.role === 'RMA_LEADER';

      filteredData.forEach(r => {
          const tr = document.createElement('tr');
          
          let colorStyle = '#ccc';
          let decText = r.dec;

          if(r.dec === 'OK' || r.dec === 'OFFRS_OK') colorStyle = 'var(--neon-green)';
          else if(r.dec === 'NG' || r.dec === 'RMA' || r.dec === 'SCRAP') colorStyle = 'var(--neon-red)';
          else if(r.dec === 'NDF') colorStyle = 'var(--neon-cyan)';

          // Logika wy≈õwietlania sub-statusu RMA
          if (r.dec === 'RMA' && r.rma_sub) {
              decText += ` <span style="color:var(--neon-orange)">(${r.rma_sub})</span>`;
          }

          // Tworzenie ≈õcie≈ºki do folderu
          const cleanPath = baseFolderPath + "\\" + r.sn;
          // Escapowanie slashy dla JS
          const jsPath = cleanPath.replace(/\\/g, '\\\\');

          // Budowanie kolumny akcji
          let actionHtml = `<a href="${cleanPath}" target="_blank" onclick="navigator.clipboard.writeText('${jsPath}'); alert('Skopiowano ≈õcie≈ºkƒô do schowka:\\n' + '${jsPath}');" class="folder-btn" title="Kopiuj ≈õcie≈ºkƒô do schowka">üìÇ</a>`;
          
          // Dodatkowe przyciski dla Lidera RMA
          if (isRmaLeader && r.dec === 'RMA') {
              const activeSid = r.rma_sub === 'SID' ? 'active' : '';
              const activeCid = r.rma_sub === 'CID' ? 'active' : '';
              const activeNdf = r.rma_sub === 'NDF' ? 'active' : '';
              
              actionHtml = `
                <div style="display:flex; align-items:center;">
                    <button class="rma-btn ${activeSid}" onclick="setRmaStatus('${r.sn}', 'SID')">SID</button>
                    <button class="rma-btn ${activeCid}" onclick="setRmaStatus('${r.sn}', 'CID')">CID</button>
                    <button class="rma-btn ${activeNdf}" onclick="setRmaStatus('${r.sn}', 'NDF')">NDF</button>
                    ${actionHtml}
                </div>
              `;
          }

          // TUTAJ ZMIANA - KLIKNIƒòCIE KOPIUJE SN I OC
          tr.innerHTML = `
            <td>${r.rawDate ? r.rawDate.toLocaleString() : '---'}</td>
            <td class="selectable-text" onclick="navigator.clipboard.writeText('${r.sn}'); alert('Skopiowano SN: ' + '${r.sn}')" title="Kliknij aby skopiowaƒá">${r.sn}</td>
            <td class="selectable-text" onclick="navigator.clipboard.writeText('${r.oc}'); alert('Skopiowano OC: ' + '${r.oc}')" title="Kliknij aby skopiowaƒá">${r.oc}</td>
            <td>${r.op}</td>
            <td style="color:${colorStyle}; font-weight:bold;">${decText}</td>
            <td style="font-size:11px; color:#888;">${r.com || ''}</td>
            <td>${actionHtml}</td>
          `;
          tbody.appendChild(tr);

          // Statystyki
          total++;
          if(['OK','OFFRS_OK','NDF'].includes(r.dec)) ok++; else ng++;
      });

      // Aktualizacja kafelk√≥w tylko je≈õli nie szukamy (≈ºeby nie psuƒá statystyk dnia wyszukiwaniem pojedynczego SN)
      if (!customData) {
          const mTotal = document.getElementById('mgrTotal'); if(mTotal) mTotal.innerText = total;
          const mOK = document.getElementById('mgrOK'); if(mOK) mOK.innerText = ok;
          const mNG = document.getElementById('mgrNG'); if(mNG) mNG.innerText = ng;
          const mYield = document.getElementById('mgrYield'); 
          if(mYield) mYield.innerText = total > 0 ? ((ok/total)*100).toFixed(1) + "%" : "0%";
          updateRankingTable(filteredData);
      }
  }

  function updateRankingTable(data) {
      const counts = {};
      data.forEach(r => {
          const op = r.op || "Nieznany";
          if(!counts[op]) counts[op] = {total:0, ok:0};
          counts[op].total++;
          // Tutaj ok oznacza wszystkie "dobre" statusy wliczane do targetu
          if(['OK', 'OFFRS_OK', 'NDF'].includes(r.dec)) counts[op].ok++;
      });

      const sortedOps = Object.keys(counts).sort((a,b) => counts[b].total - counts[a].total);
      const tbody = document.getElementById('mgrRankBody');
      if(!tbody) return;
      tbody.innerHTML = "";

      if(sortedOps.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">Brak danych</td></tr>';
          return;
      }

      sortedOps.forEach(op => {
          const stats = counts[op];
          const y = stats.total > 0 ? ((stats.ok / stats.total) * 100).toFixed(0) : 0;
          
          // Logic for Manager Target (0-15) based on filtered data (Today/Yesterday)
          const TARGET = 15;
          let tPct = (stats.ok / TARGET) * 100;
          if(tPct > 100) tPct = 100;

          // Display Logic for Month View vs Day View
          let targetDisplay = `${stats.ok} / ${TARGET}`;
          let barDisplay = `<div class="mini-target-track"><div class="mini-target-fill" style="width:${tPct}%"></div></div>`;
          
          if (leaderMode === 'MONTH' || leaderMode === 'ALL') {
              targetDisplay = `${stats.ok}`; // Just show total count for Month/All
              barDisplay = ""; // Hide daily target bar for monthly view
          }

          // Kolorowanie Yield
          let yColor = "#fff";
          if(y >= 90) yColor = "var(--neon-green)";
          else if(y < 80) yColor = "var(--neon-red)";

          tbody.innerHTML += `<tr>
            <td>
                ${op}
                ${barDisplay}
            </td>
            <td style="font-weight:bold;">${stats.total}</td>
            <td style="color:${tPct === 100 && leaderMode !== 'MONTH' ? 'var(--neon-gold)' : '#ccc'}">${targetDisplay}</td>
            <td style="color:${yColor}">${y}%</td>
          </tr>`;
      });
  }
/* --- FFL MODULE LOGIC --- */
let fflSessionPhotos = []; 

// Integracja z logowaniem: nadpisujemy funkcjƒô setupInterface dla FFL
const _origSetupInterface = setupInterface;
setupInterface = function() {
    if(currentUser && currentUser.role === 'FFL') {
        const badge = document.getElementById('operatorBadge');
        badge.innerText = currentUser.login;
        badge.style.borderColor = "var(--neon-purple)";
        badge.style.color = "var(--neon-purple)";
        
        document.body.className = "mode-ffl";
        document.getElementById('mainDashboard').style.display = 'none';
        document.getElementById('adminDash').style.display = 'none';
        document.getElementById('managerDash').style.display = 'none';
        document.getElementById('fflDash').style.display = 'flex';
        
        initFFLCamera();
        fetchCloudflareData(); 
    } else {
        _origSetupInterface();
    }
};

// Aktualizacja tabeli FFL po pobraniu danych z Cloudflare
const _origUpdateManagerView = updateManagerView;
updateManagerView = function(customData = null) {
    _origUpdateManagerView(customData);
    if(currentUser && currentUser.role === 'FFL') {
        const tbody = document.getElementById('fflTableBody');
        if(!tbody) return;
        
        // Filtrowanie: tylko status RMA_VF (dedykowany dla FFL)
        const fflData = reportsCache.filter(r => r.dec === "RMA_VF");
        tbody.innerHTML = fflData.length ? "" : '<tr><td colspan="5" style="text-align:center; padding:20px;">Brak wpis√≥w RMA DO VF</td></tr>';
        
        fflData.forEach(r => {
            const row = document.createElement('tr');
            const path = CONFIG.networkPath + "\\" + r.sn;
            row.innerHTML = `
                <td>${r.rawDate ? r.rawDate.toLocaleString() : '---'}</td>
                <td style="color:var(--neon-purple); font-weight:bold;">${r.sn}</td>
                <td>${r.oc || '---'}</td>
                <td style="font-size:11px; color:#888;">${r.com || ''}</td>
                <td><button class="folder-btn" onclick="navigator.clipboard.writeText('${path.replace(/\\/g, '\\\\')}'); alert('Skopiowano ≈õcie≈ºkƒô!');">üìÇ PATH</button></td>
            `;
            tbody.appendChild(row);
        });
    }
};

async function initFFLCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        document.getElementById('fflVideo').srcObject = stream;
    } catch(e) { console.error("FFL Camera Error:", e); }
}

function fflCapture(type) {
    const video = document.getElementById('fflVideo');
    const canvas = document.getElementById('fflCanvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);
    
    canvas.toBlob(blob => {
        blob.name = `FFL_${type}_${Date.now()}.jpg`;
        fflSessionPhotos.push(blob);
        document.getElementById('fflFileCount').innerText = `Wybrano zdjƒôƒá: ${fflSessionPhotos.length}`;
        SoundFX.play('shutter');
    }, 'image/jpeg', 0.9);
}

function fflHandleFiles(input) {
    if(input.files) {
        Array.from(input.files).forEach(file => fflSessionPhotos.push(file));
        document.getElementById('fflFileCount').innerText = `Wybrano zdjƒôƒá: ${fflSessionPhotos.length}`;
    }
}

async function saveFFLData() {
    const sn = document.getElementById('fflSn').value.trim();
    if(!sn || fflSessionPhotos.length === 0) return alert("B≈ÅƒÑD: Podaj SN i dodaj zdjƒôcia!");

    const statusBtn = document.querySelector('.ffl-btn');
    statusBtn.innerText = "ZAPISYWANIE...";
    
    const timestamp = new Date().toLocaleString();
    const comment = document.getElementById('fflComment').value;
    const oc = document.getElementById('fflOc').value;

    // 1. Zapis lokalny (je≈õli folder wybrany)
    if(dirHandle) {
        try {
            const folder = await dirHandle.getDirectoryHandle(sn, {create:true});
            const report = await folder.getFileHandle(`FFL_ANALYSIS.txt`, {create:true});
            const writer = await report.createWritable();
            await writer.write(`FFL ANALYSIS\nDATA: ${timestamp}\nSN: ${sn}\nOC: ${oc}\nOP: ${currentUser.login}\nUWAGI: ${comment}`);
            await writer.close();

            for(const [idx, file] of fflSessionPhotos.entries()) {
                const fh = await folder.getFileHandle(file.name || `FFL_PHOTO_${idx}.jpg`, {create:true});
                const fw = await fh.createWritable();
                await fw.write(file);
                await fw.close();
            }
        } catch(e) { console.warn("Local save failed", e); }
    }

    // 2. Wys≈Çanie do Cloudflare (z dedykowanym statusem RMA_VF)
    try {
        await fetch(CONFIG.reportUrl, {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                timestamp: timestamp, sn: sn, oc: oc || "---",
                op: currentUser.login, dec: "RMA_VF", com: comment
            })
        });
        SoundFX.play('success');
        alert("Zapisano pomy≈õlnie status RMA DO VF");
        
        // Reset formularza
        document.getElementById('fflSn').value = "";
        document.getElementById('fflOc').value = "";
        document.getElementById('fflComment').value = "";
        fflSessionPhotos = [];
        document.getElementById('fflFileCount').innerText = "Wybrano zdjƒôƒá: 0";
        fetchCloudflareData();
    } catch(e) { alert("B≈ÇƒÖd wysy≈Çania do bazy danych!"); }
    statusBtn.innerText = "ZAPISZ DO VF";
}
  
</script>
</body>
</html>
