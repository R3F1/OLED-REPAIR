<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>OLED REPAIR v12.9 (ULTIMATE)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap&subset=latin-ext" rel="stylesheet">
  
  <style>
    /* --- CONFIG & VARIABLES --- */
    :root {
      --bg-deep: #050505;
      --panel-glass: rgba(20, 25, 35, 0.95);
      --neon-cyan: #00f3ff;
      --neon-green: #0aff00;
      --neon-red: #ff003c;
      --neon-gold: #ffd700;
      --neon-purple: #bc13fe;
      --neon-orange: #ff9d00;
      
      --font-ui: 'Roboto', sans-serif;
      --font-tech: 'Oxanium', cursive;
    }
    
    * { box-sizing: border-box; user-select: none; }
    
    body {
      margin: 0; background-color: var(--bg-deep); color: #fff;
      font-family: var(--font-ui); height: 100vh; overflow: hidden;
      display: flex; flex-direction: column;
      background-image: 
        linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
    }

    /* --- LOGIN SCREEN --- */
    #loginScreen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999;
      display: flex; align-items: center; justify-content: center; flex-direction: column; transition: opacity 0.8s;
    }
    .login-box {
      width: 450px; padding: 40px; background: rgba(10, 10, 10, 0.95); border: 1px solid var(--neon-cyan);
      text-align: center; border-radius: 12px; position: relative; overflow: hidden;
      box-shadow: 0 0 60px rgba(0, 243, 255, 0.1); backdrop-filter: blur(10px);
    }
    .login-box h2 { font-family: var(--font-tech); font-weight: 700; letter-spacing: 1px; margin-bottom: 5px; }
    .login-input {
      width: 100%; padding: 15px; margin: 10px 0; background: #080808; border: 1px solid #333; color: var(--neon-cyan);
      font-family: var(--font-tech); font-size: 18px; text-align: center; outline: none; transition: 0.3s;
    }
    .login-input:focus { border-color: var(--neon-cyan); background: #111; }
    input[type="password"] { letter-spacing: 5px; color: var(--neon-red); }
    .login-btn {
      width: 100%; padding: 15px; margin-top: 20px; background: var(--neon-cyan); color: #000; font-weight: bold; border: none;
      cursor: pointer; font-family: var(--font-tech); transition: 0.3s; font-size: 16px; letter-spacing: 2px;
    }
    .login-btn:hover { background: #fff; box-shadow: 0 0 30px var(--neon-cyan); }
    .login-error { color: var(--neon-red); font-size: 12px; height: 20px; margin-top: 10px; font-weight: bold; font-family: var(--font-ui); }

    /* Checkbox Style */
    .remember-me {
        display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; font-size: 14px; color: #aaa;
    }
    .remember-me input { transform: scale(1.5); accent-color: var(--neon-cyan); cursor: pointer; }

    /* --- NETWORK GUARD --- */
    #networkGuard {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.95); z-index: 8000; backdrop-filter: blur(15px);
      display: none; align-items: center; justify-content: center; flex-direction: column;
    }
    .alert-box {
      width: 600px; padding: 40px; border: 2px solid var(--neon-red); background: #050505;
      text-align: center; border-radius: 12px; box-shadow: 0 0 100px rgba(255, 0, 60, 0.2);
    }
    .path-box {
      background:#111; padding:15px; border:1px dashed #555; font-size:12px; color:#fff; 
      font-family:var(--font-tech); margin-top: 5px; word-break: break-all;
    }
    .guard-btn {
      width: 100%; padding: 20px; background: var(--neon-red); color: #fff; font-weight: bold;
      border: none; cursor: pointer; font-family: var(--font-tech); font-size: 18px; margin-top: 20px;
    }
    .offline-btn {
        width: 100%; padding: 15px; background: transparent; color: var(--neon-orange); border: 1px solid var(--neon-orange);
        font-family: var(--font-tech); cursor: pointer; margin-top: 10px; font-weight: bold; transition: 0.3s;
    }
    .offline-btn:hover { background: var(--neon-orange); color: #000; }

    /* --- HEADER --- */
    header {
      height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 30px;
      background: rgba(0,0,0,0.8); border-bottom: 1px solid #333;
    }
    .brand { font-family: var(--font-tech); font-size: 28px; font-weight: 700; color: #fff; letter-spacing: 2px; }
    .brand span { color: var(--neon-cyan); text-shadow: 0 0 10px var(--neon-cyan); }
    .operator-info { display: flex; align-items: center; gap: 20px; font-family: var(--font-tech); color: #aaa; font-size: 14px; }
    
    .operator-badge { background: #1a1a1a; padding: 6px 15px; border-radius: 4px; border: 1px solid #444; color: var(--neon-cyan); transition:0.3s; font-weight: bold; }
    .operator-badge.admin { border-color: var(--neon-gold); color: var(--neon-gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.1); }
    .operator-badge.coord { border-color: var(--neon-purple); color: var(--neon-purple); box-shadow: 0 0 15px rgba(188, 19, 254, 0.2); }
    .operator-badge.manager { border-color: #fff; color: #fff; background: var(--neon-red); box-shadow: 0 0 20px var(--neon-red); }

    /* LOGOUT BTN */
    .logout-btn {
        background: transparent; border: 1px solid #444; color: var(--neon-red); padding: 5px 10px; 
        font-family: var(--font-tech); font-size: 12px; cursor: pointer; border-radius: 4px; transition: 0.3s;
    }
    .logout-btn:hover { background: var(--neon-red); color: #fff; }

    /* --- DASHBOARD (OPERATOR) --- */
    .dashboard {
      flex: 1; display: grid; grid-template-columns: 420px 1fr; gap: 20px; padding: 20px; overflow: hidden;
      opacity: 0; transition: opacity 1s;
    }
    .panel-left {
      background: var(--panel-glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px;
      display: flex; flex-direction: column; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
    .panel-right {
      position: relative; background: #000; border: 2px solid #333; border-radius: 12px; overflow: hidden;
      box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
      cursor: grab;
    }
    .panel-right:active { cursor: grabbing; }

    /* --- MANAGER DASHBOARD --- */
    #managerDash {
        display: none; /* Hidden by default */
        flex: 1; padding: 30px; flex-direction: column; overflow-y: auto;
    }
    
    .mgr-header-bar {
        display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 20px;
    }
    .mgr-filter-btn {
        background: #111; border: 1px solid #444; color: #888; padding: 10px 20px; cursor: pointer; font-family: var(--font-tech); font-size: 14px; margin-left: 10px;
    }
    .mgr-filter-btn.active {
        background: var(--neon-cyan); color: #000; border-color: var(--neon-cyan); font-weight: bold;
    }
    
    .mgr-grid {
        display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;
    }
    .mgr-card {
        background: linear-gradient(135deg, #111, #0a0a0a); border: 1px solid #333; padding: 25px; border-radius: 10px;
        text-align: center; position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .mgr-card::before {
        content:''; position: absolute; top:0; left:0; width: 100%; height: 4px; background: #333;
    }
    .mgr-val { font-size: 48px; font-weight: bold; font-family: var(--font-tech); color: #fff; margin: 10px 0; }
    .mgr-label { font-size: 14px; color: #888; text-transform: uppercase; letter-spacing: 1px; }

    .mgr-table-container {
        flex: 1; background: #111; border: 1px solid #333; border-radius: 10px; padding: 20px; overflow: auto;
    }

    /* Classes for hiding/showing modes */
    body.mode-manager .dashboard { display: none !important; }
    body.mode-manager #managerDash { display: flex !important; }
    body.mode-manager .cam-controls { display: none !important; } 

    
    /* VIDEO & ZOOM LOGIC */
    .video-container {
        width: 100%; height: 100%; overflow: hidden; position: relative;
        display: flex; justify-content: center; align-items: center;
    }
    video { 
        width: 100%; height: 100%; object-fit: contain; 
        transition: transform 0.1s linear; 
        transform-origin: center center;
    }

    /* --- DRAWING & CONTROLS --- */
    #drawCanvas {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 60; cursor: crosshair; display: none;
    }
    .draw-toolbar {
      position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100;
      display: none; background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 30px; border: 1px solid var(--neon-cyan);
      backdrop-filter: blur(5px);
    }
    .color-btn {
      width: 25px; height: 25px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; display: inline-block; margin: 0 5px;
    }
    .tool-btn {
      background: transparent; border: 1px solid #aaa; color: #fff; padding: 5px 12px; cursor: pointer; 
      font-family: var(--font-tech); font-size: 12px; margin-left: 10px; border-radius: 4px;
    }
    .tool-btn.confirm { background: var(--neon-cyan); color: #000; border-color: var(--neon-cyan); font-weight: bold; }

    /* CAM & ZOOM CONTROLS */
    .cam-controls { 
        position: absolute; bottom: 20px; right: 20px; z-index: 50; 
        display: flex; gap: 15px; align-items: center; 
        background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 30px; 
        border: 1px solid #333; backdrop-filter: blur(5px);
    }
    .cam-btn {
      background: transparent; border: 1px solid var(--neon-cyan); color: var(--neon-cyan);
      width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 18px; transition: 0.2s; 
    }
    .cam-btn:hover { background: var(--neon-cyan); color: #000; }
    
    /* SLIDER STYLE */
    .zoom-group { display: flex; align-items: center; gap: 10px; font-family: var(--font-tech); font-size: 12px; color: var(--neon-cyan); }
    input[type=range] {
      -webkit-appearance: none; width: 100px; height: 4px; background: #333; border-radius: 2px; outline: none;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--neon-cyan); cursor: pointer;
      box-shadow: 0 0 10px var(--neon-cyan);
    }

    /* UI ELEMENTS */
    .input-label { font-size: 11px; color: var(--neon-cyan); letter-spacing: 1px; margin-bottom: 5px; display: block; font-weight: bold; font-family: var(--font-tech); }
    #scanInput {
      width: 100%; background: #080808; border: 1px solid #444; color: #fff; padding: 12px; font-size: 22px;
      text-align: center; font-family: var(--font-tech); outline: none; border-radius: 6px; margin-bottom: 15px;
    }
    #scanInput:focus { border-color: var(--neon-cyan); box-shadow: 0 0 20px rgba(0, 243, 255, 0.2); }
    
    .checklist-btn {
      width: 100%; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); color: #888;
      padding: 12px; margin-bottom: 8px; cursor: pointer; text-align: left; font-family: var(--font-ui);
      display: flex; justify-content: space-between; transition: 0.2s; font-size: 14px; border-radius: 6px; font-weight: 500;
    }
    .checklist-btn:hover { background: rgba(255,255,255,0.05); color: #fff; border-color: #fff; }
    .checklist-btn.done { border-color: var(--neon-green); color: var(--neon-green); background: rgba(10,255,0,0.1); font-weight: 700; }

    /* DECISION & ACTION */
    .decision-panel { border-top: 1px solid #333; margin-top: 10px; padding-top: 15px; }
    .custom-select {
      width: 100%; background: #080808; color: #fff; border: 1px solid var(--neon-purple); padding: 10px;
      font-family: var(--font-tech); font-size: 14px; border-radius: 5px; outline: none; cursor: pointer; margin-bottom: 10px;
    }
    .custom-textarea {
      width: 100%; background: #080808; color: #ccc; border: 1px solid #444; padding: 10px;
      font-family: var(--font-ui); font-size: 14px; border-radius: 5px; outline: none; resize: vertical; margin-bottom: 10px;
    }
    .custom-textarea:focus { border-color: var(--neon-cyan); color: #fff; }

    #actionBtn {
      margin-top: auto; padding: 15px; width: 100%; background: #111; color: #444; font-weight: bold; border: none;
      font-size: 16px; cursor: not-allowed; border-radius: 6px; text-transform: uppercase; letter-spacing: 1px; font-family: var(--font-tech);
    }
    #actionBtn.active {
      background: var(--neon-green); color: #000; cursor: pointer; animation: pulseBtn 2s infinite; box-shadow: 0 0 20px var(--neon-green);
    }
    @keyframes pulseBtn { 0% { box-shadow: 0 0 10px var(--neon-green); } 50% { box-shadow: 0 0 30px var(--neon-green); } 100% { box-shadow: 0 0 10px var(--neon-green); } }

    /* PANELS */
    .bar-bottom {
      position: fixed; bottom: 0; left: 0; width: 100%; height: 40px; background: #080808; border-top: 1px solid #333;
      display: flex; justify-content: space-between; align-items: center; padding: 0 20px; z-index: 100;
    }
    .bar-group { display: flex; gap: 10px; }
    .bar-btn {
      background: transparent; border: 1px solid #444; color: #aaa; padding: 5px 15px; font-family: var(--font-tech);
      font-size: 11px; cursor: pointer; transition: 0.2s;
    }
    .bar-btn:hover { border-color: var(--neon-cyan); color: var(--neon-cyan); }
    .bar-btn.admin-only { border-color: var(--neon-gold); color: var(--neon-gold); display: none; }

    .slide-panel {
      position: fixed; bottom: 0; left: 0; width: 100%; height: 0; background: rgba(10, 12, 16, 0.98);
      z-index: 200; transition: height 0.5s cubic-bezier(0.25, 1, 0.5, 1); overflow: hidden;
      border-top: 2px solid var(--neon-cyan); display: flex; flex-direction: column;
    }
    .slide-panel.open { height: 85vh; }
    .panel-header { padding: 20px; background: #000; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
    .panel-content { flex: 1; overflow: auto; padding: 30px; }

    /* ANALYTICS & TABLES */
    table { width: 100%; border-collapse: collapse; font-size: 13px; color: #ccc; font-family: var(--font-tech); }
    th { text-align: left; padding: 12px; border-bottom: 2px solid #333; color: var(--neon-cyan); background: #000; position: sticky; top: 0; }
    td { padding: 12px; border-bottom: 1px solid #222; }
    tr:hover { background: rgba(255,255,255,0.05); }

    /* STATS BOXES */
    .stats-container { display: flex; gap: 20px; margin-bottom: 20px; }
    .stat-box {
      flex: 1; background: #111; border: 1px solid #333; padding: 20px; border-radius: 8px; text-align: center;
    }
    .stat-val { font-size: 32px; font-weight: bold; color: #fff; font-family: var(--font-tech); }
    .stat-label { font-size: 12px; color: #888; letter-spacing: 1px; }

    /* QR PASS POPUP (Screen Version) */
    #qrPopup {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #fff; color: #000; padding: 30px; border-radius: 10px; z-index: 500;
      text-align: center; display: none; box-shadow: 0 0 100px rgba(0,0,0,1); border: 5px solid var(--neon-cyan);
    }
    #qrCodeBox { margin: 20px auto; }

    /* PRINT LABEL 15x15cm (Hidden on screen) */
    #printLabel {
      display: none; /* Hidden by default */
    }

    /* PRINT STYLES */
    @media print {
        @page { size: auto; margin: 0mm; }
        body * { visibility: hidden; } /* Hide everything */
        #printLabel, #printLabel * { visibility: visible; } /* Show only label */
        
        #printLabel {
            position: absolute; left: 0; top: 0;
            width: 150mm; height: 150mm; /* 15x15 cm */
            display: flex !important;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            border: 2px solid #000;
            background: white;
            color: black;
            font-family: 'Roboto', sans-serif;
            padding: 10mm;
            box-sizing: border-box;
            z-index: 9999;
        }

        .pl-header { font-size: 24pt; font-weight: bold; border-bottom: 2px solid #000; width: 100%; text-align: center; padding-bottom: 5mm; }
        .pl-qr { margin: 5mm 0; }
        .pl-info { width: 100%; text-align: left; font-size: 14pt; line-height: 1.5; }
        .pl-footer { font-size: 10pt; width: 100%; text-align: center; border-top: 1px solid #000; padding-top: 2mm; margin-top: auto; }
        #qrPopup { display: none !important; }
    }

    /* 3D SCENE */
    .scene-container { height: 140px; perspective: 1000px; display: flex; justify-content: center; align-items: center; margin-bottom: 10px; }
    .tv-pivot { position: relative; width: 160px; height: 90px; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .tv-panel { position: absolute; width: 100%; height: 100%; background: #000; border: 2px solid #333; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; }
    .tv-front { background: linear-gradient(135deg, #050505, #1a1a1a); border: 1px solid #555; }
    .tv-front::after { content: "OLED"; opacity: 0.3; font-weight: bold; font-family: var(--font-tech); }
    .tv-back { transform: rotateY(180deg); background: #151515; border: 1px solid #444; }
    
    .cam-overlay { position: absolute; top: 20px; left: 20px; display: flex; flex-direction: column; gap: 8px; z-index: 55; pointer-events: none; }
    .tag { background: rgba(0,0,0,0.7); color: #fff; padding: 6px 12px; font-family: var(--font-tech); font-size: 14px; border-left: 3px solid var(--neon-cyan); backdrop-filter: blur(5px); }

    canvas { display: none; }

    /* PATTERN OVERLAY */
    #patternOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        z-index: 99999; display: none; cursor: pointer;
    }

  </style>
</head>
<body>

<div id="patternOverlay" onclick="nextPattern()"></div>

<div id="printLabel">
    <div class="pl-header">TPV OLED SERVICE</div>
    <div id="printQrCode" class="pl-qr"></div>
    <div class="pl-info">
        <div><strong>SN:</strong> <span id="plSN">---</span></div>
        <div><strong>DATA:</strong> <span id="plDate">---</span></div>
        <div><strong>OPERATOR:</strong> <span id="plOp">---</span></div>
        <div><strong>STATUS:</strong> <span id="plStatus" style="font-weight:bold; font-size:20pt;">---</span></div>
    </div>
    <div class="pl-footer">OLED REPAIR SYSTEM v12.9 - PASSPORT</div>
</div>

<div id="loginScreen">
  <div class="login-box">
    <h2 style="color:#fff;">OLED REPAIR SYSTEM</h2>
    <div style="font-size:12px; color:#666; margin-bottom:30px; font-family: var(--font-tech);">V12.9 (ULTIMATE)</div>
    
    <label class="input-label" style="text-align:left; margin-left:5px;">U≈ªYTKOWNIK</label>
    <input type="text" id="userInput" class="login-input" placeholder="LOGIN" autocomplete="off">
    <label class="input-label" style="text-align:left; margin-left:5px; color:var(--neon-red);">HAS≈ÅO</label>
    <input type="password" id="passInput" class="login-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    
    <div class="remember-me">
        <input type="checkbox" id="rememberCheck"> <label for="rememberCheck">ZAPAMIƒòTAJ MNIE</label>
    </div>

    <div id="loginError" class="login-error"></div>
    <button class="login-btn" onclick="attemptLogin()">ROZPOCZNIJ ZMIANƒò</button>
  </div>
</div>

<div id="networkGuard">
  <div class="alert-box">
    <h1 style="color:var(--neon-red); margin:0;">‚ö†Ô∏è SYSTEM ROZ≈ÅƒÑCZONY ‚ö†Ô∏è</h1>
    <p style="font-size:16px; color:#ccc; margin:20px 0;">WYMAGANY DOSTƒòP DO FOLDERU SIECIOWEGO</p>
    <div class="input-label" style="color:#aaa;">CEL:</div>
    <div class="path-box">\\plgorfs001\pub\SERVICE\LCDR\LCDR\OLED OBM Panels\Zdjƒôcia z napraw OLED</div>
    <button class="guard-btn" onclick="connectNetwork()">üì° PO≈ÅƒÑCZ Z SERWEREM</button>
    <button class="offline-btn" onclick="startOfflineMode()">üìÇ PRACA OFFLINE (ZIP)</button>
  </div>
</div>

<header>
  <div class="brand">TPV <span>OLED</span> REPAIR STATION</div>
  <div class="operator-info">
    <button class="bar-btn" onclick="toggleFullScreen()" title="Kiosk Mode">‚õ∂</button>
    <div class="operator-badge" id="operatorBadge">---</div>
    <button class="logout-btn" onclick="logout()">WYLOGUJ</button>
    <div id="clockDisplay">00:00</div>
  </div>
</header>

<div class="dashboard" id="mainDashboard">
  <aside class="panel-left">
    <div class="scene-container">
      <div class="tv-pivot" id="tv3d">
        <div class="tv-panel tv-front"></div>
        <div class="tv-panel tv-back">SERWIS</div>
      </div>
    </div>
    
    <span class="input-label">1. SN MODU≈ÅU (SET)</span>
    <input type="text" id="scanInput" placeholder="SKANUJ MODU≈Å..." autofocus>

    <span class="input-label" style="color:var(--neon-green)">2. SN OC (SZK≈ÅO)</span>
    <input type="text" id="scanInputOC" placeholder="OCZEKIWANIE NA DECYZJƒò..." disabled 
           style="width: 100%; background: #080808; border: 1px solid #333; color: var(--neon-green); padding: 12px; font-size: 18px; text-align: center; font-family: var(--font-tech); outline: none; border-radius: 6px; margin-bottom: 15px;">


    <div id="checklist">
        <button class="checklist-btn" style="border-color:var(--neon-purple); color:var(--neon-purple);" onclick="togglePatterns()"><span>üñ•Ô∏è TEST EKRANU (PATTERNS)</span> <span>‚èØ</span></button>
        <div style="height:10px;"></div>
        <div id="btnFront" class="checklist-btn" onclick="capture('PRZOD')"><span>1. PRZ√ìD EKRANU</span> <span>üì∑</span></div>
        <div id="btnBack" class="checklist-btn" onclick="capture('TYL')"><span>2. TY≈Å (TABLICZKA)</span> <span>üì∑</span></div>
        <div id="btnImage" class="checklist-btn" onclick="capture('OBRAZ')"><span>3. TEST OBRAZU</span> <span>üì∑</span></div>
    </div>

    <div class="decision-panel">
      <span class="input-label" style="color:var(--neon-purple)">DECYZJA SERWISOWA</span>
      <select id="statusSelect" class="custom-select" onchange="checkOcRequirement(); saveRecoveryState();">
        <option value="OK">üü¢ OK (SPRAWNY)</option>
        <option value="NG">üî¥ NG (USZKODZONY)</option>
        <option value="NDF">üîµ NDF (BRAK WAD)</option>
        <option value="RMA">üü† RMA (ZWROT)</option>
        <option value="SCRAP">‚ö´ SCRAP (Z≈ÅOM)</option>
        <option value="OFFRS_OK">üü£ OFFRS OK</option>
      </select>
      <span class="input-label">KOMENTARZ / OPIS USTERKI</span>
      <textarea id="commentInput" class="custom-textarea" rows="2" placeholder="Wpisz uwagi..." onkeyup="saveRecoveryState()"></textarea>
    </div>

    <button id="actionBtn" onclick="saveData()">OCZEKIWANIE</button>
    <div id="saveStatus" style="text-align:center; color:#666; margin-top:10px; font-size:11px; height:15px; font-family: var(--font-tech);"></div>
  </aside>

  <main class="panel-right" id="camContainer">
    <div class="cam-overlay">
      <div class="tag" id="tagSN">SN: ---</div>
      <div class="tag" id="tagOp">OP: ---</div>
    </div>
    
    <div class="draw-toolbar" id="drawToolbar">
      <span style="color:#fff; font-size:12px; margin-right:10px;">ZAZNACZ WADƒò:</span>
      <div class="color-btn" style="background:red;" onclick="setDrawColor('red')"></div>
      <div class="color-btn" style="background:#0aff00;" onclick="setDrawColor('#0aff00')"></div>
      <button class="tool-btn" onclick="clearDraw()">WYCZY≈öƒÜ</button>
      <button class="tool-btn confirm" onclick="confirmPhoto()">ZAPISZ</button>
      <button class="tool-btn" onclick="cancelPhoto()">ANULUJ</button>
    </div>

    <div class="cam-controls">
      <div class="zoom-group">
        <span>ZOOM</span>
        <input type="range" id="zoomSlider" min="1" max="4" step="0.1" value="1">
        <span id="zoomVal">1.0x</span>
      </div>
      <div style="width:1px; height:20px; background:#444; margin:0 5px;"></div>
      <div class="cam-btn" onclick="toggleMirror()" title="Odbicie lustrzane">‚Üî</div>
    </div>
    
    <div class="video-container">
        <video id="videoFeed" autoplay playsinline></video>
        <canvas id="drawCanvas"></canvas>
    </div>
  </main>
</div>

<div id="managerDash">
    <div class="mgr-header-bar">
        <div style="font-size:24px; font-family:var(--font-tech); color:var(--neon-gold);">
            PANEL KIEROWNIKA
            <span style="font-size:12px; color:#666; margin-left:20px;">PODGLƒÑD ANALITYCZNY</span>
        </div>
        <div>
            <button class="mgr-filter-btn" id="filterGlobal" onclick="setMgrFilter('GLOBAL')">GLOBALNE</button>
            <button class="mgr-filter-btn active" id="filterToday" onclick="setMgrFilter('TODAY')">DZISIAJ (24H)</button>
            <button class="mgr-filter-btn" onclick="scanNetwork()">üîÑ OD≈öWIE≈ª DANE</button>
            <button class="mgr-filter-btn" onclick="exportCSV()">üíæ EXPORT CSV</button>
        </div>
    </div>

    <div class="mgr-grid">
        <div class="mgr-card" style="border-color:var(--neon-cyan)">
            <div class="mgr-label">WYKONANE NAPRAWY</div>
            <div class="mgr-val" id="mgrTotal">0</div>
        </div>
        <div class="mgr-card" style="border-color:var(--neon-green)">
            <div class="mgr-label">POPRAWNE (OK)</div>
            <div class="mgr-val" id="mgrOK" style="color:var(--neon-green)">0</div>
        </div>
        <div class="mgr-card" style="border-color:var(--neon-red)">
            <div class="mgr-label">ODRZUTY (NG/SCRAP)</div>
            <div class="mgr-val" id="mgrNG" style="color:var(--neon-red)">0</div>
        </div>
        <div class="mgr-card" style="border-color:var(--neon-orange)">
            <div class="mgr-label">SKUTECZNO≈öƒÜ (YIELD)</div>
            <div class="mgr-val" id="mgrYield">0%</div>
        </div>
    </div>

    <div class="mgr-table-container">
        <table id="mgrTable">
            <thead>
                <tr>
                    <th>DATA</th>
                    <th>SN MODU≈ÅU</th>
                    <th>SN SZK≈ÅA (OC)</th>
                    <th>OPERATOR</th>
                    <th>DECYZJA</th>
                    <th>UWAGI</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="6" style="text-align:center; padding:30px; color:#555;">Kliknij "OD≈öWIE≈ª DANE" aby pobraƒá z serwera</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div class="bar-bottom">
  <div id="connStatus" style="color:#444; font-size:11px;">üî¥ OFFLINE</div>
  <div class="bar-group">
    <button class="bar-btn admin-only" onclick="toggleUserPanel()">üë• U≈ªYTKOWNICY</button>
    <button class="bar-btn" id="dbBtn" onclick="toggleReportPanel()">üìÇ BAZA DANYCH / STATYSTYKI</button>
  </div>
</div>

<div id="userPanel" class="slide-panel">
  <div class="panel-header">
    <div style="font-size:20px; color:var(--neon-gold); font-family: var(--font-tech);">ZARZƒÑDZANIE PERSONELEM</div>
    <button class="bar-btn" onclick="toggleUserPanel()">ZAMKNIJ X</button>
  </div>
  <div class="panel-content">
    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 100px; gap:10px; margin-bottom:20px; padding:20px; background:#111; border:1px solid #333;">
      <input type="text" id="newLogin" placeholder="NOWY LOGIN" style="background:#000; border:1px solid #444; color:#fff; padding:10px; font-family: var(--font-tech);">
      <input type="text" id="newPass" placeholder="HAS≈ÅO" style="background:#000; border:1px solid #444; color:#fff; padding:10px; font-family: var(--font-tech);">
      <select id="newRole" style="background:#000; border:1px solid #444; color:#fff; padding:10px; font-family: var(--font-tech);">
        <option value="OPERATOR">OPERATOR</option>
        <option value="KOORDYNATOR" style="color:var(--neon-purple)">KOORDYNATOR</option>
        <option value="KIEROWNIK" style="color:var(--neon-red); font-weight:bold;">KIEROWNIK</option>
        <option value="ADMIN" style="color:var(--neon-gold)">ADMINISTRATOR</option>
      </select>
      <button onclick="addUser()" style="background:var(--neon-gold); border:none; color:#000; font-weight:bold; cursor:pointer; font-family: var(--font-tech);">DODAJ</button>
    </div>
    <table id="userTable"><thead><tr><th>LOGIN</th><th>HAS≈ÅO</th><th>ROLA</th><th>AKCJA</th></tr></thead><tbody></tbody></table>
  </div>
</div>

<div id="reportPanel" class="slide-panel">
  <div class="panel-header">
    <div style="font-size:20px; color:var(--neon-cyan); font-family: var(--font-tech);">ANALYTICS CENTER</div>
    <div>
      <input type="text" id="searchDB" placeholder="SZUKAJ SN..." onkeyup="filterTable()" style="background:#111; border:1px solid #444; color:#fff; padding:5px 10px; margin-right:10px; font-family:var(--font-tech);">
      <button class="bar-btn" onclick="scanNetwork()">üîÑ SKANUJ SERWER</button>
      <button class="bar-btn" onclick="exportCSV()">üíæ CSV</button>
      <button class="bar-btn" onclick="toggleReportPanel()">ZAMKNIJ X</button>
    </div>
  </div>
  <div class="panel-content">
    <div class="stats-container">
      <div class="stat-box" style="border-color:var(--neon-cyan)">
        <div class="stat-val" id="statTotal">0</div>
        <div class="stat-label">WSZYSTKIE NAPRAWY</div>
      </div>
      <div class="stat-box" style="border-color:var(--neon-green)">
        <div class="stat-val" id="statOK">0</div>
        <div class="stat-label">STATUS OK</div>
      </div>
      <div class="stat-box" style="border-color:var(--neon-red)">
        <div class="stat-val" id="statNG">0</div>
        <div class="stat-label">STATUS NG/SCRAP</div>
      </div>
      <div class="stat-box" style="border-color:var(--neon-orange)">
        <div class="stat-val" id="statYield">0%</div>
        <div class="stat-label">YIELD (SKUTECZNO≈öƒÜ)</div>
      </div>
    </div>
    <table id="reportTable"><thead><tr><th>DATA</th><th>SN</th><th>OPERATOR</th><th>DECYZJA</th><th>UWAGI</th></tr></thead><tbody></tbody></table>
  </div>
</div>

<div id="qrPopup">
  <h2 style="font-family: var(--font-tech); margin-top:0;">OLED PASSPORT</h2>
  <div id="qrCodeBox"></div>
  <div id="qrSnDisplay" style="font-weight:bold; font-family:var(--font-tech);">SN: ---</div>
  <div id="qrStatusDisplay" style="color:green; margin-bottom:10px;">STATUS: OK</div>
  <button onclick="closeQr()" style="padding:10px 20px; background:#000; color:#fff; border:none; cursor:pointer;">ZAMKNIJ</button>
  <button onclick="window.print()" style="padding:10px 20px; background:var(--neon-cyan); color:#000; border:none; cursor:pointer;">DRUKUJ ETYKIETƒò</button>
</div>

<canvas id="photoCanvas"></canvas>

<script>
  /* --- CONFIG --- */
  const CONFIG = {
    networkPath: String.raw`\\plgorfs001\pub\SERVICE\LCDR\LCDR\OLED OBM Panels\Zdjƒôcia z napraw OLED`,
    defaultUsers: [
      { login: "DAWID", pass: "OLED12345!", role: "OPERATOR" },
      { login: "LUKASZ", pass: "050699", role: "ADMIN" },
      { login: "MICHAL", pass: "COORD2024", role: "KOORDYNATOR" },
      { login: "BOSS", pass: "1234", role: "KIEROWNIK" }
    ]
  };

  /* --- AUDIO SYSTEM --- */
  const SoundFX = {
    ctx: null,
    init: function() { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
    play: function(type) {
      if(!this.ctx) this.init();
      const osc = this.ctx.createOscillator();
      const gain = this.ctx.createGain();
      osc.connect(gain); gain.connect(this.ctx.destination);
      const now = this.ctx.currentTime;
      if(type === 'beep') {
        osc.type = 'sine'; osc.frequency.setValueAtTime(1200, now);
        gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.1);
        osc.start(now); osc.stop(now+0.1);
      } else if(type === 'error') {
        osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now+0.3);
        gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0.01, now+0.3);
        osc.start(now); osc.stop(now+0.3);
      } else if(type === 'shutter') {
        osc.type = 'square'; osc.frequency.setValueAtTime(800, now);
        gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now+0.05);
        osc.start(now); osc.stop(now+0.05);
      } else if(type === 'success') {
        osc.type = 'triangle'; osc.frequency.setValueAtTime(440, now); osc.frequency.setValueAtTime(554, now+0.1); osc.frequency.setValueAtTime(659, now+0.2); 
        gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.4);
        osc.start(now); osc.stop(now+0.4);
      }
    }
  };

  /* --- STATE --- */
  let users = [];
  let currentUser = null;
  let dirHandle = null;
  let currentSN = "";
  let currentOC = ""; 
  let photos = { PRZOD: null, TYL: null, OBRAZ: null };
  let isMirrored = false;
  let reportsCache = [];
  let managerFilterMode = 'TODAY'; 
  
  // Drawing & Zoom State
  let isDrawing = false;
  let drawColor = "red";
  let tempPhotoType = "";
  let zoomLevel = 1.0;
  let panX = 0;
  let panY = 0;
  let isPanning = false;
  let startPanX = 0;
  let startPanY = 0;

  /* --- INIT --- */
  window.onload = () => {
    loadUsers();
    checkSavedLogin();
    checkRecovery();
    checkOcRequirement();
    setInterval(() => document.getElementById('clockDisplay').innerText = new Date().toLocaleTimeString().slice(0,5), 1000);
    
    const c = document.getElementById('drawCanvas');
    c.addEventListener('mousedown', startDraw);
    c.addEventListener('mouseup', endDraw);
    c.addEventListener('mousemove', draw);
    c.addEventListener('touchstart', (e)=>{e.preventDefault(); startDraw(e.touches[0])});
    c.addEventListener('touchend', (e)=>{e.preventDefault(); endDraw()});
    c.addEventListener('touchmove', (e)=>{e.preventDefault(); draw(e.touches[0])});

    const slider = document.getElementById('zoomSlider');
    slider.addEventListener('input', (e) => {
        zoomLevel = parseFloat(e.target.value);
        document.getElementById('zoomVal').innerText = zoomLevel.toFixed(1) + "x";
        applyTransform();
    });

    const camContainer = document.getElementById('camContainer');
    camContainer.addEventListener('mousedown', (e) => {
        if(zoomLevel > 1 && !isDrawing && document.getElementById('drawCanvas').style.display === 'none') {
            isPanning = true;
            startPanX = e.clientX - panX;
            startPanY = e.clientY - panY;
            camContainer.style.cursor = 'grabbing';
        }
    });
    window.addEventListener('mouseup', () => {
        isPanning = false;
        camContainer.style.cursor = zoomLevel > 1 ? 'grab' : 'default';
    });
    window.addEventListener('mousemove', (e) => {
        if(!isPanning) return;
        e.preventDefault();
        panX = e.clientX - startPanX;
        panY = e.clientY - startPanY;
        applyTransform();
    });
  };

  function applyTransform() {
    const v = document.getElementById('videoFeed');
    const mirrorFactor = isMirrored ? -1 : 1;
    const limit = (zoomLevel - 1) * 500;
    if(panX > limit) panX = limit; if(panX < -limit) panX = -limit;
    if(panY > limit) panY = limit; if(panY < -limit) panY = -limit;
    v.style.transform = `scale(${zoomLevel * mirrorFactor}, ${zoomLevel}) translate(${panX / zoomLevel}px, ${panY / zoomLevel}px)`;
  }

  /* --- USERS & LOGIN --- */
  function loadUsers() {
    const stored = localStorage.getItem('oled_users');
    users = stored ? JSON.parse(stored) : CONFIG.defaultUsers;
  }
  function saveUsers() { localStorage.setItem('oled_users', JSON.stringify(users)); renderUserTable(); }
  
  function checkSavedLogin() {
      const saved = localStorage.getItem('oled_saved_creds');
      if(saved) {
          try {
              const creds = JSON.parse(saved);
              document.getElementById('userInput').value = creds.login;
              document.getElementById('passInput').value = creds.pass;
              document.getElementById('rememberCheck').checked = true;
          } catch(e) {}
      }
  }

  function attemptLogin() {
    const l = document.getElementById('userInput').value.trim().toUpperCase();
    const p = document.getElementById('passInput').value.trim();
    const remember = document.getElementById('rememberCheck').checked;

    const u = users.find(user => user.login === l && user.pass === p);
    if (u) {
      currentUser = u;
      
      // Handle Remember Me
      if(remember) {
          localStorage.setItem('oled_saved_creds', JSON.stringify({login:l, pass:p}));
      } else {
          localStorage.removeItem('oled_saved_creds');
      }

      document.getElementById('loginScreen').style.opacity = '0';
      setTimeout(() => {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('networkGuard').style.display = 'flex';
        document.getElementById('mainDashboard').style.opacity = '1';
        setupInterface();
      }, 800);
    } else { 
      SoundFX.play('error');
      document.getElementById('loginError').innerText = "B≈ÅƒòDNY LOGIN LUB HAS≈ÅO"; 
    }
  }

  function logout() {
      if(confirm("Czy na pewno chcesz siƒô wylogowaƒá?")) {
          // Reset State
          currentUser = null;
          dirHandle = null;
          currentSN = "";
          document.body.className = ""; // Remove manager class
          
          // Reset UI
          document.getElementById('loginScreen').style.display = 'flex';
          setTimeout(() => document.getElementById('loginScreen').style.opacity = '1', 50);
          
          document.getElementById('mainDashboard').style.opacity = '0';
          document.getElementById('networkGuard').style.display = 'none';
          document.getElementById('managerDash').style.display = 'none';
          document.getElementById('userPanel').classList.remove('open');
          document.getElementById('reportPanel').classList.remove('open');
          
          // Clear inputs if not remembered
          if(!document.getElementById('rememberCheck').checked) {
              document.getElementById('userInput').value = "";
              document.getElementById('passInput').value = "";
          }
      }
  }

  function setupInterface() {
    const b = document.getElementById('operatorBadge');
    b.innerText = currentUser.login;
    document.getElementById('tagOp').innerText = "OP: " + currentUser.login;
    b.className = "operator-badge"; 
    
    document.body.className = "";

    // Manager Logic
    if(currentUser.role === 'KIEROWNIK') {
        b.classList.add('manager');
        document.body.classList.add('mode-manager'); 
        document.getElementById('dbBtn').style.display = 'none';
    } else {
        if(currentUser.role === 'ADMIN') { b.classList.add('admin'); document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'inline-block'); renderUserTable(); }
        if(currentUser.role === 'KOORDYNATOR') b.classList.add('coord');
        initCamera();
    }
  }
  
  function addUser() {
    const l = document.getElementById('newLogin').value.trim().toUpperCase();
    const p = document.getElementById('newPass').value.trim();
    const r = document.getElementById('newRole').value;
    if(l && p) { users.push({login:l, pass:p, role:r}); saveUsers(); }
  }
  function removeUser(idx) { if(confirm("UsunƒÖƒá?")) { users.splice(idx, 1); saveUsers(); } }
  function renderUserTable() {
    const tb = document.querySelector('#userTable tbody'); tb.innerHTML = "";
    users.forEach((u, i) => {
      let color = '#fff';
      if(u.role === 'ADMIN') color = 'var(--neon-gold)';
      if(u.role === 'KOORDYNATOR') color = 'var(--neon-purple)';
      if(u.role === 'KIEROWNIK') color = 'var(--neon-red)';
      tb.innerHTML += `<tr><td>${u.login}</td><td>***</td><td style="color:${color}">${u.role}</td><td><button onclick="removeUser(${i})" style="color:red;background:none;border:none;cursor:pointer;">USU≈É</button></td></tr>`;
    });
  }

  /* --- NETWORK & OFFLINE --- */
  async function connectNetwork() {
    try {
      await navigator.clipboard.writeText(CONFIG.networkPath);
      alert("≈öcie≈ºka skopiowana!");
      dirHandle = await window.showDirectoryPicker();
      document.getElementById('networkGuard').style.display = 'none';
      document.getElementById('connStatus').innerHTML = "üü¢ ONLINE";
      document.getElementById('connStatus').style.color = "var(--neon-green)";
      
      if(currentUser.role !== 'KIEROWNIK') {
          initCamera();
          document.getElementById('scanInput').focus();
      } else {
          setTimeout(scanNetwork, 500); 
      }
    } catch(e) { alert("Wybierz folder!"); }
  }

  function startOfflineMode() {
      dirHandle = null; // Explicitly null
      document.getElementById('networkGuard').style.display = 'none';
      document.getElementById('connStatus').innerHTML = "üü° OFFLINE (ZIP)";
      document.getElementById('connStatus').style.color = "var(--neon-orange)";
      
      if(currentUser.role !== 'KIEROWNIK') {
          initCamera();
          document.getElementById('scanInput').focus();
      }
  }

  /* --- CAMERA & RECOVERY --- */
  async function initCamera() {
    if(currentUser.role === 'KIEROWNIK') return; 
    try {
      const s = await navigator.mediaDevices.getUserMedia({video:{width:{ideal:3840}, height:{ideal:2160}}});
      document.getElementById('videoFeed').srcObject = s;
    } catch(e) { console.log("Brak kamery lub rola kierownika"); }
  }
  function toggleMirror() {
    isMirrored = !isMirrored;
    applyTransform();
  }
  function toggleFullScreen() {
    if(!document.fullscreenElement) document.documentElement.requestFullscreen();
    else if(document.exitFullscreen) document.exitFullscreen();
  }

  /* --- SMART OC LOGIC --- */
  function checkOcRequirement() {
      const decision = document.getElementById('statusSelect').value;
      const ocInput = document.getElementById('scanInputOC');
      const mandatoryOC = ['OK', 'RMA'];
      
      if(!currentSN) return;

      if (mandatoryOC.includes(decision)) {
          ocInput.placeholder = "‚ö†Ô∏è SKANUJ OC (WYMAGANE!)";
          if(!currentOC) {
              ocInput.style.borderColor = "var(--neon-red)";
              ocInput.style.boxShadow = "0 0 10px rgba(255, 0, 60, 0.3)";
          } else {
              ocInput.style.borderColor = "var(--neon-green)";
              ocInput.style.boxShadow = "0 0 15px rgba(10,255,0,0.2)";
          }
      } else {
          ocInput.placeholder = "OC OPCJONALNE (BRAK WYMOGU)";
          ocInput.style.borderColor = "#333";
          ocInput.style.boxShadow = "none";
      }
  }

  function saveRecoveryState() {
      if(!currentSN) return;
      const state = {
          sn: currentSN,
          oc: currentOC,
          status: document.getElementById('statusSelect').value,
          comment: document.getElementById('commentInput').value
      };
      localStorage.setItem('oled_recovery', JSON.stringify(state));
  }
  
  function checkRecovery() {
      const rec = localStorage.getItem('oled_recovery');
      if(rec) {
          const state = JSON.parse(rec);
          if(confirm(`‚ö†Ô∏è Wykryto niezapisanƒÖ sesjƒô dla SN: ${state.sn}\nCzy przywr√≥ciƒá?`)) {
              startSession(state.sn);
              if(state.oc) {
                  currentOC = state.oc;
                  const ocInput = document.getElementById('scanInputOC');
                  ocInput.value = currentOC;
              }
              document.getElementById('statusSelect').value = state.status;
              document.getElementById('commentInput').value = state.comment;
              document.getElementById('scanInputOC').disabled = false;
              checkOcRequirement();
          } else {
              localStorage.removeItem('oled_recovery');
          }
      }
  }
  
  function clearRecovery() {
      localStorage.removeItem('oled_recovery');
  }

  /* --- DRAWING --- */
  function startDraw(e) { isDrawing = true; draw(e); }
  function endDraw() { isDrawing = false; const c = document.getElementById('drawCanvas'); c.getContext('2d').beginPath(); }
  function draw(e) {
    if(!isDrawing) return;
    const c = document.getElementById('drawCanvas');
    const ctx = c.getContext('2d');
    const rect = c.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    ctx.lineWidth = 5;
    ctx.lineCap = 'round';
    ctx.strokeStyle = drawColor;
    
    ctx.lineTo(x, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
  }
  function setDrawColor(col) { drawColor = col; }
  function clearDraw() {
    const c = document.getElementById('drawCanvas');
    c.getContext('2d').clearRect(0, 0, c.width, c.height);
  }

  /* --- WORKFLOW --- */
  document.getElementById('scanInput').addEventListener('keydown', e => {
    if(e.key==='Enter') {
      const v = e.target.value.trim().toUpperCase();
      if(v.length > 3) {
        SoundFX.play('beep');
        startSession(v);
        saveRecoveryState();
        const ocInput = document.getElementById('scanInputOC');
        ocInput.disabled = false;
        checkOcRequirement();
        ocInput.focus();
      } else {
        SoundFX.play('error');
      }
      e.target.value = ""; e.target.blur();
    }
  });

  document.getElementById('scanInputOC').addEventListener('keydown', e => {
    if(e.key === 'Enter') {
        const v = e.target.value.trim().toUpperCase();
        if(v.length > 3) {
            currentOC = v;
            SoundFX.play('beep');
            e.target.style.borderColor = "var(--neon-green)";
            e.target.style.boxShadow = "0 0 15px rgba(10,255,0,0.2)";
            saveRecoveryState();
        } else {
            SoundFX.play('error');
            currentOC = "";
        }
    }
  });

  function startSession(sn) {
    currentSN = sn; 
    currentOC = ""; 
    photos = { PRZOD: null, TYL: null, OBRAZ: null };
    document.getElementById('tagSN').innerText = "SN: " + sn;
    const ocInput = document.getElementById('scanInputOC');
    ocInput.value = "";
    ocInput.disabled = true;
    ocInput.placeholder = "OCZEKIWANIE NA MODU≈Å...";
    ocInput.style.borderColor = "#333";
    ocInput.style.boxShadow = "none";
    document.querySelectorAll('.checklist-btn').forEach(b => b.classList.remove('done'));
    document.getElementById('actionBtn').innerText = "OCZEKIWANIE (0/3)";
    document.getElementById('actionBtn').classList.remove('active');
    document.getElementById('tv3d').style.transform = "rotateY(0deg)";
    document.getElementById('commentInput').value = "";
    document.getElementById('statusSelect').value = "OK";
  }

  function capture(type) {
    if(!currentSN) return document.getElementById('scanInput').focus();
    tempPhotoType = type;
    document.getElementById('tv3d').style.transform = type === 'TYL' ? "rotateY(180deg)" : "rotateY(0deg)";
    const decision = document.getElementById('statusSelect').value;
    const requiresAnnotation = ['NG', 'SCRAP', 'RMA'].includes(decision);

    if (requiresAnnotation) {
        const v = document.getElementById('videoFeed');
        v.pause();
        SoundFX.play('shutter');
        document.getElementById('drawToolbar').style.display = 'block';
        const c = document.getElementById('drawCanvas');
        c.style.display = 'block';
        c.width = v.offsetWidth;
        c.height = v.offsetHeight;
        clearDraw();
    } else {
        SoundFX.play('shutter');
        processPhoto(false);
    }
  }

  function confirmPhoto() { processPhoto(true); }
  function cancelPhoto() {
    const v = document.getElementById('videoFeed');
    v.play();
    document.getElementById('drawToolbar').style.display = 'none';
    document.getElementById('drawCanvas').style.display = 'none';
  }

  function processPhoto(hasDrawing) {
    const v = document.getElementById('videoFeed');
    const drawC = document.getElementById('drawCanvas');
    const finalC = document.getElementById('photoCanvas');
    finalC.width = v.videoWidth;
    finalC.height = v.videoHeight;
    const ctx = finalC.getContext('2d');
    const sourceW = v.videoWidth / zoomLevel;
    const sourceH = v.videoHeight / zoomLevel;
    const containerW = v.offsetWidth;
    const containerH = v.offsetHeight;
    const panXFactor = panX / (containerW * zoomLevel); 
    const panYFactor = panY / (containerH * zoomLevel);
    let sourceX = (v.videoWidth - sourceW) / 2 - (panXFactor * v.videoWidth);
    let sourceY = (v.videoHeight - sourceH) / 2 - (panYFactor * v.videoHeight);
    
    ctx.save();
    if(isMirrored) { ctx.translate(finalC.width, 0); ctx.scale(-1, 1); }
    ctx.drawImage(v, sourceX, sourceY, sourceW, sourceH, 0, 0, finalC.width, finalC.height);
    ctx.restore();

    if(hasDrawing) { ctx.drawImage(drawC, 0, 0, finalC.width, finalC.height); }
    addWatermark(ctx, finalC.width, finalC.height);

    finalC.toBlob(b => {
      photos[tempPhotoType] = b;
      updateUIafterPhoto();
      if(hasDrawing) cancelPhoto();
    }, 'image/jpeg', 0.95);
  }

  function addWatermark(ctx, w, h) {
    const fs = Math.floor(h/25);
    ctx.font = `bold ${fs}px Roboto`; ctx.lineWidth=4; ctx.strokeStyle="black"; ctx.fillStyle="#0aff00";
    ctx.strokeText(`SN: ${currentSN}`, 50, fs+20); ctx.fillText(`SN: ${currentSN}`, 50, fs+20);
    ctx.fillStyle = "#00f3ff";
    ctx.strokeText(`TYP: ${tempPhotoType}`, 50, (fs*2)+40); ctx.fillText(`TYP: ${tempPhotoType}`, 50, (fs*2)+40);
    ctx.fillStyle = "white"; ctx.font = `bold ${Math.floor(fs*0.8)}px Roboto`;
    ctx.strokeText(`OP: ${currentUser.login}`, 50, (fs*3)+60); ctx.fillText(`OP: ${currentUser.login}`, 50, (fs*3)+60);
  }

  function updateUIafterPhoto() {
    const count = Object.values(photos).filter(o=>o).length;
    document.getElementById('actionBtn').innerText = `BRAK ZDJƒòƒÜ (${count}/3)`;
    const map = {'PRZOD':'btnFront','TYL':'btnBack','OBRAZ':'btnImage'};
    document.getElementById(map[tempPhotoType]).classList.add('done');
    if(count===3) {
      document.getElementById('actionBtn').classList.add('active');
      document.getElementById('actionBtn').innerText = "üíæ ZAPISZ";
    }
  }

  async function saveData() {
    if(!document.getElementById('actionBtn').classList.contains('active')) return;
    
    const decision = document.getElementById('statusSelect').value;
    const mandatoryOC = ['OK', 'RMA'];
    if (mandatoryOC.includes(decision) && !currentOC) {
        SoundFX.play('error');
        alert(`‚ö†Ô∏è B≈ÅƒÑD: Dla statusu ${decision} numer OC (Szk≈Ça) jest OBOWIƒÑZKOWY!`);
        document.getElementById('scanInputOC').focus();
        document.getElementById('scanInputOC').style.borderColor = "var(--neon-red)";
        return;
    }
    
    document.getElementById('saveStatus').innerText = "ZAPISYWANIE...";
    
    const comment = document.getElementById('commentInput').value.replace(/\n/g, " ");
    const displayOC = currentOC ? currentOC : "--- (BRAK/NIEWYMAGANE)";
    
    const txt = `
RAPORT SERWISOWY OLED
---------------------
MODU≈Å SN: ${currentSN}
OC SN:    ${displayOC}
DATA:     ${new Date().toLocaleString()}
OPERATOR: ${currentUser.login}
---------------------
DECYZJA:  ${decision}
UWAGI:    ${comment}
---------------------
ZDJƒòCIA:  3/3 OK
`.trim();

    // IF CONNECTED
    if(dirHandle) {
      try {
        const d = await dirHandle.getDirectoryHandle(currentSN, {create:true});
        await write(d, `${currentSN}_PRZOD.jpg`, photos.PRZOD);
        await write(d, `${currentSN}_TYL.jpg`, photos.TYL);
        await write(d, `${currentSN}_OBRAZ.jpg`, photos.OBRAZ);
        await write(d, `RAPORT_${currentSN}.txt`, new Blob([txt],{type:'text/plain'}));
        
        SoundFX.play('success');
        finishSave(decision);
      } catch(e) { 
          console.error(e);
          SoundFX.play('error');
          document.getElementById('saveStatus').innerText = "B≈ÅƒÑD ZAPISU SIECIOWEGO"; 
      }
    } 
    // IF OFFLINE (ZIP)
    else {
      try {
          const z = new JSZip(); 
          const f = z.folder(currentSN);
          f.file(`RAPORT_${currentSN}.txt`, txt); 
          f.file(`${currentSN}_PRZOD.jpg`, photos.PRZOD);
          f.file(`${currentSN}_TYL.jpg`, photos.TYL);
          f.file(`${currentSN}_OBRAZ.jpg`, photos.OBRAZ);
          
          const content = await z.generateAsync({type:"blob"});
          saveAs(content, `${currentSN}.zip`);
          
          SoundFX.play('success');
          finishSave(decision);
      } catch(e) {
          console.error(e);
          SoundFX.play('error');
          document.getElementById('saveStatus').innerText = "B≈ÅƒÑD GENEROWANIA ZIP";
      }
    }
  }
  
  function finishSave(decision) {
    clearRecovery();
    document.getElementById('saveStatus').innerText = "ZAPISANO!";
    document.getElementById('saveStatus').style.color = "#0aff00";
    showQr(currentSN, decision);
    setTimeout(()=>{ 
        currentSN=""; 
        currentOC=""; 
        startSession(""); 
        document.getElementById('scanInput').focus(); 
    }, 1500);
  }

  async function write(dh, n, b) { const h = await dh.getFileHandle(n,{create:true}); const w = await h.createWritable(); await w.write(b); await w.close(); }

  /* --- PATTERNS --- */
  const patterns = ['#fff', '#f00', '#0f0', '#00f', '#000', 'linear-gradient(90deg, white, black)'];
  let currentPatternIdx = -1;
  function togglePatterns() {
    const ov = document.getElementById('patternOverlay');
    if(ov.style.display === 'block') { ov.style.display = 'none'; currentPatternIdx = -1; } 
    else { ov.style.display = 'block'; nextPattern(); }
  }
  function nextPattern() {
    currentPatternIdx++; const ov = document.getElementById('patternOverlay');
    if(currentPatternIdx >= patterns.length) { ov.style.display = 'none'; currentPatternIdx = -1; return; }
    ov.style.background = patterns[currentPatternIdx];
  }
  document.addEventListener('keydown', (e) => {
      if(e.key === "Escape") { document.getElementById('patternOverlay').style.display = 'none'; currentPatternIdx = -1; }
  });

  /* --- QR & MANAGER --- */
  function showQr(sn, status) {
    const dateStr = new Date().toLocaleDateString();
    
    const box = document.getElementById('qrCodeBox'); box.innerHTML = "";
    new QRCode(box, { text: `${sn}|${status}|${dateStr}`, width: 128, height: 128 });
    document.getElementById('qrSnDisplay').innerText = "SN: " + sn;
    document.getElementById('qrStatusDisplay').innerText = "STATUS: " + status;
    document.getElementById('qrPopup').style.display = "block";

    const printBox = document.getElementById('printQrCode'); printBox.innerHTML = "";
    new QRCode(printBox, { text: `${sn}|${status}|${dateStr}`, width: 300, height: 300 });
    
    document.getElementById('plSN').innerText = sn;
    document.getElementById('plDate').innerText = new Date().toLocaleString();
    document.getElementById('plOp').innerText = currentUser.login;
    document.getElementById('plStatus').innerText = status;
  }
  
  function closeQr() { document.getElementById('qrPopup').style.display = "none"; document.getElementById('scanInput').focus(); }
  function toggleUserPanel() { document.getElementById('userPanel').classList.toggle('open'); document.getElementById('reportPanel').classList.remove('open'); }
  function toggleReportPanel() { document.getElementById('reportPanel').classList.toggle('open'); document.getElementById('userPanel').classList.remove('open'); }
  
  /* --- DATABASE & REPORTING --- */
  async function scanNetwork() {
    if(!dirHandle) {
        if(document.getElementById('managerDash').style.display === 'flex') {
            document.querySelector('#mgrTable tbody').innerHTML = "<tr><td colspan='6' style='text-align:center;color:orange;'>TRYB OFFLINE - BRAK DOSTƒòPU DO SERWERA</td></tr>";
        }
        return alert("Funkcja niedostƒôpna w trybie OFFLINE (ZIP)");
    }
    
    const mgrTbody = document.querySelector('#mgrTable tbody');
    if(mgrTbody) mgrTbody.innerHTML = "<tr><td colspan='6' style='text-align:center;'>POBIERANIE DANYCH...</td></tr>";
    
    reportsCache = [];
    try {
      for await (const e of dirHandle.values()) {
        if(e.kind === 'directory') {
          const sn = e.name; 
          let op="---", dateStr="---", dec="---", com="---", oc="---";
          let rawDateObj = null;

          try {
            const sub = await dirHandle.getDirectoryHandle(sn);
            for await (const f of sub.values()) {
              if(f.name.includes('RAPORT')) {
                const fl = await f.getFile(); 
                const tx = await fl.text(); 
                rawDateObj = fl.lastModifiedDate;
                dateStr = rawDateObj.toLocaleString();

                const mOp = tx.match(/OPERATOR: (.*)/); if(mOp) op=mOp[1];
                const mDec = tx.match(/DECYZJA: (.*)/); if(mDec) dec=mDec[1];
                const mCom = tx.match(/UWAGI: (.*)/); if(mCom) com=mCom[1];
                const mOc = tx.match(/OC SN:\s+(.*)/); if(mOc) oc=mOc[1];
              }
            }
          } catch(err){}
          reportsCache.push({date: dateStr, rawDate: rawDateObj, sn, op, dec, com, oc});
        }
      }
      
      renderReportTable();
      renderManagerView();
      calculateStats();
      
    } catch(e) { 
        console.error(e);
        alert("B≈ÇƒÖd skanowania"); 
    }
  }

  /* --- MANAGER VIEW FUNCTIONS --- */
  function setMgrFilter(mode) {
      managerFilterMode = mode;
      document.getElementById('filterGlobal').classList.remove('active');
      document.getElementById('filterToday').classList.remove('active');
      if(mode === 'GLOBAL') document.getElementById('filterGlobal').classList.add('active');
      else document.getElementById('filterToday').classList.add('active');
      
      renderManagerView();
  }

  function renderManagerView() {
      const tb = document.querySelector('#mgrTable tbody');
      tb.innerHTML = "";
      
      const today = new Date().toDateString();
      let filtered = [];

      if (managerFilterMode === 'TODAY') {
          filtered = reportsCache.filter(r => r.rawDate && r.rawDate.toDateString() === today);
      } else {
          filtered = reportsCache;
      }

      filtered.sort((a,b) => (b.rawDate || 0) - (a.rawDate || 0));

      if(filtered.length === 0) {
           tb.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:20px;'>BRAK DANYCH DLA TEGO FILTRA</td></tr>";
      }

      filtered.forEach(r => {
          let color = "#fff";
          if(r.dec === 'NG' || r.dec === 'SCRAP') color = "var(--neon-red)";
          if(r.dec === 'OK' || r.dec === 'OFFRS_OK') color = "var(--neon-green)";
          if(r.dec === 'RMA') color = "orange";
          
          tb.innerHTML += `
            <tr>
                <td>${r.date}</td>
                <td>${r.sn}</td>
                <td style="color:#aaa">${r.oc || '---'}</td>
                <td>${r.op}</td>
                <td style="color:${color};font-weight:bold;">${r.dec}</td>
                <td>${r.com}</td>
            </tr>`;
      });

      const total = filtered.length;
      let ok = 0, ng = 0;
      filtered.forEach(r => { if(['OK','OFFRS_OK','NDF'].includes(r.dec)) ok++; else if(['NG','SCRAP','RMA'].includes(r.dec)) ng++; });
      
      let yieldVal = 0;
      if(total > 0) yieldVal = ((ok / total) * 100).toFixed(1);

      document.getElementById('mgrTotal').innerText = total;
      document.getElementById('mgrOK').innerText = ok;
      document.getElementById('mgrNG').innerText = ng;
      document.getElementById('mgrYield').innerText = yieldVal + "%";
      
      const yE = document.getElementById('mgrYield');
      yE.style.color = yieldVal > 90 ? "var(--neon-green)" : (yieldVal > 70 ? "var(--neon-orange)" : "var(--neon-red)");
  }

  /* --- OPERATOR REPORT FUNCTIONS --- */
  function renderReportTable(filter = "") {
    const tb = document.querySelector('#reportTable tbody'); tb.innerHTML = "";
    reportsCache.forEach(r => {
      if(filter && !r.sn.includes(filter)) return;
      let color = "#fff";
      if(r.dec === 'NG' || r.dec === 'SCRAP') color = "var(--neon-red)";
      if(r.dec === 'OK' || r.dec === 'OFFRS_OK') color = "var(--neon-green)";
      if(r.dec === 'RMA') color = "orange";
      tb.innerHTML += `<tr><td>${r.date}</td><td>${r.sn}</td><td>${r.op}</td><td style="color:${color};font-weight:bold;">${r.dec}</td><td>${r.com}</td></tr>`;
    });
  }
  function filterTable() { renderReportTable(document.getElementById('searchDB').value.trim().toUpperCase()); }
  function calculateStats() {
    const total = reportsCache.length; let ok = 0, ng = 0;
    reportsCache.forEach(r => { if(['OK','OFFRS_OK','NDF'].includes(r.dec)) ok++; else if(['NG','SCRAP','RMA'].includes(r.dec)) ng++; });
    document.getElementById('statTotal').innerText = total; document.getElementById('statOK').innerText = ok; document.getElementById('statNG').innerText = ng;
    let yieldRate = 0; if(total > 0) yieldRate = ((ok / total) * 100).toFixed(1);
    const yE = document.getElementById('statYield'); yE.innerText = yieldRate + "%";
    yE.style.color = yieldRate > 90 ? "var(--neon-green)" : (yieldRate > 70 ? "var(--neon-orange)" : "var(--neon-red)");
  }
  function exportCSV() {
    if(!reportsCache.length) return alert("Pusto");
    let c = "DATA,SN_MODULU,SN_SZKLA_OC,OPERATOR,DECYZJA,UWAGI\n";
    reportsCache.forEach(r => c+=`${r.date},${r.sn},${r.oc},${r.op},${r.dec},${r.com}\n`);
    saveAs(new Blob([c],{type:'text/csv'}), "raport_serwisowy.csv");
  }
</script>
</body>
</html>
