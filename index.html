<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>OLED REPAIR v4.0 (DIRECT GOOGLE SYNC)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap&subset=latin-ext" rel="stylesheet">
  
  <style>
    /* --- STYLES --- */
    :root {
      --bg-deep: #050505;
      --panel-glass: rgba(20, 25, 35, 0.95);
      --neon-cyan: #00f3ff;
      --neon-green: #0aff00;
      --neon-red: #ff003c;
      --neon-gold: #ffd700;
      --neon-purple: #bc13fe;
      --neon-orange: #ff9d00;
      --font-ui: 'Roboto', sans-serif;
      --font-tech: 'Oxanium', cursive;
    }
    * { box-sizing: border-box; user-select: none; }
    body {
      margin: 0; background-color: var(--bg-deep); color: #fff;
      font-family: var(--font-ui); height: 100vh; overflow: hidden;
      display: flex; flex-direction: column;
      background-image: linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
    }

    /* LOGIN SCREEN */
    #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; transition: opacity 0.8s; }
    .login-box { width: 450px; padding: 40px; background: rgba(10, 10, 10, 0.95); border: 1px solid var(--neon-cyan); text-align: center; border-radius: 12px; box-shadow: 0 0 60px rgba(0, 243, 255, 0.1); backdrop-filter: blur(10px); }
    .login-input { width: 100%; padding: 15px; margin: 10px 0; background: #080808; border: 1px solid #333; color: var(--neon-cyan); font-family: var(--font-tech); font-size: 18px; text-align: center; outline: none; transition: 0.3s; }
    .login-input:focus { border-color: var(--neon-cyan); background: #111; }
    input[type="password"] { letter-spacing: 5px; color: var(--neon-red); }
    .login-btn { width: 100%; padding: 15px; margin-top: 20px; background: var(--neon-cyan); color: #000; font-weight: bold; border: none; cursor: pointer; font-family: var(--font-tech); font-size: 16px; letter-spacing: 2px; transition: 0.3s; }
    .login-btn:hover { background: #fff; box-shadow: 0 0 30px var(--neon-cyan); }
    .quick-admin-btn { width: 100%; padding: 10px; margin-top: 10px; background: transparent; color: var(--neon-gold); border: 1px dashed var(--neon-gold); cursor: pointer; font-family: var(--font-tech); font-size: 12px; transition: 0.3s; border-radius: 4px; }
    .quick-admin-btn:hover { background: rgba(255, 215, 0, 0.1); box-shadow: 0 0 15px rgba(255, 215, 0, 0.2); }
    .login-error { color: var(--neon-red); font-size: 12px; height: 20px; margin-top: 10px; font-weight: bold; font-family: var(--font-ui); }
    .sync-status { color: #666; font-size: 11px; margin-top: 10px; font-family: monospace; height: 15px; }
    .sync-status.ok { color: var(--neon-green); }
    .sync-status.err { color: var(--neon-red); }
    .remember-me { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; font-size: 14px; color: #aaa; }
    .remember-me input { transform: scale(1.5); accent-color: var(--neon-cyan); cursor: pointer; }
    .emergency-reset { position: absolute; bottom: 20px; left: 20px; color: #333; font-size: 10px; cursor: pointer; border: 1px solid #222; padding: 5px; font-family: var(--font-tech); transition: 0.3s; }
    .emergency-reset:hover { color: var(--neon-red); border-color: var(--neon-red); }

    /* NETWORK GUARD */
    #networkGuard { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 8000; display: none; align-items: center; justify-content: center; flex-direction: column; backdrop-filter: blur(15px); }
    .alert-box { width: 600px; padding: 40px; border: 2px solid var(--neon-red); background: #050505; text-align: center; border-radius: 12px; box-shadow: 0 0 100px rgba(255, 0, 60, 0.2); }
    .path-box { background:#111; padding:15px; border:1px dashed #555; font-size:12px; color:#fff; font-family:var(--font-tech); margin-top: 5px; word-break: break-all; }
    .guard-btn { width: 100%; padding: 20px; background: var(--neon-red); color: #fff; font-weight: bold; border: none; cursor: pointer; font-family: var(--font-tech); font-size: 18px; margin-top: 20px; }
    .offline-btn { width: 100%; padding: 15px; background: transparent; color: var(--neon-orange); border: 1px solid var(--neon-orange); font-family: var(--font-tech); cursor: pointer; margin-top: 10px; font-weight: bold; transition: 0.3s; }
    .offline-btn:hover { background: var(--neon-orange); color: #000; }

    /* HEADER & UI */
    header { height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 30px; background: rgba(0,0,0,0.8); border-bottom: 1px solid #333; }
    .brand { font-family: var(--font-tech); font-size: 28px; font-weight: 700; color: #fff; letter-spacing: 2px; }
    .brand span { color: var(--neon-cyan); text-shadow: 0 0 10px var(--neon-cyan); }
    .operator-info { display: flex; align-items: center; gap: 20px; font-family: var(--font-tech); color: #aaa; font-size: 14px; }
    .operator-badge { background: #1a1a1a; padding: 6px 15px; border-radius: 4px; border: 1px solid #444; color: var(--neon-cyan); transition:0.3s; font-weight: bold; }
    .operator-badge.admin { border-color: var(--neon-gold); color: var(--neon-gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.1); }
    .operator-badge.coord { border-color: var(--neon-purple); color: var(--neon-purple); box-shadow: 0 0 15px rgba(188, 19, 254, 0.2); }
    .operator-badge.manager { border-color: #fff; color: #fff; background: var(--neon-red); box-shadow: 0 0 20px var(--neon-red); }
    .logout-btn { background: transparent; border: 1px solid #444; color: var(--neon-red); padding: 5px 10px; font-family: var(--font-tech); font-size: 12px; cursor: pointer; border-radius: 4px; transition: 0.3s; }
    .logout-btn:hover { background: var(--neon-red); color: #fff; }
    #motdBar { width: 100%; background: #220000; color: var(--neon-red); text-align: center; font-family: var(--font-tech); font-weight: bold; padding: 5px; font-size: 14px; border-bottom: 1px solid var(--neon-red); display: none; animation: pulseRed 3s infinite; }
    @keyframes pulseRed { 0% {opacity:0.8;} 50% {opacity:1;} 100% {opacity:0.8;} }

    /* DASHBOARDS */
    .dashboard { flex: 1; display: grid; grid-template-columns: 420px 1fr; gap: 20px; padding: 20px; overflow: hidden; opacity: 0; transition: opacity 1s; }
    body.mode-admin .dashboard { display: none !important; }
    body.mode-admin #adminDash { display: flex !important; }
    body.mode-manager .dashboard { display: none !important; }
    body.mode-manager #managerDash { display: flex !important; }
    body.mode-manager .bar-bottom { display: none !important; } 
    .panel-left { background: var(--panel-glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
    .panel-right { position: relative; background: #000; border: 2px solid #333; border-radius: 12px; overflow: hidden; box-shadow: inset 0 0 50px rgba(0,0,0,0.8); cursor: grab; }
    .panel-right:active { cursor: grabbing; }

    /* FLOW CONTROL STYLES */
    .checklist-btn.locked { opacity: 0.2; cursor: not-allowed; border-color: #333 !important; color: #444 !important; filter: grayscale(1); }
    .confirm-identity-btn { width: 100%; padding: 15px; background: var(--neon-green); color: #000; font-weight: bold; border: none; font-family: var(--font-tech); cursor: pointer; border-radius: 6px; margin-bottom: 15px; box-shadow: 0 0 20px rgba(10, 255, 0, 0.4); display: none; animation: pulseGreen 1.5s infinite; }
    @keyframes pulseGreen { 0% { box-shadow: 0 0 5px var(--neon-green); } 50% { box-shadow: 0 0 20px var(--neon-green); } 100% { box-shadow: 0 0 5px var(--neon-green); } }
    .scan-status-info { font-family: var(--font-tech); font-size: 12px; color: var(--neon-green); text-align: center; margin-bottom: 10px; display: none; }

    /* ADMIN DASH */
    #adminDash { display: none; flex: 1; padding: 40px; flex-direction: column; overflow-y: auto; gap: 20px; align-items: center; background: radial-gradient(circle at center, #111, #000); }
    .admin-container { width: 100%; max-width: 1600px; display: flex; flex-direction: column; gap: 20px; }
    .admin-status-bar { display: flex; justify-content: space-between; background: #0a0a0a; border: 1px solid #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .status-item { display: flex; align-items: center; gap: 10px; font-family: var(--font-tech); font-size: 14px; color: #888; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #333; }
    .status-dot.ok { background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }
    .admin-grid { display: grid; grid-template-columns: 1fr 380px; gap: 25px; width: 100%; }
    .admin-panel-box { background: rgba(10, 10, 10, 0.9); border: 1px solid #333; padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); backdrop-filter: blur(5px); display: flex; flex-direction: column; }
    .admin-panel-box.highlight { border-color: var(--neon-gold); box-shadow: 0 0 20px rgba(255, 215, 0, 0.1); }
    .admin-h { font-family: var(--font-tech); color: var(--neon-gold); font-size: 20px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; display:flex; justify-content:space-between; align-items:center; letter-spacing: 1px; }
    .cfg-input { width: 100%; background: #000; color: #fff; border: 1px solid #444; padding: 12px; margin-bottom: 10px; font-family: monospace; font-size: 14px; }
    .cfg-btn { background: #222; color: #fff; border: 1px solid #555; padding: 10px 20px; font-weight:bold; cursor:pointer; font-family: var(--font-tech); transition:0.3s; font-size: 13px; text-transform: uppercase; }
    .cfg-btn:hover { background: var(--neon-gold); color: #000; border-color: var(--neon-gold); box-shadow: 0 0 15px var(--neon-gold); }
    .cfg-btn.cyan:hover { background: var(--neon-cyan); color: #000; border-color: var(--neon-cyan); box-shadow: 0 0 15px var(--neon-cyan); }
    .adm-table { width: 100%; border-collapse: collapse; }
    .adm-table th { text-align: left; border-bottom: 2px solid #444; color: var(--neon-cyan); padding: 10px; font-size: 12px; }
    .adm-table td { border-bottom: 1px solid #222; padding: 12px 10px; font-size: 14px; }
    .adm-btn-group { display: flex; gap: 8px; }
    .adm-act-btn { padding: 5px 10px; font-size: 11px; cursor: pointer; border: 1px solid #444; background: #000; color: #aaa; transition: 0.2s; }
    .adm-act-btn:hover { border-color: #fff; color: #fff; }
    .admin-terminal { background: #000; border: 1px solid #333; height: 200px; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; color: #0f0; margin-top: 20px; }
    .log-line { margin-bottom: 4px; border-bottom: 1px dashed #222; padding-bottom: 2px; }
    .log-time { color: #666; margin-right: 10px; }
    #adminCamPreview { width: 100%; height: 200px; background: #000; border: 1px solid var(--neon-cyan); object-fit: cover; margin-top: 10px; border-radius: 4px; box-shadow: 0 0 15px rgba(0,243,255,0.1); }

    /* MANAGER DASH */
    #managerDash { flex: 1; padding: 30px; flex-direction: column; overflow-y: auto; gap: 20px; background: radial-gradient(circle at top, #111, #000); }
    .mgr-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 20px; }
    .mgr-title { font-size: 32px; font-family: var(--font-tech); color: #fff; text-shadow: 0 0 20px var(--neon-cyan); display:flex; align-items:center; }
    .mgr-filters { display: flex; gap: 10px; background: #111; padding: 10px; border-radius: 8px; border: 1px solid #333; align-items:center; }
    .mgr-btn { background: transparent; border: 1px solid #555; color: #aaa; padding: 10px 25px; font-family: var(--font-tech); cursor: pointer; transition: 0.3s; font-size: 14px; }
    .mgr-btn:hover { border-color: #fff; color: #fff; }
    .mgr-btn.active { background: var(--neon-cyan); color: #000; border-color: var(--neon-cyan); font-weight: bold; box-shadow: 0 0 20px rgba(0,243,255,0.3); }
    .mgr-connect-btn { margin-left: 20px; background: var(--neon-green); color: #000; border: 1px solid var(--neon-green); padding: 10px 20px; font-weight: bold; font-family: var(--font-tech); cursor: pointer; box-shadow: 0 0 15px rgba(10,255,0,0.3); transition: 0.3s; }
    .mgr-connect-btn:hover { background: #fff; border-color: #fff; box-shadow: 0 0 25px rgba(255,255,255,0.6); }
    .mgr-stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 20px; }
    .mgr-card { background: rgba(20,20,20,0.8); border: 1px solid #333; padding: 25px; border-radius: 12px; text-align: center; backdrop-filter: blur(10px); position: relative; overflow: hidden; }
    .mgr-card h3 { font-size: 14px; color: #888; margin: 0 0 10px 0; letter-spacing: 1px; }
    .mgr-card .val { font-size: 48px; font-weight: bold; font-family: var(--font-tech); color: #fff; }
    .mgr-content-grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; flex: 1; min-height: 400px; margin-top: 20px; }
    .mgr-panel { background: #0a0a0a; border: 1px solid #333; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; }
    .mgr-panel h4 { margin: 0 0 20px 0; color: var(--neon-gold); font-family: var(--font-tech); border-bottom: 1px solid #222; padding-bottom: 10px; }
    .data-table { width: 100%; border-collapse: collapse; font-size: 13px; color: #ccc; font-family: var(--font-tech); }
    .data-table th { text-align: left; padding: 10px; background: #151515; color: #888; border-bottom: 1px solid #444; position: sticky; top: 0; }
    .data-table td { padding: 10px; border-bottom: 1px solid #222; }
    .data-table tr:hover { background: rgba(255,255,255,0.05); }

    /* CAM & UI */
    .video-container { width: 100%; height: 100%; overflow: hidden; position: relative; display: flex; justify-content: center; align-items: center; }
    video { width: 100%; height: 100%; object-fit: contain; transition: transform 0.1s linear; transform-origin: center center; }
    #drawCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 60; cursor: crosshair; display: none; }
    .draw-toolbar { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100; display: none; background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 30px; border: 1px solid var(--neon-cyan); backdrop-filter: blur(5px); }
    .color-btn { width: 25px; height: 25px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; display: inline-block; margin: 0 5px; }
    .tool-btn { background: transparent; border: 1px solid #aaa; color: #fff; padding: 5px 12px; cursor: pointer; font-family: var(--font-tech); font-size: 12px; margin-left: 10px; border-radius: 4px; }
    .tool-btn.confirm { background: var(--neon-cyan); color: #000; border-color: var(--neon-cyan); font-weight: bold; }
    .cam-controls { position: absolute; bottom: 20px; right: 20px; z-index: 50; display: flex; gap: 15px; align-items: center; background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 30px; border: 1px solid #333; backdrop-filter: blur(5px); }
    .cam-btn { background: transparent; border: 1px solid var(--neon-cyan); color: var(--neon-cyan); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; transition: 0.2s; }
    .cam-btn:hover { background: var(--neon-cyan); color: #000; }
    .zoom-group { display: flex; align-items: center; gap: 10px; font-family: var(--font-tech); font-size: 12px; color: var(--neon-cyan); }
    input[type=range] { -webkit-appearance: none; width: 100px; height: 4px; background: #333; border-radius: 2px; outline: none; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--neon-cyan); cursor: pointer; box-shadow: 0 0 10px var(--neon-cyan); }
    .input-label { font-size: 11px; color: var(--neon-cyan); letter-spacing: 1px; margin-bottom: 5px; display: block; font-weight: bold; font-family: var(--font-tech); }
    #scanInput { width: 100%; background: #080808; border: 1px solid #444; color: #fff; padding: 12px; font-size: 22px; text-align: center; font-family: var(--font-tech); outline: none; border-radius: 6px; margin-bottom: 15px; }
    #scanInput:disabled { background: #111; color: #333; border-color: #222; cursor: not-allowed; }
    #scanInput:focus { border-color: var(--neon-cyan); box-shadow: 0 0 20px rgba(0, 243, 255, 0.2); }
    .checklist-btn { width: 100%; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); color: #888; padding: 12px; margin-bottom: 8px; cursor: pointer; text-align: left; font-family: var(--font-ui); display: flex; justify-content: space-between; transition: 0.2s; font-size: 14px; border-radius: 6px; font-weight: 500; }
    .checklist-btn:hover { background: rgba(255,255,255,0.05); color: #fff; border-color: #fff; }
    .checklist-btn.done { border-color: var(--neon-green); color: var(--neon-green); background: rgba(10,255,0,0.1); font-weight: 700; }
    .decision-panel { border-top: 1px solid #333; margin-top: 10px; padding-top: 15px; }
    .custom-select { width: 100%; background: #080808; color: #fff; border: 1px solid var(--neon-purple); padding: 10px; font-family: var(--font-tech); font-size: 14px; border-radius: 5px; outline: none; cursor: pointer; margin-bottom: 10px; }
    .custom-textarea { width: 100%; background: #080808; color: #ccc; border: 1px solid #444; padding: 10px; font-family: var(--font-ui); font-size: 14px; border-radius: 5px; outline: none; resize: vertical; margin-bottom: 10px; }
    .custom-textarea:focus { border-color: var(--neon-cyan); color: #fff; }
    #actionBtn { margin-top: auto; padding: 15px; width: 100%; background: #111; color: #444; font-weight: bold; border: none; font-size: 16px; cursor: not-allowed; border-radius: 6px; text-transform: uppercase; letter-spacing: 1px; font-family: var(--font-tech); }
    #actionBtn.active { background: var(--neon-green); color: #000; cursor: pointer; animation: pulseBtn 2s infinite; box-shadow: 0 0 20px var(--neon-green); }
    @keyframes pulseBtn { 0% { box-shadow: 0 0 10px var(--neon-green); } 50% { box-shadow: 0 0 30px var(--neon-green); } 100% { box-shadow: 0 0 10px var(--neon-green); } }
    .bar-bottom { position: fixed; bottom: 0; left: 0; width: 100%; height: 40px; background: #080808; border-top: 1px solid #333; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; z-index: 100; }
    .bar-group { display: flex; gap: 10px; }
    .bar-btn { background: transparent; border: 1px solid #444; color: #aaa; padding: 5px 15px; font-family: var(--font-tech); font-size: 11px; cursor: pointer; transition: 0.2s; }
    .bar-btn:hover { border-color: var(--neon-cyan); color: var(--neon-cyan); }
    .bar-btn.admin-only { border-color: var(--neon-gold); color: var(--neon-gold); display: none; }
    .quick-defects { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
    .defect-tag { font-family: var(--font-tech); font-size: 11px; padding: 4px 8px; border: 1px solid #444; color: #888; border-radius: 4px; cursor: pointer; transition: 0.2s; }
    .defect-tag:hover { border-color: var(--neon-cyan); color: var(--neon-cyan); }
    .recent-list { margin-top: 15px; border-top: 1px solid #333; padding-top: 10px; max-height: 100px; overflow-y: auto; }
    .recent-item { display: flex; justify-content: space-between; font-size: 12px; color: #666; padding: 4px 0; border-bottom: 1px dashed #222; }
    .recent-item span:last-child { font-weight: bold; }
    .op-connect-btn { width: 100%; padding: 12px; background: var(--neon-cyan); color: #000; font-weight: bold; border: none; font-family: var(--font-tech); cursor: pointer; border-radius: 6px; margin-bottom: 15px; box-shadow: 0 0 15px rgba(0, 243, 255, 0.3); transition: 0.3s; }
    .op-connect-btn:hover { background: #fff; box-shadow: 0 0 25px rgba(0, 243, 255, 0.6); }
    .slide-panel { position: fixed; bottom: 0; left: 0; width: 100%; height: 0; background: rgba(10, 12, 16, 0.98); z-index: 200; transition: height 0.5s cubic-bezier(0.25, 1, 0.5, 1); overflow: hidden; border-top: 2px solid var(--neon-cyan); display: flex; flex-direction: column; }
    .slide-panel.open { height: 85vh; }
    .panel-header { padding: 20px; background: #000; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
    .panel-content { flex: 1; overflow: auto; padding: 30px; }
    .op-stats-row { display: flex; gap: 10px; margin-bottom: 20px; }
    .op-stat-box { flex: 1; background: #111; border: 1px solid #333; padding: 10px; text-align: center; border-radius: 6px; }
    .op-stat-num { font-size: 24px; font-weight: bold; color: #fff; font-family: var(--font-tech); }
    .op-stat-lbl { font-size: 10px; color: #888; }
    #qrPopup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; color: #000; padding: 30px; border-radius: 10px; z-index: 500; text-align: center; display: none; box-shadow: 0 0 100px rgba(0,0,0,1); border: 5px solid var(--neon-cyan); }
    #qrCodeBox { margin: 20px auto; }
    #printLabel { display: none; }
    @media print {
        @page { size: auto; margin: 0mm; }
        body * { visibility: hidden; } 
        #printLabel, #printLabel * { visibility: visible; }
        #printLabel { position: absolute; left: 0; top: 0; width: 150mm; height: 150mm; display: flex !important; flex-direction: column; justify-content: space-between; align-items: center; border: 2px solid #000; background: white; color: black; font-family: 'Roboto', sans-serif; padding: 10mm; box-sizing: border-box; z-index: 9999; }
        .pl-header { font-size: 24pt; font-weight: bold; border-bottom: 2px solid #000; width: 100%; text-align: center; padding-bottom: 5mm; }
        .pl-qr { margin: 5mm 0; }
        .pl-info { width: 100%; text-align: left; font-size: 14pt; line-height: 1.5; }
        .pl-footer { font-size: 10pt; width: 100%; text-align: center; border-top: 1px solid #000; padding-top: 2mm; margin-top: auto; }
        #qrPopup { display: none !important; }
    }
    canvas { display: none; }
    #patternOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 99999; display: none; cursor: pointer; }
  </style>
</head>
<body>

<div id="patternOverlay" onclick="nextPattern()"></div>

<div id="printLabel">
    <div class="pl-header">TPV OLED SERVICE</div>
    <div id="printQrCode" class="pl-qr"></div>
    <div class="pl-info">
        <div><strong>SN:</strong> <span id="plSN">---</span></div>
        <div><strong>DATA:</strong> <span id="plDate">---</span></div>
        <div><strong>OPERATOR:</strong> <span id="plOp">---</span></div>
        <div><strong>STATUS:</strong> <span id="plStatus" style="font-weight:bold; font-size:20pt;">---</span></div>
    </div>
    <div class="pl-footer">OLED REPAIR SYSTEM v4.0 - By ≈Åukasz Gruszczy≈Ñski</div>
</div>

<div id="loginScreen">
  <div class="login-box">
    <h2 style="color:#fff;">OLED REPAIR SYSTEM</h2>
    <div style="font-size:12px; color:#666; font-family: var(--font-tech);">v4.0 (DUAL CLOUDFLARE)</div>
    <div id="syncStatus" class="sync-status">≈Åadowanie u≈ºytkownik√≥w...</div>
    
    <label class="input-label" style="text-align:left; margin-left:5px; margin-top:20px;">U≈ªYTKOWNIK</label>
    <input type="text" id="userInput" class="login-input" placeholder="LOGIN" autocomplete="off">
    <label class="input-label" style="text-align:left; margin-left:5px; color:var(--neon-red);">HAS≈ÅO</label>
    <input type="password" id="passInput" class="login-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    
    <div class="remember-me">
        <input type="checkbox" id="rememberCheck"> <label for="rememberCheck">ZAPAMIƒòTAJ MNIE</label>
    </div>

    <div id="loginError" class="login-error"></div>
    <button class="login-btn" onclick="attemptLogin()">ROZPOCZNIJ ZMIANƒò</button>
    <button class="quick-admin-btn" onclick="quickAdminLogin()">‚ö° SZYBKIE LOGOWANIE (ADMIN)</button>
  </div>
  
  <div class="emergency-reset" onclick="emergencyReset()">‚ö† RESET BAZY</div>
</div>

<div id="networkGuard">
  <div class="alert-box">
    <h1 style="color:var(--neon-red); margin:0;">‚ö†Ô∏è SYSTEM ROZ≈ÅƒÑCZONY ‚ö†Ô∏è</h1>
    <p style="font-size:16px; color:#ccc; margin:20px 0;">WYMAGANY DOSTƒòP DO FOLDERU SIECIOWEGO</p>
    <div class="input-label" style="color:#aaa;">CEL:</div>
    <div class="path-box" id="displayPath">...</div>
    <button class="guard-btn" onclick="connectNetwork()">üì° PO≈ÅƒÑCZ Z SERWEREM</button>
    <button class="offline-btn" onclick="startOfflineMode()">üìÇ PRACA OFFLINE (ZIP)</button>
  </div>
</div>

<header>
  <div class="brand">TPV <span>OLED</span> REPAIR STATION</div>
  <div class="operator-info">
    <button class="bar-btn" onclick="toggleFullScreen()" title="Kiosk Mode">‚õ∂</button>
    <div class="operator-badge" id="operatorBadge">---</div>
    <button class="logout-btn" onclick="logout()">WYLOGUJ</button>
    <div id="clockDisplay">00:00</div>
  </div>
</header>

<div id="motdBar">KOMUNIKAT: ---</div>

<div class="dashboard" id="mainDashboard">
  <aside class="panel-left">
    <button id="opConnectBtn" class="op-connect-btn" onclick="connectNetwork()">üì° PO≈ÅƒÑCZ Z SERWEREM</button>

    <div class="scene-container">
      <div class="tv-pivot" id="tv3d">
        <div class="tv-panel tv-front"></div>
        <div class="tv-panel tv-back">SERWIS</div>
      </div>
    </div>
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
        <span class="input-label">1. SN MODU≈ÅU (SET)</span>
        <span id="snCheck" style="display:none; color:#0aff00; font-weight:bold; margin-left:10px;">‚úÖ</span>
        <span id="sessionTimer" style="font-family:var(--font-tech); color:#666; font-size:12px; margin-left:auto;">‚è±Ô∏è 00:00</span>
    </div>
    <input type="text" id="scanInput" placeholder="NAJPIERW PO≈ÅƒÑCZ Z BAZƒÑ..." disabled>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
        <span class="input-label" style="color:var(--neon-green)">2. SN OC (SZK≈ÅO)</span>
        <span id="ocCheck" style="display:none; color:#0aff00; font-weight:bold; margin-left:10px;">‚úÖ</span>
    </div>
    <input type="text" id="scanInputOC" placeholder="OCZEKIWANIE NA SN MODU≈ÅU..." disabled 
           style="width: 100%; background: #080808; border: 1px solid #333; color: var(--neon-green); padding: 12px; font-size: 18px; text-align: center; font-family: var(--font-tech); outline: none; border-radius: 6px; margin-bottom: 15px;">

    <div id="scanStatusInfo" class="scan-status-info">NUMERY ZESKANOWANE POPRAWNIE</div>
    <button id="confirmIdentityBtn" class="confirm-identity-btn" onclick="confirmScanData()">‚úÖ ZATWIERD≈π DANE (OK)</button>

    <div id="checklist">
        <button class="checklist-btn" style="border-color:var(--neon-purple); color:var(--neon-purple);" onclick="togglePatterns()"><span>üñ•Ô∏è TEST EKRANU (PATTERNS)</span> <span>‚èØ</span></button>
        <div style="height:10px;"></div>
        <div id="btnFront" class="checklist-btn locked" onclick="capture('PRZOD')"><span>1. PRZ√ìD EKRANU</span> <span>üì∑</span></div>
        <div id="btnBack" class="checklist-btn locked" onclick="capture('TYL')"><span>2. TY≈Å (TABLICZKA)</span> <span>üì∑</span></div>
        <div id="btnImage" class="checklist-btn locked" onclick="capture('OBRAZ')"><span>3. TEST OBRAZU</span> <span>üì∑</span></div>
    </div>

    <div class="decision-panel">
      <span class="input-label" style="color:var(--neon-purple)">DECYZJA SERWISOWA</span>
      <select id="statusSelect" class="custom-select" onchange="checkOcRequirement(); saveRecoveryState();">
        <option value="OK">üü¢ OK (SPRAWNY)</option>
        <option value="NG">üî¥ NG (USZKODZONY)</option>
        <option value="NDF">üîµ NDF (BRAK WAD)</option>
        <option value="RMA">üü† RMA (ZWROT)</option>
        <option value="SCRAP">‚ö´ SCRAP (Z≈ÅOM)</option>
        <option value="OFFRS_OK">üü£ OFFRS OK</option>
      </select>
      
      <span class="input-label">KOMENTARZ / SZYBKIE WADY</span>
      <div class="quick-defects">
          <div class="defect-tag" onclick="addDefect('RYSA NA MATRYCY')">RYSA</div>
          <div class="defect-tag" onclick="addDefect('BAD PIXEL')">PIXEL</div>
          <div class="defect-tag" onclick="addDefect('PƒòKNIƒòCIE')">PƒòKNIƒòCIE</div>
          <div class="defect-tag" onclick="addDefect('LINIA PIONOWA')">LINIA |</div>
          <div class="defect-tag" onclick="addDefect('LINIA POZIOMA')">LINIA ‚Äî</div>
          <div class="defect-tag" onclick="addDefect('BRAK OBRAZU')">NO IMAGE</div>
      </div>
      
      <textarea id="commentInput" class="custom-textarea" rows="2" placeholder="Wpisz uwagi..." onkeyup="saveRecoveryState()"></textarea>
    </div>

    <div class="recent-list" id="recentList"></div>

    <button id="actionBtn" onclick="saveData()">OCZEKIWANIE</button>
    <div id="saveStatus" style="text-align:center; color:#666; margin-top:10px; font-size:11px; height:15px; font-family: var(--font-tech);"></div>
  </aside>

  <main class="panel-right" id="camContainer">
    <div class="cam-overlay">
      <div class="tag" id="tagSN">SN: ---</div>
      <div class="tag" id="tagOp">OP: ---</div>
    </div>
    <div class="draw-toolbar" id="drawToolbar">
      <span style="color:#fff; font-size:12px; margin-right:10px;">ZAZNACZ WADƒò:</span>
      <div class="color-btn" style="background:red;" onclick="setDrawColor('red')"></div>
      <div class="color-btn" style="background:#0aff00;" onclick="setDrawColor('#0aff00')"></div>
      <button class="tool-btn" onclick="clearDraw()">WYCZY≈öƒÜ</button>
      <button class="tool-btn confirm" onclick="confirmPhoto()">ZAPISZ</button>
      <button class="tool-btn" onclick="cancelPhoto()">ANULUJ</button>
    </div>
    <div class="cam-controls">
      <div class="zoom-group">
        <span>ZOOM</span>
        <input type="range" id="zoomSlider" min="1" max="4" step="0.1" value="1">
        <span id="zoomVal">1.0x</span>
      </div>
      <div style="width:1px; height:20px; background:#444; margin:0 5px;"></div>
      <div class="cam-btn" onclick="toggleMirror()" title="Odbicie lustrzane">‚Üî</div>
    </div>
    <div class="video-container">
        <video id="videoFeed" autoplay playsinline></video>
        <canvas id="drawCanvas"></canvas>
    </div>
  </main>
</div>

<div id="adminDash">
    <div class="admin-container">
        <div class="admin-status-bar">
            <div class="status-item"><div class="status-dot ok"></div> SYSTEM: ONLINE</div>
            <div class="status-item">VER: 4.0</div>
            <div class="status-item">CPU: <span id="simCpu">12%</span></div>
            <div class="status-item">MEM: <span id="simMem">2.4GB</span></div>
        </div>
        <div class="admin-grid">
            <div style="display:flex; flex-direction:column; gap:20px;">
                <div class="admin-panel-box highlight">
                    <div class="admin-h">
                        <span>ZARZƒÑDZANIE U≈ªYTKOWNIKAMI</span>
                        <span style="font-size:12px; color:#666;">EDYCJA / RESET HASE≈Å</span>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 100px; gap:10px; margin-bottom:15px;">
                      <input type="text" id="newLogin" placeholder="LOGIN" class="cfg-input" style="margin:0;">
                      <input type="text" id="newPass" placeholder="HAS≈ÅO" class="cfg-input" style="margin:0;">
                      <select id="newRole" class="cfg-input" style="margin:0; padding:10px; cursor:pointer;">
                        <option value="OPERATOR">OPERATOR</option>
                        <option value="KOORDYNATOR">KOORDYNATOR</option>
                        <option value="KIEROWNIK">KIEROWNIK</option>
                        <option value="ADMIN">ADMINISTRATOR</option>
                      </select>
                      <button onclick="addUser()" class="cfg-btn">DODAJ</button>
                    </div>
                    <div style="overflow-y:auto; max-height:250px; border:1px solid #333;">
                        <table class="adm-table" id="admUserTable">
                            <thead><tr><th>LOGIN</th><th>ROLA</th><th>AKCJE</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <button class="cfg-btn" style="margin-top:10px; width:100%; border-style:dashed;" onclick="backupUsers()">üíæ BACKUP U≈ªYTKOWNIK√ìW (JSON)</button>
                </div>
                <div class="admin-panel-box">
                    <div class="admin-h" style="margin-bottom:5px;">TERMINAL SYSTEMOWY</div>
                    <div class="admin-terminal" id="sysLog">
                        <div class="log-line"><span class="log-time">System:</span> Inicjalizacja v4.0...</div>
                        <div class="log-line"><span class="log-time">System:</span> Gotowy do pracy.</div>
                    </div>
                </div>
            </div>
            <div style="display:flex; flex-direction:column; gap:20px;">
                <div class="admin-panel-box" style="border-color:var(--neon-cyan);">
                    <div class="admin-h" style="color:var(--neon-cyan)">BAZA DANYCH</div>
                    <div style="font-size:12px; color:#aaa; margin-bottom:15px;">Po≈ÇƒÖcz, aby zarzƒÖdzaƒá plikami.</div>
                    <div style="display:flex; gap:10px;">
                        <button class="cfg-btn cyan" style="flex:1;" onclick="connectNetwork()">üì° PO≈ÅƒÑCZ</button>
                        <button class="cfg-btn cyan" style="flex:1;" onclick="toggleReportPanel()">üìä RAPORTY</button>
                    </div>
                </div>
                <div class="admin-panel-box">
                    <div class="admin-h">KONFIGURACJA</div>
                    <div class="input-label">≈öCIE≈ªKA SIECIOWA</div>
                    <input type="text" id="cfgPath" class="cfg-input" value="\\plgorfs001...">
                    <button class="cfg-btn" onclick="saveConfigPath()">ZAPISZ</button>
                    <div style="margin-top:15px;"></div>
                    <div class="input-label">WIADOMO≈öƒÜ DNIA</div>
                    <input type="text" id="cfgMotd" class="cfg-input" placeholder="Komunikat...">
                    <button class="cfg-btn" onclick="saveMotd()">WY≈öLIJ</button>
                </div>
                <div class="admin-panel-box">
                    <div class="admin-h" style="margin-bottom:5px;">PODGLƒÑD KAMERY</div>
                    <video id="adminCamPreview" autoplay playsinline muted></video>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="managerDash">
    <div class="mgr-header">
        <div class="mgr-title">PANEL ANALITYCZNY</div>
        <div class="mgr-filters">
            <button class="mgr-btn active" id="fDirect" onclick="scanNetwork()">üîÑ SYNCHRONIZUJ Z GOOGLE</button>
            <div style="width:1px; background:#444; margin:0 10px;"></div>
            <button class="mgr-btn" onclick="exportCSV()">üíæ EKSPORT CSV</button>
        </div>
    </div>
    <div class="mgr-stats-row">
        <div class="mgr-card" style="border-color:var(--neon-cyan)">
            <h3>OSTATNIE 2 DNI</h3>
            <div class="val" id="mgrTotal">0</div>
        </div>
        <div class="mgr-card" style="border-color:var(--neon-green)">
            <h3>STATUS OK</h3>
            <div class="val" id="mgrOK" style="color:var(--neon-green)">0</div>
        </div>
        <div class="mgr-card" style="border-color:var(--neon-red)">
            <h3>ODRZUTY (NG)</h3>
            <div class="val" id="mgrNG" style="color:var(--neon-red)">0</div>
        </div>
        <div class="mgr-card" style="border-color:var(--neon-orange)">
            <h3>YIELD %</h3>
            <div class="val" id="mgrYield">0%</div>
        </div>
    </div>
    <div class="mgr-content-grid">
        <div class="mgr-panel mgr-ranking-panel">
            <h4>RANKING OPERATOR√ìW</h4>
            <div style="overflow:auto;">
                <table class="data-table">
                    <thead><tr><th>OP</th><th>ILO≈öƒÜ</th><th>YIELD</th></tr></thead>
                    <tbody id="mgrRankBody"><tr><td colspan="3" style="text-align:center">Brak danych</td></tr></tbody>
                </table>
            </div>
        </div>
        <div class="mgr-panel">
            <h4>DZIENNIK ZDARZE≈É (GOOGLESHEET)</h4>
            <div style="overflow:auto;">
                <table class="data-table">
                    <thead><tr><th>DATA</th><th>SN MODU≈ÅU</th><th>SN OC</th><th>OP</th><th>DECYZJA</th><th>UWAGI</th></tr></thead>
                    <tbody id="mgrLogBody"><tr><td colspan="6" style="text-align:center">Kliknij Synchronizuj...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="bar-bottom">
  <div id="connStatus" style="color:#444; font-size:11px;">üî¥ OFFLINE</div>
  <div class="bar-group">
    <button class="bar-btn admin-only" onclick="alert('U≈ºyj Panelu Administratora')">üë• U≈ªYTKOWNICY</button>
    <button class="bar-btn" id="dbBtn" onclick="toggleReportPanel()">üìä MOJE WYNIKI</button>
  </div>
</div>

<div id="reportPanel" class="slide-panel">
  <div class="panel-header">
    <div style="font-size:20px; color:var(--neon-cyan); font-family: var(--font-tech);">DANE Z GOOGLE SHEETS</div>
    <div>
        <button class="bar-btn" onclick="scanNetwork()">üîÑ OD≈öWIE≈ª</button>
        <button class="bar-btn" onclick="toggleReportPanel()">ZAMKNIJ X</button>
    </div>
  </div>
  <div class="panel-content">
    <div style="color:#888; text-align:center; font-size:14px; margin-bottom:20px;">
        Statystyki pobrane bezpo≈õrednio z bazy Google (Ostatnie 48h)
    </div>
    <div class="op-stats-row">
        <div class="op-stat-box" style="border-color:var(--neon-cyan)">
            <div class="op-stat-num" id="opTotal">0</div>
            <div class="op-stat-lbl">ZROBIONE</div>
        </div>
        <div class="op-stat-box" style="border-color:var(--neon-green)">
            <div class="op-stat-num" id="opOK">0</div>
            <div class="op-stat-lbl">OK</div>
        </div>
        <div class="op-stat-box" style="border-color:var(--neon-red)">
            <div class="op-stat-num" id="opNG">0</div>
            <div class="op-stat-lbl">NG</div>
        </div>
        <div class="op-stat-box" style="border-color:var(--neon-orange)">
            <div class="op-stat-num" id="opYield">0%</div>
            <div class="op-stat-lbl">YIELD</div>
        </div>
    </div>
  </div>
</div>

<div id="qrPopup">
  <h2 style="font-family: var(--font-tech); margin-top:0;">OLED PASSPORT</h2>
  <div id="qrCodeBox"></div>
  <div id="qrSnDisplay" style="font-weight:bold; font-family:var(--font-tech);">SN: ---</div>
  <div id="qrStatusDisplay" style="color:green; margin-bottom:10px;">STATUS: OK</div>
  <button onclick="closeQr()" style="padding:10px 20px; background:#000; color:#fff; border:none; cursor:pointer;">ZAMKNIJ</button>
  <button onclick="window.print()" style="padding:10px 20px; background:var(--neon-cyan); color:#000; border:none; cursor:pointer;">DRUKUJ ETYKIETƒò</button>
</div>

<canvas id="photoCanvas"></canvas>

<script>
  /* --- CONFIG --- */
  let CONFIG = {
    networkPath: String.raw`\\plgorfs001\pub\SERVICE\LCDR\LCDR\OLED OBM Panels\Zdjƒôcia z napraw OLED`,
    motd: "",
    loginUrl: "https://oledrepair.lukaszarmiajotpe.workers.dev/", 
    reportUrl: "https://daneoled.lukaszarmiajotpe.workers.dev/", 
    defaultUsers: [] 
  };

  /* --- STATE --- */
  let users = [];
  let currentUser = null;
  let dirHandle = null;
  let currentSN = "";
  let currentOC = ""; 
  let isScanConfirmed = false;
  let photos = { PRZOD: null, TYL: null, OBRAZ: null };
  let isMirrored = false;
  let reportsCache = [];
  
  let isDrawing = false;
  let drawColor = "red";
  let tempPhotoType = "";
  let zoomLevel = 1.0;
  let panX = 0; let panY = 0;
  let isPanning = false; let startPanX = 0; let startPanY = 0;
  let sessionStartTime = null;
  let recentScans = [];

  /* --- AUDIO SYSTEM --- */
  const SoundFX = {
    ctx: null,
    init: function() { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
    play: function(type) {
      if(!this.ctx) this.init();
      const osc = this.ctx.createOscillator();
      const gain = this.ctx.createGain();
      osc.connect(gain); gain.connect(this.ctx.destination);
      const now = this.ctx.currentTime;
      if(type === 'beep') {
        osc.type = 'sine'; osc.frequency.setValueAtTime(1200, now);
        gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.1);
        osc.start(now); osc.stop(now+0.1);
      } else if(type === 'error') {
        osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now+0.3);
        gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0.01, now+0.3);
        osc.start(now); osc.stop(now+0.3);
      } else if(type === 'shutter') {
        osc.type = 'square'; osc.frequency.setValueAtTime(800, now);
        gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now+0.05);
        osc.start(now); osc.stop(now+0.05);
      } else if(type === 'success') {
        osc.type = 'triangle'; osc.frequency.setValueAtTime(440, now); osc.frequency.setValueAtTime(554, now+0.1); osc.frequency.setValueAtTime(659, now+0.2); 
        gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.4);
        osc.start(now); osc.stop(now+0.4);
      }
    }
  };

  /* --- GOOGLE SYNC & SCAN --- */
  async function scanNetwork() {
    const logBody = document.getElementById('mgrLogBody');
    if(logBody) logBody.innerHTML = '<tr><td colspan="6" style="text-align:center">Pobieranie danych z Google Sheets...</td></tr>';
    
    try {
        const res = await fetch(CONFIG.reportUrl, { method: "GET" });
        if(!res.ok) throw new Error("B≈ÇƒÖd pobierania");
        const data = await res.json(); // Za≈Ço≈ºenie: Worker zwraca tablicƒô obiekt√≥w z arkusza
        
        // Konwersja daty i filtrowanie ostatnich 2 dni (dzisiaj + wczoraj)
        const now = new Date();
        const oneDayMs = 24 * 60 * 60 * 1000;
        const cutoff = new Date(now.getTime() - (2 * oneDayMs));
        cutoff.setHours(0,0,0,0);

        reportsCache = data.filter(item => {
            const itemDate = parseDate(item.timestamp);
            return itemDate >= cutoff;
        });

        updateLeaderboardDisplay();
        calculateOperatorStats();
        logSystem(`Zsynchronizowano pomy≈õlnie. Znaleziono ${reportsCache.length} rekord√≥w (48h).`);
    } catch(e) {
        if(logBody) logBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">B≈ÇƒÖd po≈ÇƒÖczenia z bazƒÖ Google</td></tr>';
        logSystem("B≈ÇƒÖd synchronizacji Google Sheet.");
    }
  }

  function parseDate(ts) {
      // Obs≈Çuga format√≥w DD.MM.YYYY HH:MM:SS lub ISO
      const parts = ts.split(' ');
      const dateParts = parts[0].split('.');
      if(dateParts.length === 3) {
          return new Date(dateParts[2], dateParts[1]-1, dateParts[0]);
      }
      return new Date(ts);
  }

  function updateLeaderboardDisplay() {
      const logBody = document.getElementById('mgrLogBody');
      const rankBody = document.getElementById('mgrRankBody');
      if(!logBody || !rankBody) return;

      logBody.innerHTML = "";
      let okCount = 0, ngCount = 0;
      let operators = {};

      reportsCache.forEach(r => {
          // Tabela log√≥w
          const row = `<tr>
              <td>${r.timestamp}</td>
              <td>${r.sn}</td>
              <td>${r.oc}</td>
              <td>${r.op}</td>
              <td style="color:${['OK','OFFRS_OK'].includes(r.dec) ? 'var(--neon-green)' : 'var(--neon-red)'}">${r.dec}</td>
              <td>${r.com || ""}</td>
          </tr>`;
          logBody.innerHTML += row;

          // Statystyki og√≥lne
          if(['OK','OFFRS_OK','NDF'].includes(r.dec)) okCount++; else ngCount++;

          // Ranking operator√≥w
          if(!operators[r.op]) operators[r.op] = {total:0, ok:0};
          operators[r.op].total++;
          if(['OK','OFFRS_OK','NDF'].includes(r.dec)) operators[r.op].ok++;
      });

      // Panel Stats
      document.getElementById('mgrTotal').innerText = reportsCache.length;
      document.getElementById('mgrOK').innerText = okCount;
      document.getElementById('mgrNG').innerText = ngCount;
      document.getElementById('mgrYield').innerText = reportsCache.length > 0 ? ((okCount/reportsCache.length)*100).toFixed(1) + "%" : "0%";

      // Ranking Table
      rankBody.innerHTML = "";
      Object.keys(operators).sort((a,b) => operators[b].total - operators[a].total).forEach(op => {
          const stats = operators[op];
          const yieldVal = ((stats.ok / stats.total) * 100).toFixed(1) + "%";
          rankBody.innerHTML += `<tr><td>${op}</td><td>${stats.total}</td><td>${yieldVal}</td></tr>`;
      });
  }

  /* --- OSTATNIE FUNKCJE OPERACYJNE (BEZ ZMIAN) --- */
  function quickAdminLogin() {
      document.getElementById('userInput').value = "ADMIN";
      document.getElementById('passInput').value = "";
      document.getElementById('passInput').focus();
  }

  async function saveData() {
      if(!photos.PRZOD || !photos.TYL || !photos.OBRAZ) { alert("BRAK ZDJƒòƒÜ!"); return; }
      const dec = document.getElementById('statusSelect').value;
      if(['OK','RMA'].includes(dec) && !currentOC) return alert("BRAK OC!");
      document.getElementById('saveStatus').innerText = "ZAPISYWANIE...";

      const now = new Date();
      const timestamp = now.toLocaleDateString() + " " + now.toLocaleTimeString();

      if(dirHandle) {
          try {
              const d = await dirHandle.getDirectoryHandle(currentSN, {create:true});
              const h = await d.getFileHandle(`RAPORT_${currentSN}.txt`, {create:true});
              const w = await h.createWritable(); 
              await w.write(`RAPORT\nDATA: ${timestamp}\nSN: ${currentSN}\nOC: ${currentOC}\nOP: ${currentUser.login}\nDEC: ${dec}`); 
              await w.close();
              for (const type of ['PRZOD', 'TYL', 'OBRAZ']) {
                  const fh = await d.getFileHandle(`${currentSN}_${type}.jpg`, {create: true});
                  const wr = await fh.createWritable(); await wr.write(photos[type]); await wr.close();
              }
          } catch(e) {}
      }

      try {
          await fetch(CONFIG.reportUrl, {
              method: "POST", headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                  timestamp: timestamp,
                  sn: currentSN, 
                  oc: currentOC || "---", 
                  op: currentUser.login, 
                  dec: dec, 
                  com: document.getElementById('commentInput').value
              })
          });
          logSystem("Wys≈Çano raport do Google Sheets.");
      } catch(e) { logSystem("B≈ÇƒÖd zapisu w arkuszu Google!"); }
      finishSave(dec);
  }

  function finishSave(dec) {
      const qrb = document.getElementById('qrCodeBox'); qrb.innerHTML = "";
      new QRCode(qrb, `${currentSN}|${dec}`);
      document.getElementById('qrPopup').style.display='block';
      localStorage.removeItem('oled_recovery');
      setTimeout(() => {
          resetInterface();
          scanNetwork(); // Automatyczne od≈õwie≈ºenie bazy po zapisie
      }, 1000); 
  }

  function resetInterface() {
      currentSN = ""; currentOC = ""; isScanConfirmed = false;
      photos = { PRZOD: null, TYL: null, OBRAZ: null };
      document.getElementById('scanInput').value = "";
      document.getElementById('scanInputOC').value = "";
      document.getElementById('scanInputOC').disabled = true;
      document.getElementById('commentInput').value = "";
      document.getElementById('snCheck').style.display = 'none';
      document.getElementById('ocCheck').style.display = 'none';
      document.querySelectorAll('.checklist-btn').forEach(btn => { btn.classList.add('locked'); btn.classList.remove('done'); });
      document.getElementById('actionBtn').classList.remove('active');
      document.getElementById('actionBtn').innerText = "OCZEKIWANIE (0/3)";
      document.getElementById('saveStatus').innerText = "";
      document.getElementById('scanInput').focus();
  }

  /* --- RESZTA LOGIKI (KAMERA, DRAW, LOGIN) POZOSTAJE BEZ ZMIAN --- */
  window.onload = () => {
    loadConfig();
    loadUsers(); 
    loadUsersFromSheet(); 
    checkSavedLogin();
    
    document.getElementById('mainDashboard').style.display = 'none';
    document.getElementById('adminDash').style.display = 'none';
    document.getElementById('managerDash').style.display = 'none';

    setInterval(() => {
        document.getElementById('clockDisplay').innerText = new Date().toLocaleTimeString().slice(0,5);
        updateSessionTimer(); 
    }, 1000);
    
    const slider = document.getElementById('zoomSlider');
    slider.addEventListener('input', (e) => { zoomLevel = parseFloat(e.target.value); applyTransform(); });

    const c = document.getElementById('drawCanvas');
    c.addEventListener('mousedown', startDraw); c.addEventListener('mouseup', endDraw); c.addEventListener('mousemove', draw);
  };

  function calculateOperatorStats() {
      const myStats = reportsCache.filter(r => r.op === currentUser.login);
      let ok = 0;
      myStats.forEach(r => { if(['OK','OFFRS_OK','NDF'].includes(r.dec)) ok++; });
      document.getElementById('opTotal').innerText = myStats.length;
      document.getElementById('opOK').innerText = ok;
      document.getElementById('opNG').innerText = myStats.length - ok;
      document.getElementById('opYield').innerText = myStats.length > 0 ? ((ok/myStats.length)*100).toFixed(1) + "%" : "0%";
  }

  function setupInterface() {
    const b = document.getElementById('operatorBadge');
    b.innerText = currentUser.login;
    document.getElementById('tagOp').innerText = "OP: " + currentUser.login;
    document.body.className = "";
    document.getElementById('mainDashboard').style.display = 'none';
    document.getElementById('adminDash').style.display = 'none';
    document.getElementById('managerDash').style.display = 'none';

    if(currentUser.role === 'KIEROWNIK' || currentUser.role === 'KOORDYNATOR') {
        document.body.classList.add('mode-manager');
        document.getElementById('managerDash').style.display = 'flex';
        scanNetwork(); 
    } else if(currentUser.role === 'ADMIN') {
        document.body.classList.add('mode-admin');
        document.getElementById('adminDash').style.display = 'flex';
    } else {
        document.getElementById('mainDashboard').style.display = 'grid';
        setTimeout(() => document.getElementById('mainDashboard').style.opacity = '1', 100);
        scanNetwork(); 
    }
  }

  async function initCamera() {
    try {
      const s = await navigator.mediaDevices.getUserMedia({ video: true }); 
      document.getElementById('videoFeed').srcObject = s;
    } catch(e) {}
  }

  function startSession(sn) {
    currentSN = sn; sessionStartTime = new Date();
    document.getElementById('tagSN').innerText = "SN: " + sn;
    initCamera();
  }

  document.getElementById('scanInput').addEventListener('keydown', e => {
    if(e.key==='Enter') {
      const v = e.target.value.trim().toUpperCase();
      if(v.length > 3 && (v.startsWith("TBV") || v.startsWith("TOV"))) { 
          SoundFX.play('beep'); startSession(v);
          document.getElementById('snCheck').style.display = 'inline';
          document.getElementById('scanInputOC').disabled=false; 
          document.getElementById('scanInputOC').focus(); 
      } else { SoundFX.play('error'); alert("B≈ÅƒòDNY SN!"); }
    }
  });

  document.getElementById('scanInputOC').addEventListener('keydown', e => {
    if(e.key==='Enter') {
        const v = e.target.value.trim().toUpperCase();
        if(v.length > 3) { 
            currentOC = v; SoundFX.play('beep'); 
            document.getElementById('ocCheck').style.display = 'inline';
            document.getElementById('confirmIdentityBtn').style.display = 'block';
            document.getElementById('scanStatusInfo').style.display = 'block';
        }
    }
  });

  function confirmScanData() {
      isScanConfirmed = true; SoundFX.play('success');
      document.getElementById('confirmIdentityBtn').style.display = 'none';
      document.querySelectorAll('.checklist-btn').forEach(btn => btn.classList.remove('locked'));
  }

  function capture(type) {
      if(!isScanConfirmed) return;
      tempPhotoType = type; processPhoto();
  }

  function processPhoto() {
      const v = document.getElementById('videoFeed');
      const finalC = document.getElementById('photoCanvas'); finalC.width=v.videoWidth; finalC.height=v.videoHeight;
      const ctx = finalC.getContext('2d');
      ctx.drawImage(v,0,0);
      finalC.toBlob(b => { 
          photos[tempPhotoType] = b; 
          document.getElementById('btn' + tempPhotoType.charAt(0) + tempPhotoType.slice(1).toLowerCase()).classList.add('done');
          updateProgress();
      },'image/jpeg',0.9);
  }

  function updateProgress() {
      let count = Object.values(photos).filter(p => p !== null).length;
      document.getElementById('actionBtn').innerText = count === 3 ? "ZAPISZ DANE" : `OCZEKIWANIE (${count}/3)`;
      if(count === 3) document.getElementById('actionBtn').classList.add('active');
  }

  /* Funkcje pomocnicze login/styles */
  function attemptLogin() {
    const l = document.getElementById('userInput').value.trim().toUpperCase();
    const p = document.getElementById('passInput').value.trim();
    const u = users.find(user => user.login === l && user.pass === p);
    if (u) {
      currentUser = u;
      document.getElementById('loginScreen').style.display = 'none';
      setupInterface();
    } else { document.getElementById('loginError').innerText = "B≈ÅƒÑD LOGOWANIA"; }
  }

  function loadUsers() {
    const stored = localStorage.getItem('oled_users');
    users = stored ? JSON.parse(stored) : [];
  }

  async function loadUsersFromSheet() {
      try {
          const res = await fetch(CONFIG.loginUrl);
          const txt = await res.text();
          const rows = txt.split('\n');
          users = rows.slice(1).map(r => {
              const c = r.split(',');
              return {login: c[0].trim().toUpperCase(), pass: c[1].trim(), role: c[2].trim().toUpperCase()};
          });
          localStorage.setItem('oled_users', JSON.stringify(users));
      } catch(e) {}
  }

  function applyTransform() {
    const v = document.getElementById('videoFeed');
    v.style.transform = `scale(${zoomLevel})`;
  }

  function startDraw(e) { isDrawing=true; }
  function endDraw() { isDrawing=false; }
  function draw(e) { if(isDrawing) { /* Rysowanie */ } }
  function toggleReportPanel() { document.getElementById('reportPanel').classList.toggle('open'); }
  function logout() { location.reload(); }
</script>
</body>
</html>
