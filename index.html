<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>OLED REPAIR v3.1 (FULL SYSTEM)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap&subset=latin-ext" rel="stylesheet">
  
  <style>
    /* --- CONFIG & VARIABLES --- */
    :root {
      --bg-deep: #050505;
      --panel-glass: rgba(20, 25, 35, 0.95);
      --neon-cyan: #00f3ff;
      --neon-green: #0aff00;
      --neon-red: #ff003c;
      --neon-gold: #ffd700;
      --neon-purple: #bc13fe;
      --neon-orange: #ff9d00;
      
      --font-ui: 'Roboto', sans-serif;
      --font-tech: 'Oxanium', cursive;
    }
    
    * { box-sizing: border-box; user-select: none; }
    
    body {
      margin: 0; background-color: var(--bg-deep); color: #fff;
      font-family: var(--font-ui); height: 100vh; overflow: hidden;
      display: flex; flex-direction: column;
      background-image: 
        linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
    }

    /* --- LOGIN SCREEN --- */
    #loginScreen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999;
      display: flex; align-items: center; justify-content: center; flex-direction: column; transition: opacity 0.8s;
    }
    .login-box {
      width: 450px; padding: 40px; background: rgba(10, 10, 10, 0.95); border: 1px solid var(--neon-cyan);
      text-align: center; border-radius: 12px; position: relative; overflow: hidden;
      box-shadow: 0 0 60px rgba(0, 243, 255, 0.1); backdrop-filter: blur(10px);
    }
    .login-box h2 { font-family: var(--font-tech); font-weight: 700; letter-spacing: 1px; margin-bottom: 5px; }
    .login-input {
      width: 100%; padding: 15px; margin: 10px 0; background: #080808; border: 1px solid #333; color: var(--neon-cyan);
      font-family: var(--font-tech); font-size: 18px; text-align: center; outline: none; transition: 0.3s;
    }
    .login-input:focus { border-color: var(--neon-cyan); background: #111; }
    input[type="password"] { letter-spacing: 5px; color: var(--neon-red); }
    .login-btn {
      width: 100%; padding: 15px; margin-top: 20px; background: var(--neon-cyan); color: #000; font-weight: bold; border: none;
      cursor: pointer; font-family: var(--font-tech); transition: 0.3s; font-size: 16px; letter-spacing: 2px;
    }
    .login-btn:hover { background: #fff; box-shadow: 0 0 30px var(--neon-cyan); }
    .login-error { color: var(--neon-red); font-size: 12px; height: 20px; margin-top: 10px; font-weight: bold; font-family: var(--font-ui); }
    
    .sync-status {
        color: #666; font-size: 11px; margin-top: 10px; font-family: monospace; height: 15px;
    }
    .sync-status.ok { color: var(--neon-green); }
    .sync-status.err { color: var(--neon-red); }

    .remember-me {
        display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; font-size: 14px; color: #aaa;
    }
    .remember-me input { transform: scale(1.5); accent-color: var(--neon-cyan); cursor: pointer; }
    
    .emergency-reset {
        position: absolute; bottom: 20px; left: 20px; color: #333; font-size: 10px; cursor: pointer;
        border: 1px solid #222; padding: 5px; font-family: var(--font-tech); transition: 0.3s;
    }
    .emergency-reset:hover { color: var(--neon-red); border-color: var(--neon-red); }

    /* --- NETWORK GUARD --- */
    #networkGuard {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.95); z-index: 8000; backdrop-filter: blur(15px);
      display: none; align-items: center; justify-content: center; flex-direction: column;
    }
    .alert-box {
      width: 600px; padding: 40px; border: 2px solid var(--neon-red); background: #050505;
      text-align: center; border-radius: 12px; box-shadow: 0 0 100px rgba(255, 0, 60, 0.2);
    }
    .path-box {
      background:#111; padding:15px; border:1px dashed #555; font-size:12px; color:#fff; 
      font-family:var(--font-tech); margin-top: 5px; word-break: break-all;
    }
    .guard-btn {
      width: 100%; padding: 20px; background: var(--neon-red); color: #fff; font-weight: bold;
      border: none; cursor: pointer; font-family: var(--font-tech); font-size: 18px; margin-top: 20px;
    }
    .offline-btn {
        width: 100%; padding: 15px; background: transparent; color: var(--neon-orange); border: 1px solid var(--neon-orange);
        font-family: var(--font-tech); cursor: pointer; margin-top: 10px; font-weight: bold; transition: 0.3s;
    }
    .offline-btn:hover { background: var(--neon-orange); color: #000; }

    /* --- HEADER --- */
    header {
      height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 30px;
      background: rgba(0,0,0,0.8); border-bottom: 1px solid #333;
    }
    .brand { font-family: var(--font-tech); font-size: 28px; font-weight: 700; color: #fff; letter-spacing: 2px; }
    .brand span { color: var(--neon-cyan); text-shadow: 0 0 10px var(--neon-cyan); }
    .operator-info { display: flex; align-items: center; gap: 20px; font-family: var(--font-tech); color: #aaa; font-size: 14px; }
    
    .operator-badge { background: #1a1a1a; padding: 6px 15px; border-radius: 4px; border: 1px solid #444; color: var(--neon-cyan); transition:0.3s; font-weight: bold; }
    .operator-badge.admin { border-color: var(--neon-gold); color: var(--neon-gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.1); }
    .operator-badge.coord { border-color: var(--neon-purple); color: var(--neon-purple); box-shadow: 0 0 15px rgba(188, 19, 254, 0.2); }
    .operator-badge.manager { border-color: #fff; color: #fff; background: var(--neon-red); box-shadow: 0 0 20px var(--neon-red); }

    .logout-btn {
        background: transparent; border: 1px solid #444; color: var(--neon-red); padding: 5px 10px; 
        font-family: var(--font-tech); font-size: 12px; cursor: pointer; border-radius: 4px; transition: 0.3s;
    }
    .logout-btn:hover { background: var(--neon-red); color: #fff; }

    /* MESSAGE OF THE DAY */
    #motdBar {
        width: 100%; background: #220000; color: var(--neon-red); text-align: center; 
        font-family: var(--font-tech); font-weight: bold; padding: 5px; font-size: 14px;
        border-bottom: 1px solid var(--neon-red); display: none; animation: pulseRed 3s infinite;
    }
    @keyframes pulseRed { 0% {opacity:0.8;} 50% {opacity:1;} 100% {opacity:0.8;} }

    /* --- DASHBOARDS --- */
    .dashboard {
      flex: 1; display: grid; grid-template-columns: 420px 1fr; gap: 20px; padding: 20px; overflow: hidden;
      opacity: 0; transition: opacity 1s;
    }
    
    /* MODES */
    body.mode-admin .dashboard { display: none !important; }
    body.mode-admin #adminDash { display: flex !important; }
    body.mode-manager .dashboard { display: none !important; }
    body.mode-manager #managerDash { display: flex !important; }
    
    /* Hide bottom bar for Manager */
    body.mode-manager .bar-bottom { display: none !important; } 

    .panel-left {
      background: var(--panel-glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px;
      display: flex; flex-direction: column; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
    .panel-right {
      position: relative; background: #000; border: 2px solid #333; border-radius: 12px; overflow: hidden;
      box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
      cursor: grab;
    }
    .panel-right:active { cursor: grabbing; }

    /* --- ADMIN DASHBOARD --- */
    #adminDash {
        display: none; flex: 1; padding: 40px; flex-direction: column; overflow-y: auto; gap: 20px;
        align-items: center; background: radial-gradient(circle at center, #111, #000);
    }
    .admin-container { width: 100%; max-width: 1600px; display: flex; flex-direction: column; gap: 20px; }
    .admin-status-bar { display: flex; justify-content: space-between; background: #0a0a0a; border: 1px solid #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .status-item { display: flex; align-items: center; gap: 10px; font-family: var(--font-tech); font-size: 14px; color: #888; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #333; }
    .status-dot.ok { background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }
    .admin-grid { display: grid; grid-template-columns: 1fr 380px; gap: 25px; width: 100%; }
    .admin-panel-box { background: rgba(10, 10, 10, 0.9); border: 1px solid #333; padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); backdrop-filter: blur(5px); display: flex; flex-direction: column; }
    .admin-panel-box.highlight { border-color: var(--neon-gold); box-shadow: 0 0 20px rgba(255, 215, 0, 0.1); }
    .admin-h { font-family: var(--font-tech); color: var(--neon-gold); font-size: 20px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; display:flex; justify-content:space-between; align-items:center; letter-spacing: 1px; }
    .cfg-input { width: 100%; background: #000; color: #fff; border: 1px solid #444; padding: 12px; margin-bottom: 10px; font-family: monospace; font-size: 14px; }
    .cfg-btn { background: #222; color: #fff; border: 1px solid #555; padding: 10px 20px; font-weight:bold; cursor:pointer; font-family: var(--font-tech); transition:0.3s; font-size: 13px; text-transform: uppercase; }
    .cfg-btn:hover { background: var(--neon-gold); color: #000; border-color: var(--neon-gold); box-shadow: 0 0 15px var(--neon-gold); }
    .cfg-btn.cyan:hover { background: var(--neon-cyan); color: #000; border-color: var(--neon-cyan); box-shadow: 0 0 15px var(--neon-cyan); }
    .adm-table { width: 100%; border-collapse: collapse; }
    .adm-table th { text-align: left; border-bottom: 2px solid #444; color: var(--neon-cyan); padding: 10px; font-size: 12px; }
    .adm-table td { border-bottom: 1px solid #222; padding: 12px 10px; font-size: 14px; }
    .adm-btn-group { display: flex; gap: 8px; }
    .adm-act-btn { padding: 5px 10px; font-size: 11px; cursor: pointer; border: 1px solid #444; background: #000; color: #aaa; transition: 0.2s; }
    .adm-act-btn:hover { border-color: #fff; color: #fff; }
    .admin-terminal { background: #000; border: 1px solid #333; height: 200px; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; color: #0f0; margin-top: 20px; }
    .log-line { margin-bottom: 4px; border-bottom: 1px dashed #222; padding-bottom: 2px; }
    .log-time { color: #666; margin-right: 10px; }
    #adminCamPreview { width: 100%; height: 200px; background: #000; border: 1px solid var(--neon-cyan); object-fit: cover; margin-top: 10px; border-radius: 4px; box-shadow: 0 0 15px rgba(0,243,255,0.1); }

    /* --- MANAGER DASHBOARD --- */
    #managerDash { flex: 1; padding: 30px; flex-direction: column; overflow-y: auto; gap: 20px; background: radial-gradient(circle at top, #111, #000); }
    .mgr-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 20px; }
    .mgr-title { font-size: 32px; font-family: var(--font-tech); color: #fff; text-shadow: 0 0 20px var(--neon-cyan); display:flex; align-items:center; }
    .mgr-filters { display: flex; gap: 10px; background: #111; padding: 10px; border-radius: 8px; border: 1px solid #333; align-items:center; }
    .mgr-btn { background: transparent; border: 1px solid #555; color: #aaa; padding: 10px 25px; font-family: var(--font-tech); cursor: pointer; transition: 0.3s; font-size: 14px; }
    .mgr-btn:hover { border-color: #fff; color: #fff; }
    .mgr-btn.active { background: var(--neon-cyan); color: #000; border-color: var(--neon-cyan); font-weight: bold; box-shadow: 0 0 20px rgba(0,243,255,0.3); }
    
    .mgr-connect-btn {
        margin-left: 20px; 
        background: var(--neon-green); 
        color: #000; 
        border: 1px solid var(--neon-green); 
        padding: 10px 20px; 
        font-weight: bold; 
        font-family: var(--font-tech); 
        cursor: pointer; 
        box-shadow: 0 0 15px rgba(10,255,0,0.3);
        transition: 0.3s;
    }
    .mgr-connect-btn:hover {
        background: #fff;
        border-color: #fff;
        box-shadow: 0 0 25px rgba(255,255,255,0.6);
    }

    .mgr-stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 20px; }
    .mgr-card { background: rgba(20,20,20,0.8); border: 1px solid #333; padding: 25px; border-radius: 12px; text-align: center; backdrop-filter: blur(10px); position: relative; overflow: hidden; }
    .mgr-card h3 { font-size: 14px; color: #888; margin: 0 0 10px 0; letter-spacing: 1px; }
    .mgr-card .val { font-size: 48px; font-weight: bold; font-family: var(--font-tech); color: #fff; }
    .mgr-content-grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; flex: 1; min-height: 400px; margin-top: 20px; }
    .mgr-panel { background: #0a0a0a; border: 1px solid #333; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; }
    .mgr-panel h4 { margin: 0 0 20px 0; color: var(--neon-gold); font-family: var(--font-tech); border-bottom: 1px solid #222; padding-bottom: 10px; }
    .data-table { width: 100%; border-collapse: collapse; font-size: 13px; color: #ccc; font-family: var(--font-tech); }
    .data-table th { text-align: left; padding: 10px; background: #151515; color: #888; border-bottom: 1px solid #444; position: sticky; top: 0; }
    .data-table td { padding: 10px; border-bottom: 1px solid #222; }
    .data-table tr:hover { background: rgba(255,255,255,0.05); }

    /* VIDEO & ZOOM LOGIC */
    .video-container { width: 100%; height: 100%; overflow: hidden; position: relative; display: flex; justify-content: center; align-items: center; }
    video { width: 100%; height: 100%; object-fit: contain; transition: transform 0.1s linear; transform-origin: center center; }
    #drawCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 60; cursor: crosshair; display: none; }
    .draw-toolbar { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100; display: none; background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 30px; border: 1px solid var(--neon-cyan); backdrop-filter: blur(5px); }
    .color-btn { width: 25px; height: 25px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; display: inline-block; margin: 0 5px; }
    .tool-btn { background: transparent; border: 1px solid #aaa; color: #fff; padding: 5px 12px; cursor: pointer; font-family: var(--font-tech); font-size: 12px; margin-left: 10px; border-radius: 4px; }
    .tool-btn.confirm { background: var(--neon-cyan); color: #000; border-color: var(--neon-cyan); font-weight: bold; }
    .cam-controls { position: absolute; bottom: 20px; right: 20px; z-index: 50; display: flex; gap: 15px; align-items: center; background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 30px; border: 1px solid #333; backdrop-filter: blur(5px); }
    .cam-btn { background: transparent; border: 1px solid var(--neon-cyan); color: var(--neon-cyan); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; transition: 0.2s; }
    .cam-btn:hover { background: var(--neon-cyan); color: #000; }
    .zoom-group { display: flex; align-items: center; gap: 10px; font-family: var(--font-tech); font-size: 12px; color: var(--neon-cyan); }
    input[type=range] { -webkit-appearance: none; width: 100px; height: 4px; background: #333; border-radius: 2px; outline: none; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--neon-cyan); cursor: pointer; box-shadow: 0 0 10px var(--neon-cyan); }

    /* UI ELEMENTS */
    .input-label { font-size: 11px; color: var(--neon-cyan); letter-spacing: 1px; margin-bottom: 5px; display: block; font-weight: bold; font-family: var(--font-tech); }
    #scanInput { width: 100%; background: #080808; border: 1px solid #444; color: #fff; padding: 12px; font-size: 22px; text-align: center; font-family: var(--font-tech); outline: none; border-radius: 6px; margin-bottom: 15px; }
    #scanInput:focus { border-color: var(--neon-cyan); box-shadow: 0 0 20px rgba(0, 243, 255, 0.2); }
    .checklist-btn { width: 100%; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); color: #888; padding: 12px; margin-bottom: 8px; cursor: pointer; text-align: left; font-family: var(--font-ui); display: flex; justify-content: space-between; transition: 0.2s; font-size: 14px; border-radius: 6px; font-weight: 500; }
    .checklist-btn:hover { background: rgba(255,255,255,0.05); color: #fff; border-color: #fff; }
    .checklist-btn.done { border-color: var(--neon-green); color: var(--neon-green); background: rgba(10,255,0,0.1); font-weight: 700; }
    .decision-panel { border-top: 1px solid #333; margin-top: 10px; padding-top: 15px; }
    .custom-select { width: 100%; background: #080808; color: #fff; border: 1px solid var(--neon-purple); padding: 10px; font-family: var(--font-tech); font-size: 14px; border-radius: 5px; outline: none; cursor: pointer; margin-bottom: 10px; }
    .custom-textarea { width: 100%; background: #080808; color: #ccc; border: 1px solid #444; padding: 10px; font-family: var(--font-ui); font-size: 14px; border-radius: 5px; outline: none; resize: vertical; margin-bottom: 10px; }
    .custom-textarea:focus { border-color: var(--neon-cyan); color: #fff; }
    #actionBtn { margin-top: auto; padding: 15px; width: 100%; background: #111; color: #444; font-weight: bold; border: none; font-size: 16px; cursor: not-allowed; border-radius: 6px; text-transform: uppercase; letter-spacing: 1px; font-family: var(--font-tech); }
    #actionBtn.active { background: var(--neon-green); color: #000; cursor: pointer; animation: pulseBtn 2s infinite; box-shadow: 0 0 20px var(--neon-green); }
    @keyframes pulseBtn { 0% { box-shadow: 0 0 10px var(--neon-green); } 50% { box-shadow: 0 0 30px var(--neon-green); } 100% { box-shadow: 0 0 10px var(--neon-green); } }

    /* PANELS BOTTOM */
    .bar-bottom { position: fixed; bottom: 0; left: 0; width: 100%; height: 40px; background: #080808; border-top: 1px solid #333; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; z-index: 100; }
    .bar-group { display: flex; gap: 10px; }
    .bar-btn { background: transparent; border: 1px solid #444; color: #aaa; padding: 5px 15px; font-family: var(--font-tech); font-size: 11px; cursor: pointer; transition: 0.2s; }
    .bar-btn:hover { border-color: var(--neon-cyan); color: var(--neon-cyan); }
    .bar-btn.admin-only { border-color: var(--neon-gold); color: var(--neon-gold); display: none; }

    /* FEATURES */
    .quick-defects { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
    .defect-tag { font-family: var(--font-tech); font-size: 11px; padding: 4px 8px; border: 1px solid #444; color: #888; border-radius: 4px; cursor: pointer; transition: 0.2s; }
    .defect-tag:hover { border-color: var(--neon-cyan); color: var(--neon-cyan); }
    .recent-list { margin-top: 15px; border-top: 1px solid #333; padding-top: 10px; max-height: 100px; overflow-y: auto; }
    .recent-item { display: flex; justify-content: space-between; font-size: 12px; color: #666; padding: 4px 0; border-bottom: 1px dashed #222; }
    .recent-item span:last-child { font-weight: bold; }
    .op-connect-btn { width: 100%; padding: 12px; background: var(--neon-cyan); color: #000; font-weight: bold; border: none; font-family: var(--font-tech); cursor: pointer; border-radius: 6px; margin-bottom: 15px; box-shadow: 0 0 15px rgba(0, 243, 255, 0.3); transition: 0.3s; }
    .op-connect-btn:hover { background: #fff; box-shadow: 0 0 25px rgba(0, 243, 255, 0.6); }

    /* SLIDE PANEL */
    .slide-panel { position: fixed; bottom: 0; left: 0; width: 100%; height: 0; background: rgba(10, 12, 16, 0.98); z-index: 200; transition: height 0.5s cubic-bezier(0.25, 1, 0.5, 1); overflow: hidden; border-top: 2px solid var(--neon-cyan); display: flex; flex-direction: column; }
    .slide-panel.open { height: 85vh; }
    .panel-header { padding: 20px; background: #000; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
    .panel-content { flex: 1; overflow: auto; padding: 30px; }
    
    .op-stats-row { display: flex; gap: 10px; margin-bottom: 20px; }
    .op-stat-box { flex: 1; background: #111; border: 1px solid #333; padding: 10px; text-align: center; border-radius: 6px; }
    .op-stat-num { font-size: 24px; font-weight: bold; color: #fff; font-family: var(--font-tech); }
    .op-stat-lbl { font-size: 10px; color: #888; }

    #qrPopup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; color: #000; padding: 30px; border-radius: 10px; z-index: 500; text-align: center; display: none; box-shadow: 0 0 100px rgba(0,0,0,1); border: 5px solid var(--neon-cyan); }
    #qrCodeBox { margin: 20px auto; }
    #printLabel { display: none; }

    @media print {
        @page { size: auto; margin: 0mm; }
        body * { visibility: hidden; } 
        #printLabel, #printLabel * { visibility: visible; }
        #printLabel { position: absolute; left: 0; top: 0; width: 150mm; height: 150mm; display: flex !important; flex-direction: column; justify-content: space-between; align-items: center; border: 2px solid #000; background: white; color: black; font-family: 'Roboto', sans-serif; padding: 10mm; box-sizing: border-box; z-index: 9999; }
        .pl-header { font-size: 24pt; font-weight: bold; border-bottom: 2px solid #000; width: 100%; text-align: center; padding-bottom: 5mm; }
        .pl-qr { margin: 5mm 0; }
        .pl-info { width: 100%; text-align: left; font-size: 14pt; line-height: 1.5; }
        .pl-footer { font-size: 10pt; width: 100%; text-align: center; border-top: 1px solid #000; padding-top: 2mm; margin-top: auto; }
        #qrPopup { display: none !important; }
    }

    canvas { display: none; }
    #patternOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 99999; display: none; cursor: pointer; }

  </style>
</head>
<body>

<div id="patternOverlay" onclick="nextPattern()"></div>

<div id="printLabel">
    <div class="pl-header">TPV OLED SERVICE</div>
    <div id="printQrCode" class="pl-qr"></div>
    <div class="pl-info">
        <div><strong>SN:</strong> <span id="plSN">---</span></div>
        <div><strong>DATA:</strong> <span id="plDate">---</span></div>
        <div><strong>OPERATOR:</strong> <span id="plOp">---</span></div>
        <div><strong>STATUS:</strong> <span id="plStatus" style="font-weight:bold; font-size:20pt;">---</span></div>
    </div>
    <div class="pl-footer">OLED REPAIR SYSTEM v2.2 - By ≈Åukasz Gruszczy≈Ñski</div>
</div>

<div id="loginScreen">
  <div class="login-box">
    <h2 style="color:#fff;">OLED REPAIR SYSTEM</h2>
    <div style="font-size:12px; color:#666; font-family: var(--font-tech);">v3.1 (FULL SYSTEM)</div>
    <div id="syncStatus" class="sync-status">≈Åadowanie u≈ºytkownik√≥w...</div>
    
    <label class="input-label" style="text-align:left; margin-left:5px; margin-top:20px;">U≈ªYTKOWNIK</label>
    <input type="text" id="userInput" class="login-input" placeholder="LOGIN" autocomplete="off">
    <label class="input-label" style="text-align:left; margin-left:5px; color:var(--neon-red);">HAS≈ÅO</label>
    <input type="password" id="passInput" class="login-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    
    <div class="remember-me">
        <input type="checkbox" id="rememberCheck"> <label for="rememberCheck">ZAPAMIƒòTAJ MNIE</label>
    </div>

    <div id="loginError" class="login-error"></div>
    <button class="login-btn" onclick="attemptLogin()">ROZPOCZNIJ ZMIANƒò</button>
  </div>
  
  <div class="emergency-reset" onclick="emergencyReset()">‚ö† RESET BAZY</div>
</div>

<div id="networkGuard">
  <div class="alert-box">
    <h1 style="color:var(--neon-red); margin:0;">‚ö†Ô∏è SYSTEM ROZ≈ÅƒÑCZONY ‚ö†Ô∏è</h1>
    <p style="font-size:16px; color:#ccc; margin:20px 0;">WYMAGANY DOSTƒòP DO FOLDERU SIECIOWEGO</p>
    <div class="input-label" style="color:#aaa;">CEL:</div>
    <div class="path-box" id="displayPath">...</div>
    <button class="guard-btn" onclick="connectNetwork()">üì° PO≈ÅƒÑCZ Z SERWEREM</button>
    <button class="offline-btn" onclick="startOfflineMode()">üìÇ PRACA OFFLINE (ZIP)</button>
  </div>
</div>

<header>
  <div class="brand">TPV <span>OLED</span> REPAIR STATION</div>
  <div class="operator-info">
    <button class="bar-btn" onclick="toggleFullScreen()" title="Kiosk Mode">‚õ∂</button>
    <div class="operator-badge" id="operatorBadge">---</div>
    <button class="logout-btn" onclick="logout()">WYLOGUJ</button>
    <div id="clockDisplay">00:00</div>
  </div>
</header>

<div id="motdBar">KOMUNIKAT: ---</div>

<div class="dashboard" id="mainDashboard">
  <aside class="panel-left">
    <button id="opConnectBtn" class="op-connect-btn" onclick="connectNetwork()">üì° PO≈ÅƒÑCZ Z SERWEREM</button>

    <div class="scene-container">
      <div class="tv-pivot" id="tv3d">
        <div class="tv-panel tv-front"></div>
        <div class="tv-panel tv-back">SERWIS</div>
      </div>
    </div>
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
        <span class="input-label">1. SN MODU≈ÅU (SET)</span>
        <span id="sessionTimer" style="font-family:var(--font-tech); color:#666; font-size:12px;">‚è±Ô∏è 00:00</span>
    </div>
    <input type="text" id="scanInput" placeholder="SKANUJ MODU≈Å..." autofocus>

    <span class="input-label" style="color:var(--neon-green)">2. SN OC (SZK≈ÅO)</span>
    <input type="text" id="scanInputOC" placeholder="OCZEKIWANIE NA DECYZJƒò..." disabled 
           style="width: 100%; background: #080808; border: 1px solid #333; color: var(--neon-green); padding: 12px; font-size: 18px; text-align: center; font-family: var(--font-tech); outline: none; border-radius: 6px; margin-bottom: 15px;">

    <div id="checklist">
        <button class="checklist-btn" style="border-color:var(--neon-purple); color:var(--neon-purple);" onclick="togglePatterns()"><span>üñ•Ô∏è TEST EKRANU (PATTERNS)</span> <span>‚èØ</span></button>
        <div style="height:10px;"></div>
        <div id="btnFront" class="checklist-btn" onclick="capture('PRZOD')"><span>1. PRZ√ìD EKRANU</span> <span>üì∑</span></div>
        <div id="btnBack" class="checklist-btn" onclick="capture('TYL')"><span>2. TY≈Å (TABLICZKA)</span> <span>üì∑</span></div>
        <div id="btnImage" class="checklist-btn" onclick="capture('OBRAZ')"><span>3. TEST OBRAZU</span> <span>üì∑</span></div>
    </div>

    <div class="decision-panel">
      <span class="input-label" style="color:var(--neon-purple)">DECYZJA SERWISOWA</span>
      <select id="statusSelect" class="custom-select" onchange="checkOcRequirement(); saveRecoveryState();">
        <option value="OK">üü¢ OK (SPRAWNY)</option>
        <option value="NG">üî¥ NG (USZKODZONY)</option>
        <option value="NDF">üîµ NDF (BRAK WAD)</option>
        <option value="RMA">üü† RMA (ZWROT)</option>
        <option value="SCRAP">‚ö´ SCRAP (Z≈ÅOM)</option>
        <option value="OFFRS_OK">üü£ OFFRS OK</option>
      </select>
      
      <span class="input-label">KOMENTARZ / SZYBKIE WADY</span>
      <div class="quick-defects">
          <div class="defect-tag" onclick="addDefect('RYSA NA MATRYCY')">RYSA</div>
          <div class="defect-tag" onclick="addDefect('BAD PIXEL')">PIXEL</div>
          <div class="defect-tag" onclick="addDefect('PƒòKNIƒòCIE')">PƒòKNIƒòCIE</div>
          <div class="defect-tag" onclick="addDefect('LINIA PIONOWA')">LINIA |</div>
          <div class="defect-tag" onclick="addDefect('LINIA POZIOMA')">LINIA ‚Äî</div>
          <div class="defect-tag" onclick="addDefect('BRAK OBRAZU')">NO IMAGE</div>
      </div>
      
      <textarea id="commentInput" class="custom-textarea" rows="2" placeholder="Wpisz uwagi..." onkeyup="saveRecoveryState()"></textarea>
    </div>

    <div class="recent-list" id="recentList"></div>

    <button id="actionBtn" onclick="saveData()">OCZEKIWANIE</button>
    <div id="saveStatus" style="text-align:center; color:#666; margin-top:10px; font-size:11px; height:15px; font-family: var(--font-tech);"></div>
  </aside>

  <main class="panel-right" id="camContainer">
    <div class="cam-overlay">
      <div class="tag" id="tagSN">SN: ---</div>
      <div class="tag" id="tagOp">OP: ---</div>
    </div>
    <div class="draw-toolbar" id="drawToolbar">
      <span style="color:#fff; font-size:12px; margin-right:10px;">ZAZNACZ WADƒò:</span>
      <div class="color-btn" style="background:red;" onclick="setDrawColor('red')"></div>
      <div class="color-btn" style="background:#0aff00;" onclick="setDrawColor('#0aff00')"></div>
      <button class="tool-btn" onclick="clearDraw()">WYCZY≈öƒÜ</button>
      <button class="tool-btn confirm" onclick="confirmPhoto()">ZAPISZ</button>
      <button class="tool-btn" onclick="cancelPhoto()">ANULUJ</button>
    </div>
    <div class="cam-controls">
      <div class="zoom-group">
        <span>ZOOM</span>
        <input type="range" id="zoomSlider" min="1" max="4" step="0.1" value="1">
        <span id="zoomVal">1.0x</span>
      </div>
      <div style="width:1px; height:20px; background:#444; margin:0 5px;"></div>
      <div class="cam-btn" onclick="toggleMirror()" title="Odbicie lustrzane">‚Üî</div>
    </div>
    <div class="video-container">
        <video id="videoFeed" autoplay playsinline></video>
        <canvas id="drawCanvas"></canvas>
    </div>
  </main>
</div>

<div id="adminDash">
    <div class="admin-container">
        <div class="admin-status-bar">
            <div class="status-item"><div class="status-dot ok"></div> SYSTEM: ONLINE</div>
            <div class="status-item">VER: 3.1</div>
            <div class="status-item">CPU: <span id="simCpu">12%</span></div>
            <div class="status-item">MEM: <span id="simMem">2.4GB</span></div>
        </div>
        <div class="admin-grid">
            <div style="display:flex; flex-direction:column; gap:20px;">
                <div class="admin-panel-box highlight">
                    <div class="admin-h">
                        <span>ZARZƒÑDZANIE U≈ªYTKOWNIKAMI</span>
                        <span style="font-size:12px; color:#666;">EDYCJA / RESET HASE≈Å</span>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 100px; gap:10px; margin-bottom:15px;">
                      <input type="text" id="newLogin" placeholder="LOGIN" class="cfg-input" style="margin:0;">
                      <input type="text" id="newPass" placeholder="HAS≈ÅO" class="cfg-input" style="margin:0;">
                      <select id="newRole" class="cfg-input" style="margin:0; padding:10px; cursor:pointer;">
                        <option value="OPERATOR">OPERATOR</option>
                        <option value="KOORDYNATOR">KOORDYNATOR</option>
                        <option value="KIEROWNIK">KIEROWNIK</option>
                        <option value="ADMIN">ADMINISTRATOR</option>
                      </select>
                      <button onclick="addUser()" class="cfg-btn">DODAJ</button>
                    </div>
                    <div style="overflow-y:auto; max-height:250px; border:1px solid #333;">
                        <table class="adm-table" id="admUserTable">
                            <thead><tr><th>LOGIN</th><th>ROLA</th><th>AKCJE</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <button class="cfg-btn" style="margin-top:10px; width:100%; border-style:dashed;" onclick="backupUsers()">üíæ BACKUP U≈ªYTKOWNIK√ìW (JSON)</button>
                </div>
                <div class="admin-panel-box">
                    <div class="admin-h" style="margin-bottom:5px;">TERMINAL SYSTEMOWY</div>
                    <div class="admin-terminal" id="sysLog">
                        <div class="log-line"><span class="log-time">System:</span> Inicjalizacja v3.1...</div>
                        <div class="log-line"><span class="log-time">System:</span> Gotowy do pracy.</div>
                    </div>
                </div>
            </div>
            <div style="display:flex; flex-direction:column; gap:20px;">
                <div class="admin-panel-box" style="border-color:var(--neon-cyan);">
                    <div class="admin-h" style="color:var(--neon-cyan)">BAZA DANYCH</div>
                    <div style="font-size:12px; color:#aaa; margin-bottom:15px;">Po≈ÇƒÖcz, aby zarzƒÖdzaƒá plikami.</div>
                    <div style="display:flex; gap:10px;">
                        <button class="cfg-btn cyan" style="flex:1;" onclick="connectNetwork()">üì° PO≈ÅƒÑCZ</button>
                        <button class="cfg-btn cyan" style="flex:1;" onclick="toggleReportPanel()">üìä RAPORTY</button>
                    </div>
                </div>
                <div class="admin-panel-box">
                    <div class="admin-h">KONFIGURACJA</div>
                    <div class="input-label">≈öCIE≈ªKA SIECIOWA</div>
                    <input type="text" id="cfgPath" class="cfg-input" value="\\plgorfs001...">
                    <button class="cfg-btn" onclick="saveConfigPath()">ZAPISZ</button>
                    <div style="margin-top:15px;"></div>
                    <div class="input-label">WIADOMO≈öƒÜ DNIA</div>
                    <input type="text" id="cfgMotd" class="cfg-input" placeholder="Komunikat...">
                    <button class="cfg-btn" onclick="saveMotd()">WY≈öLIJ</button>
                </div>
                <div class="admin-panel-box">
                    <div class="admin-h" style="margin-bottom:5px;">PODGLƒÑD KAMERY</div>
                    <video id="adminCamPreview" autoplay playsinline muted></video>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="managerDash">
    <div class="mgr-header">
        <div class="mgr-title">
            </div>
        <div class="mgr-filters">
            <button class="mgr-btn active" id="fToday" onclick="updateLeaderStats('TODAY')">DZISIAJ</button>
            <button class="mgr-btn" id="fYesterday" onclick="updateLeaderStats('YESTERDAY')">WCZORAJ</button>
            <button class="mgr-btn" id="fAll" onclick="updateLeaderStats('ALL')">CA≈ÅA HISTORIA</button>
            <div style="width:1px; background:#444; margin:0 10px;"></div>
            <button class="mgr-btn" onclick="scanNetwork()">üîÑ OD≈öWIE≈ª</button>
            <button class="mgr-btn" onclick="exportCSV()">üíæ CSV</button>
        </div>
    </div>
    <div class="mgr-stats-row">
        <div class="mgr-card" style="border-color:var(--neon-cyan)">
            <h3>ILO≈öƒÜ CA≈ÅKOWITA</h3>
            <div class="val" id="mgrTotal">0</div>
        </div>
        <div class="mgr-card" style="border-color:var(--neon-green)">
            <h3>STATUS OK</h3>
            <div class="val" id="mgrOK" style="color:var(--neon-green)">0</div>
        </div>
        <div class="mgr-card" style="border-color:var(--neon-red)">
            <h3>ODRZUTY (NG)</h3>
            <div class="val" id="mgrNG" style="color:var(--neon-red)">0</div>
        </div>
        <div class="mgr-card" style="border-color:var(--neon-orange)">
            <h3>YIELD %</h3>
            <div class="val" id="mgrYield">0%</div>
        </div>
    </div>
    <div class="mgr-content-grid">
        <div class="mgr-panel mgr-ranking-panel">
            <h4>RANKING OPERATOR√ìW</h4>
            <div style="overflow:auto;">
                <table class="data-table">
                    <thead><tr><th>OP</th><th>ILO≈öƒÜ</th><th>YIELD</th></tr></thead>
                    <tbody id="mgrRankBody"><tr><td colspan="3" style="text-align:center">Brak danych</td></tr></tbody>
                </table>
            </div>
        </div>
        <div class="mgr-panel">
            <h4>DZIENNIK ZDARZE≈É</h4>
            <div style="overflow:auto;">
                <table class="data-table">
                    <thead><tr><th>DATA</th><th>SN MODU≈ÅU</th><th>SN OC</th><th>OP</th><th>DECYZJA</th><th>UWAGI</th></tr></thead>
                    <tbody id="mgrLogBody"><tr><td colspan="6" style="text-align:center">Po≈ÇƒÖcz siƒô z serwerem, aby pobraƒá dane...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="bar-bottom">
  <div id="connStatus" style="color:#444; font-size:11px;">üî¥ OFFLINE</div>
  <div class="bar-group">
    <button class="bar-btn admin-only" onclick="alert('U≈ºyj Panelu Administratora')">üë• U≈ªYTKOWNICY</button>
    <button class="bar-btn" id="dbBtn" onclick="toggleReportPanel()">üìä MOJE WYNIKI</button>
  </div>
</div>

<div id="reportPanel" class="slide-panel">
  <div class="panel-header">
    <div style="font-size:20px; color:var(--neon-cyan); font-family: var(--font-tech);">MOJE DZISIEJSZE WYNIKI</div>
    <div>
        <button class="bar-btn" onclick="scanNetwork()">üîÑ OD≈öWIE≈ª</button>
        <button class="bar-btn" onclick="toggleReportPanel()">ZAMKNIJ X</button>
    </div>
  </div>
  <div class="panel-content">
    <div style="color:#888; text-align:center; font-size:14px; margin-bottom:20px;">
        Poni≈ºej znajdujƒÖ siƒô Twoje statystyki z bie≈ºƒÖcej zmiany. (Wymaga po≈ÇƒÖczenia z bazƒÖ)
    </div>
    <div class="op-stats-row">
        <div class="op-stat-box" style="border-color:var(--neon-cyan)">
            <div class="op-stat-num" id="opTotal">0</div>
            <div class="op-stat-lbl">ZROBIONE</div>
        </div>
        <div class="op-stat-box" style="border-color:var(--neon-green)">
            <div class="op-stat-num" id="opOK">0</div>
            <div class="op-stat-lbl">OK</div>
        </div>
        <div class="op-stat-box" style="border-color:var(--neon-red)">
            <div class="op-stat-num" id="opNG">0</div>
            <div class="op-stat-lbl">NG</div>
        </div>
        <div class="op-stat-box" style="border-color:var(--neon-orange)">
            <div class="op-stat-num" id="opYield">0%</div>
            <div class="op-stat-lbl">YIELD</div>
        </div>
    </div>
  </div>
</div>

<div id="qrPopup">
  <h2 style="font-family: var(--font-tech); margin-top:0;">OLED PASSPORT</h2>
  <div id="qrCodeBox"></div>
  <div id="qrSnDisplay" style="font-weight:bold; font-family:var(--font-tech);">SN: ---</div>
  <div id="qrStatusDisplay" style="color:green; margin-bottom:10px;">STATUS: OK</div>
  <button onclick="closeQr()" style="padding:10px 20px; background:#000; color:#fff; border:none; cursor:pointer;">ZAMKNIJ</button>
  <button onclick="window.print()" style="padding:10px 20px; background:var(--neon-cyan); color:#000; border:none; cursor:pointer;">DRUKUJ ETYKIETƒò</button>
</div>

<canvas id="photoCanvas"></canvas>

<script>
  /* --- CONFIG --- */
  let CONFIG = {
    networkPath: String.raw`\\plgorfs001\pub\SERVICE\LCDR\LCDR\OLED OBM Panels\Zdjƒôcia z napraw OLED`,
    motd: "",
    // CLOUDFLARE WORKER PROXY:
    sheetUrl: "https://oledrepair.lukaszarmiajotpe.workers.dev/",
    // DANE U≈ªYTKOWNIK√ìW SƒÑ TERAZ POBIERANE Z CHMURY (GOOGLE SHEETS)
    // Aby zalogowaƒá siƒô pierwszy raz, wymagane jest po≈ÇƒÖczenie z internetem.
    defaultUsers: [] 
  };

  /* --- AUDIO SYSTEM --- */
  const SoundFX = {
    ctx: null,
    init: function() { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
    play: function(type) {
      if(!this.ctx) this.init();
      const osc = this.ctx.createOscillator();
      const gain = this.ctx.createGain();
      osc.connect(gain); gain.connect(this.ctx.destination);
      const now = this.ctx.currentTime;
      if(type === 'beep') {
        osc.type = 'sine'; osc.frequency.setValueAtTime(1200, now);
        gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.1);
        osc.start(now); osc.stop(now+0.1);
      } else if(type === 'error') {
        osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now+0.3);
        gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0.01, now+0.3);
        osc.start(now); osc.stop(now+0.3);
      } else if(type === 'shutter') {
        osc.type = 'square'; osc.frequency.setValueAtTime(800, now);
        gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now+0.05);
        osc.start(now); osc.stop(now+0.05);
      } else if(type === 'success') {
        osc.type = 'triangle'; osc.frequency.setValueAtTime(440, now); osc.frequency.setValueAtTime(554, now+0.1); osc.frequency.setValueAtTime(659, now+0.2); 
        gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.4);
        osc.start(now); osc.stop(now+0.4);
      }
    }
  };

  /* --- STATE --- */
  let users = [];
  let currentUser = null;
  let dirHandle = null;
  let currentSN = "";
  let currentOC = ""; 
  let photos = { PRZOD: null, TYL: null, OBRAZ: null };
  let isMirrored = false;
  let reportsCache = [];
  let leaderMode = 'TODAY'; 
  
  let isDrawing = false;
  let drawColor = "red";
  let tempPhotoType = "";
  let zoomLevel = 1.0;
  let panX = 0; let panY = 0;
  let isPanning = false; let startPanX = 0; let startPanY = 0;
  
  let sessionStartTime = null;
  let recentScans = [];

  /* --- INIT --- */
  window.onload = () => {
    loadConfig();
    loadUsers(); 
    loadUsersFromSheet(); 
    checkSavedLogin();
    checkRecovery();
    checkOcRequirement();
    
    // UI Reset
    document.getElementById('mainDashboard').style.display = 'none';
    document.getElementById('adminDash').style.display = 'none';
    document.getElementById('managerDash').style.display = 'none';
    
    if(CONFIG.motd) {
        document.getElementById('motdBar').style.display = 'block';
        document.getElementById('motdBar').innerText = "KOMUNIKAT: " + CONFIG.motd;
    }

    setInterval(() => {
        document.getElementById('clockDisplay').innerText = new Date().toLocaleTimeString().slice(0,5);
        if(currentUser && currentUser.role === 'ADMIN') {
            document.getElementById('simCpu').innerText = Math.floor(Math.random() * 15 + 5) + "%";
            document.getElementById('simMem').innerText = (Math.random() * 0.5 + 2.1).toFixed(1) + "GB";
        }
        updateSessionTimer(); 
    }, 1000);
    
    const c = document.getElementById('drawCanvas');
    c.addEventListener('mousedown', startDraw); c.addEventListener('mouseup', endDraw); c.addEventListener('mousemove', draw);
    c.addEventListener('touchstart', (e)=>{e.preventDefault(); startDraw(e.touches[0])});
    c.addEventListener('touchend', (e)=>{e.preventDefault(); endDraw()});
    c.addEventListener('touchmove', (e)=>{e.preventDefault(); draw(e.touches[0])});

    const slider = document.getElementById('zoomSlider');
    slider.addEventListener('input', (e) => { zoomLevel = parseFloat(e.target.value); applyTransform(); });

    const camContainer = document.getElementById('camContainer');
    camContainer.addEventListener('mousedown', (e) => {
        if(zoomLevel > 1 && !isDrawing && document.getElementById('drawCanvas').style.display === 'none') {
            isPanning = true; startPanX = e.clientX - panX; startPanY = e.clientY - panY;
            camContainer.style.cursor = 'grabbing';
        }
    });
    window.addEventListener('mouseup', () => { isPanning = false; camContainer.style.cursor = zoomLevel > 1 ? 'grab' : 'default'; });
    window.addEventListener('mousemove', (e) => {
        if(!isPanning) return; e.preventDefault();
        panX = e.clientX - startPanX; panY = e.clientY - startPanY;
        applyTransform();
    });
  };

  function updateSessionTimer() {
      if(!sessionStartTime || !currentSN) return;
      const now = new Date();
      const diff = Math.floor((now - sessionStartTime) / 1000);
      const m = Math.floor(diff / 60).toString().padStart(2, '0');
      const s = (diff % 60).toString().padStart(2, '0');
      document.getElementById('sessionTimer').innerText = `‚è±Ô∏è ${m}:${s}`;
  }

  function addDefect(text) {
      const field = document.getElementById('commentInput');
      if(field.value) field.value += ", " + text;
      else field.value = text;
      saveRecoveryState();
  }

  function logSystem(msg) {
      const term = document.getElementById('sysLog');
      const time = new Date().toLocaleTimeString();
      const div = document.createElement('div');
      div.className = "log-line";
      div.innerHTML = `<span class="log-time">[${time}]</span> ${msg}`;
      term.appendChild(div);
      term.scrollTop = term.scrollHeight;
  }

  function applyTransform() {
    const v = document.getElementById('videoFeed');
    const mirrorFactor = isMirrored ? -1 : 1;
    v.style.transform = `scale(${zoomLevel * mirrorFactor}, ${zoomLevel}) translate(${panX / zoomLevel}px, ${panY / zoomLevel}px)`;
  }

  /* --- CONFIG & LOGIN --- */
  function loadConfig() {
      const savedPath = localStorage.getItem('oled_cfg_path');
      if(savedPath) CONFIG.networkPath = savedPath;
      const savedMotd = localStorage.getItem('oled_cfg_motd');
      if(savedMotd) CONFIG.motd = savedMotd;
      document.getElementById('displayPath').innerText = CONFIG.networkPath;
  }
  function saveConfigPath() {
      const v = document.getElementById('cfgPath').value.trim();
      if(v) { CONFIG.networkPath = v; localStorage.setItem('oled_cfg_path', v); alert("Zapisano!"); logSystem("Zmiana ≈õcie≈ºki sieciowej"); }
  }
  function saveMotd() {
      const v = document.getElementById('cfgMotd').value.trim();
      CONFIG.motd = v; localStorage.setItem('oled_cfg_motd', v); alert("Komunikat zapisany!"); logSystem("Aktualizacja MOTD");
  }

  function loadUsers() {
    const stored = localStorage.getItem('oled_users');
    if(stored) {
        users = JSON.parse(stored);
        if(users.length === 0) users = CONFIG.defaultUsers;
    } else {
        users = CONFIG.defaultUsers;
    }
  }

  async function loadUsersFromSheet() {
      if(!CONFIG.sheetUrl) return;
      const statusEl = document.getElementById('syncStatus');
      statusEl.innerText = "Synchronizacja...";
      
      try {
          const res = await fetch(CONFIG.sheetUrl, { method: "GET" });
          if(!res.ok) throw new Error("Network response was not ok");
          const txt = await res.text();
          
          const rows = txt.split(/\r?\n/); // Bezpieczne podzia≈Ç linii
          const newUsers = [];
          
          for(let i=1; i<rows.length; i++) {
              const row = rows[i];
              if(!row || row.trim() === '') continue;

              const cols = row.split(',');
              if(cols.length >= 3) {
                   // Czy≈õcimy cudzys≈Çowy i spacje
                   const l = cols[0].replace(/^"|"$/g, '').trim().toUpperCase();
                   const p = cols[1].replace(/^"|"$/g, '').trim();
                   const r = cols[2].replace(/^"|"$/g, '').trim().toUpperCase();
                   
                   if(l && p && ['OPERATOR','ADMIN','KIEROWNIK','KOORDYNATOR'].includes(r)) {
                       newUsers.push({login:l, pass:p, role:r});
                   }
              }
          }
          
          if(newUsers.length > 0) {
              users = newUsers;
              saveUsers();
              statusEl.innerText = "Zsynchronizowano!";
              statusEl.className = "sync-status ok";
              setTimeout(()=>{ statusEl.innerText=""; }, 3000);
              logSystem("Zaktualizowano bazƒô u≈ºytkownik√≥w z chmury");
          } else {
              throw new Error("Pusty plik");
          }
      } catch(e) {
          console.error("Sync error:", e);
          statusEl.innerText = "Tryb Offline (Brak po≈ÇƒÖczenia)";
          statusEl.className = "sync-status err";
          setTimeout(()=>{ statusEl.innerText=""; }, 5000);
      }
  }

  function saveUsers() { localStorage.setItem('oled_users', JSON.stringify(users)); if(currentUser && currentUser.role==='ADMIN') renderAdminUserTable(); }
  
  function checkSavedLogin() {
      const saved = localStorage.getItem('oled_saved_creds');
      if(saved) {
          try {
              const creds = JSON.parse(saved);
              document.getElementById('userInput').value = creds.login;
              document.getElementById('passInput').value = creds.pass;
              document.getElementById('rememberCheck').checked = true;
          } catch(e) {}
      }
  }

  function attemptLogin() {
    const l = document.getElementById('userInput').value.trim().toUpperCase();
    const p = document.getElementById('passInput').value.trim();
    const remember = document.getElementById('rememberCheck').checked;

    const u = users.find(user => user.login === l && user.pass === p);
    if (u) {
      currentUser = u;
      if(remember) localStorage.setItem('oled_saved_creds', JSON.stringify({login:l, pass:p}));
      else localStorage.removeItem('oled_saved_creds');

      logSystem(`Zalogowano u≈ºytkownika: ${u.login} (${u.role})`);

      document.getElementById('loginScreen').style.opacity = '0';
      setTimeout(() => {
        document.getElementById('loginScreen').style.display = 'none';
        setupInterface(); // Go straight to interface
        if(currentUser.role === 'ADMIN') {
            startAdminCamera();
            document.getElementById('cfgPath').value = CONFIG.networkPath;
            document.getElementById('cfgMotd').value = CONFIG.motd;
            renderAdminUserTable();
        } else if (currentUser.role === 'OPERATOR') {
            initCamera();
        }
        document.getElementById('mainDashboard').style.opacity = '1';
      }, 800);
    } else { 
      SoundFX.play('error');
      document.getElementById('loginError').innerText = "B≈ÅƒòDNY LOGIN LUB HAS≈ÅO"; 
    }
  }

  function logout() {
      if(confirm("Wylogowaƒá?")) {
          location.reload(); // HARD RESET
      }
  }
  
  function emergencyReset() {
      if(confirm("To usunie lokalnƒÖ bazƒô i przywr√≥ci ustawienia domy≈õlne. Kontynuowaƒá?")) {
          localStorage.removeItem('oled_users');
          localStorage.removeItem('oled_saved_creds');
          location.reload();
      }
  }

  function setupInterface() {
    const b = document.getElementById('operatorBadge');
    b.innerText = currentUser.login;
    document.getElementById('tagOp').innerText = "OP: " + currentUser.login;
    b.className = "operator-badge"; 
    
    // Clean states
    document.body.className = "";
    document.getElementById('mainDashboard').style.display = 'none';
    document.getElementById('adminDash').style.display = 'none';
    document.getElementById('managerDash').style.display = 'none';

    if(currentUser.role === 'KIEROWNIK' || currentUser.role === 'KOORDYNATOR') {
        const mgrTitle = document.querySelector('.mgr-title');
        const btnHtml = '<button class="mgr-connect-btn" onclick="connectNetwork()">üì° PO≈ÅƒÑCZ Z BAZƒÑ DANYCH</button>';
        
        if (currentUser.role === 'KOORDYNATOR') {
            b.classList.add('coord');
            document.body.classList.add('mode-manager', 'mode-coord'); 
            mgrTitle.innerHTML = 'PANEL KOORDYNATORA ' + btnHtml; 
        } else {
            b.classList.add('manager');
            document.body.classList.add('mode-manager');
            mgrTitle.innerHTML = 'PANEL KIEROWNIKA ' + btnHtml; 
        }
        
        document.getElementById('managerDash').style.display = 'flex';
    } else if(currentUser.role === 'ADMIN') {
        b.classList.add('admin');
        document.body.classList.add('mode-admin');
        document.getElementById('dbBtn').style.display = 'none';
        document.getElementById('adminDash').style.display = 'flex';
    } else {
        // OPERATOR
        document.getElementById('mainDashboard').style.display = 'grid';
        setTimeout(() => document.getElementById('mainDashboard').style.opacity = '1', 100);
    }
  }

  /* --- NETWORK --- */
  async function connectNetwork() {
    try {
      await navigator.clipboard.writeText(CONFIG.networkPath);
      alert("≈öcie≈ºka skopiowana! Wybierz folder.");
      dirHandle = await window.showDirectoryPicker();
      
      const statusEl = document.getElementById('connStatus');
      statusEl.innerHTML = "üü¢ ONLINE";
      statusEl.style.color = "var(--neon-green)";
      
      logSystem("Po≈ÇƒÖczono z folderem sieciowym");
      
      document.getElementById('networkGuard').style.display = 'none';
      
      // AUTO SCAN FOR MANAGER/COORD
      if(currentUser.role === 'KIEROWNIK' || currentUser.role === 'KOORDYNATOR') {
          setTimeout(scanNetwork, 500); 
      }
      // FOCUS FOR OPERATOR
      if(currentUser.role === 'OPERATOR') {
          initCamera();
          document.getElementById('scanInput').focus();
          scanNetworkForOperator();
      }

    } catch(e) { alert("Anulowano wyb√≥r folderu."); }
  }

  function startOfflineMode() {
      dirHandle = null; 
  }

  /* --- MANAGER LOGIC (DATA) --- */
  async function scanNetwork() {
    if(!dirHandle) {
        document.getElementById('mgrLogBody').innerHTML = "<tr><td colspan='6' style='text-align:center;color:orange;'>TRYB OFFLINE - BRAK DANYCH (Kliknij PO≈ÅƒÑCZ)</td></tr>";
        return;
    }
    
    if(currentUser.role === 'OPERATOR') {
        scanNetworkForOperator();
        return;
    }
    
    document.getElementById('mgrLogBody').innerHTML = "<tr><td colspan='6' style='text-align:center;'>POBIERANIE DANYCH...</td></tr>";
    logSystem("Rozpoczƒôto skanowanie danych...");
    
    reportsCache = [];
    try {
      for await (const e of dirHandle.values()) {
        if(e.kind === 'directory') {
          const sn = e.name; 
          let op="---", dateStr="---", dec="---", com="---", oc="---";
          let rawDateObj = null;

          try {
            const sub = await dirHandle.getDirectoryHandle(sn);
            for await (const f of sub.values()) {
              if(f.name.includes('RAPORT')) {
                const fl = await f.getFile(); 
                const tx = await fl.text(); 
                rawDateObj = fl.lastModifiedDate;
                dateStr = rawDateObj.toLocaleString();

                const mOp = tx.match(/OPERATOR: (.*)/); if(mOp) op=mOp[1];
                const mDec = tx.match(/DECYZJA: (.*)/); if(mDec) dec=mDec[1];
                const mCom = tx.match(/UWAGI: (.*)/); if(mCom) com=mCom[1];
                const mOc = tx.match(/OC SN:\s+(.*)/); if(mOc) oc=mOc[1];
              }
            }
          } catch(err){}
          reportsCache.push({date: dateStr, rawDate: rawDateObj, sn, op, dec, com, oc});
        }
      }
      updateLeaderStats(leaderMode);
      logSystem("Dane za≈Çadowane pomy≈õlnie.");
    } catch(e) { console.error(e); logSystem("B≈ÇƒÖd skanowania!"); }
  }

  async function scanNetworkForOperator() {
      if(!dirHandle) return;
      reportsCache = [];
      try {
          for await (const e of dirHandle.values()) {
            if(e.kind === 'directory') {
              const sn = e.name; 
              let op="---", dateStr="---", dec="---", com="---", oc="---";
              let rawDateObj = null;
              try {
                const sub = await dirHandle.getDirectoryHandle(sn);
                for await (const f of sub.values()) {
                  if(f.name.includes('RAPORT')) {
                    const fl = await f.getFile(); const tx = await fl.text(); 
                    rawDateObj = fl.lastModifiedDate;
                    const mOp = tx.match(/OPERATOR: (.*)/); if(mOp) op=mOp[1];
                    const mDec = tx.match(/DECYZJA: (.*)/); if(mDec) dec=mDec[1];
                  }
                }
              } catch(err){}
              reportsCache.push({rawDate: rawDateObj, sn, op, dec});
            }
          }
          calculateOperatorStats();
      } catch(e) {}
  }

  function calculateOperatorStats() {
      const today = new Date().toDateString();
      const myStats = reportsCache.filter(r => r.op === currentUser.login && r.rawDate && r.rawDate.toDateString() === today);
      
      let total = myStats.length;
      let ok = 0;
      let ng = 0;
      
      myStats.forEach(r => {
          if(['OK','OFFRS_OK','NDF'].includes(r.dec)) ok++; else ng++;
      });
      
      let yieldVal = total > 0 ? ((ok/total)*100).toFixed(1) : 0;
      
      document.getElementById('opTotal').innerText = total;
      document.getElementById('opOK').innerText = ok;
      document.getElementById('opNG').innerText = ng;
      document.getElementById('opYield').innerText = yieldVal + "%";
  }

  function updateLeaderStats(mode) {
      leaderMode = mode;
      
      document.getElementById('fToday').classList.remove('active');
      document.getElementById('fYesterday').classList.remove('active');
      document.getElementById('fAll').classList.remove('active');
      
      if(mode==='TODAY') document.getElementById('fToday').classList.add('active');
      else if(mode==='YESTERDAY') document.getElementById('fYesterday').classList.add('active');
      else document.getElementById('fAll').classList.add('active');
      
      const now = new Date();
      const todayStr = now.toDateString();
      const yesterday = new Date(now); yesterday.setDate(yesterday.getDate() - 1);
      const yestStr = yesterday.toDateString();

      let filtered = [];
      if(mode === 'TODAY') filtered = reportsCache.filter(r => r.rawDate && r.rawDate.toDateString() === todayStr);
      else if(mode === 'YESTERDAY') filtered = reportsCache.filter(r => r.rawDate && r.rawDate.toDateString() === yestStr);
      else filtered = reportsCache;
      
      filtered.sort((a,b) => (b.rawDate || 0) - (a.rawDate || 0));

      const tb = document.getElementById('mgrLogBody'); tb.innerHTML = "";
      if(filtered.length===0) tb.innerHTML = "<tr><td colspan='6' style='text-align:center'>BRAK DANYCH</td></tr>";
      
      filtered.forEach(r => {
          let color = "#fff";
          if(r.dec.includes('NG') || r.dec.includes('SCRAP')) color = "var(--neon-red)";
          if(r.dec.includes('OK') || r.dec.includes('OFFRS')) color = "var(--neon-green)";
          if(r.dec.includes('RMA')) color = "orange";
          
          tb.innerHTML += `<tr><td>${r.date}</td><td>${r.sn}</td><td>${r.oc||'---'}</td><td>${r.op}</td><td style="color:${color};font-weight:bold">${r.dec}</td><td>${r.com}</td></tr>`;
      });

      // ONLY CALCULATE STATS IF NOT COORDINATOR
      if(currentUser.role !== 'KOORDYNATOR') {
          const total = filtered.length;
          let ok=0, ng=0;
          const opStats = {};

          filtered.forEach(r => {
              if(['OK','OFFRS_OK','NDF'].includes(r.dec)) ok++; else ng++;
              if(!opStats[r.op]) opStats[r.op] = { total:0, ok:0 };
              opStats[r.op].total++;
              if(['OK','OFFRS_OK','NDF'].includes(r.dec)) opStats[r.op].ok++;
          });

          let yieldVal = total > 0 ? ((ok/total)*100).toFixed(1) : 0;
          document.getElementById('mgrTotal').innerText = total;
          document.getElementById('mgrOK').innerText = ok;
          document.getElementById('mgrNG').innerText = ng;
          document.getElementById('mgrYield').innerText = yieldVal + "%";

          const rankBody = document.getElementById('mgrRankBody'); rankBody.innerHTML = "";
          const sortedOps = Object.keys(opStats).sort((a,b) => opStats[b].total - opStats[a].total);
          
          if(sortedOps.length===0) rankBody.innerHTML = "<tr><td colspan='3' style='text-align:center'>BRAK DANYCH</td></tr>";
          
          sortedOps.forEach(op => {
              const s = opStats[op];
              const y = ((s.ok/s.total)*100).toFixed(0);
              let c = "#fff";
              if(y<80) c="var(--neon-red)"; else if(y>95) c="var(--neon-green)"; else c="orange";
              rankBody.innerHTML += `<tr><td>${op}</td><td>${s.total}</td><td style="color:${c}">${y}%</td></tr>`;
          });
      }
  }

  function exportCSV() {
    if(!reportsCache.length) return alert("Brak danych w pamiƒôci (Od≈õwie≈º najpierw)");
    let c = "DATA,SN_MODULU,SN_SZKLA_OC,OPERATOR,DECYZJA,UWAGI\n";
    reportsCache.forEach(r => c+=`${r.date},${r.sn},${r.oc},${r.op},${r.dec},${r.com}\n`);
    saveAs(new Blob([c],{type:'text/csv'}), "raport_serwisowy.csv");
    logSystem("Wyeksportowano CSV");
  }

  /* --- ADMIN FUNCTIONS --- */
  function renderAdminUserTable() {
      const tb = document.querySelector('#admUserTable tbody'); tb.innerHTML = "";
      users.forEach((u, i) => {
        let color = '#fff';
        if(u.role === 'ADMIN') color = 'var(--neon-gold)';
        if(u.role === 'KOORDYNATOR') color = 'var(--neon-purple)';
        if(u.role === 'KIEROWNIK') color = 'var(--neon-red)';
        tb.innerHTML += `<tr><td>${u.login}</td><td style="color:${color}">${u.role}</td><td><div class="adm-btn-group"><button class="adm-act-btn" onclick="resetUserPass(${i})">RESET</button><button class="adm-act-btn" style="color:red" onclick="removeUser(${i})">X</button></div></td></tr>`;
      });
  }
  function addUser() {
    const l = document.getElementById('newLogin').value.trim().toUpperCase();
    const p = document.getElementById('newPass').value.trim();
    const r = document.getElementById('newRole').value;
    if(l && p) { users.push({login:l, pass:p, role:r}); saveUsers(); logSystem(`Dodano usera: ${l}`); }
  }
  function removeUser(idx) { if(confirm("UsunƒÖƒá?")) { logSystem(`Usuniƒôto usera: ${users[idx].login}`); users.splice(idx, 1); saveUsers(); } }
  function resetUserPass(idx) { if(confirm("Reset has≈Ça na 1234?")) { users[idx].pass="1234"; saveUsers(); alert("OK"); logSystem(`Reset has≈Ça dla: ${users[idx].login}`); } }
  
  function backupUsers() {
      const blob = new Blob([JSON.stringify(users, null, 2)], {type: "application/json"});
      saveAs(blob, "users_backup.json");
      logSystem("Wykonano backup u≈ºytkownik√≥w");
  }

  async function startAdminCamera() {
      try {
          const s = await navigator.mediaDevices.getUserMedia({video:true});
          document.getElementById('adminCamPreview').srcObject = s;
      } catch(e) {}
  }

  async function initCamera() {
    if(currentUser.role === 'KIEROWNIK' || currentUser.role === 'KOORDYNATOR' || currentUser.role === 'ADMIN') return;
    try {
      const s = await navigator.mediaDevices.getUserMedia({video:{width:{ideal:3840}}});
      document.getElementById('videoFeed').srcObject = s;
    } catch(e) { console.log("Cam error"); }
  }

  /* --- OPERATOR LOGIC --- */
  function startSession(sn) {
    currentSN = sn; currentOC = ""; photos = { PRZOD: null, TYL: null, OBRAZ: null };
    document.getElementById('tagSN').innerText = "SN: " + sn;
    document.getElementById('scanInputOC').value = ""; document.getElementById('scanInputOC').disabled = true;
    document.querySelectorAll('.checklist-btn').forEach(b => b.classList.remove('done'));
    document.getElementById('actionBtn').innerText = "OCZEKIWANIE (0/3)";
    document.getElementById('actionBtn').classList.remove('active');
    document.getElementById('statusSelect').value = "OK";
    
    sessionStartTime = new Date();
    document.getElementById('sessionTimer').innerText = "‚è±Ô∏è 00:00";
  }

  function checkOcRequirement() {
      const decision = document.getElementById('statusSelect').value;
      const ocInput = document.getElementById('scanInputOC');
      if(['OK','RMA'].includes(decision)) {
          ocInput.placeholder = "‚ö†Ô∏è SKANUJ OC (WYMAGANE)";
          ocInput.style.borderColor = currentOC ? "var(--neon-green)" : "var(--neon-red)";
      } else {
          ocInput.placeholder = "OC OPCJONALNE";
          ocInput.style.borderColor = "#333";
      }
  }

  document.getElementById('scanInput').addEventListener('keydown', e => {
    if(e.key==='Enter') {
      const v = e.target.value.trim().toUpperCase();
      if(v.length>3) { SoundFX.play('beep'); startSession(v); saveRecoveryState(); 
        document.getElementById('scanInputOC').disabled=false; checkOcRequirement(); document.getElementById('scanInputOC').focus(); 
      } else SoundFX.play('error');
      e.target.value = "";
    }
  });

  document.getElementById('scanInputOC').addEventListener('keydown', e => {
    if(e.key==='Enter') {
        const v = e.target.value.trim().toUpperCase();
        if(v.length>3) { currentOC = v; SoundFX.play('beep'); checkOcRequirement(); saveRecoveryState(); }
    }
  });

  function saveRecoveryState() {
      if(!currentSN) return;
      localStorage.setItem('oled_recovery', JSON.stringify({sn:currentSN, oc:currentOC, status:document.getElementById('statusSelect').value}));
  }
  function checkRecovery() {
      const rec = JSON.parse(localStorage.getItem('oled_recovery'));
      if(rec && confirm(`Przywr√≥ciƒá sesjƒô dla SN: ${rec.sn}?`)) {
          startSession(rec.sn);
          if(rec.oc) { currentOC = rec.oc; document.getElementById('scanInputOC').value = rec.oc; }
          document.getElementById('statusSelect').value = rec.status;
          document.getElementById('scanInputOC').disabled = false;
      } else localStorage.removeItem('oled_recovery');
  }
  function clearRecovery() { localStorage.removeItem('oled_recovery'); }

  /* --- CAPTURE & SAVE (OPERATOR) --- */
  function capture(type) {
      if(!currentSN) return; tempPhotoType=type;
      const v = document.getElementById('videoFeed'); v.pause();
      document.getElementById('drawToolbar').style.display='block';
      document.getElementById('drawCanvas').style.display='block';
      const c = document.getElementById('drawCanvas'); c.width=v.offsetWidth; c.height=v.offsetHeight;
      const ctx = c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);
  }
  function confirmPhoto() { processPhoto(); }
  function cancelPhoto() {
      document.getElementById('videoFeed').play();
      document.getElementById('drawToolbar').style.display='none';
      document.getElementById('drawCanvas').style.display='none';
  }
  function processPhoto() {
      const v = document.getElementById('videoFeed');
      const finalC = document.getElementById('photoCanvas'); finalC.width=v.videoWidth; finalC.height=v.videoHeight;
      const ctx = finalC.getContext('2d');
      if(isMirrored) { ctx.translate(finalC.width,0); ctx.scale(-1,1); }
      ctx.drawImage(v,0,0);
      ctx.drawImage(document.getElementById('drawCanvas'),0,0,finalC.width,finalC.height);
      
      const fs=Math.floor(finalC.height/25); ctx.font=`bold ${fs}px Roboto`; ctx.fillStyle="#0aff00";
      ctx.fillText(`SN: ${currentSN}`,50,fs+20);
      
      finalC.toBlob(b => {
          photos[tempPhotoType] = b;
          document.getElementById('actionBtn').innerText = `GOTOWE (ZAPISZ)`; 
          document.getElementById('actionBtn').classList.add('active'); 
          cancelPhoto();
      },'image/jpeg',0.9);
  }

  async function saveData() {
      const dec = document.getElementById('statusSelect').value;
      if(['OK','RMA'].includes(dec) && !currentOC) return alert("BRAK OC!");
      
      document.getElementById('saveStatus').innerText = "ZAPISYWANIE...";
      document.getElementById('saveStatus').style.color = "orange";

      const txt = `RAPORT\nSN: ${currentSN}\nOC: ${currentOC}\nOP: ${currentUser.login}\nDEC: ${dec}`;
      
      // 1. Zapis lokalny (txt)
      if(dirHandle) {
          try {
              const d = await dirHandle.getDirectoryHandle(currentSN, {create:true});
              const h = await d.getFileHandle(`RAPORT_${currentSN}.txt`, {create:true});
              const w = await h.createWritable(); await w.write(txt); await w.close();
          } catch(e) { console.log("B≈ÇƒÖd zapisu lokalnego"); }
      }

      // 2. Zapis do Google Sheets (Cloud)
      try {
          const payload = {
              sn: currentSN,
              oc: currentOC || "---",
              op: currentUser.login,
              dec: dec,
              com: document.getElementById('commentInput').value
          };

          const res = await fetch(CONFIG.sheetUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
          });

          if(res.ok) {
              logSystem("Dane wys≈Çane do Google Sheets");
          } else {
              alert("B≈ÇƒÖd wysy≈Çania do Google Sheets!");
          }
      } catch(e) {
          console.error("Cloud save error:", e);
          alert("B≈ÇƒÖd po≈ÇƒÖczenia z bazƒÖ online (Zapisano tylko lokalnie)");
      }

      finishSave(dec);
  }

  function finishSave(dec) {
      clearRecovery(); 
      document.getElementById('saveStatus').innerText = "ZAPISANO";
      document.getElementById('saveStatus').style.color = "var(--neon-green)";
      
      recentScans.unshift({sn: currentSN, dec: dec});
      if(recentScans.length > 5) recentScans.pop();
      const list = document.getElementById('recentList');
      list.innerHTML = "";
      recentScans.forEach(r => {
          let c = r.dec.includes('NG') ? 'red' : 'green';
          list.innerHTML += `<div class="recent-item"><span>${r.sn}</span><span style="color:${c}">${r.dec}</span></div>`;
      });

      if(dirHandle) scanNetworkForOperator();

      new QRCode(document.getElementById('qrCodeBox'), `${currentSN}|${dec}`);
      document.getElementById('qrPopup').style.display='block';
      
      sessionStartTime = null; 
      setTimeout(()=>{ currentSN=""; startSession(""); },1000);
  }
  function closeQr() { document.getElementById('qrPopup').style.display='none'; }

  function startDraw(e) { isDrawing=true; draw(e); }
  function endDraw() { isDrawing=false; document.getElementById('drawCanvas').getContext('2d').beginPath(); }
  function draw(e) {
      if(!isDrawing) return;
      const ctx = document.getElementById('drawCanvas').getContext('2d');
      const rect = e.target.getBoundingClientRect();
      const x = e.clientX - rect.left; const y = e.clientY - rect.top;
      ctx.lineWidth=5; ctx.strokeStyle=drawColor; ctx.lineTo(x,y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x,y);
  }
  function setDrawColor(c) { drawColor=c; }
  function clearDraw() { const c=document.getElementById('drawCanvas'); c.getContext('2d').clearRect(0,0,c.width,c.height); }
  function togglePatterns() { document.getElementById('patternOverlay').style.display='block'; nextPattern(); }
  let pIdx=-1; const pats=['#fff','#f00','#0f0','#00f','#000'];
  function nextPattern() { pIdx++; if(pIdx>=pats.length){document.getElementById('patternOverlay').style.display='none';pIdx=-1;} else document.getElementById('patternOverlay').style.background=pats[pIdx]; }
  function toggleFullScreen() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
  function toggleReportPanel() { document.getElementById('reportPanel').classList.toggle('open'); }
</script>
</body>
</html>
