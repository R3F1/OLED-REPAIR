<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>OLED REPAIR - NETWORK AUTO SAVE</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-color: #050505;
      --panel-bg: rgba(15, 20, 30, 0.9);
      --neon-blue: #00f3ff;
      --neon-green: #0aff00;
      --neon-red: #ff003c;
      --glass-border: 1px solid rgba(255, 255, 255, 0.15);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background-color: var(--bg-color); color: #fff;
      font-family: 'Rajdhani', sans-serif; height: 100vh;
      overflow: hidden; display: flex; flex-direction: column;
      background-image: linear-gradient(rgba(0, 243, 255, 0.02) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 243, 255, 0.02) 1px, transparent 1px);
      background-size: 30px 30px;
    }

    /* HEADER */
    header {
      height: 60px; display: flex; justify-content: space-between; align-items: center;
      padding: 0 20px; background: rgba(0,0,0,0.8); border-bottom: 1px solid #333;
    }
    .brand { font-family: 'Share Tech Mono'; font-size: 22px; color: var(--neon-blue); letter-spacing: 2px; }
    
    /* PRZYCISK PO≈ÅƒÑCZENIA SIECIOWEGO */
    .network-btn {
      background: #222; border: 1px solid #555; color: #aaa;
      padding: 8px 20px; cursor: pointer; font-family: 'Share Tech Mono';
      border-radius: 4px; transition: 0.3s; display: flex; align-items: center; gap: 10px;
    }
    .network-btn.connected {
      background: rgba(10, 255, 0, 0.1); border-color: var(--neon-green); color: var(--neon-green);
      box-shadow: 0 0 15px rgba(10, 255, 0, 0.2);
    }
    .network-btn:hover { border-color: #fff; color: #fff; }

    /* LAYOUT */
    .dashboard { flex: 1; display: grid; grid-template-columns: 360px 1fr; gap: 20px; padding: 20px; overflow: hidden; }
    
    .control-panel {
      background: var(--panel-bg); border: var(--glass-border); border-radius: 12px;
      padding: 20px; display: flex; flex-direction: column; overflow-y: auto;
    }
    .camera-panel {
      position: relative; background: #000; border: 2px solid #333; border-radius: 12px; overflow: hidden;
    }
    video { width: 100%; height: 100%; object-fit: contain; }

    /* INPUT */
    .scan-container { margin-bottom: 20px; }
    #scanInput {
      width: 100%; padding: 15px; font-size: 24px; text-align: center;
      background: #000; border: 2px solid #444; color: var(--neon-green);
      font-family: 'Share Tech Mono'; border-radius: 8px; outline: none;
    }
    #scanInput:focus { border-color: var(--neon-green); box-shadow: 0 0 15px rgba(10,255,0,0.2); }

    /* BUTTONS */
    .btn-step {
      width: 100%; padding: 15px; margin-bottom: 10px;
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
      color: #fff; cursor: pointer; text-align: left; font-weight: bold;
      display: flex; justify-content: space-between; border-radius: 5px;
    }
    .btn-step.done { border-color: var(--neon-green); color: var(--neon-green); background: rgba(10,255,0,0.05); }

    #finalizeBtn {
      width: 100%; padding: 20px; margin-top: auto;
      background: #222; color: #555; border: none; font-size: 16px; font-weight: bold;
      cursor: not-allowed; border-radius: 8px; text-transform: uppercase;
    }
    #finalizeBtn.ready {
      background: var(--neon-green); color: #000; cursor: pointer;
      animation: pulse 2s infinite; box-shadow: 0 0 20px rgba(10,255,0,0.4);
    }
    
    @keyframes pulse { 0% { box-shadow: 0 0 15px rgba(10,255,0,0.4); } 50% { box-shadow: 0 0 30px rgba(10,255,0,0.7); } 100% { box-shadow: 0 0 15px rgba(10,255,0,0.4); } }

    /* OVERLAYS */
    .overlay-info {
      position: absolute; top: 20px; left: 20px;
      background: rgba(0,0,0,0.7); padding: 5px 15px;
      border-left: 3px solid var(--neon-blue); font-family: 'Share Tech Mono';
    }
    .path-copy-box {
      font-size: 10px; color: #666; margin-top: 5px; cursor: pointer;
      border: 1px dashed #444; padding: 5px; text-align: center;
    }
    .path-copy-box:hover { color: var(--neon-blue); border-color: var(--neon-blue); }

    canvas { display: none; }
  </style>
</head>
<body>

<header>
  <div class="brand">OLED REPAIR <span style="font-size:12px; opacity:0.6">NETWORK AUTO-SAVE</span></div>
  
  <button class="network-btn" id="connectBtn" onclick="connectToNetworkFolder()">
    <span id="connIcon">üìÇ</span>
    <span id="connText">PO≈ÅƒÑCZ Z FOLDEREM SIECIOWYM</span>
  </button>
</header>

<div class="dashboard">
  <aside class="control-panel">
    <div class="scan-container">
      <div style="font-size:12px; color:#888; margin-bottom:5px;">SKANER KOD√ìW (SN)</div>
      <input type="text" id="scanInput" placeholder="ZESKANUJ TUTAJ" autocomplete="off" autofocus>
    </div>

    <div class="path-copy-box" onclick="copyNetworkPath()" title="Kliknij, aby skopiowaƒá ≈õcie≈ºkƒô do schowka">
      Domy≈õlna ≈õcie≈ºka:<br>
      \\plgorfs001\pub\SERVICE\LCDR\LCDR\OLED OBM Panels\Zdjƒôcia z napraw OLED
    </div>

    <h3 style="border-bottom:1px solid #333; padding-bottom:10px; color:var(--neon-blue)">STATUS ZDJƒòƒÜ: <span id="photoCounter">0/3</span></h3>

    <button class="btn-step" id="btnFront" onclick="capture('PRZOD')">
      <span>1. PRZ√ìD TV</span> <span>[ ]</span>
    </button>
    <button class="btn-step" id="btnBack" onclick="capture('TYL')">
      <span>2. TY≈Å TV (Tabliczka)</span> <span>[ ]</span>
    </button>
    <button class="btn-step" id="btnImage" onclick="capture('OBRAZ')">
      <span>3. OBRAZ (Test)</span> <span>[ ]</span>
    </button>

    <button id="finalizeBtn" onclick="saveFiles()">
      OCZEKIWANIE NA ZDJƒòCIA
    </button>
    
    <div id="statusMsg" style="margin-top:15px; text-align:center; color:#888; font-size:12px;"></div>
  </aside>

  <main class="camera-panel">
    <div class="overlay-info">
      <div id="dispSN" style="font-size:18px; color:#fff;">SN: BRAK</div>
      <div id="dispMode" style="font-size:12px; color:#aaa;">OCZEKIWANIE</div>
    </div>
    <video id="videoFeed" autoplay playsinline></video>
  </main>
</div>

<canvas id="photoCanvas"></canvas>

<script>
  // ≈öCIE≈ªKA DO SKOPIOWANIA (Dla wygody u≈ºytkownika)
  const NETWORK_PATH = String.raw`\\plgorfs001\pub\SERVICE\LCDR\LCDR\OLED OBM Panels\Zdjƒôcia z napraw OLED`;

  // ZMIENNE
  let dirHandle = null; // Uchwyt do folderu sieciowego
  let currentSN = "";
  let photos = { PRZOD: null, TYL: null, OBRAZ: null };
  
  const video = document.getElementById('videoFeed');
  const canvas = document.getElementById('photoCanvas');
  const ctx = canvas.getContext('2d');
  const scanInput = document.getElementById('scanInput');
  const finalizeBtn = document.getElementById('finalizeBtn');

  // START
  initCamera();

  /* --- 1. ≈ÅƒÑCZENIE Z FOLDEREM SIECIOWYM (FILE SYSTEM API) --- */
  async function connectToNetworkFolder() {
    try {
      // Wywo≈Çanie okna wyboru folderu
      alert("W nastƒôpnym oknie wybierz folder sieciowy:\n\n" + NETWORK_PATH + "\n\n(Skopiowa≈Çem Ci ju≈º ≈õcie≈ºkƒô do schowka - wklej jƒÖ w pasek adresu!)");
      await navigator.clipboard.writeText(NETWORK_PATH);
      
      dirHandle = await window.showDirectoryPicker();
      
      // Zmiana wyglƒÖdu przycisku na po≈ÇƒÖczony
      document.getElementById('connectBtn').classList.add('connected');
      document.getElementById('connText').innerText = "PO≈ÅƒÑCZONO Z SIECIƒÑ";
      document.getElementById('connIcon').innerText = "üì°";
      document.getElementById('statusMsg').innerText = "Gotowy do zapisu bezpo≈õredniego na serwerze.";
      document.getElementById('statusMsg').style.color = "#0aff00";

    } catch (err) {
      console.error(err);
      alert("Nie wybrano folderu lub przeglƒÖdarka nie obs≈Çuguje tej funkcji. System prze≈ÇƒÖczy siƒô w tryb pobierania ZIP.");
    }
  }

  function copyNetworkPath() {
    navigator.clipboard.writeText(NETWORK_PATH);
    const box = document.querySelector('.path-copy-box');
    const oldText = box.innerHTML;
    box.innerText = "SKOPIOWANO DO SCHOWKA!";
    box.style.borderColor = "#0aff00";
    box.style.color = "#0aff00";
    setTimeout(() => {
      box.innerHTML = oldText;
      box.style.borderColor = "#444";
      box.style.color = "#666";
    }, 1500);
  }

  /* --- 2. KAMERA 4K --- */
  async function initCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { width: { ideal: 4096 }, height: { ideal: 2160 } } 
      });
      video.srcObject = stream;
    } catch (e) {
      alert("B≈ÇƒÖd kamery!");
    }
  }

  /* --- 3. SKANER --- */
  scanInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const val = scanInput.value.trim().toUpperCase();
      if (val.length > 3) {
        newSession(val);
        scanInput.value = "";
        scanInput.blur();
      } else {
        alert("Za kr√≥tki SN");
      }
    }
  });

  function newSession(sn) {
    currentSN = sn;
    photos = { PRZOD: null, TYL: null, OBRAZ: null };
    
    // UI Reset
    document.getElementById('dispSN').innerText = "SN: " + sn;
    document.getElementById('photoCounter').innerText = "0/3";
    finalizeBtn.className = "";
    finalizeBtn.innerText = "OCZEKIWANIE NA ZDJƒòCIA";
    
    ['btnFront', 'btnBack', 'btnImage'].forEach(id => {
      const btn = document.getElementById(id);
      btn.classList.remove('done');
      btn.children[1].innerText = "[ ]";
    });
  }

  /* --- 4. ZDJƒòCIA --- */
  function capture(type) {
    if (!currentSN) {
      alert("Najpierw zeskanuj SN!");
      scanInput.focus();
      return;
    }

    // Flash
    const flash = document.createElement('div');
    flash.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;background:white;opacity:0.8;z-index:999";
    document.querySelector('.camera-panel').appendChild(flash);
    setTimeout(() => flash.remove(), 100);

    // Capture
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    
    // Watermark
    const fs = Math.floor(video.videoHeight / 30);
    ctx.font = `bold ${fs}px Consolas`;
    ctx.fillStyle = "#0aff00"; ctx.strokeStyle = "black"; ctx.lineWidth = 3;
    ctx.strokeText(`SN: ${currentSN}`, 50, fs+20);
    ctx.fillText(`SN: ${currentSN}`, 50, fs+20);
    ctx.fillStyle = "#00f3ff";
    ctx.strokeText(type, 50, (fs*2)+30);
    ctx.fillText(type, 50, (fs*2)+30);

    canvas.toBlob(blob => {
      photos[type] = blob;
      updateUI();
    }, 'image/jpeg', 0.95);
  }

  function updateUI() {
    const done = Object.values(photos).filter(p => p).length;
    document.getElementById('photoCounter').innerText = `${done}/3`;
    
    // Checkmarks
    if(photos.PRZOD) { document.getElementById('btnFront').classList.add('done'); document.getElementById('btnFront').children[1].innerText = "[‚úî]"; }
    if(photos.TYL) { document.getElementById('btnBack').classList.add('done'); document.getElementById('btnBack').children[1].innerText = "[‚úî]"; }
    if(photos.OBRAZ) { document.getElementById('btnImage').classList.add('done'); document.getElementById('btnImage').children[1].innerText = "[‚úî]"; }

    if (done === 3) {
      finalizeBtn.classList.add('ready');
      if (dirHandle) {
        finalizeBtn.innerText = "üíæ ZAPISZ AUTOMATYCZNIE NA SERWERZE";
      } else {
        finalizeBtn.innerText = "üíæ POBIERZ ZIP (BRAK PO≈ÅƒÑCZENIA)";
      }
    }
  }

  /* --- 5. ZAPIS PLIK√ìW (KLUCZOWA FUNKCJA) --- */
  async function saveFiles() {
    if (!finalizeBtn.classList.contains('ready')) return;

    // TRYB AUTOMATYCZNY (Gdy wybrano folder)
    if (dirHandle) {
      try {
        finalizeBtn.innerText = "‚è≥ ZAPISYWANIE NA SERWERZE...";
        
        // 1. Tworzymy podfolder dla danego SN
        // getDirectoryHandle(name, {create: true}) tworzy folder je≈õli nie istnieje
        const snFolderHandle = await dirHandle.getDirectoryHandle(currentSN, { create: true });

        // 2. Zapisujemy 3 zdjƒôcia
        await writeToFile(snFolderHandle, `${currentSN}_PRZOD.jpg`, photos.PRZOD);
        await writeToFile(snFolderHandle, `${currentSN}_TYL.jpg`, photos.TYL);
        await writeToFile(snFolderHandle, `${currentSN}_OBRAZ.jpg`, photos.OBRAZ);

        // Sukces
        alert(`SUKCES!\nZdjƒôcia zapisane w folderze:\n...\\${currentSN}\\`);
        resetSession();

      } catch (err) {
        console.error(err);
        alert("B≈ÇƒÖd zapisu! Sprawd≈∫ uprawnienia do folderu sieciowego.\nSpr√≥bujƒô pobraƒá ZIP jako awariƒô.");
        downloadZipFallback();
      }
    } 
    // TRYB FALLBACK (ZIP)
    else {
      alert("Nie po≈ÇƒÖczono z folderem sieciowym. Pobieram ZIP na dysk lokalny.");
      downloadZipFallback();
    }
  }

  // Pomocnicza funkcja zapisu pliku
  async function writeToFile(folderHandle, filename, blob) {
    const fileHandle = await folderHandle.getFileHandle(filename, { create: true });
    const writable = await fileHandle.createWritable();
    await writable.write(blob);
    await writable.close();
  }

  function downloadZipFallback() {
    const zip = new JSZip();
    const folder = zip.folder(currentSN);
    folder.file(`${currentSN}_PRZOD.jpg`, photos.PRZOD);
    folder.file(`${currentSN}_TYL.jpg`, photos.TYL);
    folder.file(`${currentSN}_OBRAZ.jpg`, photos.OBRAZ);
    zip.generateAsync({type:"blob"}).then(c => {
      saveAs(c, `${currentSN}.zip`);
      resetSession();
    });
  }

  function resetSession() {
    currentSN = "";
    document.getElementById('dispSN').innerText = "GOTOWY";
    document.getElementById('photoCounter').innerText = "0/3";
    finalizeBtn.classList.remove('ready');
    finalizeBtn.innerText = "OCZEKIWANIE NA ZDJƒòCIA";
    ['btnFront', 'btnBack', 'btnImage'].forEach(id => {
      document.getElementById(id).classList.remove('done');
      document.getElementById(id).children[1].innerText = "[ ]";
    });
    scanInput.focus();
  }
</script>

</body>
</html>
