<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>OLED MASTER REPAIR STATION</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  
  <style>
    :root {
      --primary: #00f3ff;   /* Cyber Blue */
      --success: #00ff66;   /* Cyber Green */
      --danger: #ff0055;    /* Cyber Red */
      --bg-dark: #050505;
      --panel: rgba(20, 20, 25, 0.9);
      --glass: rgba(255, 255, 255, 0.05);
    }

    body {
      font-family: 'Segoe UI', 'Roboto', monospace;
      margin: 0;
      background-color: var(--bg-dark);
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(0, 243, 255, 0.1) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(255, 0, 85, 0.1) 0%, transparent 20%);
      color: #eee;
      height: 100vh;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
    }

    /* HEADER */
    header {
      padding: 15px 30px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(10px);
    }
    header h1 {
      margin: 0;
      font-size: 24px;
      letter-spacing: 2px;
      text-transform: uppercase;
      background: linear-gradient(90deg, #fff, var(--primary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* CONTAINER */
    .main-grid {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 20px;
      padding: 20px;
      flex: 1;
      overflow-y: auto;
    }

    /* PANELS */
    .panel {
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 30px rgba(0,0,0,0.5);
      position: relative;
    }
    .panel h2 {
      margin-top: 0;
      color: var(--primary);
      font-size: 16px;
      text-transform: uppercase;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 10px;
    }

    /* INPUT SECTION */
    .scan-wrapper {
      position: relative;
      margin-bottom: 20px;
    }
    #scanInput {
      width: 100%;
      padding: 15px;
      font-size: 22px;
      background: rgba(0,0,0,0.5);
      border: 2px solid #333;
      border-radius: 8px;
      color: var(--success);
      font-family: monospace;
      text-align: center;
      outline: none;
      transition: 0.3s;
      box-sizing: border-box;
    }
    #scanInput:focus {
      border-color: var(--primary);
      box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
    }

    /* CAMERA VIEW */
    .camera-frame {
      width: 100%;
      height: 400px;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      border: 2px solid #333;
    }
    video { width: 100%; height: 100%; object-fit: cover; }
    
    .overlay-info {
      position: absolute;
      top: 10px; left: 10px;
      background: rgba(0,0,0,0.7);
      padding: 5px 10px;
      border-left: 3px solid var(--primary);
      font-family: monospace;
      font-size: 14px;
    }

    /* 3D TV MODEL */
    .scene-3d {
      height: 180px;
      perspective: 800px;
      margin: 20px 0;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .tv-cube {
      width: 240px;
      height: 140px;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .face {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border: 2px solid #444;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
    }
    .face-front {
      background: linear-gradient(135deg, #111, #1a1a1a);
      color: var(--primary);
      border-bottom: 8px solid #000;
    }
    .face-back {
      background: #222;
      color: #888;
      transform: rotateY(180deg);
      border: 2px dashed #555;
    }

    /* PROGRESS BAR */
    .progress-container {
      background: #333;
      height: 10px;
      border-radius: 5px;
      margin: 15px 0;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: var(--danger); /* Zaczyna jako czerwony */
      transition: width 0.3s, background 0.3s;
    }

    /* BUTTONS */
    .btn-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    .action-btn {
      padding: 15px 5px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      cursor: pointer;
      border-radius: 6px;
      transition: 0.2s;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }
    .action-btn:hover { background: rgba(255,255,255,0.1); }
    .action-btn.done {
      border-color: var(--success);
      color: var(--success);
      background: rgba(0, 255, 102, 0.1);
    }
    .action-btn.done::after { content: "‚úî OK"; font-size: 10px; }

    #finalizeBtn {
      width: 100%;
      padding: 18px;
      background: #333;
      color: #777;
      border: none;
      font-size: 16px;
      font-weight: bold;
      border-radius: 8px;
      cursor: not-allowed;
      transition: 0.3s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    /* Styl aktywnego przycisku */
    #finalizeBtn.active {
      background: var(--success);
      color: #000;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(0, 255, 102, 0.4);
    }
    #finalizeBtn.active:hover { transform: scale(1.02); }

    /* DATABASE TABLE */
    .db-container {
      margin-top: 20px;
      max-height: 200px;
      overflow-y: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th { text-align: left; color: #888; border-bottom: 1px solid #333; padding: 5px; }
    td { padding: 8px 5px; border-bottom: 1px solid #222; }
    .status-badge {
      background: var(--success);
      color: black;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: bold;
    }

    /* ALERTS (TOAST) */
    #toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      padding: 15px 30px;
      border-radius: 50px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      font-weight: bold;
      opacity: 0;
      pointer-events: none;
      transition: 0.3s;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #toast.error { background: var(--danger); color: white; }
    #toast.success { background: var(--success); color: black; }
    #toast.show { opacity: 1; bottom: 50px; }

    canvas { display: none; }
  </style>
</head>
<body>

<header>
  <h1>OLED REPAIR <span style="font-size:0.5em; opacity:0.7">MASTER STATION</span></h1>
  <div style="font-size: 12px; color: #aaa;">Lokalna Baza Danych: AKTYWNA</div>
</header>

<div class="main-grid">
  
  <div class="panel">
    <h2>1. Skanowanie</h2>
    <div class="scan-wrapper">
      <input type="text" id="scanInput" placeholder="Skup siƒô tu i ZESKANUJ..." autofocus autocomplete="off">
    </div>

    <div class="camera-frame">
      <video id="videoFeed" autoplay playsinline></video>
      <div class="overlay-info">
        <div id="overlaySN">SN: BRAK</div>
        <div id="overlayDate" style="font-size:10px; opacity:0.7">--</div>
      </div>
    </div>
  </div>

  <div class="panel">
    <h2>2. Dokumentacja (Wymagane 3)</h2>
    
    <div class="scene-3d">
      <div class="tv-cube" id="tvModel">
        <div class="face face-front">EKRAN (PRZ√ìD/OBRAZ)</div>
        <div class="face face-back">ELEKTRONIKA (TY≈Å)</div>
      </div>
    </div>

    <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;">
      <span>Postƒôp zdjƒôƒá:</span>
      <span id="progressText">0 / 3</span>
    </div>
    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="btn-grid">
      <button class="action-btn" id="btnFront" onclick="captureStep('PRZOD')">
        üì∏ 1. PRZ√ìD
      </button>
      <button class="action-btn" id="btnBack" onclick="captureStep('TYL')">
        üì∏ 2. TY≈Å
      </button>
      <button class="action-btn" id="btnImage" onclick="captureStep('OBRAZ')">
        üì∏ 3. OBRAZ
      </button>
    </div>

    <button id="finalizeBtn" onclick="finalizeProcess()">
      üîí Zablokowane (Brakuje zdjƒôƒá)
    </button>

    <div style="margin-top: 30px;">
      <h2>Historia Sesji (Lokalna)</h2>
      <div class="db-container">
        <table id="dbTable">
          <thead>
            <tr><th>Godz.</th><th>Serial Number</th><th>Status</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <button onclick="clearDB()" style="margin-top:10px; background:transparent; border:none; color:#555; cursor:pointer; font-size:11px;">[Wyczy≈õƒá historiƒô]</button>
    </div>
  </div>
</div>

<canvas id="photoCanvas"></canvas>

<div id="toast">Komunikat</div>

<script>
  /* --- ZMIENNE SYSTEMOWE --- */
  let currentSN = "";
  let sessionPhotos = {
    PRZOD: null,
    TYL: null,
    OBRAZ: null
  };
  
  const video = document.getElementById('videoFeed');
  const canvas = document.getElementById('photoCanvas');
  const ctx = canvas.getContext('2d');
  const tv3d = document.getElementById('tvModel');
  
  // Elementy UI
  const progressText = document.getElementById('progressText');
  const progressBar = document.getElementById('progressBar');
  const finalizeBtn = document.getElementById('finalizeBtn');

  /* --- 1. INICJALIZACJA KAMERY --- */
  async function initCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { width: { ideal: 1920 }, height: { ideal: 1080 } } 
      });
      video.srcObject = stream;
    } catch (e) {
      showToast("B≈ÇƒÖd kamery! Sprawd≈∫ USB.", "error");
    }
    loadHistory(); // Za≈Çaduj tabelƒô przy starcie
  }
  initCamera();

  /* --- 2. OBS≈ÅUGA SKANOWANIA --- */
  document.getElementById('scanInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      const val = this.value.trim().toUpperCase();
      if (val.length > 3) {
        startNewSession(val);
        this.value = "";
        this.blur();
      } else {
        showToast("Za kr√≥tki kod SN!", "error");
      }
    }
  });

  function startNewSession(sn) {
    currentSN = sn;
    // Reset zmiennych
    sessionPhotos = { PRZOD: null, TYL: null, OBRAZ: null };
    
    // Update UI
    document.getElementById('overlaySN').textContent = "SN: " + sn;
    document.getElementById('overlayDate').textContent = new Date().toLocaleString();
    
    // Reset przycisk√≥w
    ['btnFront', 'btnBack', 'btnImage'].forEach(id => {
      document.getElementById(id).classList.remove('done');
    });
    
    updateProgress();
    rotate3D('front');
    showToast(`Zeskanowano: ${sn}`, "success");
  }

  /* --- 3. ROBIENIE ZDJƒòƒÜ I WALIDACJA --- */
  function captureStep(type) {
    if (!currentSN) {
      showToast("B≈ÅƒÑD: Najpierw zeskanuj kod!", "error");
      document.getElementById('scanInput').focus();
      return;
    }

    // Efekt obrotu TV
    if (type === 'TYL') rotate3D('back');
    else rotate3D('front');

    // Rysowanie na canvas
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);

    // WATERMARK (Wypalanie danych)
    ctx.font = "bold 30px Consolas";
    ctx.fillStyle = "#00ff66";
    ctx.shadowColor = "black";
    ctx.shadowBlur = 4;
    ctx.fillText(`SN: ${currentSN}`, 30, 50);
    ctx.fillStyle = "#00f3ff";
    ctx.fillText(`WIDOK: ${type}`, 30, 90);
    ctx.fillStyle = "white";
    ctx.font = "20px Consolas";
    ctx.fillText(new Date().toLocaleString(), 30, 125);

    // Zapis do Bloba
    canvas.toBlob(blob => {
      sessionPhotos[type] = blob;
      
      // Oznacz przycisk jako zrobiony
      let btnId = type === 'PRZOD' ? 'btnFront' : (type === 'TYL' ? 'btnBack' : 'btnImage');
      document.getElementById(btnId).classList.add('done');
      
      updateProgress();
    }, 'image/jpeg', 0.90);
  }

  /* --- 4. LOGIKA PROGRESU (0/3 -> OK) --- */
  function updateProgress() {
    const taken = Object.values(sessionPhotos).filter(p => p !== null).length;
    const total = 3;
    const percent = (taken / total) * 100;

    progressText.textContent = `${taken} / ${total}`;
    progressBar.style.width = `${percent}%`;

    if (taken === 3) {
      // Sukces - odblokuj przycisk
      progressBar.style.background = "var(--success)";
      finalizeBtn.classList.add('active');
      finalizeBtn.innerHTML = "üíæ ZAPISZ I POBIERZ PACZKƒò";
      finalizeBtn.onclick = finalizeProcess;
      showToast("Komplet! Mo≈ºesz zapisaƒá.", "success");
    } else {
      // Niekompletne
      progressBar.style.background = "var(--danger)";
      finalizeBtn.classList.remove('active');
      finalizeBtn.innerHTML = `üîí Brakuje zdjƒôƒá (${3-taken})`;
      finalizeBtn.onclick = () => showToast(`Brakuje jeszcze ${3-taken} zdjƒôƒá!`, "error");
    }
  }

  /* --- 5. FINALIZACJA I BAZA DANYCH (LocalStorage) --- */
  function finalizeProcess() {
    if (!currentSN) return;

    // 1. Zapis do Historii (Baza Lokalna)
    saveToLocalDB(currentSN, "OK");

    // 2. Generowanie ZIP
    const zip = new JSZip();
    const folder = zip.folder(currentSN);
    folder.file(`${currentSN}_PRZOD.jpg`, sessionPhotos.PRZOD);
    folder.file(`${currentSN}_TYL.jpg`, sessionPhotos.TYL);
    folder.file(`${currentSN}_OBRAZ.jpg`, sessionPhotos.OBRAZ);

    zip.generateAsync({type:"blob"}).then(content => {
      saveAs(content, `${currentSN}_COMPLETE.zip`);
      showToast("Pobieranie rozpoczƒôte...", "success");
      
      // 3. Reset sesji po zapisie
      setTimeout(() => {
        currentSN = "";
        document.getElementById('overlaySN').textContent = "GOTOWY";
        document.getElementById('scanInput').focus();
        document.getElementById('scanInput').value = "";
        // Reset wizualny
        ['btnFront', 'btnBack', 'btnImage'].forEach(id => document.getElementById(id).classList.remove('done'));
        progressBar.style.width = "0%";
        finalizeBtn.classList.remove('active');
        finalizeBtn.innerHTML = "üîí Oczekiwanie na skan";
      }, 2000);
    });
  }

  // --- OBS≈ÅUGA LOCAL STORAGE ---
  function saveToLocalDB(sn, status) {
    let db = JSON.parse(localStorage.getItem('oled_repair_db') || "[]");
    
    // Dodaj nowy wpis na poczƒÖtek
    db.unshift({
      time: new Date().toLocaleTimeString(),
      sn: sn,
      status: status
    });

    // Ogranicz do ostatnich 50 wpis√≥w
    if (db.length > 50) db.pop();

    localStorage.setItem('oled_repair_db', JSON.stringify(db));
    loadHistory(); // Od≈õwie≈º tabelƒô
  }

  function loadHistory() {
    let db = JSON.parse(localStorage.getItem('oled_repair_db') || "[]");
    const tbody = document.querySelector("#dbTable tbody");
    tbody.innerHTML = "";

    db.forEach(row => {
      let tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.time}</td>
        <td style="font-family:monospace; color:#fff;">${row.sn}</td>
        <td><span class="status-badge">${row.status}</span></td>
      `;
      tbody.appendChild(tr);
    });
  }

  function clearDB() {
    if(confirm("Czy na pewno usunƒÖƒá historiƒô lokalnƒÖ?")) {
      localStorage.removeItem('oled_repair_db');
      loadHistory();
    }
  }

  /* --- POMOCNICZE --- */
  function rotate3D(view) {
    if (view === 'back') tv3d.style.transform = "rotateY(180deg)";
    else tv3d.style.transform = "rotateY(0deg)";
  }

  function showToast(msg, type) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = type; // success lub error
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
  }
</script>

</body>
</html>
