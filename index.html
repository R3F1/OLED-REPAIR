<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>OLED REPAIR SYSTEM v7.0 SECURE</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  
  <style>
    /* --- CONFIG & CORE STYLES --- */
    :root {
      --bg-deep: #050505;
      --panel-glass: rgba(20, 25, 35, 0.95);
      --neon-cyan: #00f3ff;
      --neon-green: #0aff00;
      --neon-red: #ff003c;
      --neon-gold: #ffd700; /* Kolor dla W≈Ça≈õciciela */
      --font-ui: 'Rajdhani', sans-serif;
      --font-tech: 'Share Tech Mono', monospace;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background-color: var(--bg-deep); color: #fff;
      font-family: var(--font-ui); height: 100vh; overflow: hidden;
      display: flex; flex-direction: column;
      background-image: radial-gradient(circle at 50% 50%, rgba(0, 243, 255, 0.05) 0%, transparent 60%), linear-gradient(0deg, rgba(0,0,0,0.8), transparent 2px);
      background-size: 100% 100%, 100% 4px;
    }

    /* --- 1. EKRAN LOGOWANIA --- */
    #loginScreen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999;
      display: flex; align-items: center; justify-content: center; flex-direction: column; transition: opacity 0.8s;
    }
    .login-box {
      width: 420px; padding: 40px; background: rgba(10, 10, 10, 0.95); border: 1px solid var(--neon-cyan);
      text-align: center; border-radius: 10px; position: relative; overflow: hidden;
      box-shadow: 0 0 50px rgba(0, 243, 255, 0.15);
    }
    .login-input {
      width: 100%; padding: 15px; margin: 10px 0; background: #000; border: 2px solid #333; color: var(--neon-cyan);
      font-family: var(--font-tech); font-size: 18px; text-align: center; outline: none;
    }
    .login-input:focus { border-color: var(--neon-cyan); }
    /* Styl dla pola has≈Ça */
    input[type="password"] { letter-spacing: 5px; color: var(--neon-red); }

    .login-btn {
      width: 100%; padding: 15px; margin-top: 20px; background: var(--neon-cyan); color: #000; font-weight: bold; border: none;
      cursor: pointer; font-family: var(--font-tech); transition: 0.3s; font-size: 16px;
    }
    .login-btn:hover { background: #fff; box-shadow: 0 0 20px var(--neon-cyan); }
    
    .login-error {
      color: var(--neon-red); font-size: 12px; height: 15px; margin-top: 10px; font-weight: bold;
    }

    /* --- 2. NETWORK GUARD --- */
    #networkGuard {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9); z-index: 8000; backdrop-filter: blur(10px);
      display: none; align-items: center; justify-content: center; flex-direction: column;
    }
    .alert-box {
      width: 500px; padding: 30px; border: 2px solid var(--neon-red); background: #080808;
      text-align: center; border-radius: 12px; box-shadow: 0 0 60px rgba(255, 0, 60, 0.2);
      animation: pulseAlert 2s infinite;
    }
    @keyframes pulseAlert { 0% { box-shadow: 0 0 30px rgba(255,0,60,0.1); } 50% { box-shadow: 0 0 60px rgba(255,0,60,0.3); } 100% { box-shadow: 0 0 30px rgba(255,0,60,0.1); } }
    .guard-btn {
      width: 100%; padding: 18px; background: var(--neon-red); color: #fff; font-weight: bold;
      border: none; cursor: pointer; font-family: var(--font-tech); font-size: 16px; margin-top: 10px;
    }
    .skip-btn { margin-top: 10px; background: transparent; border: none; color: #555; text-decoration: underline; cursor: pointer; font-size: 11px; }

    /* --- HEADER --- */
    header {
      height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 25px;
      background: rgba(0,0,0,0.8); border-bottom: 1px solid #333;
    }
    .brand { font-size: 24px; font-weight: 700; color: #fff; letter-spacing: 2px; }
    .brand span { color: var(--neon-cyan); }
    .operator-info { display: flex; align-items: center; gap: 15px; font-family: var(--font-tech); color: #aaa; font-size: 14px; }
    .operator-badge { background: #222; padding: 5px 15px; border-radius: 4px; border: 1px solid #444; color: var(--neon-cyan); transition: 0.3s; }
    
    /* Specjalny styl dla ADMINA */
    .operator-badge.admin {
      border-color: var(--neon-gold); color: var(--neon-gold);
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
    }

    /* --- DASHBOARD --- */
    .dashboard {
      flex: 1; display: grid; grid-template-columns: 380px 1fr; gap: 20px; padding: 20px; overflow: hidden;
      opacity: 0; transition: opacity 1s;
    }
    .panel-left {
      background: var(--panel-glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px;
      display: flex; flex-direction: column; overflow-y: auto;
    }
    .panel-right {
      position: relative; background: #000; border: 2px solid #333; border-radius: 12px; overflow: hidden;
    }
    video { width: 100%; height: 100%; object-fit: contain; }

    /* UI COMPONENTS */
    #scanInput {
      width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 12px; font-size: 20px;
      text-align: center; font-family: var(--font-tech); outline: none; border-radius: 5px; margin-bottom: 20px;
    }
    #scanInput:focus { border-color: var(--neon-green); }
    
    .checklist-btn {
      width: 100%; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); color: #aaa;
      padding: 12px; margin-bottom: 8px; cursor: pointer; text-align: left; font-family: var(--font-ui);
      display: flex; justify-content: space-between; transition: 0.2s; font-size: 14px;
    }
    .checklist-btn.done { border-color: var(--neon-green); color: var(--neon-green); background: rgba(10,255,0,0.05); }

    #actionBtn {
      margin-top: auto; padding: 15px; width: 100%; background: #111; color: #444; font-weight: bold; border: none;
      font-size: 14px; cursor: not-allowed; border-radius: 6px; text-transform: uppercase;
    }
    #actionBtn.active {
      background: var(--neon-green); color: #000; cursor: pointer; animation: pulseBtn 2s infinite;
    }
    @keyframes pulseBtn { 0% { box-shadow: 0 0 10px rgba(10,255,0,0.4); } 50% { box-shadow: 0 0 20px rgba(10,255,0,0.7); } 100% { box-shadow: 0 0 10px rgba(10,255,0,0.4); } }

    /* OVERLAYS */
    .cam-overlay { position: absolute; top: 20px; left: 20px; display: flex; flex-direction: column; gap: 5px; }
    .tag {
      background: rgba(0,0,0,0.8); color: #fff; padding: 4px 10px; font-family: var(--font-tech);
      font-size: 13px; border-left: 3px solid var(--neon-cyan); backdrop-filter: blur(5px);
    }
    .status-bar {
      height: 30px; background: #111; border-top: 1px solid #333; display: flex; align-items: center; justify-content: center;
      font-family: var(--font-tech); font-size: 11px; color: #666; gap: 10px;
    }
    .status-bar.ok { color: var(--neon-green); }

    /* MANAGER PANEL */
    .database-trigger {
      position: absolute; bottom: 30px; right: 30px; padding: 10px 20px; background: rgba(0,0,0,0.8);
      border: 1px solid var(--neon-cyan); color: var(--neon-cyan); cursor: pointer; font-family: var(--font-tech);
      z-index: 50; transition: 0.3s;
    }
    .database-trigger:hover { background: var(--neon-cyan); color: #000; }

    #databasePanel {
      position: fixed; bottom: 0; left: 0; width: 100%; height: 0; background: rgba(10, 15, 20, 0.98);
      z-index: 200; transition: height 0.5s; overflow: hidden; border-top: 2px solid var(--neon-cyan);
      display: flex; flex-direction: column;
    }
    #databasePanel.open { height: 80vh; }
    .db-header { padding: 20px; background: #000; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
    .db-content { flex: 1; overflow: auto; padding: 20px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; color: #ccc; font-family: var(--font-tech); }
    th { text-align: left; padding: 10px; border-bottom: 2px solid #333; color: var(--neon-cyan); background: #000; position: sticky; top: 0; }
    td { padding: 10px; border-bottom: 1px solid #222; }
    
    /* 3D SCENE */
    .scene-container { height: 180px; perspective: 800px; display: flex; justify-content: center; align-items: center; margin-bottom: 10px; }
    .tv-pivot { position: relative; width: 180px; height: 110px; transform-style: preserve-3d; transition: transform 0.8s; }
    .tv-panel { position: absolute; width: 100%; height: 100%; background: #000; border: 2px solid #333; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; }
    .tv-front { background: linear-gradient(135deg, #050505, #1a1a1a); border: 1px solid #555; }
    .tv-front::after { content: "OLED"; opacity: 0.3; font-weight: bold; }
    .tv-back { transform: rotateY(180deg); background: #151515; }
    .tv-stand { position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%); width: 60px; height: 5px; background: #333; }

    canvas { display: none; }
  </style>
</head>
<body>

<div id="loginScreen">
  <div class="login-box">
    <h2 style="margin:0; color:#fff; font-family: 'Share Tech Mono';">OLED REPAIR SYSTEM</h2>
    <div style="font-size:12px; color:#666; margin-bottom:20px;">V7.0 SECURE ACCESS</div>
    
    <label style="color:var(--neon-cyan); font-size:10px; display:block; text-align:left; margin-left:10px;">U≈ªYTKOWNIK</label>
    <input type="text" id="userInput" class="login-input" placeholder="IMIƒò">
    
    <label style="color:var(--neon-red); font-size:10px; display:block; text-align:left; margin-left:10px;">HAS≈ÅO</label>
    <input type="password" id="passInput" class="login-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">

    <div id="loginError" class="login-error"></div>

    <button class="login-btn" onclick="checkLogin()">ZALOGUJ</button>
  </div>
</div>

<div id="networkGuard">
  <div class="alert-box">
    <h2 style="color:var(--neon-red); margin:0;">‚ö†Ô∏è KONFIGURACJA SIECIOWA ‚ö†Ô∏è</h2>
    <p style="font-size:14px; color:#ddd; margin:10px 0;">WYMAGANE PO≈ÅƒÑCZENIE Z FOLDEREM SIECIOWYM</p>
    <div style="font-size:11px; color:#aaa; margin-bottom:5px;">≈öCIE≈ªKA DOCELOWA:</div>
    <div style="background:#111; padding:10px; border:1px dashed #555; font-size:10px; color:#aaa;">\\plgorfs001\pub\SERVICE\LCDR\LCDR\OLED OBM Panels\Zdjƒôcia z napraw OLED</div>
    <button class="guard-btn" onclick="connectNetwork()">üì° PO≈ÅƒÑCZ Z SERWEREM</button>
    <button class="skip-btn" onclick="skipNetwork()">Pracuj Offline (ZIP)</button>
  </div>
</div>

<header>
  <div class="brand">TPV <span>OLED</span> REPAIR STATION</div>
  <div class="operator-info">
    <div class="operator-badge" id="operatorDisplay">---</div>
    <div id="clockDisplay">00:00</div>
  </div>
</header>

<div class="dashboard" id="mainDashboard">
  <aside class="panel-left">
    <div class="scene-container">
      <div class="tv-pivot" id="tv3d">
        <div class="tv-panel tv-front"></div>
        <div class="tv-panel tv-back">SERWIS</div>
        <div class="tv-stand"></div>
      </div>
    </div>
    
    <div style="font-size:11px; color:var(--neon-cyan); margin-bottom:5px;">SKANER SN</div>
    <input type="text" id="scanInput" placeholder="ZESKANUJ..." autofocus>

    <div style="margin-top:20px;">
      <div id="btnFront" class="checklist-btn" onclick="capture('PRZOD')"><span>1. PRZ√ìD</span> <span>üì∑</span></div>
      <div id="btnBack" class="checklist-btn" onclick="capture('TYL')"><span>2. TY≈Å</span> <span>üì∑</span></div>
      <div id="btnImage" class="checklist-btn" onclick="capture('OBRAZ')"><span>3. OBRAZ</span> <span>üì∑</span></div>
    </div>

    <button id="actionBtn" onclick="saveData()">OCZEKIWANIE</button>
    <div id="saveStatus" style="text-align:center; color:#666; margin-top:5px; font-size:10px;"></div>
  </aside>

  <main class="panel-right">
    <div class="cam-overlay">
      <div class="tag" id="tagSN">SN: BRAK</div>
      <div class="tag" id="tagOp">OP: ---</div>
    </div>
    <video id="videoFeed" autoplay playsinline></video>
  </main>
</div>

<div class="status-bar" id="bottomBar"><span id="connStatus">üî¥ ROZ≈ÅƒÑCZONY</span></div>

<div class="database-trigger" onclick="toggleDatabase()">üìÇ BAZA DANYCH</div>

<div id="databasePanel">
  <div class="db-header">
    <div style="font-size:18px; color:var(--neon-cyan);">RAPORTY</div>
    <div style="display:flex; gap:10px;">
      <button onclick="scanNetworkForReports()" style="padding:5px; background:var(--neon-cyan); border:none; cursor:pointer;">OD≈öWIE≈ª</button>
      <button onclick="exportToCSV()" style="padding:5px; background:#333; color:#fff; border:1px solid #555; cursor:pointer;">CSV</button>
      <button onclick="toggleDatabase()" style="padding:5px; background:#333; color:#fff; border:1px solid #555; cursor:pointer;">X</button>
    </div>
  </div>
  <div class="db-content">
    <div id="loader" style="display:none; text-align:center; color:var(--neon-cyan);">Skanowanie...</div>
    <table id="reportTable"><thead><tr><th>DATA</th><th>SN</th><th>OPERATOR</th><th>STATUS</th></tr></thead><tbody></tbody></table>
  </div>
</div>

<canvas id="photoCanvas"></canvas>

<script>
  /* --- BAZA U≈ªYTKOWNIK√ìW --- */
  const USERS = {
    "DAWID": { pass: "OLED12345!", role: "OPERATOR", label: "DAWID" },
    "LUKASZ": { pass: "050699", role: "ADMIN", label: "W≈ÅA≈öCICIEL" }
  };

  /* --- KONFIGURACJA --- */
  const NETWORK_PATH = String.raw`\\plgorfs001\pub\SERVICE\LCDR\LCDR\OLED OBM Panels\Zdjƒôcia z napraw OLED`;
  let currentUser = null;
  let dirHandle = null;
  let currentSN = "";
  let photos = { PRZOD: null, TYL: null, OBRAZ: null };
  let reportCache = [];

  const video = document.getElementById('videoFeed');
  const canvas = document.getElementById('photoCanvas');
  const ctx = canvas.getContext('2d');
  const scanInput = document.getElementById('scanInput');
  const actionBtn = document.getElementById('actionBtn');
  const tv3d = document.getElementById('tv3d');

  setInterval(() => document.getElementById('clockDisplay').innerText = new Date().toLocaleTimeString().slice(0,5), 1000);

  /* --- 1. SYSTEM LOGOWANIA (NOWY) --- */
  function checkLogin() {
    const user = document.getElementById('userInput').value.trim().toUpperCase();
    const pass = document.getElementById('passInput').value.trim();
    const err = document.getElementById('loginError');

    if (USERS[user]) {
      if (USERS[user].pass === pass) {
        // Zalogowano pomy≈õlnie
        currentUser = USERS[user];
        proceedToSystem();
      } else {
        err.innerText = "B≈ÅƒòDNE HAS≈ÅO!";
        animateShake();
      }
    } else {
      err.innerText = "U≈ªYTKOWNIK NIE ISTNIEJE!";
      animateShake();
    }
  }

  function proceedToSystem() {
    // Ustawienie interfejsu
    const badge = document.getElementById('operatorDisplay');
    badge.innerText = currentUser.label;
    document.getElementById('tagOp').innerText = "OP: " + currentUser.label;

    if (currentUser.role === "ADMIN") {
      badge.classList.add('admin');
      badge.style.borderColor = "#ffd700";
      badge.style.color = "#ffd700";
    }

    // Ukrywanie loginu
    document.getElementById('loginScreen').style.opacity = '0';
    setTimeout(() => {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainDashboard').style.opacity = '1';
      document.getElementById('networkGuard').style.display = 'flex'; // Blokada sieciowa
    }, 800);
  }

  function animateShake() {
    const box = document.querySelector('.login-box');
    box.style.transform = "translateX(10px)";
    setTimeout(() => box.style.transform = "translateX(-10px)", 50);
    setTimeout(() => box.style.transform = "translateX(5px)", 100);
    setTimeout(() => box.style.transform = "translateX(0)", 150);
  }

  // Obs≈Çuga Entera w polach logowania
  document.getElementById('passInput').addEventListener('keydown', e => { if(e.key==='Enter') checkLogin() });
  document.getElementById('userInput').addEventListener('keydown', e => { if(e.key==='Enter') document.getElementById('passInput').focus() });

  /* --- 2. NETWORK --- */
  async function connectNetwork() {
    try {
      alert("Skopiowano ≈õcie≈ºkƒô do schowka.");
      await navigator.clipboard.writeText(NETWORK_PATH);
      dirHandle = await window.showDirectoryPicker();
      document.getElementById('networkGuard').style.display = 'none';
      document.getElementById('connStatus').innerHTML = "üü¢ PO≈ÅƒÑCZONO Z SIECIƒÑ";
      document.getElementById('bottomBar').classList.add('ok');
      initCamera();
      scanInput.focus();
    } catch (e) {
      alert("Wymagane jest wybranie folderu!");
    }
  }

  function skipNetwork() {
    if(confirm("Praca OFFLINE?")) {
      document.getElementById('networkGuard').style.display = 'none';
      document.getElementById('connStatus').innerHTML = "üî¥ OFFLINE";
      initCamera();
      scanInput.focus();
    }
  }

  /* --- 3. KAMERA --- */
  async function initCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 3840 }, height: { ideal: 2160 } } });
      video.srcObject = stream;
    } catch (e) { alert("B≈ÇƒÖd kamery!"); }
  }

  /* --- 4. G≈Å√ìWNA LOGIKA --- */
  scanInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      const sn = scanInput.value.trim().toUpperCase();
      if (sn.length > 3) startSession(sn);
      else alert("B≈Çƒôdny SN");
      scanInput.value = ""; scanInput.blur();
    }
  });

  function startSession(sn) {
    currentSN = sn; photos = { PRZOD: null, TYL: null, OBRAZ: null };
    document.getElementById('tagSN').innerText = "SN: " + sn;
    document.querySelectorAll('.checklist-btn').forEach(b => b.classList.remove('done'));
    actionBtn.className = ""; actionBtn.innerText = "OCZEKIWANIE (0/3)";
    tv3d.style.transform = "rotateY(0deg)";
  }

  function capture(type) {
    if (!currentSN) { scanInput.focus(); return alert("Zeskanuj SN!"); }
    tv3d.style.transform = type === 'TYL' ? "rotateY(180deg)" : "rotateY(0deg)";
    
    // Flash
    const f = document.createElement('div');
    f.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;background:#fff;opacity:0.8;z-index:99";
    document.querySelector('.panel-right').appendChild(f);
    setTimeout(() => f.remove(), 80);

    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    
    // Watermark
    const fs = Math.floor(video.videoHeight/25);
    ctx.font = `bold ${fs}px Consolas`; ctx.lineWidth = 4; ctx.strokeStyle = "black"; ctx.fillStyle = "#0aff00";
    ctx.strokeText(`SN: ${currentSN}`, 50, fs+20); ctx.fillText(`SN: ${currentSN}`, 50, fs+20);
    ctx.fillStyle = "#00f3ff";
    ctx.strokeText(`TYP: ${type}`, 50, (fs*2)+40); ctx.fillText(`TYP: ${type}`, 50, (fs*2)+40);
    
    // U≈ºywamy currentUser.label zamiast starej zmiennej globalnej
    const operatorLabel = currentUser ? currentUser.label : "UNKNOWN";
    ctx.fillStyle = "white"; ctx.font = `bold ${Math.floor(fs*0.8)}px Consolas`;
    ctx.strokeText(`OP: ${operatorLabel}`, 50, (fs*3)+60); ctx.fillText(`OP: ${operatorLabel}`, 50, (fs*3)+60);

    canvas.toBlob(blob => {
      photos[type] = blob;
      const done = Object.values(photos).filter(p=>p).length;
      actionBtn.innerText = `BRAK ZDJƒòƒÜ (${done}/3)`;
      const map = {'PRZOD':'btnFront','TYL':'btnBack','OBRAZ':'btnImage'};
      document.getElementById(map[type]).classList.add('done');
      if(done===3) { actionBtn.classList.add('active'); actionBtn.innerText = "üíæ ZAPISZ"; }
    }, 'image/jpeg', 0.95);
  }

  async function saveData() {
    if(!actionBtn.classList.contains('active')) return;
    document.getElementById('saveStatus').innerText = "ZAPISYWANIE...";
    
    const operatorLabel = currentUser ? currentUser.label : "UNKNOWN";
    const txt = `SN: ${currentSN}\nDATA: ${new Date().toLocaleString()}\nOPERATOR: ${operatorLabel}\nSTATUS: OK`;

    if(dirHandle) {
      try {
        const folder = await dirHandle.getDirectoryHandle(currentSN, {create:true});
        await writeF(folder, `${currentSN}_PRZOD.jpg`, photos.PRZOD);
        await writeF(folder, `${currentSN}_TYL.jpg`, photos.TYL);
        await writeF(folder, `${currentSN}_OBRAZ.jpg`, photos.OBRAZ);
        await writeF(folder, `RAPORT_${currentSN}.txt`, new Blob([txt], {type:'text/plain'}));
        
        document.getElementById('saveStatus').innerText = "ZAPISANO NA SERWERZE!";
        setTimeout(() => { currentSN=""; startSession(""); scanInput.focus(); }, 1500);
      } catch(e) { alert("B≈ÇƒÖd zapisu sieciowego!"); }
    } else {
      const z = new JSZip(); const f = z.folder(currentSN);
      f.file("info.txt", txt);
      f.file("foto.jpg", photos.PRZOD); // Fallback example
      z.generateAsync({type:"blob"}).then(c => saveAs(c, `${currentSN}.zip`));
    }
  }
  async function writeF(dh, n, b) { const h = await dh.getFileHandle(n,{create:true}); const w = await h.createWritable(); await w.write(b); await w.close(); }

  /* --- 5. MANAGER --- */
  function toggleDatabase() { document.getElementById('databasePanel').classList.toggle('open'); }

  async function scanNetworkForReports() {
    if (!dirHandle) return alert("Brak sieci!");
    const tb = document.querySelector('#reportTable tbody'); tb.innerHTML = "";
    document.getElementById('loader').style.display = 'block';
    reportCache = [];
    try {
      for await (const entry of dirHandle.values()) {
        if (entry.kind === 'directory') {
          const sn = entry.name; let op = "---"; let date = "---"; let stat = "TYLKO FOTO";
          try {
            const snDir = await dirHandle.getDirectoryHandle(sn);
            for await (const f of snDir.values()) {
              if (f.name.includes("RAPORT")) {
                const file = await f.getFile();
                const text = await f.text(); // Pobieranie tre≈õci raportu
                date = file.lastModifiedDate.toLocaleString();
                const m = text.match(/OPERATOR: (.*)/);
                if(m) op = m[1];
                stat = "KOMPLET";
              }
            }
          } catch(e){}
          reportCache.push({date, sn, op, stat});
          tb.innerHTML += `<tr><td>${date}</td><td>${sn}</td><td>${op}</td><td style="color:${stat==='KOMPLET'?'#0f0':'#f00'}">${stat}</td></tr>`;
        }
      }
    } catch(e){ alert("B≈ÇƒÖd skanowania"); }
    document.getElementById('loader').style.display = 'none';
  }

  function exportToCSV() {
    if(!reportCache.length) return alert("Pusta baza");
    let c = "DATA,SN,OPERATOR,STATUS\n";
    reportCache.forEach(r => c += `${r.date},${r.sn},${r.op},${r.stat}\n`);
    saveAs(new Blob([c], {type:"text/csv"}), "raport.csv");
  }
</script>
</body>
</html>
