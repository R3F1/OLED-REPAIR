<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>OLED REPAIR v13.0 (STABLE ZOOM & CROP)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap&subset=latin-ext" rel="stylesheet">
  
  <style>
    /* --- CONFIG & VARIABLES --- */
    :root {
      --bg-deep: #050505;
      --panel-glass: rgba(20, 25, 35, 0.95);
      --neon-cyan: #00f3ff;
      --neon-green: #0aff00;
      --neon-red: #ff003c;
      --neon-gold: #ffd700;
      --neon-purple: #bc13fe;
      
      --font-ui: 'Roboto', sans-serif;
      --font-tech: 'Oxanium', cursive;
    }
    
    * { box-sizing: border-box; user-select: none; }
    
    body {
      margin: 0; background-color: var(--bg-deep); color: #fff;
      font-family: var(--font-ui); height: 100vh; overflow: hidden;
      display: flex; flex-direction: column;
      background-image: 
        linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
    }

    /* --- LOGIN SCREEN --- */
    #loginScreen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999;
      display: flex; align-items: center; justify-content: center; flex-direction: column; transition: opacity 0.8s;
    }
    .login-box {
      width: 450px; padding: 40px; background: rgba(10, 10, 10, 0.95); border: 1px solid var(--neon-cyan);
      text-align: center; border-radius: 12px;
      box-shadow: 0 0 60px rgba(0, 243, 255, 0.1); backdrop-filter: blur(10px);
    }
    .login-input {
      width: 100%; padding: 15px; margin: 10px 0; background: #080808; border: 1px solid #333; color: var(--neon-cyan);
      font-family: var(--font-tech); font-size: 18px; text-align: center; outline: none;
    }
    .login-btn {
      width: 100%; padding: 15px; margin-top: 20px; background: var(--neon-cyan); color: #000; font-weight: bold; border: none;
      cursor: pointer; font-family: var(--font-tech); transition: 0.3s; font-size: 16px; letter-spacing: 2px;
    }

    /* --- NETWORK GUARD --- */
    #networkGuard {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.95); z-index: 8000; backdrop-filter: blur(15px);
      display: none; align-items: center; justify-content: center; flex-direction: column;
    }
    .path-box {
      background:#111; padding:15px; border:1px dashed #555; font-size:12px; color:#fff; 
      font-family:var(--font-tech); margin-top: 5px; word-break: break-all;
    }
    .guard-btn {
      width: 100%; padding: 20px; background: var(--neon-red); color: #fff; font-weight: bold;
      border: none; cursor: pointer; font-family: var(--font-tech); font-size: 18px; margin-top: 20px;
    }

    /* --- HEADER --- */
    header {
      height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 30px;
      background: rgba(0,0,0,0.8); border-bottom: 1px solid #333;
    }
    .brand { font-family: var(--font-tech); font-size: 28px; font-weight: 700; color: #fff; letter-spacing: 2px; }
    .operator-badge { background: #1a1a1a; padding: 6px 15px; border-radius: 4px; border: 1px solid #444; color: var(--neon-cyan); font-weight: bold; }

    /* --- DASHBOARD --- */
    .dashboard {
      flex: 1; display: grid; grid-template-columns: 420px 1fr; gap: 20px; padding: 20px; overflow: hidden;
      opacity: 0; transition: opacity 1s;
    }
    .panel-left {
      background: var(--panel-glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px;
      display: flex; flex-direction: column; overflow-y: auto;
    }
    .panel-right {
      position: relative; background: #000; border: 2px solid #333; border-radius: 12px; overflow: hidden;
      box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
      /* Cursor logic handled by JS */
    }
    
    /* VIDEO & ZOOM LOGIC */
    .video-container {
        width: 100%; height: 100%; overflow: hidden; position: relative;
        display: flex; justify-content: center; align-items: center;
        touch-action: none; /* Disable native touch actions for custom drag */
    }
    video { 
        width: 100%; height: 100%; object-fit: contain; 
        transform-origin: center center;
        pointer-events: auto; /* Ensure video catches events */
    }

    /* OVERLAYS & CONTROLS */
    .cam-overlay { 
        position: absolute; top: 20px; left: 20px; display: flex; flex-direction: column; gap: 8px; z-index: 55; 
        pointer-events: none; /* CRITICAL: Allows clicks to pass through to video */
    }
    .tag { background: rgba(0,0,0,0.7); color: #fff; padding: 6px 12px; font-family: var(--font-tech); font-size: 14px; border-left: 3px solid var(--neon-cyan); }
    
    .crop-badge {
        position: absolute; top: 20px; right: 20px; background: var(--neon-red); color: #fff;
        padding: 5px 15px; font-family: var(--font-tech); font-weight: bold; border-radius: 4px;
        display: none; z-index: 55; pointer-events: none; animation: pulseRed 1s infinite;
    }
    @keyframes pulseRed { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    /* DRAWING TOOLBAR */
    #drawCanvas {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 60; cursor: crosshair; display: none;
    }
    .draw-toolbar {
      position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 100;
      display: none; background: rgba(0,0,0,0.9); padding: 10px 20px; border-radius: 30px; border: 1px solid var(--neon-cyan);
    }
    .color-btn { width: 25px; height: 25px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; display: inline-block; margin: 0 5px; }
    .tool-btn { background: #333; border: 1px solid #aaa; color: #fff; padding: 5px 12px; cursor: pointer; font-family: var(--font-tech); font-size: 12px; margin-left: 10px; border-radius: 4px; }
    .tool-btn.confirm { background: var(--neon-cyan); color: #000; border-color: var(--neon-cyan); font-weight: bold; }

    /* CAM CONTROLS */
    .cam-controls { 
        position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 50; 
        display: flex; gap: 15px; align-items: center; 
        background: rgba(0,0,0,0.8); padding: 10px 25px; border-radius: 30px; 
        border: 1px solid #444; backdrop-filter: blur(5px);
    }
    .cam-btn {
      background: transparent; border: 1px solid var(--neon-cyan); color: var(--neon-cyan);
      width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 18px; transition: 0.2s; 
    }
    
    .zoom-group { display: flex; align-items: center; gap: 10px; font-family: var(--font-tech); font-size: 12px; color: var(--neon-cyan); }
    input[type=range] { -webkit-appearance: none; width: 120px; height: 4px; background: #333; border-radius: 2px; outline: none; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--neon-cyan); cursor: pointer; }

    /* CHECKLIST */
    .checklist-btn {
      width: 100%; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); color: #888;
      padding: 12px; margin-bottom: 8px; cursor: pointer; text-align: left; font-family: var(--font-ui);
      display: flex; justify-content: space-between; transition: 0.2s; font-size: 14px; border-radius: 6px; 
    }
    .checklist-btn.done { border-color: var(--neon-green); color: var(--neon-green); background: rgba(10,255,0,0.1); font-weight: 700; }

    /* ACTION BTN */
    #actionBtn {
      margin-top: auto; padding: 15px; width: 100%; background: #111; color: #444; font-weight: bold; border: none;
      font-size: 16px; cursor: not-allowed; border-radius: 6px; text-transform: uppercase; letter-spacing: 1px; font-family: var(--font-tech);
    }
    #actionBtn.active {
      background: var(--neon-green); color: #000; cursor: pointer; animation: pulseBtn 2s infinite; box-shadow: 0 0 20px var(--neon-green);
    }
    @keyframes pulseBtn { 0% { box-shadow: 0 0 10px var(--neon-green); } 50% { box-shadow: 0 0 30px var(--neon-green); } 100% { box-shadow: 0 0 10px var(--neon-green); } }

    /* PANELS */
    .bar-bottom {
      position: fixed; bottom: 0; left: 0; width: 100%; height: 40px; background: #080808; border-top: 1px solid #333;
      display: flex; justify-content: space-between; align-items: center; padding: 0 20px; z-index: 100;
    }
    .slide-panel {
      position: fixed; bottom: 0; left: 0; width: 100%; height: 0; background: rgba(10, 12, 16, 0.98);
      z-index: 200; transition: height 0.5s cubic-bezier(0.25, 1, 0.5, 1); overflow: hidden;
      border-top: 2px solid var(--neon-cyan); display: flex; flex-direction: column;
    }
    .slide-panel.open { height: 85vh; }
    
    /* PRINT LABEL (150x150mm) */
    #printLabel { display: none; }
    @media print {
        @page { size: auto; margin: 0mm; }
        body * { visibility: hidden; }
        #printLabel, #printLabel * { visibility: visible; }
        #printLabel {
            position: absolute; left: 0; top: 0; width: 150mm; height: 150mm;
            display: flex !important; flex-direction: column; justify-content: space-between; align-items: center;
            border: 2px solid #000; background: white; color: black; font-family: 'Roboto', sans-serif;
            padding: 10mm; box-sizing: border-box; z-index: 9999;
        }
        .pl-header { font-size: 24pt; font-weight: bold; border-bottom: 2px solid #000; width: 100%; text-align: center; }
        .pl-info { width: 100%; text-align: left; font-size: 14pt; line-height: 1.5; }
        .pl-footer { font-size: 10pt; width: 100%; text-align: center; border-top: 1px solid #000; padding-top: 2mm; }
        #qrPopup { display: none !important; }
    }

    /* 3D TV MODEL */
    .scene-container { height: 140px; perspective: 1000px; display: flex; justify-content: center; align-items: center; }
    .tv-pivot { position: relative; width: 160px; height: 90px; transform-style: preserve-3d; transition: transform 0.8s; }
    .tv-panel { position: absolute; width: 100%; height: 100%; background: #000; border: 2px solid #333; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; }
    .tv-front { background: linear-gradient(135deg, #050505, #1a1a1a); border: 1px solid #555; }
    .tv-back { transform: rotateY(180deg); background: #151515; border: 1px solid #444; }

    /* PATTERN OVERLAY */
    #patternOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 99999; display: none; cursor: pointer; }
    
    canvas { display: none; }

    /* INPUTS */
    #scanInput { width: 100%; background: #080808; border: 1px solid #444; color: #fff; padding: 12px; font-size: 22px; text-align: center; font-family: var(--font-tech); outline: none; margin-bottom: 15px; }
  </style>
</head>
<body>

<div id="patternOverlay" onclick="nextPattern()"></div>

<div id="printLabel">
    <div class="pl-header">TPV OLED SERVICE</div>
    <div id="printQrCode" style="margin:5mm 0;"></div>
    <div class="pl-info">
        <div><strong>SN:</strong> <span id="plSN">---</span></div>
        <div><strong>DATA:</strong> <span id="plDate">---</span></div>
        <div><strong>OP:</strong> <span id="plOp">---</span></div>
        <div><strong>STATUS:</strong> <span id="plStatus" style="font-weight:bold; font-size:20pt;">---</span></div>
    </div>
    <div class="pl-footer">PASSPORT v13.0</div>
</div>

<div id="loginScreen">
  <div class="login-box">
    <h2 style="color:#fff;">OLED REPAIR SYSTEM</h2>
    <div style="font-size:12px; color:#666; margin-bottom:30px; font-family: var(--font-tech);">V13.0 ONYX (STABLE)</div>
    <input type="text" id="userInput" class="login-input" placeholder="LOGIN" autocomplete="off">
    <input type="password" id="passInput" class="login-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="margin-top:10px;">
    <button class="login-btn" onclick="attemptLogin()">ROZPOCZNIJ</button>
  </div>
</div>

<div id="networkGuard">
  <div class="alert-box" style="width:600px; padding:40px; background:#050505; border:2px solid red; text-align:center;">
    <h1 style="color:red; margin:0;">‚ö†Ô∏è SIECI ROZ≈ÅƒÑCZONA</h1>
    <div class="path-box">\\plgorfs001\pub\SERVICE\LCDR\LCDR\OLED OBM Panels\Zdjƒôcia z napraw OLED</div>
    <button class="guard-btn" onclick="connectNetwork()">üì° PO≈ÅƒÑCZ</button>
  </div>
</div>

<header>
  <div class="brand">TPV <span>OLED</span> REPAIR</div>
  <div style="display:flex; gap:20px; color:#aaa; font-family:var(--font-tech);">
    <button style="background:none; border:none; color:#fff; cursor:pointer;" onclick="toggleFullScreen()">‚õ∂</button>
    <div class="operator-badge" id="operatorBadge">---</div>
    <div id="clockDisplay">00:00</div>
  </div>
</header>

<div class="dashboard" id="mainDashboard">
  <aside class="panel-left">
    <div class="scene-container">
      <div class="tv-pivot" id="tv3d">
        <div class="tv-panel tv-front">OLED</div>
        <div class="tv-panel tv-back">SERWIS</div>
      </div>
    </div>
    
    <input type="text" id="scanInput" placeholder="SKANUJ SN..." autofocus>

    <div id="checklist">
        <button class="checklist-btn" style="color:var(--neon-purple); border-color:var(--neon-purple);" onclick="togglePatterns()"><span>üñ•Ô∏è TEST EKRANU</span> <span>‚èØ</span></button>
        <div style="height:10px;"></div>
        <div id="btnFront" class="checklist-btn" onclick="capture('PRZOD')"><span>1. PRZ√ìD</span> <span>üì∑</span></div>
        <div id="btnBack" class="checklist-btn" onclick="capture('TYL')"><span>2. TY≈Å</span> <span>üì∑</span></div>
        <div id="btnImage" class="checklist-btn" onclick="capture('OBRAZ')"><span>3. OBRAZ (AUTO-CROP)</span> <span>üì∑</span></div>
    </div>

    <div style="border-top:1px solid #333; margin-top:10px; padding-top:15px;">
      <span style="font-size:11px; color:var(--neon-purple); font-weight:bold; font-family:var(--font-tech);">DECYZJA</span>
      <select id="statusSelect" style="width:100%; background:#080808; color:#fff; border:1px solid var(--neon-purple); padding:10px; margin-bottom:10px;" onchange="saveRecoveryState()">
        <option value="OK">üü¢ OK</option>
        <option value="NG">üî¥ NG</option>
        <option value="NDF">üîµ NDF</option>
        <option value="RMA">üü† RMA</option>
        <option value="SCRAP">‚ö´ SCRAP</option>
        <option value="OFFRS_OK">üü£ OFFRS OK</option>
      </select>
      <textarea id="commentInput" rows="2" placeholder="Uwagi..." style="width:100%; background:#080808; color:#ccc; border:1px solid #444; padding:10px;" onkeyup="saveRecoveryState()"></textarea>
    </div>

    <button id="actionBtn" onclick="saveData()">OCZEKIWANIE</button>
    <div id="saveStatus" style="text-align:center; color:#666; margin-top:5px; font-size:11px; font-family:var(--font-tech);"></div>
  </aside>

  <main class="panel-right" id="camContainer">
    <div class="cam-overlay">
      <div class="tag" id="tagSN">SN: ---</div>
      <div class="tag" id="tagOp">OP: ---</div>
    </div>
    
    <div class="crop-badge" id="cropBadge">‚úÇÔ∏è KADROWANIE AKTYWNE</div>
    
    <div class="draw-toolbar" id="drawToolbar">
      <span style="color:#fff; font-size:12px; margin-right:10px;">RYSOWANIE:</span>
      <div class="color-btn" style="background:red;" onclick="setDrawColor('red')"></div>
      <div class="color-btn" style="background:#0aff00;" onclick="setDrawColor('#0aff00')"></div>
      <button class="tool-btn" onclick="clearDraw()">WYCZY≈öƒÜ</button>
      <button class="tool-btn confirm" onclick="confirmPhoto()">ZAPISZ</button>
      <button class="tool-btn" onclick="cancelPhoto()">ANULUJ</button>
    </div>

    <div class="cam-controls">
      <div class="zoom-group">
        <span>ZOOM</span>
        <input type="range" id="zoomSlider" min="1" max="4" step="0.1" value="1">
        <span id="zoomVal" style="width:30px;">1.0x</span>
      </div>
      <div class="cam-btn" onclick="toggleMirror()" title="Lustro">‚Üî</div>
    </div>
    
    <div class="video-container">
        <video id="videoFeed" autoplay playsinline ondragstart="return false;"></video>
        <canvas id="drawCanvas"></canvas>
    </div>
  </main>
</div>

<div class="bar-bottom">
  <div id="connStatus" style="color:#444; font-size:11px;">üî¥ OFFLINE</div>
  <div style="display:flex; gap:10px;">
    <button style="background:transparent; border:1px solid #444; color:#aaa; cursor:pointer;" onclick="document.getElementById('userPanel').classList.toggle('open')">üë• U≈ªYTKOWNICY</button>
    <button style="background:transparent; border:1px solid #444; color:#aaa; cursor:pointer;" onclick="document.getElementById('reportPanel').classList.toggle('open')">üìÇ STATYSTYKI</button>
  </div>
</div>

<div id="userPanel" class="slide-panel">
  <div style="padding:20px; background:#000; border-bottom:1px solid #333;">ZARZƒÑDZANIE <button onclick="document.getElementById('userPanel').classList.remove('open')" style="float:right;">X</button></div>
  <div style="padding:20px;">
      <input id="newLogin" placeholder="Login"> <input id="newPass" placeholder="Pass">
      <button onclick="addUser()">DODAJ</button>
      <table id="userTable" style="width:100%; color:#ccc; margin-top:20px;"><tbody></tbody></table>
  </div>
</div>

<div id="reportPanel" class="slide-panel">
  <div style="padding:20px; background:#000; border-bottom:1px solid #333;">RAPORTY <button onclick="scanNetwork()">SKANUJ</button> <button onclick="document.getElementById('reportPanel').classList.remove('open')" style="float:right;">X</button></div>
  <div style="padding:20px; overflow:auto;">
    <table id="reportTable" style="width:100%; color:#ccc;"><thead><tr><th>SN</th><th>DECYZJA</th><th>UWAGI</th></tr></thead><tbody></tbody></table>
  </div>
</div>

<div id="qrPopup" style="background:#fff; color:#000; padding:20px; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:999; display:none; text-align:center;">
  <div id="qrCodeBox"></div>
  <div id="qrSnDisplay" style="font-weight:bold; margin-top:10px;"></div>
  <button onclick="window.print()" style="margin-top:10px; padding:10px; background:cyan; border:none; cursor:pointer;">DRUKUJ</button>
  <button onclick="closeQr()" style="margin-top:10px; padding:10px;">ZAMKNIJ</button>
</div>

<canvas id="photoCanvas"></canvas>

<script>
  /* CONFIG */
  const CONFIG = {
    networkPath: String.raw`\\plgorfs001\pub\SERVICE\LCDR\LCDR\OLED OBM Panels\Zdjƒôcia z napraw OLED`,
    defaultUsers: [{login:"DAWID", pass:"1", role:"OPERATOR"}, {login:"ADMIN", pass:"admin", role:"ADMIN"}]
  };
  
  /* VARS */
  let users=[], currentUser=null, dirHandle=null, currentSN="", photos={PRZOD:null, TYL:null, OBRAZ:null};
  let isMirrored=false;
  
  /* ZOOM & PAN STATE */
  let zoomLevel=1.0, panX=0, panY=0, isPanning=false, startX=0, startY=0;
  let isDrawing=false, drawColor="red", tempPhotoType="";

  /* INIT */
  window.onload = () => {
    loadUsers();
    setInterval(()=>document.getElementById('clockDisplay').innerText=new Date().toLocaleTimeString().slice(0,5),1000);
    checkRecovery();
    setupZoomPan();
    setupDrawing();
  };

  /* USERS */
  function loadUsers(){ users = JSON.parse(localStorage.getItem('oled_users')) || CONFIG.defaultUsers; }
  function attemptLogin(){
      const l=document.getElementById('userInput').value.toUpperCase(), p=document.getElementById('passInput').value;
      const u=users.find(x=>x.login===l && x.pass===p);
      if(u){ currentUser=u; document.getElementById('loginScreen').style.display='none'; document.getElementById('networkGuard').style.display='flex'; setupUI(); }
  }
  function setupUI(){ document.getElementById('operatorBadge').innerText=currentUser.login; document.getElementById('tagOp').innerText="OP: "+currentUser.login; renderUserTable(); }
  function renderUserTable(){ 
      const t=document.getElementById('userTable').querySelector('tbody'); t.innerHTML="";
      users.forEach((u,i)=>t.innerHTML+=`<tr><td>${u.login}</td><td>${u.role}</td></tr>`);
  }
  function addUser(){ 
      users.push({login:document.getElementById('newLogin').value.toUpperCase(), pass:document.getElementById('newPass').value, role:"OPERATOR"});
      localStorage.setItem('oled_users',JSON.stringify(users)); renderUserTable();
  }

  /* NETWORK & CAM */
  async function connectNetwork(){
      try {
          await navigator.clipboard.writeText(CONFIG.networkPath); alert("≈öcie≈ºka w schowku!");
          dirHandle = await window.showDirectoryPicker();
          document.getElementById('networkGuard').style.display='none'; document.getElementById('connStatus').innerText="üü¢ ONLINE";
          initCam();
      } catch(e){ alert("Wybierz folder!"); }
  }
  async function initCam(){
      try{ 
          const s = await navigator.mediaDevices.getUserMedia({video:{width:{ideal:3840}, height:{ideal:2160}}});
          document.getElementById('videoFeed').srcObject=s;
      }catch(e){alert("Brak kamery");}
  }

  /* ZOOM & PAN LOGIC (FIXED) */
  function setupZoomPan(){
      const cont = document.getElementById('camContainer');
      const slider = document.getElementById('zoomSlider');
      
      slider.oninput = (e) => {
          zoomLevel = parseFloat(e.target.value);
          document.getElementById('zoomVal').innerText = zoomLevel.toFixed(1)+"x";
          document.getElementById('cropBadge').style.display = zoomLevel > 1.0 ? 'block' : 'none';
          applyTransform();
      };

      // Mouse Events for Panning
      cont.onmousedown = (e) => {
          if(zoomLevel > 1 && !isDrawing) {
              e.preventDefault(); // Stop text selection/ghost drag
              isPanning = true;
              startX = e.clientX - panX;
              startY = e.clientY - panY;
              cont.style.cursor = 'grabbing';
          }
      };
      
      // Use window to catch mouseup outside container
      window.onmouseup = () => { isPanning = false; cont.style.cursor = zoomLevel>1 ? 'grab' : 'default'; };
      
      window.onmousemove = (e) => {
          if(!isPanning) return;
          e.preventDefault();
          panX = e.clientX - startX;
          panY = e.clientY - startY;
          applyTransform();
      };
  }

  function applyTransform(){
      const v = document.getElementById('videoFeed');
      // Constrain Pan
      const limit = (zoomLevel - 1) * 800; // Approximate pixel limit
      if(panX > limit) panX = limit; if(panX < -limit) panX = -limit;
      if(panY > limit) panY = limit; if(panY < -limit) panY = -limit;
      
      const mirror = isMirrored ? -1 : 1;
      v.style.transform = `scale(${zoomLevel*mirror}, ${zoomLevel}) translate(${panX/zoomLevel}px, ${panY/zoomLevel}px)`;
  }
  
  function toggleMirror(){ isMirrored=!isMirrored; applyTransform(); }

  /* WORKFLOW */
  document.getElementById('scanInput').onkeydown = (e) => {
      if(e.key==='Enter'){ 
          if(e.target.value.length>3) startSession(e.target.value.toUpperCase());
          e.target.value=""; 
      }
  };

  function startSession(sn){
      currentSN=sn; photos={PRZOD:null, TYL:null, OBRAZ:null};
      document.getElementById('tagSN').innerText="SN: "+sn;
      document.querySelectorAll('.checklist-btn').forEach(b=>b.classList.remove('done'));
      document.getElementById('actionBtn').innerText="OCZEKIWANIE (0/3)";
      document.getElementById('actionBtn').classList.remove('active');
      saveRecoveryState();
  }

  /* CAPTURE & CROP MATH */
  function capture(type){
      if(!currentSN) return document.getElementById('scanInput').focus();
      tempPhotoType=type;
      
      // Rotate TV Model
      document.getElementById('tv3d').style.transform = type==='TYL' ? "rotateY(180deg)" : "rotateY(0deg)";

      const decision = document.getElementById('statusSelect').value;
      const isBad = ['NG','SCRAP','RMA'].includes(decision);
      const v = document.getElementById('videoFeed');

      if(isBad){
          // Manual Drawing Mode
          v.pause();
          document.getElementById('drawToolbar').style.display='flex';
          const c = document.getElementById('drawCanvas');
          c.style.display='block'; c.width=v.offsetWidth; c.height=v.offsetHeight;
          const ctx = c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);
      } else {
          // Instant Snap (with Auto-Crop)
          processPhoto(false);
      }
  }
  
  function confirmPhoto(){ processPhoto(true); }
  function cancelPhoto(){
      document.getElementById('videoFeed').play();
      document.getElementById('drawToolbar').style.display='none';
      document.getElementById('drawCanvas').style.display='none';
  }

  function processPhoto(hasDrawing){
      const v = document.getElementById('videoFeed');
      const fc = document.getElementById('photoCanvas');
      fc.width = v.videoWidth; fc.height = v.videoHeight;
      const ctx = fc.getContext('2d');

      // --- IMPROVED CROP MATH ---
      // Source Width visible
      const sW = v.videoWidth / zoomLevel;
      const sH = v.videoHeight / zoomLevel;
      
      // Pan offset in Video Pixels
      // panX is in Screen Pixels. 
      // Ratio: videoWidth / offsetWidth.
      // But CSS translate is relative to element.
      // Simple offset from center:
      
      // Calculate center of source rectangle
      const centerX = v.videoWidth / 2 - (panX * (v.videoWidth / v.offsetWidth) / zoomLevel);
      const centerY = v.videoHeight / 2 - (panY * (v.videoHeight / v.offsetHeight) / zoomLevel);
      
      const sX = centerX - sW/2;
      const sY = centerY - sH/2;

      ctx.save();
      if(isMirrored){ ctx.translate(fc.width,0); ctx.scale(-1,1); }
      
      // Draw visible portion stretched to full canvas (Digital Zoom effect)
      ctx.drawImage(v, sX, sY, sW, sH, 0, 0, fc.width, fc.height);
      ctx.restore();

      // Overlay Drawing (if any)
      if(hasDrawing){
          const dc = document.getElementById('drawCanvas');
          ctx.drawImage(dc, 0, 0, fc.width, fc.height);
      }
      
      // Watermark
      addWatermark(ctx, fc.width, fc.height);

      fc.toBlob(b=>{
          photos[tempPhotoType]=b;
          updateButtons();
          if(hasDrawing) cancelPhoto();
      }, 'image/jpeg', 0.95);
  }

  function addWatermark(ctx, w, h){
      const fs=Math.floor(h/30);
      ctx.font=`bold ${fs}px Roboto`; ctx.fillStyle="#0aff00"; ctx.strokeStyle="black"; ctx.lineWidth=3;
      ctx.strokeText(currentSN, 20, fs+10); ctx.fillText(currentSN, 20, fs+10);
      ctx.fillStyle="white";
      ctx.strokeText(currentUser.login, 20, h-20); ctx.fillText(currentUser.login, 20, h-20);
  }

  function updateButtons(){
      const n = Object.values(photos).filter(x=>x).length;
      const btn = document.getElementById('actionBtn');
      btn.innerText=`ZDJƒòCIA (${n}/3)`;
      document.getElementById(tempPhotoType==='PRZOD'?'btnFront':(tempPhotoType==='TYL'?'btnBack':'btnImage')).classList.add('done');
      if(n===3){ btn.classList.add('active'); btn.innerText="ZAPISZ"; }
  }

  /* SAVING */
  async function saveData(){
      const btn = document.getElementById('actionBtn');
      if(!btn.classList.contains('active')) return;
      btn.innerText="ZAPISYWANIE...";
      
      const txt = `SN: ${currentSN}\nOP: ${currentUser.login}\nDEC: ${document.getElementById('statusSelect').value}\nKOM: ${document.getElementById('commentInput').value}`;
      
      if(dirHandle){
          try{
              const d = await dirHandle.getDirectoryHandle(currentSN, {create:true});
              await write(d, currentSN+"_PRZOD.jpg", photos.PRZOD);
              await write(d, currentSN+"_TYL.jpg", photos.TYL);
              await write(d, currentSN+"_OBRAZ.jpg", photos.OBRAZ);
              await write(d, "RAPORT.txt", new Blob([txt]));
              showQr();
              localStorage.removeItem('oled_rec');
          }catch(e){ alert("B≈ÅƒÑD ZAPISU"); }
      }
  }
  async function write(dh,n,b){ const h=await dh.getFileHandle(n,{create:true}); const w=await h.createWritable(); await w.write(b); await w.close(); }

  /* QR & PRINT */
  function showQr(){
      const sn = currentSN; const st = document.getElementById('statusSelect').value;
      
      // Screen QR
      const box = document.getElementById('qrCodeBox'); box.innerHTML="";
      new QRCode(box, {text:sn+"|"+st, width:128, height:128});
      document.getElementById('qrSnDisplay').innerText=sn;
      document.getElementById('qrPopup').style.display='block';

      // Print Label QR
      const pbox = document.getElementById('printQrCode'); pbox.innerHTML="";
      new QRCode(pbox, {text:sn+"|"+st, width:350, height:350});
      document.getElementById('plSN').innerText=sn;
      document.getElementById('plDate').innerText=new Date().toLocaleDateString();
      document.getElementById('plOp').innerText=currentUser.login;
      document.getElementById('plStatus').innerText=st;
  }
  function closeQr(){ 
      document.getElementById('qrPopup').style.display='none'; 
      startSession(""); 
  }

  /* RECOVERY */
  function saveRecoveryState(){
      if(!currentSN) return;
      const s = {sn:currentSN, st:document.getElementById('statusSelect').value, cm:document.getElementById('commentInput').value};
      localStorage.setItem('oled_rec', JSON.stringify(s));
  }
  function checkRecovery(){
      const r = JSON.parse(localStorage.getItem('oled_rec'));
      if(r && confirm("Przywr√≥ciƒá sesjƒô dla "+r.sn+"?")){
          startSession(r.sn);
          document.getElementById('statusSelect').value=r.st;
          document.getElementById('commentInput').value=r.cm;
      }
  }

  /* DRAWING HELPERS */
  function setupDrawing(){
      const c = document.getElementById('drawCanvas');
      c.onmousedown=(e)=>{isDrawing=true; draw(e)};
      c.onmouseup=()=>{isDrawing=false; c.getContext('2d').beginPath()};
      c.onmousemove=draw;
  }
  function draw(e){
      if(!isDrawing) return;
      const c=document.getElementById('drawCanvas'); const ctx=c.getContext('2d');
      const r=c.getBoundingClientRect();
      ctx.lineWidth=5; ctx.lineCap='round'; ctx.strokeStyle=drawColor;
      ctx.lineTo(e.clientX-r.left, e.clientY-r.top); ctx.stroke(); ctx.beginPath(); ctx.moveTo(e.clientX-r.left, e.clientY-r.top);
  }
  function setDrawColor(c){drawColor=c}
  function clearDraw(){const c=document.getElementById('drawCanvas'); c.getContext('2d').clearRect(0,0,c.width,c.height)}

  /* PATTERNS */
  const pats=['#fff','#f00','#0f0','#00f','#000']; let pIdx=-1;
  function togglePatterns(){ 
      const o=document.getElementById('patternOverlay');
      if(o.style.display==='block'){o.style.display='none'; pIdx=-1;} else {o.style.display='block'; nextPattern();}
  }
  function nextPattern(){
      pIdx++; const o=document.getElementById('patternOverlay');
      if(pIdx>=pats.length){o.style.display='none'; pIdx=-1; return;}
      o.style.background=pats[pIdx];
  }
  function scanNetwork(){ /* Simplified for length */ alert("Skanowanie..."); }
</script>
</body>
</html>
