<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>OLED REPAIR SYSTEM v6.0 MANAGER</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  
  <style>
    /* --- STYLE PODSTAWOWE (ZACHOWANE Z V5) --- */
    :root {
      --bg-deep: #050505;
      --panel-glass: rgba(20, 25, 35, 0.95);
      --neon-cyan: #00f3ff;
      --neon-green: #0aff00;
      --neon-red: #ff003c;
      --neon-amber: #ffb300;
      --border-light: 1px solid rgba(255, 255, 255, 0.1);
      --font-ui: 'Rajdhani', sans-serif;
      --font-tech: 'Share Tech Mono', monospace;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background-color: var(--bg-deep); color: #fff;
      font-family: var(--font-ui); height: 100vh; overflow: hidden;
      display: flex; flex-direction: column;
      background-image: radial-gradient(circle at 50% 50%, rgba(0, 243, 255, 0.05) 0%, transparent 60%), linear-gradient(0deg, rgba(0,0,0,0.8), transparent 2px);
      background-size: 100% 100%, 100% 4px;
    }

    /* --- LOGIN & HEADER --- */
    #loginScreen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999;
      display: flex; align-items: center; justify-content: center; flex-direction: column; transition: opacity 0.8s;
    }
    .login-box {
      width: 400px; padding: 40px; background: rgba(10, 10, 10, 0.9); border: 1px solid var(--neon-cyan);
      text-align: center; border-radius: 10px; position: relative; overflow: hidden;
      box-shadow: 0 0 40px rgba(0, 243, 255, 0.15);
    }
    .login-input {
      width: 100%; padding: 15px; margin: 20px 0; background: #000; border: 2px solid #333; color: var(--neon-cyan);
      font-family: var(--font-tech); font-size: 18px; text-align: center; outline: none; text-transform: uppercase;
    }
    .login-btn {
      width: 100%; padding: 15px; background: var(--neon-cyan); color: #000; font-weight: bold; border: none;
      cursor: pointer; font-family: var(--font-tech); transition: 0.3s;
    }
    .login-btn:hover { background: #fff; box-shadow: 0 0 20px var(--neon-cyan); }

    header {
      height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 25px;
      background: rgba(0,0,0,0.8); border-bottom: 1px solid #333;
    }
    .brand { font-size: 24px; font-weight: 700; color: #fff; letter-spacing: 2px; }
    .operator-info { display: flex; align-items: center; gap: 15px; font-family: var(--font-tech); color: #aaa; font-size: 14px; }
    .operator-badge { background: #222; padding: 5px 15px; border-radius: 4px; border: 1px solid #444; color: var(--neon-cyan); }

    .network-status-bar {
      height: 35px; background: #0b0b0b; border-bottom: 1px solid #222; display: flex; align-items: center;
      justify-content: center; gap: 10px; font-family: var(--font-tech); font-size: 12px; color: #666;
    }
    .network-status-bar.connected { background: rgba(10, 255, 0, 0.05); color: var(--neon-green); border-bottom-color: var(--neon-green); }
    .status-dot { width: 8px; height: 8px; background: #444; border-radius: 50%; }
    .connected .status-dot { background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }

    /* --- G≈Å√ìWNY DASHBOARD --- */
    .dashboard {
      flex: 1; display: grid; grid-template-columns: 380px 1fr; gap: 20px; padding: 20px; overflow: hidden;
      opacity: 0; transition: opacity 1s;
    }
    .panel-left {
      background: var(--panel-glass); border: var(--border-light); border-radius: 12px; padding: 20px;
      display: flex; flex-direction: column; overflow-y: auto;
    }
    .panel-right {
      position: relative; background: #000; border: 2px solid #333; border-radius: 12px; overflow: hidden;
    }
    video { width: 100%; height: 100%; object-fit: contain; }

    /* UI ELEMENTY */
    .input-group { margin-bottom: 15px; }
    .input-label { font-size: 11px; color: var(--neon-cyan); letter-spacing: 1px; margin-bottom: 5px; display: block; }
    #scanInput {
      width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 12px; font-size: 20px;
      text-align: center; font-family: var(--font-tech); outline: none; border-radius: 5px;
    }
    #scanInput:focus { border-color: var(--neon-green); }
    
    .checklist-btn {
      width: 100%; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); color: #aaa;
      padding: 10px; margin-bottom: 6px; cursor: pointer; text-align: left; font-family: var(--font-ui);
      display: flex; justify-content: space-between; transition: 0.2s; font-size: 14px;
    }
    .checklist-btn.done { border-color: var(--neon-green); color: var(--neon-green); background: rgba(10,255,0,0.05); }

    #actionBtn {
      margin-top: auto; padding: 15px; width: 100%; background: #111; color: #444; font-weight: bold; border: none;
      font-size: 14px; cursor: not-allowed; border-radius: 6px; text-transform: uppercase;
    }
    #actionBtn.active {
      background: var(--neon-green); color: #000; cursor: pointer; animation: pulseBtn 2s infinite;
    }
    @keyframes pulseBtn { 0% { box-shadow: 0 0 10px rgba(10,255,0,0.4); } 50% { box-shadow: 0 0 20px rgba(10,255,0,0.7); } 100% { box-shadow: 0 0 10px rgba(10,255,0,0.4); } }

    /* OVERLAYE KAMERY */
    .cam-overlay { position: absolute; top: 20px; left: 20px; display: flex; flex-direction: column; gap: 5px; }
    .tag {
      background: rgba(0,0,0,0.8); color: #fff; padding: 4px 10px; font-family: var(--font-tech);
      font-size: 13px; border-left: 3px solid var(--neon-cyan); backdrop-filter: blur(5px);
    }

    /* --- NOWO≈öƒÜ: PANEL MANAGERA (BAZA DANYCH) --- */
    .database-trigger {
      position: absolute; bottom: 0; width: 100%; height: 40px; background: #111; border-top: 1px solid var(--neon-cyan);
      display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 100;
      font-family: var(--font-tech); color: var(--neon-cyan); letter-spacing: 2px; transition: 0.3s;
    }
    .database-trigger:hover { background: var(--neon-cyan); color: #000; }

    #databasePanel {
      position: fixed; bottom: 0; left: 0; width: 100%; height: 0; background: rgba(10, 15, 20, 0.98);
      z-index: 200; transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden;
      border-top: 2px solid var(--neon-cyan); display: flex; flex-direction: column;
    }
    #databasePanel.open { height: 80vh; }

    .db-header {
      padding: 20px; background: #000; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;
    }
    .db-controls { display: flex; gap: 10px; }
    .db-btn {
      padding: 10px 20px; border: 1px solid #444; background: #111; color: #fff; cursor: pointer;
      font-family: var(--font-tech); text-transform: uppercase; font-size: 12px;
    }
    .db-btn:hover { border-color: #fff; }
    .db-btn.primary { background: var(--neon-cyan); color: #000; border-color: var(--neon-cyan); font-weight: bold; }

    .db-content { flex: 1; overflow: auto; padding: 20px; }
    
    /* TABELA DANYCH */
    #reportTable { width: 100%; border-collapse: collapse; font-size: 13px; color: #ccc; font-family: var(--font-tech); }
    #reportTable th { text-align: left; padding: 10px; border-bottom: 2px solid #333; color: var(--neon-cyan); position: sticky; top: 0; background: #000; }
    #reportTable td { padding: 10px; border-bottom: 1px solid #222; }
    #reportTable tr:hover { background: rgba(255,255,255,0.05); }
    
    .status-ok { color: var(--neon-green); font-weight: bold; }
    .status-warn { color: var(--neon-amber); }
    .status-err { color: var(--neon-red); }

    /* 3D SCENE (CSS Only) */
    .scene-container { height: 180px; perspective: 800px; display: flex; justify-content: center; align-items: center; margin-bottom: 10px; }
    .tv-pivot { position: relative; width: 180px; height: 110px; transform-style: preserve-3d; transition: transform 0.8s; }
    .tv-panel { position: absolute; width: 100%; height: 100%; background: #000; border: 2px solid #333; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; }
    .tv-front { background: linear-gradient(135deg, #050505, #1a1a1a); border: 1px solid #555; }
    .tv-front::after { content: "OLED"; opacity: 0.3; font-weight: bold; }
    .tv-back { transform: rotateY(180deg); background: #151515; }
    .tv-stand { position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%); width: 60px; height: 5px; background: #333; }

    canvas { display: none; }
  </style>
</head>
<body>

<div id="loginScreen">
  <div class="login-box">
    <h2 style="margin:0; color:#fff; font-family: 'Share Tech Mono';">OLED REPAIR SYSTEM</h2>
    <div style="font-size:12px; color:#666; margin-bottom:20px;">AUTHORIZATION REQUIRED</div>
    <label style="color:var(--neon-cyan); font-size:12px;">IDENTYFIKATOR OPERATORA</label>
    <input type="text" id="operatorNameInput" class="login-input" placeholder="IMIƒò I NAZWISKO">
    <button class="login-btn" onclick="loginOperator()">ZALOGUJ</button>
  </div>
</div>

<header>
  <div class="brand">LG <span>OLED</span> STUDIO <span style="font-size:12px; color:#555;">v6.0 MANAGER</span></div>
  <div class="operator-info">
    <div class="operator-badge" id="operatorDisplay">---</div>
    <div id="clockDisplay">00:00</div>
  </div>
</header>

<div class="network-status-bar" id="networkBar">
  <div class="status-dot"></div>
  <span id="networkText">FOLDER ROZ≈ÅƒÑCZONY</span>
  <button onclick="connectNetwork()" style="background:none; border:1px solid #444; color:#aaa; cursor:pointer; margin-left:10px; font-size:10px;">[ PO≈ÅƒÑCZ ]</button>
</div>

<div class="dashboard" id="mainDashboard">
  <aside class="panel-left">
    <div class="scene-container">
      <div class="tv-pivot" id="tv3d">
        <div class="tv-panel tv-front"></div>
        <div class="tv-panel tv-back">Elektronika</div>
        <div class="tv-stand"></div>
      </div>
    </div>
    
    <div class="input-group">
      <span class="input-label">SKANER SN</span>
      <input type="text" id="scanInput" placeholder="ZESKANUJ..." autofocus>
    </div>

    <div style="margin-bottom:15px;">
      <div id="btnFront" class="checklist-btn" onclick="capture('PRZOD')"><span>1. PRZ√ìD</span> <span>üì∑</span></div>
      <div id="btnBack" class="checklist-btn" onclick="capture('TYL')"><span>2. TY≈Å</span> <span>üì∑</span></div>
      <div id="btnImage" class="checklist-btn" onclick="capture('OBRAZ')"><span>3. OBRAZ</span> <span>üì∑</span></div>
    </div>

    <button id="actionBtn" onclick="saveData()">OCZEKIWANIE</button>
    <div id="saveStatus" style="text-align:center; color:#666; margin-top:5px; font-size:10px;"></div>
  </aside>

  <main class="panel-right">
    <div class="cam-overlay">
      <div class="tag" id="tagSN">SN: BRAK</div>
      <div class="tag" id="tagOp">OP: ---</div>
    </div>
    <video id="videoFeed" autoplay playsinline></video>
  </main>
</div>

<div class="database-trigger" onclick="toggleDatabase()">
  üìÇ OTW√ìRZ BAZƒò DANYCH / RAPORTY
</div>

<div id="databasePanel">
  <div class="db-header">
    <div style="font-size:18px; color:var(--neon-cyan); font-weight:bold;">RAPORT SIECIOWY (LIVE SCAN)</div>
    <div class="db-controls">
      <button class="db-btn primary" onclick="scanNetworkForReports()">üîÑ OD≈öWIE≈ª Z SERWERA</button>
      <button class="db-btn" onclick="exportToCSV()">üíæ EKSPORTUJ CSV (EXCEL)</button>
      <button class="db-btn" onclick="toggleDatabase()">‚ùå ZAMKNIJ</button>
    </div>
  </div>
  <div class="db-content">
    <div id="loadingIndicator" style="display:none; text-align:center; padding:50px; color:var(--neon-cyan);">
      Skanowanie folder√≥w sieciowych... Proszƒô czekaƒá...
    </div>
    <table id="reportTable">
      <thead>
        <tr>
          <th>DATA NAPRAWY</th>
          <th>SERIAL NUMBER (SN)</th>
          <th>OPERATOR</th>
          <th>STATUS PLIK√ìW</th>
        </tr>
      </thead>
      <tbody>
        </tbody>
    </table>
  </div>
</div>

<canvas id="photoCanvas"></canvas>

<script>
  /* --- KONFIGURACJA --- */
  const NETWORK_PATH = String.raw`\\plgorfs001\pub\SERVICE\LCDR\LCDR\OLED OBM Panels\Zdjƒôcia z napraw OLED`;
  let operatorName = "";
  let dirHandle = null;
  let currentSN = "";
  let photos = { PRZOD: null, TYL: null, OBRAZ: null };
  let reportDataCache = []; // Przechowuje dane do eksportu

  const video = document.getElementById('videoFeed');
  const canvas = document.getElementById('photoCanvas');
  const ctx = canvas.getContext('2d');
  const scanInput = document.getElementById('scanInput');
  const actionBtn = document.getElementById('actionBtn');
  const tv3d = document.getElementById('tv3d');

  /* --- ZEGAR --- */
  setInterval(() => document.getElementById('clockDisplay').innerText = new Date().toLocaleTimeString().slice(0,5), 1000);

  /* --- 1. LOGOWANIE --- */
  function loginOperator() {
    const val = document.getElementById('operatorNameInput').value.trim().toUpperCase();
    if (val.length < 3) return alert("Podaj poprawne dane!");
    operatorName = val;
    document.getElementById('operatorDisplay').innerText = operatorName;
    document.getElementById('tagOp').innerText = "OP: " + operatorName;
    document.getElementById('loginScreen').style.opacity = '0';
    setTimeout(() => {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainDashboard').style.opacity = '1';
      initCamera();
      scanInput.focus();
    }, 800);
  }
  document.getElementById('operatorNameInput').addEventListener('keydown', e => { if(e.key==='Enter') loginOperator() });

  /* --- 2. ≈ÅƒÑCZENIE SIECIOWE --- */
  async function connectNetwork() {
    try {
      alert("Skopiowano ≈õcie≈ºkƒô:\n" + NETWORK_PATH + "\n\nWklej jƒÖ w oknie wyboru folderu.");
      await navigator.clipboard.writeText(NETWORK_PATH);
      dirHandle = await window.showDirectoryPicker();
      document.getElementById('networkBar').classList.add('connected');
      document.getElementById('networkText').innerText = "PO≈ÅƒÑCZONO: \\Zdjƒôcia z napraw OLED";
    } catch (e) { console.error(e); }
  }

  /* --- 3. KAMERA --- */
  async function initCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 3840 }, height: { ideal: 2160 } } });
      video.srcObject = stream;
    } catch (e) { alert("B≈ÇƒÖd kamery!"); }
  }

  /* --- 4. G≈Å√ìWNA LOGIKA --- */
  scanInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      const sn = scanInput.value.trim().toUpperCase();
      if (sn.length > 3) startSession(sn);
      else alert("B≈Çƒôdny SN");
      scanInput.value = ""; scanInput.blur();
    }
  });

  function startSession(sn) {
    currentSN = sn; photos = { PRZOD: null, TYL: null, OBRAZ: null };
    document.getElementById('tagSN').innerText = "SN: " + sn;
    document.querySelectorAll('.checklist-btn').forEach(b => b.classList.remove('done'));
    actionBtn.className = ""; actionBtn.innerText = "OCZEKIWANIE (0/3)";
    tv3d.style.transform = "rotateY(0deg)";
  }

  function capture(type) {
    if (!currentSN) { scanInput.focus(); return alert("Zeskanuj SN!"); }
    tv3d.style.transform = type === 'TYL' ? "rotateY(180deg)" : "rotateY(0deg)";
    
    // Flash
    const f = document.createElement('div');
    f.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;background:#fff;opacity:0.8;z-index:99";
    document.querySelector('.panel-right').appendChild(f);
    setTimeout(() => f.remove(), 100);

    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    
    // Watermark
    const fs = Math.floor(video.videoHeight/25);
    ctx.font = `bold ${fs}px Consolas`; ctx.lineWidth = 4; ctx.strokeStyle = "black"; ctx.fillStyle = "#0aff00";
    ctx.strokeText(`SN: ${currentSN}`, 50, fs+20); ctx.fillText(`SN: ${currentSN}`, 50, fs+20);
    ctx.fillStyle = "#00f3ff";
    ctx.strokeText(`TYP: ${type}`, 50, (fs*2)+40); ctx.fillText(`TYP: ${type}`, 50, (fs*2)+40);
    ctx.fillStyle = "white"; ctx.font = `bold ${Math.floor(fs*0.8)}px Consolas`;
    ctx.strokeText(`OP: ${operatorName}`, 50, (fs*3)+60); ctx.fillText(`OP: ${operatorName}`, 50, (fs*3)+60);

    canvas.toBlob(blob => {
      photos[type] = blob;
      const done = Object.values(photos).filter(p=>p).length;
      actionBtn.innerText = `BRAK ZDJƒòƒÜ (${done}/3)`;
      const map = {'PRZOD':'btnFront','TYL':'btnBack','OBRAZ':'btnImage'};
      document.getElementById(map[type]).classList.add('done');
      if(done===3) { actionBtn.classList.add('active'); actionBtn.innerText = "üíæ ZAPISZ"; }
    }, 'image/jpeg', 0.95);
  }

  async function saveData() {
    if(!actionBtn.classList.contains('active')) return;
    document.getElementById('saveStatus').innerText = "ZAPISYWANIE...";
    
    // Generowanie tekstu raportu
    const txt = `SN: ${currentSN}\nDATA: ${new Date().toLocaleString()}\nOPERATOR: ${operatorName}\nSTATUS: OK`;

    if(dirHandle) {
      try {
        const folder = await dirHandle.getDirectoryHandle(currentSN, {create:true});
        await writeF(folder, `${currentSN}_PRZOD.jpg`, photos.PRZOD);
        await writeF(folder, `${currentSN}_TYL.jpg`, photos.TYL);
        await writeF(folder, `${currentSN}_OBRAZ.jpg`, photos.OBRAZ);
        // Zapis pliku TXT (Kluczowe dla raportowania!)
        await writeF(folder, `RAPORT_${currentSN}.txt`, new Blob([txt], {type:'text/plain'}));
        
        document.getElementById('saveStatus').innerText = "ZAPISANO NA SERWERZE!";
        setTimeout(() => { currentSN=""; startSession(""); scanInput.focus(); }, 1500);
      } catch(e) { alert("B≈ÇƒÖd zapisu sieciowego!"); }
    } else {
      const z = new JSZip(); const f = z.folder(currentSN);
      f.file("info.txt", txt);
      // ... dodaj foty do zip (kod skr√≥cony dla czytelno≈õci, logika ta sama co w v5)
      alert("Brak sieci - pobieram ZIP (Funkcja uproszczona w widoku Managera)");
    }
  }
  async function writeF(dh, n, b) { const h = await dh.getFileHandle(n,{create:true}); const w = await h.createWritable(); await w.write(b); await w.close(); }

  /* --- 5. MANAGER: DATABASE SCANNER --- */
  function toggleDatabase() {
    const p = document.getElementById('databasePanel');
    p.classList.toggle('open');
  }

  async function scanNetworkForReports() {
    if (!dirHandle) return alert("Najpierw po≈ÇƒÖcz siƒô z folderem sieciowym!");
    
    const tbody = document.querySelector('#reportTable tbody');
    tbody.innerHTML = "";
    document.getElementById('loadingIndicator').style.display = 'block';
    reportDataCache = [];

    try {
      // Iterujemy przez wszystkie foldery w g≈Ç√≥wnym katalogu
      for await (const entry of dirHandle.values()) {
        if (entry.kind === 'directory') {
          const sn = entry.name;
          let op = "Nieznany";
          let date = "---";
          let status = `<span class="status-warn">BRAK RAPORTU</span>`;
          
          // Wchodzimy do ≈õrodka folderu SN
          try {
            const snDir = await dirHandle.getDirectoryHandle(sn);
            let hasTxt = false;

            for await (const file of snDir.values()) {
              if (file.name.includes("RAPORT") && file.name.endsWith(".txt")) {
                const f = await file.getFile();
                const text = await f.text();
                date = f.lastModifiedDate ? f.lastModifiedDate.toLocaleString() : "---";
                
                // Parsowanie operatora z pliku txt
                const match = text.match(/OPERATOR: (.*)/);
                if (match) op = match[1];
                
                status = `<span class="status-ok">KOMPLETNY</span>`;
                hasTxt = true;
              }
            }
            if (!hasTxt) {
                // Je≈õli nie ma txt, sprawdzamy czy sƒÖ chocia≈º jpg
                status = `<span class="status-err">TYLKO ZDJƒòCIA</span>`;
            }
          } catch (e) {
            status = `<span class="status-err">B≈ÅƒÑD ODCZYTU</span>`;
          }

          // Dodajemy wiersz
          const rowData = { date, sn, op, statusText: status.replace(/<[^>]*>?/gm, '') };
          reportDataCache.push(rowData);

          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${date}</td><td>${sn}</td><td>${op}</td><td>${status}</td>`;
          tbody.appendChild(tr);
        }
      }
    } catch (e) {
      console.error(e);
      alert("B≈ÇƒÖd podczas skanowania folder√≥w.");
    } finally {
      document.getElementById('loadingIndicator').style.display = 'none';
    }
  }

  function exportToCSV() {
    if (reportDataCache.length === 0) return alert("Najpierw przeskanuj serwer!");
    
    let csvContent = "DATA,SERIAL NUMBER,OPERATOR,STATUS\n";
    reportDataCache.forEach(row => {
      csvContent += `${row.date},${row.sn},${row.op},${row.statusText}\n`;
    });

    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    saveAs(blob, "OLED_RAPORT_BAZA.csv");
  }

</script>
</body>
</html>
