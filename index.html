<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>OLED REPAIR SYSTEM v5.0</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-deep: #050505;
      --panel-glass: rgba(20, 25, 35, 0.95);
      --neon-cyan: #00f3ff;
      --neon-green: #0aff00;
      --neon-red: #ff003c;
      --border-light: 1px solid rgba(255, 255, 255, 0.1);
      --font-ui: 'Rajdhani', sans-serif;
      --font-tech: 'Share Tech Mono', monospace;
    }

    * { box-sizing: border-box; }
    
    body {
      margin: 0; padding: 0;
      background-color: var(--bg-deep);
      color: #fff;
      font-family: var(--font-ui);
      height: 100vh;
      overflow: hidden;
      display: flex; flex-direction: column;
      /* T≈Ço techniczne */
      background-image: 
        radial-gradient(circle at 50% 50%, rgba(0, 243, 255, 0.05) 0%, transparent 60%),
        linear-gradient(0deg, rgba(0,0,0,0.8), transparent 2px);
      background-size: 100% 100%, 100% 4px;
    }

    /* --- EKRAN LOGOWANIA --- */
    #loginScreen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #000; z-index: 9999;
      display: flex; align-items: center; justify-content: center;
      flex-direction: column;
      transition: opacity 0.8s ease-in-out;
    }
    
    .login-box {
      width: 400px; padding: 40px;
      background: rgba(10, 10, 10, 0.9);
      border: 1px solid var(--neon-cyan);
      box-shadow: 0 0 50px rgba(0, 243, 255, 0.1);
      text-align: center; border-radius: 10px;
      position: relative; overflow: hidden;
    }
    
    /* Animacja skanera na logowaniu */
    .login-box::before {
      content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 2px;
      background: var(--neon-cyan);
      box-shadow: 0 0 20px var(--neon-cyan);
      animation: scanLogin 3s infinite linear;
    }
    @keyframes scanLogin { 0% { left: -100%; } 50% { left: 100%; } 100% { left: 100%; } }

    .login-input {
      width: 100%; padding: 15px; margin: 20px 0;
      background: #000; border: 2px solid #333; color: var(--neon-cyan);
      font-family: var(--font-tech); font-size: 18px; text-align: center;
      outline: none; text-transform: uppercase;
    }
    .login-input:focus { border-color: var(--neon-cyan); }
    
    .login-btn {
      width: 100%; padding: 15px;
      background: var(--neon-cyan); color: #000; font-weight: bold;
      border: none; cursor: pointer; font-size: 16px;
      font-family: var(--font-tech); text-transform: uppercase;
      transition: 0.3s;
    }
    .login-btn:hover { background: #fff; box-shadow: 0 0 20px var(--neon-cyan); }

    /* --- G≈Å√ìWNY HEADER --- */
    header {
      height: 60px; display: flex; justify-content: space-between; align-items: center;
      padding: 0 25px; background: rgba(0,0,0,0.8); border-bottom: 1px solid #333;
    }
    .brand { font-size: 24px; font-weight: 700; color: #fff; letter-spacing: 2px; }
    .brand span { color: var(--neon-cyan); }
    
    .operator-info {
      display: flex; align-items: center; gap: 15px;
      font-family: var(--font-tech); color: #aaa; font-size: 14px;
    }
    .operator-badge {
      background: #222; padding: 5px 15px; border-radius: 4px; border: 1px solid #444;
      color: var(--neon-cyan);
    }

    /* --- STATUS PO≈ÅƒÑCZENIA --- */
    .network-status-bar {
      height: 40px; background: #0b0b0b; border-bottom: 1px solid #222;
      display: flex; align-items: center; justify-content: center; gap: 10px;
      font-family: var(--font-tech); font-size: 13px; color: #666; transition: 0.3s;
    }
    .network-status-bar.connected {
      background: rgba(10, 255, 0, 0.05); color: var(--neon-green); border-bottom-color: var(--neon-green);
    }
    .status-dot { width: 8px; height: 8px; background: #444; border-radius: 50%; }
    .connected .status-dot { background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }
    
    .connect-trigger {
      background: transparent; border: 1px solid #444; color: #aaa;
      padding: 2px 10px; cursor: pointer; font-size: 11px; margin-left: 10px;
    }
    .connect-trigger:hover { color: #fff; border-color: #fff; }

    /* --- DASHBOARD --- */
    .dashboard {
      flex: 1; display: grid; grid-template-columns: 380px 1fr;
      gap: 20px; padding: 20px; overflow: hidden;
      opacity: 0; transition: opacity 1s; /* Domy≈õlnie ukryty, poka≈ºe siƒô po logowaniu */
    }

    /* LEWY PANEL */
    .panel-left {
      background: var(--panel-glass); border: var(--border-light);
      border-radius: 12px; padding: 20px; display: flex; flex-direction: column;
      box-shadow: 0 0 30px rgba(0,0,0,0.5); overflow-y: auto;
    }

    /* 3D OLED MODEL (CSS) */
    .scene-container {
      height: 220px; perspective: 1000px;
      display: flex; justify-content: center; align-items: center;
      margin-bottom: 20px;
    }
    .tv-pivot {
      position: relative; width: 220px; height: 130px;
      transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Panel TV */
    .tv-panel {
      position: absolute; width: 100%; height: 100%;
      background: #000; border: 2px solid #333; border-radius: 4px;
      backface-visibility: hidden;
      display: flex; align-items: center; justify-content: center;
    }
    .tv-front {
      background: linear-gradient(135deg, #050505 0%, #1a1a1a 100%);
      border: 1px solid #555;
      box-shadow: 0 0 20px rgba(0,0,0,0.8);
    }
    .tv-front::after { content: "OLED"; color: #fff; font-weight: 700; opacity: 0.3; font-family: sans-serif; }
    
    .tv-back {
      transform: rotateY(180deg); background: #151515;
      background-image: repeating-linear-gradient(45deg, #1a1a1a 0, #1a1a1a 2px, transparent 2px, transparent 6px);
    }
    /* "Elektronika" z ty≈Çu */
    .electronics-box {
      width: 60%; height: 60%; background: #222; border: 1px solid #444;
      display: flex; align-items: center; justify-content: center; color: #666; font-size: 10px;
    }
    
    /* Podstawka TV */
    .tv-stand-neck {
      position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%);
      width: 40px; height: 20px; background: #222;
    }
    .tv-stand-base {
      position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%);
      width: 100px; height: 5px; background: #333; border-radius: 5px;
      box-shadow: 0 5px 10px rgba(0,0,0,0.8);
    }

    /* INPUT SKANOWANIA */
    .input-group { margin-bottom: 20px; position: relative; }
    .input-label { font-size: 11px; color: var(--neon-cyan); letter-spacing: 1px; margin-bottom: 5px; display: block; }
    #scanInput {
      width: 100%; background: #000; border: 1px solid #444;
      color: #fff; padding: 15px; font-size: 22px; text-align: center;
      font-family: var(--font-tech); outline: none; border-radius: 5px;
    }
    #scanInput:focus { border-color: var(--neon-green); box-shadow: 0 0 15px rgba(10,255,0,0.2); }

    /* CHECKLISTA */
    .checklist-btn {
      width: 100%; background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1); color: #aaa;
      padding: 12px; margin-bottom: 8px; cursor: pointer; text-align: left;
      font-family: var(--font-ui); font-weight: 600;
      display: flex; justify-content: space-between; transition: 0.2s;
    }
    .checklist-btn:hover { background: rgba(255,255,255,0.08); color: #fff; }
    .checklist-btn.done {
      border-color: var(--neon-green); color: var(--neon-green); background: rgba(10,255,0,0.05);
    }

    /* SAVE BUTTON */
    #actionBtn {
      margin-top: auto; padding: 20px; width: 100%;
      background: #111; color: #444; font-weight: bold; border: none;
      font-size: 16px; cursor: not-allowed; border-radius: 6px; text-transform: uppercase;
    }
    #actionBtn.active {
      background: var(--neon-green); color: #000; cursor: pointer;
      box-shadow: 0 0 20px rgba(10, 255, 0, 0.4);
      animation: pulseBtn 2s infinite;
    }
    @keyframes pulseBtn { 0% { box-shadow: 0 0 10px rgba(10,255,0,0.4); } 50% { box-shadow: 0 0 30px rgba(10,255,0,0.7); } 100% { box-shadow: 0 0 10px rgba(10,255,0,0.4); } }

    /* PRAWY PANEL (KAMERA) */
    .panel-right {
      position: relative; background: #000; border: 2px solid #333;
      border-radius: 12px; overflow: hidden;
    }
    video { width: 100%; height: 100%; object-fit: contain; }
    
    .cam-overlay {
      position: absolute; top: 20px; left: 20px; z-index: 10;
      display: flex; flex-direction: column; gap: 5px;
    }
    .tag {
      background: rgba(0,0,0,0.8); color: #fff; padding: 5px 12px;
      font-family: var(--font-tech); font-size: 14px;
      border-left: 3px solid var(--neon-cyan); backdrop-filter: blur(5px);
    }
    
    /* Ukryty Canvas */
    canvas { display: none; }

  </style>
</head>
<body>

<div id="loginScreen">
  <div class="login-box">
    <h2 style="margin:0; color:#fff; font-family: 'Share Tech Mono';">OLED REPAIR SYSTEM</h2>
    <div style="font-size:12px; color:#666; margin-bottom:20px;">AUTHORIZATION REQUIRED</div>
    
    <label style="color:var(--neon-cyan); font-size:12px;">IDENTYFIKATOR OPERATORA</label>
    <input type="text" id="operatorNameInput" class="login-input" placeholder="IMIƒò I NAZWISKO" autocomplete="off">
    
    <button class="login-btn" onclick="loginOperator()">ROZPOCZNIJ ZMIANƒò</button>
  </div>
</div>

<header>
  <div class="brand">TPV <span>OLED</span> REPAIR STATION</div>
  <div class="operator-info">
    <span>OPERATOR:</span>
    <div class="operator-badge" id="operatorDisplay">---</div>
    <div style="font-size:12px; color:#555;" id="clockDisplay">00:00:00</div>
  </div>
</header>

<div class="network-status-bar" id="networkBar">
  <div class="status-dot"></div>
  <span id="networkText">FOLDER ROZ≈ÅƒÑCZONY - DANE BƒòDƒÑ POBIERANE LOKALNIE</span>
  <button class="connect-trigger" onclick="connectNetwork()">[ PO≈ÅƒÑCZ Z SERWEREM ]</button>
</div>

<div class="dashboard" id="mainDashboard">
  
  <aside class="panel-left">
    
    <div class="scene-container">
      <div class="tv-pivot" id="tv3d">
        <div class="tv-panel tv-front"></div>
        <div class="tv-panel tv-back">
          <div class="electronics-box">SERWIS</div>
        </div>
        <div class="tv-stand-neck"></div>
        <div class="tv-stand-base"></div>
      </div>
    </div>

    <div class="input-group">
      <span class="input-label">SKANER SERIAL NUMBER (SN)</span>
      <input type="text" id="scanInput" placeholder="ZESKANUJ..." autofocus>
    </div>

    <div style="margin-bottom:20px;">
      <span class="input-label" style="color:#aaa;">ETAPY DOKUMENTACJI (0/3)</span>
      <div id="btnFront" class="checklist-btn" onclick="capture('PRZOD')">
        <span>1. PRZ√ìD (Ekran)</span> <span>üì∑</span>
      </div>
      <div id="btnBack" class="checklist-btn" onclick="capture('TYL')">
        <span>2. TY≈Å (Tabliczka)</span> <span>üì∑</span>
      </div>
      <div id="btnImage" class="checklist-btn" onclick="capture('OBRAZ')">
        <span>3. OBRAZ (Test)</span> <span>üì∑</span>
      </div>
    </div>

    <button id="actionBtn" onclick="saveData()">OCZEKIWANIE NA DANE</button>
    <div id="saveStatus" style="text-align:center; color:#666; margin-top:10px; font-size:11px;"></div>
  </aside>

  <main class="panel-right">
    <div class="cam-overlay">
      <div class="tag" id="tagSN">SN: BRAK</div>
      <div class="tag" id="tagOp">OP: ---</div>
      <div class="tag" style="color:var(--neon-green)">REC: LIVE</div>
    </div>
    <video id="videoFeed" autoplay playsinline></video>
  </main>

</div>

<canvas id="photoCanvas"></canvas>

<script>
  /* --- KONFIGURACJA SIECIOWA --- */
  const NETWORK_PATH = String.raw`\\plgorfs001\pub\SERVICE\LCDR\LCDR\OLED OBM Panels\Zdjƒôcia z napraw OLED`;
  
  /* --- ZMIENNE STANU --- */
  let operatorName = "";
  let dirHandle = null; // Uchwyt do folderu sieciowego
  let currentSN = "";
  let photos = { PRZOD: null, TYL: null, OBRAZ: null };

  const video = document.getElementById('videoFeed');
  const canvas = document.getElementById('photoCanvas');
  const ctx = canvas.getContext('2d');
  const scanInput = document.getElementById('scanInput');
  const actionBtn = document.getElementById('actionBtn');
  const tv3d = document.getElementById('tv3d');

  /* --- ZEGAR --- */
  setInterval(() => {
    document.getElementById('clockDisplay').innerText = new Date().toLocaleTimeString();
  }, 1000);

  /* --- 1. LOGOWANIE --- */
  function loginOperator() {
    const input = document.getElementById('operatorNameInput');
    const name = input.value.trim().toUpperCase();
    
    if (name.length < 3) {
      alert("Proszƒô wpisaƒá poprawne Imiƒô i Nazwisko.");
      return;
    }
    
    operatorName = name;
    
    // UI Updates
    document.getElementById('operatorDisplay').innerText = operatorName;
    document.getElementById('tagOp').innerText = "OP: " + operatorName;
    
    // Animacja znikania logowania
    const loginScreen = document.getElementById('loginScreen');
    loginScreen.style.opacity = '0';
    setTimeout(() => {
      loginScreen.style.display = 'none';
      document.getElementById('mainDashboard').style.opacity = '1';
      initCamera();
      scanInput.focus();
    }, 800);
  }

  // Obs≈Çuga Entera na logowaniu
  document.getElementById('operatorNameInput').addEventListener('keydown', (e) => {
    if(e.key === 'Enter') loginOperator();
  });

  /* --- 2. ≈ÅƒÑCZENIE Z SIECIƒÑ (File System API) --- */
  async function connectNetwork() {
    try {
      alert("Skopiowa≈Çem ≈õcie≈ºkƒô do schowka: \n" + NETWORK_PATH + "\n\nWklej jƒÖ w oknie wyboru folderu!");
      await navigator.clipboard.writeText(NETWORK_PATH);
      
      dirHandle = await window.showDirectoryPicker();
      
      // Sukces
      const bar = document.getElementById('networkBar');
      bar.classList.add('connected');
      document.getElementById('networkText').innerText = "PO≈ÅƒÑCZONO Z: \\Zdjƒôcia z napraw OLED";
      document.querySelector('.connect-trigger').style.display = 'none';

    } catch (err) {
      console.error(err);
      alert("Nie uda≈Ço siƒô po≈ÇƒÖczyƒá z folderem. Zdjƒôcia bƒôdƒÖ pobierane jako ZIP.");
    }
  }

  /* --- 3. KAMERA --- */
  async function initCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { width: { ideal: 3840 }, height: { ideal: 2160 } } 
      });
      video.srcObject = stream;
    } catch (e) {
      alert("B≈ÇƒÖd kamery!");
    }
  }

  /* --- 4. LOGIKA SYSTEMU --- */
  scanInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const val = scanInput.value.trim().toUpperCase();
      if (val.length > 3) {
        startRepair(val);
        scanInput.value = "";
        scanInput.blur();
      } else {
        alert("B≈Çƒôdny SN");
      }
    }
  });

  function startRepair(sn) {
    currentSN = sn;
    photos = { PRZOD: null, TYL: null, OBRAZ: null };
    
    // Reset UI
    document.getElementById('tagSN').innerText = "SN: " + sn;
    document.querySelectorAll('.checklist-btn').forEach(b => b.classList.remove('done'));
    actionBtn.className = "";
    actionBtn.innerText = "BRAK ZDJƒòƒÜ (0/3)";
    document.getElementById('saveStatus').innerText = "";
    
    rotateTV('front');
  }

  /* --- 5. ROBIENIE ZDJƒòƒÜ --- */
  function rotateTV(side) {
    if(side === 'back') tv3d.style.transform = "rotateY(180deg)";
    else tv3d.style.transform = "rotateY(0deg)";
  }

  function capture(type) {
    if(!currentSN) {
      scanInput.focus(); return alert("ZESKANUJ SN!");
    }

    // Obr√≥t TV dla efektu
    rotateTV(type === 'TYL' ? 'back' : 'front');

    // Migniƒôcie
    const flash = document.createElement('div');
    flash.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;background:#fff;opacity:0.8;z-index:99";
    document.querySelector('.panel-right').appendChild(flash);
    setTimeout(() => flash.remove(), 80);

    // Rysowanie na canvasie
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);

    // --- WATERMARK (Z NAZWISKIEM OPERATORA) ---
    const fs = Math.floor(video.videoHeight / 25);
    ctx.font = `bold ${fs}px Consolas`;
    ctx.lineWidth = 4;
    ctx.strokeStyle = "black";
    ctx.fillStyle = "#0aff00"; // Zielony SN
    
    // Linia 1: SN
    ctx.strokeText(`SN: ${currentSN}`, 50, fs+20);
    ctx.fillText(`SN: ${currentSN}`, 50, fs+20);
    
    // Linia 2: Typ + Data
    ctx.fillStyle = "#00f3ff"; // Niebieski Typ
    ctx.strokeText(`${type} | ${new Date().toLocaleString()}`, 50, (fs*2)+40);
    ctx.fillText(`${type} | ${new Date().toLocaleString()}`, 50, (fs*2)+40);
    
    // Linia 3: OPERATOR (Wa≈ºne!)
    ctx.fillStyle = "white";
    ctx.font = `bold ${Math.floor(fs*0.8)}px Consolas`;
    ctx.strokeText(`OP: ${operatorName}`, 50, (fs*3)+60);
    ctx.fillText(`OP: ${operatorName}`, 50, (fs*3)+60);

    canvas.toBlob(blob => {
      photos[type] = blob;
      updateChecklist(type);
    }, 'image/jpeg', 0.95);
  }

  function updateChecklist(type) {
    const btnMap = { 'PRZOD': 'btnFront', 'TYL': 'btnBack', 'OBRAZ': 'btnImage' };
    document.getElementById(btnMap[type]).classList.add('done');
    
    const count = Object.values(photos).filter(p => p).length;
    actionBtn.innerText = `BRAK ZDJƒòƒÜ (${count}/3)`;
    
    if(count === 3) {
      actionBtn.classList.add('active');
      actionBtn.innerText = dirHandle ? "üíæ ZAPISZ NA SERWERZE" : "üíæ POBIERZ PACZKƒò";
    }
  }

  /* --- 6. ZAPIS DANYCH (Z Raportem) --- */
  async function saveData() {
    if(!actionBtn.classList.contains('active')) return;

    const statusDiv = document.getElementById('saveStatus');
    statusDiv.innerText = "PRZETWARZANIE...";

    // Generowanie tre≈õci raportu tekstowego
    const reportContent = 
`RAPORT NAPRAWY OLED
--------------------------------
SN: ${currentSN}
DATA: ${new Date().toLocaleString()}
OPERATOR: ${operatorName}
--------------------------------
STATUS: ZDJƒòCIA KOMPLETNE (3/3)
1. PRZOD - OK
2. TYL - OK
3. OBRAZ - OK
--------------------------------
SYSTEM VER: 5.0`;

    // 1. ZAPIS SIECIOWY
    if(dirHandle) {
      try {
        const folder = await dirHandle.getDirectoryHandle(currentSN, { create: true });
        
        // Zapisz zdjƒôcia
        await writeFiles(folder, `${currentSN}_PRZOD.jpg`, photos.PRZOD);
        await writeFiles(folder, `${currentSN}_TYL.jpg`, photos.TYL);
        await writeFiles(folder, `${currentSN}_OBRAZ.jpg`, photos.OBRAZ);
        
        // Zapisz RAPORT TXT (Nowo≈õƒá)
        const txtBlob = new Blob([reportContent], {type: 'text/plain'});
        await writeFiles(folder, `RAPORT_${currentSN}.txt`, txtBlob);

        statusDiv.innerText = "ZAPISANO POPRAWNIE NA SERWERZE!";
        statusDiv.style.color = "#0aff00";
        setTimeout(resetAll, 2000);

      } catch (err) {
        console.error(err);
        statusDiv.innerText = "B≈ÅƒÑD ZAPISU SIECIOWEGO! POBIERAM ZIP.";
        statusDiv.style.color = "red";
        downloadZIP(reportContent);
      }
    } 
    // 2. ZAPIS LOKALNY (ZIP)
    else {
      downloadZIP(reportContent);
    }
  }

  async function writeFiles(folder, name, blob) {
    const file = await folder.getFileHandle(name, { create: true });
    const writable = await file.createWritable();
    await writable.write(blob);
    await writable.close();
  }

  function downloadZIP(txtContent) {
    const zip = new JSZip();
    const f = zip.folder(currentSN);
    f.file(`${currentSN}_PRZOD.jpg`, photos.PRZOD);
    f.file(`${currentSN}_TYL.jpg`, photos.TYL);
    f.file(`${currentSN}_OBRAZ.jpg`, photos.OBRAZ);
    f.file(`RAPORT.txt`, txtContent); // Dodajemy raport do ZIP

    zip.generateAsync({type:"blob"}).then(c => {
      saveAs(c, `${currentSN}.zip`);
      document.getElementById('saveStatus').innerText = "POBRANO ZIP LOKALNIE";
      setTimeout(resetAll, 2000);
    });
  }

  function resetAll() {
    currentSN = "";
    document.getElementById('tagSN').innerText = "SN: OCZEKIWANIE";
    document.querySelectorAll('.checklist-btn').forEach(b => b.classList.remove('done'));
    actionBtn.className = "";
    actionBtn.innerText = "OCZEKIWANIE";
    document.getElementById('saveStatus').innerText = "";
    scanInput.focus();
  }
</script>

</body>
</html>
