<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>OLED REPAIR v1.3 (by ≈Åukasz Gruszczy≈Ñski)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap&subset=latin-ext" rel="stylesheet">
  
  <style>
    /* --- CONFIG & VARIABLES --- */
    :root {
      --bg-deep: #050505;
      --panel-glass: rgba(20, 25, 35, 0.95);
      --neon-cyan: #00f3ff;
      --neon-green: #0aff00;
      --neon-red: #ff003c;
      --neon-gold: #ffd700;
      --neon-purple: #bc13fe;
      --neon-orange: #ff9d00;
      
      --font-ui: 'Roboto', sans-serif;
      --font-tech: 'Oxanium', cursive;
    }
    
    * { box-sizing: border-box; user-select: none; }
    
    body {
      margin: 0; background-color: var(--bg-deep); color: #fff;
      font-family: var(--font-ui); height: 100vh; overflow: hidden;
      display: flex; flex-direction: column;
      background-image: 
        linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
    }

    /* --- LOGIN SCREEN --- */
    #loginScreen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999;
      display: flex; align-items: center; justify-content: center; flex-direction: column; transition: opacity 0.8s;
    }
    .login-box {
      width: 450px; padding: 40px; background: rgba(10, 10, 10, 0.95); border: 1px solid var(--neon-cyan);
      text-align: center; border-radius: 12px; position: relative; overflow: hidden;
      box-shadow: 0 0 60px rgba(0, 243, 255, 0.1); backdrop-filter: blur(10px);
    }
    .login-box h2 { font-family: var(--font-tech); font-weight: 700; letter-spacing: 1px; margin-bottom: 5px; }
    .login-input {
      width: 100%; padding: 15px; margin: 10px 0; background: #080808; border: 1px solid #333; color: var(--neon-cyan);
      font-family: var(--font-tech); font-size: 18px; text-align: center; outline: none; transition: 0.3s;
    }
    .login-input:focus { border-color: var(--neon-cyan); background: #111; }
    input[type="password"] { letter-spacing: 5px; color: var(--neon-red); }
    .login-btn {
      width: 100%; padding: 15px; margin-top: 20px; background: var(--neon-cyan); color: #000; font-weight: bold; border: none;
      cursor: pointer; font-family: var(--font-tech); transition: 0.3s; font-size: 16px; letter-spacing: 2px;
    }
    .login-btn:hover { background: #fff; box-shadow: 0 0 30px var(--neon-cyan); }
    .login-error { color: var(--neon-red); font-size: 12px; height: 20px; margin-top: 10px; font-weight: bold; font-family: var(--font-ui); }

    .remember-me {
        display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; font-size: 14px; color: #aaa;
    }
    .remember-me input { transform: scale(1.5); accent-color: var(--neon-cyan); cursor: pointer; }

    /* --- NETWORK GUARD --- */
    #networkGuard {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.95); z-index: 8000; backdrop-filter: blur(15px);
      display: none; align-items: center; justify-content: center; flex-direction: column;
    }
    .alert-box {
      width: 600px; padding: 40px; border: 2px solid var(--neon-red); background: #050505;
      text-align: center; border-radius: 12px; box-shadow: 0 0 100px rgba(255, 0, 60, 0.2);
    }
    .path-box {
      background:#111; padding:15px; border:1px dashed #555; font-size:12px; color:#fff; 
      font-family:var(--font-tech); margin-top: 5px; word-break: break-all;
    }
    .guard-btn {
      width: 100%; padding: 20px; background: var(--neon-red); color: #fff; font-weight: bold;
      border: none; cursor: pointer; font-family: var(--font-tech); font-size: 18px; margin-top: 20px;
    }
    .offline-btn {
        width: 100%; padding: 15px; background: transparent; color: var(--neon-orange); border: 1px solid var(--neon-orange);
        font-family: var(--font-tech); cursor: pointer; margin-top: 10px; font-weight: bold; transition: 0.3s;
    }
    .offline-btn:hover { background: var(--neon-orange); color: #000; }

    /* --- HEADER --- */
    header {
      height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 30px;
      background: rgba(0,0,0,0.8); border-bottom: 1px solid #333;
    }
    .brand { font-family: var(--font-tech); font-size: 28px; font-weight: 700; color: #fff; letter-spacing: 2px; }
    .brand span { color: var(--neon-cyan); text-shadow: 0 0 10px var(--neon-cyan); }
    .operator-info { display: flex; align-items: center; gap: 20px; font-family: var(--font-tech); color: #aaa; font-size: 14px; }
    
    .operator-badge { background: #1a1a1a; padding: 6px 15px; border-radius: 4px; border: 1px solid #444; color: var(--neon-cyan); transition:0.3s; font-weight: bold; }
    .operator-badge.admin { border-color: var(--neon-gold); color: var(--neon-gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.1); }
    .operator-badge.coord { border-color: var(--neon-purple); color: var(--neon-purple); box-shadow: 0 0 15px rgba(188, 19, 254, 0.2); }
    .operator-badge.manager { border-color: #fff; color: #fff; background: var(--neon-red); box-shadow: 0 0 20px var(--neon-red); }

    .logout-btn {
        background: transparent; border: 1px solid #444; color: var(--neon-red); padding: 5px 10px; 
        font-family: var(--font-tech); font-size: 12px; cursor: pointer; border-radius: 4px; transition: 0.3s;
    }
    .logout-btn:hover { background: var(--neon-red); color: #fff; }

    /* MESSAGE OF THE DAY */
    #motdBar {
        width: 100%; background: #220000; color: var(--neon-red); text-align: center; 
        font-family: var(--font-tech); font-weight: bold; padding: 5px; font-size: 14px;
        border-bottom: 1px solid var(--neon-red); display: none; animation: pulseRed 3s infinite;
    }
    @keyframes pulseRed { 0% {opacity:0.8;} 50% {opacity:1;} 100% {opacity:0.8;} }

    /* --- VIEW MODES --- */
    /* Domy≈õlnie Dashboard (Operator) jest widoczny, inne ukryte */
    .dashboard { display: grid; flex: 1; grid-template-columns: 420px 1fr; gap: 20px; padding: 20px; overflow: hidden; opacity: 0; transition: opacity 1s; }
    #adminDash { display: none; }
    #managerDash { display: none; }

    /* TRYB MANAGERA (KIEROWNIK) - Ukrywamy wszystko co operacyjne */
    body.mode-manager .dashboard { display: none !important; }
    body.mode-manager #adminDash { display: none !important; }
    body.mode-manager #managerDash { display: flex !important; }
    body.mode-manager .bar-bottom { display: none !important; } /* Kierownik nie ma paska na dole */
    body.mode-manager .cam-controls { display: none !important; }

    /* TRYB ADMINA */
    body.mode-admin .dashboard { display: none !important; }
    body.mode-admin #managerDash { display: none !important; }
    body.mode-admin #adminDash { display: flex !important; }

    /* --- OPERATOR PANELS --- */
    .panel-left {
      background: var(--panel-glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px;
      display: flex; flex-direction: column; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
    .panel-right {
      position: relative; background: #000; border: 2px solid #333; border-radius: 12px; overflow: hidden;
      box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
      cursor: grab;
    }
    .panel-right:active { cursor: grabbing; }

    /* --- MANAGER DASHBOARD (ZAAWANSOWANE) --- */
    #managerDash {
        flex: 1; padding: 30px; flex-direction: column; overflow-y: auto; gap: 20px;
        background: radial-gradient(circle at top, #111, #000);
    }
    .mgr-header {
        display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 20px;
    }
    .mgr-title { font-size: 32px; font-family: var(--font-tech); color: #fff; text-shadow: 0 0 20px var(--neon-cyan); }
    
    .mgr-filters { display: flex; gap: 10px; background: #111; padding: 10px; border-radius: 8px; border: 1px solid #333; }
    .mgr-btn {
        background: transparent; border: 1px solid #555; color: #aaa; padding: 10px 25px; 
        font-family: var(--font-tech); cursor: pointer; transition: 0.3s; font-size: 14px;
    }
    .mgr-btn:hover { border-color: #fff; color: #fff; }
    .mgr-btn.active { background: var(--neon-cyan); color: #000; border-color: var(--neon-cyan); font-weight: bold; box-shadow: 0 0 20px rgba(0,243,255,0.3); }
    
    .mgr-stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 20px; }
    .mgr-card {
        background: rgba(20,20,20,0.8); border: 1px solid #333; padding: 25px; border-radius: 12px; text-align: center;
        backdrop-filter: blur(10px); position: relative; overflow: hidden;
    }
    .mgr-card h3 { font-size: 14px; color: #888; margin: 0 0 10px 0; letter-spacing: 1px; }
    .mgr-card .val { font-size: 48px; font-weight: bold; font-family: var(--font-tech); color: #fff; }
    
    .mgr-content-grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; flex: 1; min-height: 400px; margin-top: 20px; }
    .mgr-panel { background: #0a0a0a; border: 1px solid #333; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; }
    .mgr-panel h4 { margin: 0 0 20px 0; color: var(--neon-gold); font-family: var(--font-tech); border-bottom: 1px solid #222; padding-bottom: 10px; }

    /* Tables in Manager */
    .data-table { width: 100%; border-collapse: collapse; font-size: 13px; color: #ccc; font-family: var(--font-tech); }
    .data-table th { text-align: left; padding: 10px; background: #151515; color: #888; border-bottom: 1px solid #444; position: sticky; top: 0; }
    .data-table td { padding: 10px; border-bottom: 1px solid #222; }
    .data-table tr:hover { background: rgba(255,255,255,0.05); }

    /* --- ADMIN DASHBOARD --- */
    .admin-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
    .admin-panel-box { background: #0a0a0a; border: 1px solid #333; padding: 20px; border-radius: 10px; }
    .admin-h { font-family: var(--font-tech); color: var(--neon-gold); font-size: 18px; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; display:flex; justify-content:space-between; align-items:center; }
    .cfg-input { width: 100%; background: #111; color: #fff; border: 1px solid #444; padding: 10px; margin-bottom: 10px; font-family: monospace; }
    .cfg-btn { background: var(--neon-cyan); color: #000; border:none; padding:8px 15px; font-weight:bold; cursor:pointer; font-family: var(--font-tech); transition:0.3s; }
    .cfg-btn:hover { background: #fff; box-shadow: 0 0 15px var(--neon-cyan); }
    #adminCamPreview { width: 100%; height: 150px; background: #000; border: 1px solid #444; object-fit: contain; margin-top: 10px; }

    /* VIDEO & ZOOM LOGIC (Operator only) */
    .video-container { width: 100%; height: 100%; overflow: hidden; position: relative; display: flex; justify-content: center; align-items: center; }
    video { width: 100%; height: 100%; object-fit: contain; transition: transform 0.1s linear; transform-origin: center center; }
    #drawCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 60; cursor: crosshair; display: none; }
    .draw-toolbar { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100; display: none; background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 30px; border: 1px solid var(--neon-cyan); backdrop-filter: blur(5px); }
    .color-btn { width: 25px; height: 25px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; display: inline-block; margin: 0 5px; }
    .tool-btn { background: transparent; border: 1px solid #aaa; color: #fff; padding: 5px 12px; cursor: pointer; font-family: var(--font-tech); font-size: 12px; margin-left: 10px; border-radius: 4px; }
    .tool-btn.confirm { background: var(--neon-cyan); color: #000; border-color: var(--neon-cyan); font-weight: bold; }
    .cam-controls { position: absolute; bottom: 20px; right: 20px; z-index: 50; display: flex; gap: 15px; align-items: center; background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 30px; border: 1px solid #333; backdrop-filter: blur(5px); }
    .cam-btn { background: transparent; border: 1px solid var(--neon-cyan); color: var(--neon-cyan); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; transition: 0.2s; }
    .cam-btn:hover { background: var(--neon-cyan); color: #000; }
    .zoom-group { display: flex; align-items: center; gap: 10px; font-family: var(--font-tech); font-size: 12px; color: var(--neon-cyan); }
    input[type=range] { -webkit-appearance: none; width: 100px; height: 4px; background: #333; border-radius: 2px; outline: none; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--neon-cyan); cursor: pointer; box-shadow: 0 0 10px var(--neon-cyan); }

    /* UI ELEMENTS */
    .input-label { font-size: 11px; color: var(--neon-cyan); letter-spacing: 1px; margin-bottom: 5px; display: block; font-weight: bold; font-family: var(--font-tech); }
    #scanInput { width: 100%; background: #080808; border: 1px solid #444; color: #fff; padding: 12px; font-size: 22px; text-align: center; font-family: var(--font-tech); outline: none; border-radius: 6px; margin-bottom: 15px; }
    #scanInput:focus { border-color: var(--neon-cyan); box-shadow: 0 0 20px rgba(0, 243, 255, 0.2); }
    .checklist-btn { width: 100%; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); color: #888; padding: 12px; margin-bottom: 8px; cursor: pointer; text-align: left; font-family: var(--font-ui); display: flex; justify-content: space-between; transition: 0.2s; font-size: 14px; border-radius: 6px; font-weight: 500; }
    .checklist-btn:hover { background: rgba(255,255,255,0.05); color: #fff; border-color: #fff; }
    .checklist-btn.done { border-color: var(--neon-green); color: var(--neon-green); background: rgba(10,255,0,0.1); font-weight: 700; }
    .decision-panel { border-top: 1px solid #333; margin-top: 10px; padding-top: 15px; }
    .custom-select { width: 100%; background: #080808; color: #fff; border: 1px solid var(--neon-purple); padding: 10px; font-family: var(--font-tech); font-size: 14px; border-radius: 5px; outline: none; cursor: pointer; margin-bottom: 10px; }
    .custom-textarea { width: 100%; background: #080808; color: #ccc; border: 1px solid #444; padding: 10px; font-family: var(--font-ui); font-size: 14px; border-radius: 5px; outline: none; resize: vertical; margin-bottom: 10px; }
    .custom-textarea:focus { border-color: var(--neon-cyan); color: #fff; }
    #actionBtn { margin-top: auto; padding: 15px; width: 100%; background: #111; color: #444; font-weight: bold; border: none; font-size: 16px; cursor: not-allowed; border-radius: 6px; text-transform: uppercase; letter-spacing: 1px; font-family: var(--font-tech); }
    #actionBtn.active { background: var(--neon-green); color: #000; cursor: pointer; animation: pulseBtn 2s infinite; box-shadow: 0 0 20px var(--neon-green); }
    @keyframes pulseBtn { 0% { box-shadow: 0 0 10px var(--neon-green); } 50% { box-shadow: 0 0 30px var(--neon-green); } 100% { box-shadow: 0 0 10px var(--neon-green); } }

    /* PANELS BOTTOM */
    .bar-bottom { position: fixed; bottom: 0; left: 0; width: 100%; height: 40px; background: #080808; border-top: 1px solid #333; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; z-index: 100; }
    .bar-group { display: flex; gap: 10px; }
    .bar-btn { background: transparent; border: 1px solid #444; color: #aaa; padding: 5px 15px; font-family: var(--font-tech); font-size: 11px; cursor: pointer; transition: 0.2s; }
    .bar-btn:hover { border-color: var(--neon-cyan); color: var(--neon-cyan); }
    .bar-btn.admin-only { border-color: var(--neon-gold); color: var(--neon-gold); display: none; }

    /* SLIDE PANEL (Operator Analytics) */
    .slide-panel { position: fixed; bottom: 0; left: 0; width: 100%; height: 0; background: rgba(10, 12, 16, 0.98); z-index: 200; transition: height 0.5s cubic-bezier(0.25, 1, 0.5, 1); overflow: hidden; border-top: 2px solid var(--neon-cyan); display: flex; flex-direction: column; }
    .slide-panel.open { height: 85vh; }
    .panel-header { padding: 20px; background: #000; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
    .panel-content { flex: 1; overflow: auto; padding: 30px; }

    #qrPopup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; color: #000; padding: 30px; border-radius: 10px; z-index: 500; text-align: center; display: none; box-shadow: 0 0 100px rgba(0,0,0,1); border: 5px solid var(--neon-cyan); }
    #qrCodeBox { margin: 20px auto; }
    #printLabel { display: none; }

    @media print {
        @page { size: auto; margin: 0mm; }
        body * { visibility: hidden; } 
        #printLabel, #printLabel * { visibility: visible; }
        #printLabel { position: absolute; left: 0; top: 0; width: 150mm; height: 150mm; display: flex !important; flex-direction: column; justify-content: space-between; align-items: center; border: 2px solid #000; background: white; color: black; font-family: 'Roboto', sans-serif; padding: 10mm; box-sizing: border-box; z-index: 9999; }
        .pl-header { font-size: 24pt; font-weight: bold; border-bottom: 2px solid #000; width: 100%; text-align: center; padding-bottom: 5mm; }
        .pl-qr { margin: 5mm 0; }
        .pl-info { width: 100%; text-align: left; font-size: 14pt; line-height: 1.5; }
        .pl-footer { font-size: 10pt; width: 100%; text-align: center; border-top: 1px solid #000; padding-top: 2mm; margin-top: auto; }
        #qrPopup { display: none !important; }
    }

    canvas { display: none; }
    #patternOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 99999; display: none; cursor: pointer; }

  </style>
</head>
<body>

<div id="patternOverlay" onclick="nextPattern()"></div>

<div id="printLabel">
    <div class="pl-header">TPV OLED SERVICE</div>
    <div id="printQrCode" class="pl-qr"></div>
    <div class="pl-info">
        <div><strong>SN:</strong> <span id="plSN">---</span></div>
        <div><strong>DATA:</strong> <span id="plDate">---</span></div>
        <div><strong>OPERATOR:</strong> <span id="plOp">---</span></div>
        <div><strong>STATUS:</strong> <span id="plStatus" style="font-weight:bold; font-size:20pt;">---</span></div>
    </div>
    <div class="pl-footer">OLED REPAIR SYSTEM v1.3 - By ≈Åukasz Gruszczy≈Ñski</div>
</div>

<div id="loginScreen">
  <div class="login-box">
    <h2 style="color:#fff;">OLED REPAIR SYSTEM</h2>
    <div style="font-size:12px; color:#666; margin-bottom:30px; font-family: var(--font-tech);">v1.3 (by ≈Åukasz Gruszczy≈Ñski)</div>
    
    <label class="input-label" style="text-align:left; margin-left:5px;">U≈ªYTKOWNIK</label>
    <input type="text" id="userInput" class="login-input" placeholder="LOGIN" autocomplete="off">
    <label class="input-label" style="text-align:left; margin-left:5px; color:var(--neon-red);">HAS≈ÅO</label>
    <input type="password" id="passInput" class="login-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    
    <div class="remember-me">
        <input type="checkbox" id="rememberCheck"> <label for="rememberCheck">ZAPAMIƒòTAJ MNIE</label>
    </div>

    <div id="loginError" class="login-error"></div>
    <button class="login-btn" onclick="attemptLogin()">ROZPOCZNIJ ZMIANƒò</button>
  </div>
</div>

<div id="networkGuard">
  <div class="alert-box">
    <h1 style="color:var(--neon-red); margin:0;">‚ö†Ô∏è SYSTEM ROZ≈ÅƒÑCZONY ‚ö†Ô∏è</h1>
    <p style="font-size:16px; color:#ccc; margin:20px 0;">WYMAGANY DOSTƒòP DO FOLDERU SIECIOWEGO</p>
    <div class="input-label" style="color:#aaa;">CEL:</div>
    <div class="path-box" id="displayPath">...</div>
    <button class="guard-btn" onclick="connectNetwork()">üì° PO≈ÅƒÑCZ Z SERWEREM</button>
    <button class="offline-btn" onclick="startOfflineMode()">üìÇ PRACA OFFLINE (ZIP)</button>
  </div>
</div>

<header>
  <div class="brand">TPV <span>OLED</span> REPAIR STATION</div>
  <div class="operator-info">
    <button class="bar-btn" onclick="toggleFullScreen()" title="Kiosk Mode">‚õ∂</button>
    <div class="operator-badge" id="operatorBadge">---</div>
    <button class="logout-btn" onclick="logout()">WYLOGUJ</button>
    <div id="clockDisplay">00:00</div>
  </div>
</header>

<div id="motdBar">KOMUNIKAT: ---</div>

<div class="dashboard" id="mainDashboard">
  <aside class="panel-left">
    <div class="scene-container">
      <div class="tv-pivot" id="tv3d">
        <div class="tv-panel tv-front"></div>
        <div class="tv-panel tv-back">SERWIS</div>
      </div>
    </div>
    
    <span class="input-label">1. SN MODU≈ÅU (SET)</span>
    <input type="text" id="scanInput" placeholder="SKANUJ MODU≈Å..." autofocus>

    <span class="input-label" style="color:var(--neon-green)">2. SN OC (SZK≈ÅO)</span>
    <input type="text" id="scanInputOC" placeholder="OCZEKIWANIE NA DECYZJƒò..." disabled 
           style="width: 100%; background: #080808; border: 1px solid #333; color: var(--neon-green); padding: 12px; font-size: 18px; text-align: center; font-family: var(--font-tech); outline: none; border-radius: 6px; margin-bottom: 15px;">

    <div id="checklist">
        <button class="checklist-btn" style="border-color:var(--neon-purple); color:var(--neon-purple);" onclick="togglePatterns()"><span>üñ•Ô∏è TEST EKRANU (PATTERNS)</span> <span>‚èØ</span></button>
        <div style="height:10px;"></div>
        <div id="btnFront" class="checklist-btn" onclick="capture('PRZOD')"><span>1. PRZ√ìD EKRANU</span> <span>üì∑</span></div>
        <div id="btnBack" class="checklist-btn" onclick="capture('TYL')"><span>2. TY≈Å (TABLICZKA)</span> <span>üì∑</span></div>
        <div id="btnImage" class="checklist-btn" onclick="capture('OBRAZ')"><span>3. TEST OBRAZU</span> <span>üì∑</span></div>
    </div>

    <div class="decision-panel">
      <span class="input-label" style="color:var(--neon-purple)">DECYZJA SERWISOWA</span>
      <select id="statusSelect" class="custom-select" onchange="checkOcRequirement(); saveRecoveryState();">
        <option value="OK">üü¢ OK (SPRAWNY)</option>
        <option value="NG">üî¥ NG (USZKODZONY)</option>
        <option value="NDF">üîµ NDF (BRAK WAD)</option>
        <option value="RMA">üü† RMA (ZWROT)</option>
        <option value="SCRAP">‚ö´ SCRAP (Z≈ÅOM)</option>
        <option value="OFFRS_OK">üü£ OFFRS OK</option>
      </select>
      <span class="input-label">KOMENTARZ / OPIS USTERKI</span>
      <textarea id="commentInput" class="custom-textarea" rows="2" placeholder="Wpisz uwagi..." onkeyup="saveRecoveryState()"></textarea>
    </div>

    <button id="actionBtn" onclick="saveData()">OCZEKIWANIE</button>
    <div id="saveStatus" style="text-align:center; color:#666; margin-top:10px; font-size:11px; height:15px; font-family: var(--font-tech);"></div>
  </aside>

  <main class="panel-right" id="camContainer">
    <div class="cam-overlay">
      <div class="tag" id="tagSN">SN: ---</div>
      <div class="tag" id="tagOp">OP: ---</div>
    </div>
    
    <div class="draw-toolbar" id="drawToolbar">
      <span style="color:#fff; font-size:12px; margin-right:10px;">ZAZNACZ WADƒò:</span>
      <div class="color-btn" style="background:red;" onclick="setDrawColor('red')"></div>
      <div class="color-btn" style="background:#0aff00;" onclick="setDrawColor('#0aff00')"></div>
      <button class="tool-btn" onclick="clearDraw()">WYCZY≈öƒÜ</button>
      <button class="tool-btn confirm" onclick="confirmPhoto()">ZAPISZ</button>
      <button class="tool-btn" onclick="cancelPhoto()">ANULUJ</button>
    </div>

    <div class="cam-controls">
      <div class="zoom-group">
        <span>ZOOM</span>
        <input type="range" id="zoomSlider" min="1" max="4" step="0.1" value="1">
        <span id="zoomVal">1.0x</span>
      </div>
      <div style="width:1px; height:20px; background:#444; margin:0 5px;"></div>
      <div class="cam-btn" onclick="toggleMirror()" title="Odbicie lustrzane">‚Üî</div>
    </div>
    
    <div class="video-container">
        <video id="videoFeed" autoplay playsinline></video>
        <canvas id="drawCanvas"></canvas>
    </div>
  </main>
</div>

<div id="adminDash">
    <div class="admin-grid">
        <div class="admin-panel-box">
            <div class="admin-h">
                <span>ZARZƒÑDZANIE U≈ªYTKOWNIKAMI</span>
                <span style="font-size:12px; color:#666;">EDYCJA / RESET HASE≈Å</span>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 100px; gap:10px; margin-bottom:15px;">
              <input type="text" id="newLogin" placeholder="NOWY LOGIN" class="cfg-input" style="margin:0;">
              <input type="text" id="newPass" placeholder="HAS≈ÅO" class="cfg-input" style="margin:0;">
              <select id="newRole" class="cfg-input" style="margin:0; padding:10px;">
                <option value="OPERATOR">OPERATOR</option>
                <option value="KOORDYNATOR">KOORDYNATOR</option>
                <option value="KIEROWNIK">KIEROWNIK</option>
                <option value="ADMIN">ADMINISTRATOR</option>
              </select>
              <button onclick="addUser()" class="cfg-btn">DODAJ</button>
            </div>
            
            <div style="overflow-y:auto; max-height:400px;">
                <table class="adm-table" id="admUserTable">
                    <thead><tr><th>LOGIN</th><th>ROLA</th><th>AKCJE</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div style="display:flex; flex-direction:column; gap:20px;">
            <div class="admin-panel-box" style="border-color:var(--neon-cyan);">
                <div class="admin-h" style="color:var(--neon-cyan)">BAZA DANYCH I ANALITYKA</div>
                <div style="font-size:12px; color:#aaa; margin-bottom:15px;">
                    Po≈ÇƒÖcz siƒô z serwerem, aby przeglƒÖdaƒá raporty, statystyki i exportowaƒá dane.
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="cfg-btn" style="flex:1; border-color:var(--neon-cyan);" onclick="connectNetwork()">üì° PO≈ÅƒÑCZ Z SERWEREM</button>
                    <button class="cfg-btn" style="flex:1; background:var(--neon-cyan); color:#000;" onclick="toggleReportPanel()">üìä OTW√ìRZ RAPORTY</button>
                </div>
            </div>

            <div class="admin-panel-box">
                <div class="admin-h">KONFIGURACJA SYSTEMU</div>
                <div class="input-label">≈öCIE≈ªKA SIECIOWA (ZAPIS)</div>
                <input type="text" id="cfgPath" class="cfg-input" value="\\plgorfs001...">
                <button class="cfg-btn" onclick="saveConfigPath()">ZAPISZ ≈öCIE≈ªKƒò</button>
                
                <div style="margin-top:20px;"></div>
                <div class="input-label">WIADOMO≈öƒÜ DNIA (BROADCAST)</div>
                <input type="text" id="cfgMotd" class="cfg-input" placeholder="Wpisz komunikat...">
                <button class="cfg-btn" onclick="saveMotd()">WY≈öLIJ KOMUNIKAT</button>
            </div>

            <div class="admin-panel-box">
                <div class="admin-h">PODGLƒÑD STANOWISKA</div>
                <video id="adminCamPreview" autoplay playsinline muted></video>
                <div style="text-align:center; font-size:10px; color:#666; margin-top:5px;">PODGLƒÑD NA ≈ªYWO (BEZ ZAPISU)</div>
            </div>
        </div>
    </div>
</div>

<div id="managerDash">
    <div class="mgr-header">
        <div class="mgr-title">PANEL KIEROWNIKA</div>
        <div class="mgr-filters">
            <button class="mgr-btn active" id="fToday" onclick="updateLeaderStats('TODAY')">DZISIAJ</button>
            <button class="mgr-btn" id="fYesterday" onclick="updateLeaderStats('YESTERDAY')">WCZORAJ</button>
            <button class="mgr-btn" id="fAll" onclick="updateLeaderStats('ALL')">CA≈ÅA HISTORIA</button>
            <div style="width:1px; background:#444; margin:0 10px;"></div>
            <button class="mgr-btn" onclick="scanNetwork()">üîÑ OD≈öWIE≈ª</button>
            <button class="mgr-btn" onclick="exportCSV()">üíæ CSV</button>
        </div>
    </div>

    <div class="mgr-stats-row">
        <div class="mgr-card" style="border-color:var(--neon-cyan)">
            <h3>ILO≈öƒÜ CA≈ÅKOWITA</h3>
            <div class="val" id="mgrTotal">0</div>
        </div>
        <div class="mgr-card" style="border-color:var(--neon-green)">
            <h3>STATUS OK</h3>
            <div class="val" id="mgrOK" style="color:var(--neon-green)">0</div>
        </div>
        <div class="mgr-card" style="border-color:var(--neon-red)">
            <h3>ODRZUTY (NG)</h3>
            <div class="val" id="mgrNG" style="color:var(--neon-red)">0</div>
        </div>
        <div class="mgr-card" style="border-color:var(--neon-orange)">
            <h3>YIELD %</h3>
            <div class="val" id="mgrYield">0%</div>
        </div>
    </div>

    <div class="mgr-content-grid">
        <div class="mgr-panel">
            <h4>RANKING OPERATOR√ìW</h4>
            <div style="overflow:auto;">
                <table class="data-table">
                    <thead><tr><th>OP</th><th>ILO≈öƒÜ</th><th>YIELD</th></tr></thead>
                    <tbody id="mgrRankBody"><tr><td colspan="3" style="text-align:center">Brak danych</td></tr></tbody>
                </table>
            </div>
        </div>

        <div class="mgr-panel">
            <h4>DZIENNIK ZDARZE≈É</h4>
            <div style="overflow:auto;">
                <table class="data-table">
                    <thead><tr><th>DATA</th><th>SN MODU≈ÅU</th><th>SN OC</th><th>OP</th><th>DECYZJA</th><th>UWAGI</th></tr></thead>
                    <tbody id="mgrLogBody"><tr><td colspan="6" style="text-align:center">Po≈ÇƒÖcz siƒô z serwerem...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="bar-bottom">
  <div id="connStatus" style="color:#444; font-size:11px;">üî¥ OFFLINE</div>
  <div class="bar-group">
    <button class="bar-btn admin-only" onclick="alert('U≈ºyj Panelu Administratora')">üë• U≈ªYTKOWNICY</button>
    <button class="bar-btn" id="dbBtn" onclick="toggleReportPanel()">üìÇ BAZA DANYCH (OPERATOR)</button>
  </div>
</div>

<div id="reportPanel" class="slide-panel">
  <div class="panel-header">
    <div style="font-size:20px; color:var(--neon-cyan); font-family: var(--font-tech);">CENTRUM ANALIZ (PODGLƒÑD)</div>
    <button class="bar-btn" onclick="toggleReportPanel()">ZAMKNIJ X</button>
  </div>
  <div class="panel-content">
    <div style="color:#888; text-align:center; margin-top:50px;">
        To jest uproszczony podglƒÖd dla Operatora. Pe≈Çne dane w panelu Kierownika/Admina.
    </div>
  </div>
</div>

<div id="qrPopup">
  <h2 style="font-family: var(--font-tech); margin-top:0;">OLED PASSPORT</h2>
  <div id="qrCodeBox"></div>
  <div id="qrSnDisplay" style="font-weight:bold; font-family:var(--font-tech);">SN: ---</div>
  <div id="qrStatusDisplay" style="color:green; margin-bottom:10px;">STATUS: OK</div>
  <button onclick="closeQr()" style="padding:10px 20px; background:#000; color:#fff; border:none; cursor:pointer;">ZAMKNIJ</button>
  <button onclick="window.print()" style="padding:10px 20px; background:var(--neon-cyan); color:#000; border:none; cursor:pointer;">DRUKUJ ETYKIETƒò</button>
</div>

<canvas id="photoCanvas"></canvas>

<script>
  /* --- CONFIG --- */
  let CONFIG = {
    networkPath: String.raw`\\plgorfs001\pub\SERVICE\LCDR\LCDR\OLED OBM Panels\Zdjƒôcia z napraw OLED`,
    motd: "",
    defaultUsers: [
      { login: "DAWID", pass: "OLED12345!", role: "OPERATOR" },
      { login: "LUKASZ", pass: "050699", role: "ADMIN" },
      { login: "MICHAL", pass: "COORD2024", role: "KOORDYNATOR" },
      { login: "BOSS", pass: "1234", role: "KIEROWNIK" }
    ]
  };

  /* --- STATE --- */
  let users = [];
  let currentUser = null;
  let dirHandle = null;
  let currentSN = "";
  let currentOC = ""; 
  let photos = { PRZOD: null, TYL: null, OBRAZ: null };
  let isMirrored = false;
  let reportsCache = [];
  let leaderMode = 'TODAY'; // TODAY, YESTERDAY, ALL
  
  /* --- AUDIO --- */
  const SoundFX = {
    ctx: null,
    init: function() { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
    play: function(type) {
      if(!this.ctx) this.init();
      const osc = this.ctx.createOscillator();
      const gain = this.ctx.createGain();
      osc.connect(gain); gain.connect(this.ctx.destination);
      const now = this.ctx.currentTime;
      if(type === 'beep') {
        osc.type = 'sine'; osc.frequency.setValueAtTime(1200, now);
        gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.1);
        osc.start(now); osc.stop(now+0.1);
      } else if(type === 'error') {
        osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now+0.3);
        gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0.01, now+0.3);
        osc.start(now); osc.stop(now+0.3);
      } else if(type === 'success') {
        osc.type = 'triangle'; osc.frequency.setValueAtTime(440, now); osc.frequency.setValueAtTime(554, now+0.1); osc.frequency.setValueAtTime(659, now+0.2); 
        gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.4);
        osc.start(now); osc.stop(now+0.4);
      }
    }
  };

  // Drawing State
  let isDrawing = false;
  let drawColor = "red";
  let tempPhotoType = "";
  let zoomLevel = 1.0;
  let panX = 0; let panY = 0;
  let isPanning = false; let startPanX = 0; let startPanY = 0;

  /* --- INIT --- */
  window.onload = () => {
    loadConfig();
    loadUsers();
    checkSavedLogin();
    checkRecovery();
    checkOcRequirement();
    
    if(CONFIG.motd) {
        document.getElementById('motdBar').style.display = 'block';
        document.getElementById('motdBar').innerText = "KOMUNIKAT: " + CONFIG.motd;
    }

    setInterval(() => document.getElementById('clockDisplay').innerText = new Date().toLocaleTimeString().slice(0,5), 1000);
    
    // Canvas Listeners
    const c = document.getElementById('drawCanvas');
    c.addEventListener('mousedown', startDraw); c.addEventListener('mouseup', endDraw); c.addEventListener('mousemove', draw);
    c.addEventListener('touchstart', (e)=>{e.preventDefault(); startDraw(e.touches[0])});
    c.addEventListener('touchend', (e)=>{e.preventDefault(); endDraw()});
    c.addEventListener('touchmove', (e)=>{e.preventDefault(); draw(e.touches[0])});

    // Zoom
    const slider = document.getElementById('zoomSlider');
    slider.addEventListener('input', (e) => { zoomLevel = parseFloat(e.target.value); applyTransform(); });

    // Pan
    const camContainer = document.getElementById('camContainer');
    camContainer.addEventListener('mousedown', (e) => {
        if(zoomLevel > 1 && !isDrawing && document.getElementById('drawCanvas').style.display === 'none') {
            isPanning = true; startPanX = e.clientX - panX; startPanY = e.clientY - panY;
            camContainer.style.cursor = 'grabbing';
        }
    });
    window.addEventListener('mouseup', () => { isPanning = false; camContainer.style.cursor = zoomLevel > 1 ? 'grab' : 'default'; });
    window.addEventListener('mousemove', (e) => {
        if(!isPanning) return; e.preventDefault();
        panX = e.clientX - startPanX; panY = e.clientY - startPanY;
        applyTransform();
    });
  };

  function applyTransform() {
    const v = document.getElementById('videoFeed');
    const mirrorFactor = isMirrored ? -1 : 1;
    v.style.transform = `scale(${zoomLevel * mirrorFactor}, ${zoomLevel}) translate(${panX / zoomLevel}px, ${panY / zoomLevel}px)`;
  }

  /* --- CONFIG & LOGIN --- */
  function loadConfig() {
      const savedPath = localStorage.getItem('oled_cfg_path');
      if(savedPath) CONFIG.networkPath = savedPath;
      const savedMotd = localStorage.getItem('oled_cfg_motd');
      if(savedMotd) CONFIG.motd = savedMotd;
      document.getElementById('displayPath').innerText = CONFIG.networkPath;
  }
  function saveConfigPath() {
      const v = document.getElementById('cfgPath').value.trim();
      if(v) { CONFIG.networkPath = v; localStorage.setItem('oled_cfg_path', v); alert("Zapisano!"); }
  }
  function saveMotd() {
      const v = document.getElementById('cfgMotd').value.trim();
      CONFIG.motd = v; localStorage.setItem('oled_cfg_motd', v); alert("Komunikat zapisany!");
  }

  function loadUsers() {
    const stored = localStorage.getItem('oled_users');
    users = stored ? JSON.parse(stored) : CONFIG.defaultUsers;
  }
  function saveUsers() { localStorage.setItem('oled_users', JSON.stringify(users)); renderAdminUserTable(); }
  function checkSavedLogin() {
      const saved = localStorage.getItem('oled_saved_creds');
      if(saved) {
          try {
              const creds = JSON.parse(saved);
              document.getElementById('userInput').value = creds.login;
              document.getElementById('passInput').value = creds.pass;
              document.getElementById('rememberCheck').checked = true;
          } catch(e) {}
      }
  }

  function attemptLogin() {
    const l = document.getElementById('userInput').value.trim().toUpperCase();
    const p = document.getElementById('passInput').value.trim();
    const remember = document.getElementById('rememberCheck').checked;

    const u = users.find(user => user.login === l && user.pass === p);
    if (u) {
      currentUser = u;
      if(remember) localStorage.setItem('oled_saved_creds', JSON.stringify({login:l, pass:p}));
      else localStorage.removeItem('oled_saved_creds');

      document.getElementById('loginScreen').style.opacity = '0';
      setTimeout(() => {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('networkGuard').style.display = 'flex'; // ZAWSZE NAJPIERW PO≈ÅƒÑCZENIE
        setupInterface(); // Ustawia klasy (ukrywa dashboardy)
        document.getElementById('mainDashboard').style.opacity = '1';
      }, 800);
    } else { 
      SoundFX.play('error');
      document.getElementById('loginError').innerText = "B≈ÅƒòDNY LOGIN LUB HAS≈ÅO"; 
    }
  }

  function logout() {
      if(confirm("Wylogowaƒá?")) {
          currentUser = null; dirHandle = null; currentSN = "";
          document.body.className = "";
          document.getElementById('loginScreen').style.display = 'flex';
          setTimeout(() => document.getElementById('loginScreen').style.opacity = '1', 50);
          document.getElementById('mainDashboard').style.opacity = '0';
          document.getElementById('networkGuard').style.display = 'none';
          document.getElementById('adminDash').style.display = 'none';
          document.getElementById('managerDash').style.display = 'none'; // Hide Manager
          document.getElementById('connStatus').innerHTML = "üî¥ OFFLINE";
          document.getElementById('connStatus').style.color = "#444";
      }
  }

  function setupInterface() {
    const b = document.getElementById('operatorBadge');
    b.innerText = currentUser.login;
    document.getElementById('tagOp').innerText = "OP: " + currentUser.login;
    b.className = "operator-badge"; 
    
    document.body.classList.remove('mode-manager', 'mode-admin');

    if(currentUser.role === 'KIEROWNIK') {
        b.classList.add('manager');
        document.body.classList.add('mode-manager');
        // KIEROWNIK NIE MA DOSTƒòPU DO KAMERY ANI OPERACJI
    } else if(currentUser.role === 'ADMIN') {
        b.classList.add('admin');
        document.body.classList.add('mode-admin');
        document.getElementById('dbBtn').style.display = 'none';
        document.getElementById('cfgPath').value = CONFIG.networkPath;
        document.getElementById('cfgMotd').value = CONFIG.motd;
        renderAdminUserTable();
        startAdminCamera(); // Tylko podglƒÖd
    } else {
        if(currentUser.role === 'KOORDYNATOR') b.classList.add('coord');
        initCamera(); // Operator ma kamerƒô
    }
  }

  /* --- NETWORK --- */
  async function connectNetwork() {
    try {
      await navigator.clipboard.writeText(CONFIG.networkPath);
      alert("≈öcie≈ºka skopiowana! Wybierz folder.");
      dirHandle = await window.showDirectoryPicker();
      
      // STATUS UPDATE (Naprawione)
      const statusEl = document.getElementById('connStatus');
      statusEl.innerHTML = "üü¢ ONLINE";
      statusEl.style.color = "var(--neon-green)";
      
      document.getElementById('networkGuard').style.display = 'none';
      
      // AUTO SCAN FOR MANAGER
      if(currentUser.role === 'KIEROWNIK') {
          setTimeout(scanNetwork, 500); 
      }
      // FOCUS FOR OPERATOR
      if(currentUser.role !== 'KIEROWNIK' && currentUser.role !== 'ADMIN') {
          document.getElementById('scanInput').focus();
      }

    } catch(e) { alert("Anulowano wyb√≥r folderu."); }
  }

  function startOfflineMode() {
      dirHandle = null; 
      const statusEl = document.getElementById('connStatus');
      statusEl.innerHTML = "üü° OFFLINE (ZIP)";
      statusEl.style.color = "var(--neon-orange)";
      
      document.getElementById('networkGuard').style.display = 'none';
      
      if(currentUser.role !== 'KIEROWNIK' && currentUser.role !== 'ADMIN') {
          document.getElementById('scanInput').focus();
      }
  }

  /* --- MANAGER LOGIC (DATA) --- */
  async function scanNetwork() {
    if(!dirHandle) {
        document.getElementById('mgrLogBody').innerHTML = "<tr><td colspan='6' style='text-align:center;color:orange;'>TRYB OFFLINE - BRAK DANYCH</td></tr>";
        return;
    }
    
    document.getElementById('mgrLogBody').innerHTML = "<tr><td colspan='6' style='text-align:center;'>POBIERANIE DANYCH...</td></tr>";
    
    reportsCache = [];
    try {
      for await (const e of dirHandle.values()) {
        if(e.kind === 'directory') {
          const sn = e.name; 
          let op="---", dateStr="---", dec="---", com="---", oc="---";
          let rawDateObj = null;

          try {
            const sub = await dirHandle.getDirectoryHandle(sn);
            for await (const f of sub.values()) {
              if(f.name.includes('RAPORT')) {
                const fl = await f.getFile(); 
                const tx = await fl.text(); 
                rawDateObj = fl.lastModifiedDate;
                dateStr = rawDateObj.toLocaleString();

                const mOp = tx.match(/OPERATOR: (.*)/); if(mOp) op=mOp[1];
                const mDec = tx.match(/DECYZJA: (.*)/); if(mDec) dec=mDec[1];
                const mCom = tx.match(/UWAGI: (.*)/); if(mCom) com=mCom[1];
                const mOc = tx.match(/OC SN:\s+(.*)/); if(mOc) oc=mOc[1];
              }
            }
          } catch(err){}
          reportsCache.push({date: dateStr, rawDate: rawDateObj, sn, op, dec, com, oc});
        }
      }
      updateLeaderStats(leaderMode);
    } catch(e) { console.error(e); }
  }

  function updateLeaderStats(mode) {
      leaderMode = mode;
      
      document.getElementById('fToday').classList.remove('active');
      document.getElementById('fYesterday').classList.remove('active');
      document.getElementById('fAll').classList.remove('active');
      
      if(mode==='TODAY') document.getElementById('fToday').classList.add('active');
      else if(mode==='YESTERDAY') document.getElementById('fYesterday').classList.add('active');
      else document.getElementById('fAll').classList.add('active');
      
      const now = new Date();
      const todayStr = now.toDateString();
      const yesterday = new Date(now); yesterday.setDate(yesterday.getDate() - 1);
      const yestStr = yesterday.toDateString();

      let filtered = [];
      if(mode === 'TODAY') filtered = reportsCache.filter(r => r.rawDate && r.rawDate.toDateString() === todayStr);
      else if(mode === 'YESTERDAY') filtered = reportsCache.filter(r => r.rawDate && r.rawDate.toDateString() === yestStr);
      else filtered = reportsCache;
      
      filtered.sort((a,b) => (b.rawDate || 0) - (a.rawDate || 0));

      // 1. Log Table
      const tb = document.getElementById('mgrLogBody'); tb.innerHTML = "";
      if(filtered.length===0) tb.innerHTML = "<tr><td colspan='6' style='text-align:center'>BRAK DANYCH</td></tr>";
      
      filtered.forEach(r => {
          let color = "#fff";
          if(r.dec.includes('NG') || r.dec.includes('SCRAP')) color = "var(--neon-red)";
          if(r.dec.includes('OK') || r.dec.includes('OFFRS')) color = "var(--neon-green)";
          if(r.dec.includes('RMA')) color = "orange";
          
          tb.innerHTML += `<tr><td>${r.date}</td><td>${r.sn}</td><td>${r.oc||'---'}</td><td>${r.op}</td><td style="color:${color};font-weight:bold">${r.dec}</td><td>${r.com}</td></tr>`;
      });

      // 2. Stats Cards
      const total = filtered.length;
      let ok=0, ng=0;
      const opStats = {};

      filtered.forEach(r => {
          if(['OK','OFFRS_OK','NDF'].includes(r.dec)) ok++; else ng++;
          
          if(!opStats[r.op]) opStats[r.op] = { total:0, ok:0 };
          opStats[r.op].total++;
          if(['OK','OFFRS_OK','NDF'].includes(r.dec)) opStats[r.op].ok++;
      });

      let yieldVal = total > 0 ? ((ok/total)*100).toFixed(1) : 0;
      document.getElementById('mgrTotal').innerText = total;
      document.getElementById('mgrOK').innerText = ok;
      document.getElementById('mgrNG').innerText = ng;
      document.getElementById('mgrYield').innerText = yieldVal + "%";

      // 3. Ranking
      const rankBody = document.getElementById('mgrRankBody'); rankBody.innerHTML = "";
      const sortedOps = Object.keys(opStats).sort((a,b) => opStats[b].total - opStats[a].total);
      
      if(sortedOps.length===0) rankBody.innerHTML = "<tr><td colspan='3' style='text-align:center'>BRAK DANYCH</td></tr>";
      
      sortedOps.forEach(op => {
          const s = opStats[op];
          const y = ((s.ok/s.total)*100).toFixed(0);
          let c = "#fff";
          if(y<80) c="var(--neon-red)"; else if(y>95) c="var(--neon-green)"; else c="orange";
          
          rankBody.innerHTML += `<tr><td>${op}</td><td>${s.total}</td><td style="color:${c}">${y}%</td></tr>`;
      });
  }

  function exportCSV() {
    if(!reportsCache.length) return alert("Brak danych w pamiƒôci (Od≈õwie≈º najpierw)");
    let c = "DATA,SN_MODULU,SN_SZKLA_OC,OPERATOR,DECYZJA,UWAGI\n";
    reportsCache.forEach(r => c+=`${r.date},${r.sn},${r.oc},${r.op},${r.dec},${r.com}\n`);
    saveAs(new Blob([c],{type:'text/csv'}), "raport_serwisowy.csv");
  }

  /* --- ADMIN & OPERATOR FUNCTIONS --- */
  function renderAdminUserTable() {
      const tb = document.querySelector('#admUserTable tbody'); tb.innerHTML = "";
      users.forEach((u, i) => {
        let color = '#fff';
        if(u.role === 'ADMIN') color = 'var(--neon-gold)';
        if(u.role === 'KOORDYNATOR') color = 'var(--neon-purple)';
        if(u.role === 'KIEROWNIK') color = 'var(--neon-red)';
        tb.innerHTML += `<tr><td>${u.login}</td><td style="color:${color}">${u.role}</td><td><div class="adm-btn-group"><button class="adm-act-btn" onclick="resetUserPass(${i})">RESET</button><button class="adm-act-btn" style="color:red" onclick="removeUser(${i})">X</button></div></td></tr>`;
      });
  }
  function addUser() {
    const l = document.getElementById('newLogin').value.trim().toUpperCase();
    const p = document.getElementById('newPass').value.trim();
    const r = document.getElementById('newRole').value;
    if(l && p) { users.push({login:l, pass:p, role:r}); saveUsers(); }
  }
  function removeUser(idx) { if(confirm("UsunƒÖƒá?")) { users.splice(idx, 1); saveUsers(); } }
  function resetUserPass(idx) { if(confirm("Reset has≈Ça na 1234?")) { users[idx].pass="1234"; saveUsers(); alert("OK"); } }
  
  async function startAdminCamera() {
      try {
          const s = await navigator.mediaDevices.getUserMedia({video:true});
          document.getElementById('adminCamPreview').srcObject = s;
      } catch(e) {}
  }

  async function initCamera() {
    if(currentUser.role === 'KIEROWNIK' || currentUser.role === 'ADMIN') return;
    try {
      const s = await navigator.mediaDevices.getUserMedia({video:{width:{ideal:3840}}});
      document.getElementById('videoFeed').srcObject = s;
    } catch(e) { console.log("Cam error"); }
  }

  /* --- OPERATOR LOGIC --- */
  function startSession(sn) {
    currentSN = sn; currentOC = ""; photos = { PRZOD: null, TYL: null, OBRAZ: null };
    document.getElementById('tagSN').innerText = "SN: " + sn;
    document.getElementById('scanInputOC').value = ""; document.getElementById('scanInputOC').disabled = true;
    document.querySelectorAll('.checklist-btn').forEach(b => b.classList.remove('done'));
    document.getElementById('actionBtn').classList.remove('active');
    document.getElementById('statusSelect').value = "OK";
  }

  function checkOcRequirement() {
      const decision = document.getElementById('statusSelect').value;
      const ocInput = document.getElementById('scanInputOC');
      if(['OK','RMA'].includes(decision)) {
          ocInput.placeholder = "‚ö†Ô∏è SKANUJ OC (WYMAGANE)";
          ocInput.style.borderColor = currentOC ? "var(--neon-green)" : "var(--neon-red)";
      } else {
          ocInput.placeholder = "OC OPCJONALNE";
          ocInput.style.borderColor = "#333";
      }
  }

  document.getElementById('scanInput').addEventListener('keydown', e => {
    if(e.key==='Enter') {
      const v = e.target.value.trim().toUpperCase();
      if(v.length>3) { SoundFX.play('beep'); startSession(v); saveRecoveryState(); 
        document.getElementById('scanInputOC').disabled=false; checkOcRequirement(); document.getElementById('scanInputOC').focus(); 
      } else SoundFX.play('error');
      e.target.value = "";
    }
  });

  document.getElementById('scanInputOC').addEventListener('keydown', e => {
    if(e.key==='Enter') {
        const v = e.target.value.trim().toUpperCase();
        if(v.length>3) { currentOC = v; SoundFX.play('beep'); checkOcRequirement(); saveRecoveryState(); }
    }
  });

  function saveRecoveryState() {
      if(!currentSN) return;
      localStorage.setItem('oled_recovery', JSON.stringify({sn:currentSN, oc:currentOC, status:document.getElementById('statusSelect').value}));
  }
  function checkRecovery() {
      const rec = JSON.parse(localStorage.getItem('oled_recovery'));
      if(rec && confirm(`Przywr√≥ciƒá sesjƒô dla SN: ${rec.sn}?`)) {
          startSession(rec.sn);
          if(rec.oc) { currentOC = rec.oc; document.getElementById('scanInputOC').value = rec.oc; }
          document.getElementById('statusSelect').value = rec.status;
          document.getElementById('scanInputOC').disabled = false;
      } else localStorage.removeItem('oled_recovery');
  }
  function clearRecovery() { localStorage.removeItem('oled_recovery'); }

  /* --- CAPTURE & SAVE (OPERATOR) --- */
  function capture(type) {
      if(!currentSN) return; tempPhotoType=type;
      const v = document.getElementById('videoFeed'); v.pause();
      document.getElementById('drawToolbar').style.display='block';
      document.getElementById('drawCanvas').style.display='block';
      const c = document.getElementById('drawCanvas'); c.width=v.offsetWidth; c.height=v.offsetHeight;
      const ctx = c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);
  }
  function confirmPhoto() { processPhoto(); }
  function cancelPhoto() {
      document.getElementById('videoFeed').play();
      document.getElementById('drawToolbar').style.display='none';
      document.getElementById('drawCanvas').style.display='none';
  }
  function processPhoto() {
      const v = document.getElementById('videoFeed');
      const finalC = document.getElementById('photoCanvas'); finalC.width=v.videoWidth; finalC.height=v.videoHeight;
      const ctx = finalC.getContext('2d');
      if(isMirrored) { ctx.translate(finalC.width,0); ctx.scale(-1,1); }
      ctx.drawImage(v,0,0);
      ctx.drawImage(document.getElementById('drawCanvas'),0,0,finalC.width,finalC.height);
      
      // Watermark
      const fs=Math.floor(finalC.height/25); ctx.font=`bold ${fs}px Roboto`; ctx.fillStyle="#0aff00";
      ctx.fillText(`SN: ${currentSN}`,50,fs+20);
      
      finalC.toBlob(b => {
          photos[tempPhotoType] = b;
          document.getElementById('actionBtn').classList.add('active'); // Uproszczone dla demo
          cancelPhoto();
      },'image/jpeg',0.9);
  }

  async function saveData() {
      const dec = document.getElementById('statusSelect').value;
      if(['OK','RMA'].includes(dec) && !currentOC) return alert("BRAK OC!");
      
      document.getElementById('saveStatus').innerText = "ZAPISYWANIE...";
      const txt = `RAPORT\nSN: ${currentSN}\nOC: ${currentOC}\nOP: ${currentUser.login}\nDEC: ${dec}`;
      
      if(dirHandle) {
          try {
              const d = await dirHandle.getDirectoryHandle(currentSN, {create:true});
              const h = await d.getFileHandle(`RAPORT_${currentSN}.txt`, {create:true});
              const w = await h.createWritable(); await w.write(txt); await w.close();
              finishSave(dec);
          } catch(e) { alert("B≈ÅƒÑD ZAPISU"); }
      } else {
          // Offline ZIP logic here (simplified)
          finishSave(dec);
      }
  }

  function finishSave(dec) {
      clearRecovery(); document.getElementById('saveStatus').innerText = "ZAPISANO";
      new QRCode(document.getElementById('qrCodeBox'), `${currentSN}|${dec}`);
      document.getElementById('qrPopup').style.display='block';
      setTimeout(()=>{ currentSN=""; startSession(""); },1000);
  }
  function closeQr() { document.getElementById('qrPopup').style.display='none'; }

  /* --- UTILS --- */
  function startDraw(e) { isDrawing=true; draw(e); }
  function endDraw() { isDrawing=false; document.getElementById('drawCanvas').getContext('2d').beginPath(); }
  function draw(e) {
      if(!isDrawing) return;
      const ctx = document.getElementById('drawCanvas').getContext('2d');
      const rect = e.target.getBoundingClientRect();
      const x = e.clientX - rect.left; const y = e.clientY - rect.top;
      ctx.lineWidth=5; ctx.strokeStyle=drawColor; ctx.lineTo(x,y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x,y);
  }
  function setDrawColor(c) { drawColor=c; }
  function clearDraw() { const c=document.getElementById('drawCanvas'); c.getContext('2d').clearRect(0,0,c.width,c.height); }
  function togglePatterns() { document.getElementById('patternOverlay').style.display='block'; nextPattern(); }
  let pIdx=-1; const pats=['#fff','#f00','#0f0','#00f','#000'];
  function nextPattern() { pIdx++; if(pIdx>=pats.length){document.getElementById('patternOverlay').style.display='none';pIdx=-1;} else document.getElementById('patternOverlay').style.background=pats[pIdx]; }
  function toggleFullScreen() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
  function toggleReportPanel() { document.getElementById('reportPanel').classList.toggle('open'); }
</script>
</body>
</html>
