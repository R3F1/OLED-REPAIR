Papa.parse(CSV_URL, {
  download: true,
  complete: function(results) {
    const data = results.data;
    const headers = data[0];
    const dateIndex = headers.findIndex(h => h.trim().toLowerCase() === "data");
    const statusIndex = headers.findIndex(h => h.trim().toLowerCase() === "status");

    const today = new Date().toISOString().split('T')[0];
    const yesterday = new Date(new Date().setDate(new Date().getDate() - 1)).toISOString().split('T')[0];
    const last7Days = getDateStringsISO(7);

    const thead = document.querySelector("#oledTable thead");
    const tbody = document.querySelector("#oledTable tbody");
    thead.innerHTML = '';
    tbody.innerHTML = '';

    const headRow = document.createElement("tr");
    headers.forEach(h => {
      const th = document.createElement("th");
      th.textContent = h;
      headRow.appendChild(th);
    });
    thead.appendChild(headRow);

    let shownRows = 0;
    const statusCounts = {};
    let okCount = 0;
    const exportRows = [];
    const allRows = [];

    data.slice(1).forEach(row => {
      const rowDate = row[dateIndex]?.trim();
      const status = row[statusIndex]?.trim();

      allRows.push(row); // zapamiętaj wszystko do przeszukiwania

      if (last7Days.includes(rowDate)) {
        statusCounts[status] = (statusCounts[status] || 0) + 1;
        if (status === "OK") okCount++;
      }

      if (rowDate === today || rowDate === yesterday) {
        const tr = document.createElement("tr");
        row.forEach(cell => {
          const td = document.createElement("td");
          td.textContent = cell;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
        exportRows.push(row);
        shownRows++;
      }
    });

    document.getElementById("counter").textContent =
      `Liczba wpisów z ${yesterday} i ${today}: ${shownRows}`;

    document.getElementById("exportBtn").addEventListener("click", () => {
      downloadCSV(headers, exportRows);
    });

    const ctx = document.getElementById('statusChart').getContext('2d');
    const colorMap = {
      "OK": "#4CAF50",
      "NG": "#F44336",
      "NDF": "#2196F3",
      "WTG": "#FFC107",
      "DMNT": "#9E9E9E"
    };
    const colors = Object.keys(statusCounts).map(s => colorMap[s] || "#9C27B0");

    const centerTextPlugin = {
      id: 'centerText',
      beforeDraw: (chart) => {
        const {width, height} = chart;
        const ctx = chart.ctx;
        ctx.restore();
        const fontSize = (height / 140).toFixed(2);
        ctx.font = `${fontSize}em sans-serif`;
        ctx.textBaseline = "middle";
        ctx.fillStyle = "#000";
        const text = `OK: ${okCount}`;
        const textX = Math.round((width - ctx.measureText(text).width) / 2);
        const textY = height / 2;
        ctx.fillText(text, textX, textY);
        ctx.save();
      }
    };

    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(statusCounts),
        datasets: [{
          label: 'STATUS (7 dni)',
          data: Object.values(statusCounts),
          backgroundColor: colors,
          borderColor: '#111',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { labels:
